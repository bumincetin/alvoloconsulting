module.exports=[30947,a=>{"use strict";let b,c,d;var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u={exports:{}};e=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,f=/^(?=([^\/?#]*))\1([^]*)$/,g=/(?:\/|^)\.(?=\/)/g,h=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,u.exports=i={buildAbsoluteURL:function(a,b,c){if(c=c||{},a=a.trim(),!(b=b.trim())){if(!c.alwaysNormalize)return a;var d=i.parseURL(a);if(!d)throw Error("Error trying to parse base URL.");return d.path=i.normalizePath(d.path),i.buildURLFromParts(d)}var e=i.parseURL(b);if(!e)throw Error("Error trying to parse relative URL.");if(e.scheme)return c.alwaysNormalize?(e.path=i.normalizePath(e.path),i.buildURLFromParts(e)):b;var g=i.parseURL(a);if(!g)throw Error("Error trying to parse base URL.");if(!g.netLoc&&g.path&&"/"!==g.path[0]){var h=f.exec(g.path);g.netLoc=h[1],g.path=h[2]}g.netLoc&&!g.path&&(g.path="/");var j={scheme:g.scheme,netLoc:e.netLoc,path:null,params:e.params,query:e.query,fragment:e.fragment};if(!e.netLoc&&(j.netLoc=g.netLoc,"/"!==e.path[0]))if(e.path){var k=g.path,l=k.substring(0,k.lastIndexOf("/")+1)+e.path;j.path=i.normalizePath(l)}else j.path=g.path,!e.params&&(j.params=g.params,e.query||(j.query=g.query));return null===j.path&&(j.path=c.alwaysNormalize?i.normalizePath(e.path):e.path),i.buildURLFromParts(j)},parseURL:function(a){var b=e.exec(a);return b?{scheme:b[1]||"",netLoc:b[2]||"",path:b[3]||"",params:b[4]||"",query:b[5]||"",fragment:b[6]||""}:null},normalizePath:function(a){for(a=a.split("").reverse().join("").replace(g,"");a.length!==(a=a.replace(h,"")).length;);return a.split("").reverse().join("")},buildURLFromParts:function(a){return a.scheme+a.netLoc+a.path+a.params+a.query+a.fragment}};var v=u.exports;function w(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function x(a){for(var b=1;b<arguments.length;b++){var c=null!=arguments[b]?arguments[b]:{};b%2?w(Object(c),!0).forEach(function(b){!function(a,b,c){var d;(b="symbol"==typeof(d=function(a,b){if("object"!=typeof a||!a)return a;var c=a[Symbol.toPrimitive];if(void 0!==c){var d=c.call(a,b||"default");if("object"!=typeof d)return d;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===b?String:Number)(a)}(b,"string"))?d:String(d))in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c}(a,b,c[b])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(c)):w(Object(c)).forEach(function(b){Object.defineProperty(a,b,Object.getOwnPropertyDescriptor(c,b))})}return a}function y(){return(y=Object.assign.bind()).apply(this,arguments)}let z=Number.isFinite||function(a){return"number"==typeof a&&isFinite(a)},A=Number.isSafeInteger||function(a){return"number"==typeof a&&Math.abs(a)<=B},B=Number.MAX_SAFE_INTEGER||0x1fffffffffffff,C=((j={}).MEDIA_ATTACHING="hlsMediaAttaching",j.MEDIA_ATTACHED="hlsMediaAttached",j.MEDIA_DETACHING="hlsMediaDetaching",j.MEDIA_DETACHED="hlsMediaDetached",j.BUFFER_RESET="hlsBufferReset",j.BUFFER_CODECS="hlsBufferCodecs",j.BUFFER_CREATED="hlsBufferCreated",j.BUFFER_APPENDING="hlsBufferAppending",j.BUFFER_APPENDED="hlsBufferAppended",j.BUFFER_EOS="hlsBufferEos",j.BUFFER_FLUSHING="hlsBufferFlushing",j.BUFFER_FLUSHED="hlsBufferFlushed",j.MANIFEST_LOADING="hlsManifestLoading",j.MANIFEST_LOADED="hlsManifestLoaded",j.MANIFEST_PARSED="hlsManifestParsed",j.LEVEL_SWITCHING="hlsLevelSwitching",j.LEVEL_SWITCHED="hlsLevelSwitched",j.LEVEL_LOADING="hlsLevelLoading",j.LEVEL_LOADED="hlsLevelLoaded",j.LEVEL_UPDATED="hlsLevelUpdated",j.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",j.LEVELS_UPDATED="hlsLevelsUpdated",j.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",j.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",j.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",j.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",j.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",j.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",j.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",j.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",j.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",j.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",j.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",j.CUES_PARSED="hlsCuesParsed",j.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",j.INIT_PTS_FOUND="hlsInitPtsFound",j.FRAG_LOADING="hlsFragLoading",j.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",j.FRAG_LOADED="hlsFragLoaded",j.FRAG_DECRYPTED="hlsFragDecrypted",j.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",j.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",j.FRAG_PARSING_METADATA="hlsFragParsingMetadata",j.FRAG_PARSED="hlsFragParsed",j.FRAG_BUFFERED="hlsFragBuffered",j.FRAG_CHANGED="hlsFragChanged",j.FPS_DROP="hlsFpsDrop",j.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",j.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",j.ERROR="hlsError",j.DESTROYING="hlsDestroying",j.KEY_LOADING="hlsKeyLoading",j.KEY_LOADED="hlsKeyLoaded",j.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",j.BACK_BUFFER_REACHED="hlsBackBufferReached",j.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",j),D=((k={}).NETWORK_ERROR="networkError",k.MEDIA_ERROR="mediaError",k.KEY_SYSTEM_ERROR="keySystemError",k.MUX_ERROR="muxError",k.OTHER_ERROR="otherError",k),E=((l={}).KEY_SYSTEM_NO_KEYS="keySystemNoKeys",l.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",l.KEY_SYSTEM_NO_SESSION="keySystemNoSession",l.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",l.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",l.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",l.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",l.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",l.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",l.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",l.MANIFEST_LOAD_ERROR="manifestLoadError",l.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",l.MANIFEST_PARSING_ERROR="manifestParsingError",l.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",l.LEVEL_EMPTY_ERROR="levelEmptyError",l.LEVEL_LOAD_ERROR="levelLoadError",l.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",l.LEVEL_PARSING_ERROR="levelParsingError",l.LEVEL_SWITCH_ERROR="levelSwitchError",l.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",l.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",l.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",l.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",l.FRAG_LOAD_ERROR="fragLoadError",l.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",l.FRAG_DECRYPT_ERROR="fragDecryptError",l.FRAG_PARSING_ERROR="fragParsingError",l.FRAG_GAP="fragGap",l.REMUX_ALLOC_ERROR="remuxAllocError",l.KEY_LOAD_ERROR="keyLoadError",l.KEY_LOAD_TIMEOUT="keyLoadTimeOut",l.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",l.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",l.BUFFER_APPEND_ERROR="bufferAppendError",l.BUFFER_APPENDING_ERROR="bufferAppendingError",l.BUFFER_STALLED_ERROR="bufferStalledError",l.BUFFER_FULL_ERROR="bufferFullError",l.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",l.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",l.INTERNAL_EXCEPTION="internalException",l.INTERNAL_ABORTED="aborted",l.UNKNOWN="unknown",l),F=function(){},G={trace:F,debug:F,log:F,warn:F,info:F,error:F},H=G,I=H,J=/^(\d+)x(\d+)$/,K=/(.+?)=(".*?"|.*?)(?:,|$)/g;class L{constructor(a){"string"==typeof a&&(a=L.parseAttrList(a)),y(this,a)}get clientAttrs(){return Object.keys(this).filter(a=>"X-"===a.substring(0,2))}decimalInteger(a){let b=parseInt(this[a],10);return b>Number.MAX_SAFE_INTEGER?1/0:b}hexadecimalInteger(a){if(!this[a])return null;{let b=(this[a]||"0x").slice(2),c=new Uint8Array((b=(1&b.length?"0":"")+b).length/2);for(let a=0;a<b.length/2;a++)c[a]=parseInt(b.slice(2*a,2*a+2),16);return c}}hexadecimalIntegerAsNumber(a){let b=parseInt(this[a],16);return b>Number.MAX_SAFE_INTEGER?1/0:b}decimalFloatingPoint(a){return parseFloat(this[a])}optionalFloat(a,b){let c=this[a];return c?parseFloat(c):b}enumeratedString(a){return this[a]}bool(a){return"YES"===this[a]}decimalResolution(a){let b=J.exec(this[a]);if(null!==b)return{width:parseInt(b[1],10),height:parseInt(b[2],10)}}static parseAttrList(a){let b,c={};for(K.lastIndex=0;null!==(b=K.exec(a));){let a=b[2];0===a.indexOf('"')&&a.lastIndexOf('"')===a.length-1&&(a=a.slice(1,-1)),c[b[1].trim()]=a}return c}}class M{constructor(a,b){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,b){const c=b.attr;for(const b in c)if(Object.prototype.hasOwnProperty.call(a,b)&&a[b]!==c[b]){I.warn(`DATERANGE tag attribute: "${b}" does not match for tags with ID: "${a.ID}"`),this._badValueForSameId=b;break}a=y(new L({}),c,a)}if(this.attr=a,this._startDate=new Date(a["START-DATE"]),"END-DATE"in this.attr){const a=new Date(this.attr["END-DATE"]);z(a.getTime())&&(this._endDate=a)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;let a=this.duration;return null!==a?new Date(this._startDate.getTime()+1e3*a):null}get duration(){if("DURATION"in this.attr){let a=this.attr.decimalFloatingPoint("DURATION");if(z(a))return a}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&z(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class N{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var O="audio",P="video",Q="audiovideo";class R{constructor(a){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[O]:null,[P]:null,[Q]:null},this.baseurl=a}setByteRange(a,b){let c,d=a.split("@",2);c=1===d.length?(null==b?void 0:b.byteRangeEndOffset)||0:parseInt(d[1]),this._byteRange=[c,parseInt(d[0])+c]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=v.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(a){this._url=a}}class S extends R{constructor(a,b){super(b),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new N,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=a}get decryptdata(){let{levelkeys:a}=this;if(!a&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){let a=this.levelkeys.identity;if(a)this._decryptdata=a.getDecryptData(this.sn);else{let a=Object.keys(this.levelkeys);if(1===a.length)return this._decryptdata=this.levelkeys[a[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime||!z(this.programDateTime))return null;let a=z(this.duration)?this.duration:0;return this.programDateTime+1e3*a}get encrypted(){var a;if(null!=(a=this._decryptdata)&&a.encrypted)return!0;if(this.levelkeys){let a=Object.keys(this.levelkeys),b=a.length;if(b>1||1===b&&this.levelkeys[a[0]].encrypted)return!0}return!1}setKeyFormat(a){if(this.levelkeys){let b=this.levelkeys[a];b&&!this._decryptdata&&(this._decryptdata=b.getDecryptData(this.sn))}}abortRequests(){var a,b;null==(a=this.loader)||a.abort(),null==(b=this.keyLoader)||b.abort()}setElementaryStreamInfo(a,b,c,d,e,f=!1){let{elementaryStreams:g}=this,h=g[a];if(!h){g[a]={startPTS:b,endPTS:c,startDTS:d,endDTS:e,partial:f};return}h.startPTS=Math.min(h.startPTS,b),h.endPTS=Math.max(h.endPTS,c),h.startDTS=Math.min(h.startDTS,d),h.endDTS=Math.max(h.endDTS,e)}clearElementaryStreamInfo(){let{elementaryStreams:a}=this;a[O]=null,a[P]=null,a[Q]=null}}class T extends R{constructor(a,b,c,d,e){super(c),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new N,this.duration=a.decimalFloatingPoint("DURATION"),this.gap=a.bool("GAP"),this.independent=a.bool("INDEPENDENT"),this.relurl=a.enumeratedString("URI"),this.fragment=b,this.index=d;const f=a.enumeratedString("BYTERANGE");f&&this.setByteRange(f,e),e&&(this.fragOffset=e.fragOffset+e.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){let{elementaryStreams:a}=this;return!!(a.audio||a.video||a.audiovideo)}}class U{constructor(a){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=a}reloaded(a){if(!a){this.advanced=!0,this.updated=!0;return}let b=this.lastPartSn-a.lastPartSn,c=this.lastPartIndex-a.lastPartIndex;this.updated=this.endSN!==a.endSN||!!c||!!b||!this.live,this.advanced=this.endSN>a.endSN||b>0||0===b&&c>0,this.updated||this.advanced?this.misses=Math.floor(.6*a.misses):this.misses=a.misses+1,this.availabilityDelay=a.availabilityDelay}get hasProgramDateTime(){return!!this.fragments.length&&z(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){let a=this.driftEndTime-this.driftStartTime;return a>0?1e3*(this.driftEnd-this.driftStart)/a:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var a;return null!=(a=this.partList)&&a.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var a;return null!=(a=this.fragments)&&a.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var a;return null!=(a=this.partList)&&a.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var a;return null!=(a=this.partList)&&a.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}function V(a){return Uint8Array.from(atob(a),a=>a.charCodeAt(0))}function W(a){return Uint8Array.from(unescape(encodeURIComponent(a)),a=>a.charCodeAt(0))}let X="u">typeof self?self:void 0;var Y="org.w3.clearkey",Z="com.apple.fps",$="com.microsoft.playready",_="com.widevine.alpha",aa="org.w3.clearkey",ab="com.apple.streamingkeydelivery",ac="com.microsoft.playready",ad="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed";function ae(a){switch(a){case ab:return Z;case ac:return $;case ad:return _;case aa:return Y}}var af="edef8ba979d64acea3c827dcd51d21ed";function ag(a){return a===af?_:"9a04f07998404286ab92e65be0885f95"===a?$:"1077efecc0b24d02ace33c1e52e2fb4b"===a||"e2719d58a985b3c9781ab030af78d30e"===a?Y:void 0}function ah(a){switch(a){case Z:return ab;case $:return ac;case _:return ad;case Y:return aa}}function ai(a){let{drmSystems:b,widevineLicenseUrl:c}=a,d=b?[Z,_,$,Y].filter(a=>!!b[a]):[];return!d[_]&&c&&d.push(_),d}let aj=null!=X&&null!=(m=X.navigator)&&m.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;function ak(a,b,c){return Uint8Array.prototype.slice?a.slice(b,c):new Uint8Array(Array.prototype.slice.call(a,b,c))}let al=(a,b)=>b+10<=a.length&&73===a[b]&&68===a[b+1]&&51===a[b+2]&&a[b+3]<255&&a[b+4]<255&&a[b+6]<128&&a[b+7]<128&&a[b+8]<128&&a[b+9]<128||!1,am=(a,b)=>b+10<=a.length&&51===a[b]&&68===a[b+1]&&73===a[b+2]&&a[b+3]<255&&a[b+4]<255&&a[b+6]<128&&a[b+7]<128&&a[b+8]<128&&a[b+9]<128||!1,an=(a,b)=>{let c=b,d=0;for(;al(a,b);)d+=10,d+=ao(a,b+6),am(a,b+10)&&(d+=10),b+=d;if(d>0)return a.subarray(c,c+d)},ao=(a,b)=>(127&a[b])<<21|(127&a[b+1])<<14|(127&a[b+2])<<7|127&a[b+3],ap=(a,b)=>al(a,b)&&ao(a,b+6)+10<=a.length-b,aq=a=>{let b=at(a);for(let a=0;a<b.length;a++){let c=b[a];if(ar(c))return ay(c)}},ar=a=>a&&"PRIV"===a.key&&"com.apple.streaming.transportStreamTimestamp"===a.info,as=a=>{let b=String.fromCharCode(a[0],a[1],a[2],a[3]),c=ao(a,4);return{type:b,size:c,data:a.subarray(10,10+c)}},at=a=>{let b=0,c=[];for(;al(a,b);){let d=ao(a,b+6),e=(b+=10)+d;for(;b+8<e;){let d=as(a.subarray(b)),e=au(d);e&&c.push(e),b+=d.size+10}am(a,b)&&(b+=10)}return c},au=a=>"PRIV"===a.type?av(a):"W"===a.type[0]?ax(a):aw(a),av=a=>{if(a.size<2)return;let b=az(a.data,!0),c=new Uint8Array(a.data.subarray(b.length+1));return{key:a.type,info:b,data:c.buffer}},aw=a=>{if(a.size<2)return;if("TXXX"===a.type){let b=1,c=az(a.data.subarray(b),!0);b+=c.length+1;let d=az(a.data.subarray(b));return{key:a.type,info:c,data:d}}let b=az(a.data.subarray(1));return{key:a.type,data:b}},ax=a=>{if("WXXX"===a.type){if(a.size<2)return;let b=1,c=az(a.data.subarray(b),!0);b+=c.length+1;let d=az(a.data.subarray(b));return{key:a.type,info:c,data:d}}let b=az(a.data);return{key:a.type,data:b}},ay=a=>{if(8===a.data.byteLength){let b=new Uint8Array(a.data),c=1&b[3],d=(b[4]<<23)+(b[5]<<15)+(b[6]<<7)+b[7];return d/=45,c&&(d+=47721858.84),Math.round(d)}},az=(a,c=!1)=>{let d,e,f=function(){if(!navigator.userAgent.includes("PlayStation 4"))return b||void 0===self.TextDecoder||(b=new self.TextDecoder("utf-8")),b}();if(f){let b=f.decode(a);if(c){let a=b.indexOf("\0");return -1!==a?b.substring(0,a):b}return b.replace(/\0/g,"")}let g=a.length,h="",i=0;for(;i<g&&(0!==(d=a[i++])||!c);)if(0!==d&&3!==d)switch(d>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:h+=String.fromCharCode(d);break;case 12:case 13:h+=String.fromCharCode((31&d)<<6|63&(e=a[i++]));break;case 14:h+=String.fromCharCode((15&d)<<12|(63&(e=a[i++]))<<6|63&a[i++])}return h},aA=function(a){let b="";for(let c=0;c<a.length;c++){let d=a[c].toString(16);d.length<2&&(d="0"+d),b+=d}return b},aB=[].push,aC={video:1,audio:2,id3:3,text:4};function aD(a){return String.fromCharCode.apply(null,a)}function aE(a,b){let c=a[b]<<8|a[b+1];return c<0?65536+c:c}function aF(a,b){let c=aH(a,b);return c<0?0x100000000+c:c}function aG(a,b){let c=aF(a,b);return c*=0x100000000,c+=aF(a,b+4)}function aH(a,b){return a[b]<<24|a[b+1]<<16|a[b+2]<<8|a[b+3]}function aI(a,b,c){a[b]=c>>24,a[b+1]=c>>16&255,a[b+2]=c>>8&255,a[b+3]=255&c}function aJ(a,b){let c=[];if(!b.length)return c;let d=a.byteLength;for(let e=0;e<d;){let f=aF(a,e),g=aD(a.subarray(e+4,e+8)),h=f>1?e+f:d;if(g===b[0])if(1===b.length)c.push(a.subarray(e+8,h));else{let d=aJ(a.subarray(e+8,h),b.slice(1));d.length&&aB.apply(c,d)}e=h}return c}function aK(a){let b=[],c=aJ(a,["moov","trak"]);for(let a=0;a<c.length;a++){let d=c[a],e=aJ(d,["tkhd"])[0];if(e){let a=e[0],c=aF(e,0===a?12:20),f=aJ(d,["mdia","mdhd"])[0];if(f){a=f[0];let e=aF(f,0===a?12:20),g=aJ(d,["mdia","hdlr"])[0];if(g){let a={soun:O,vide:P}[aD(g.subarray(8,12))];if(a){let f=function(a){let b=a.subarray(8),c=b.subarray(86),d=aD(b.subarray(4,8)),e=d,f="enca"===d||"encv"===d;if(f){let a=aJ(b,[d])[0].subarray("enca"===d?28:78);aJ(a,["sinf"]).forEach(a=>{let b=aJ(a,["schm"])[0];if(b){let c=aD(b.subarray(4,8));if("cbcs"===c||"cenc"===c){let b=aJ(a,["frma"])[0];b&&(e=aD(b))}}})}switch(e){case"avc1":case"avc2":case"avc3":case"avc4":{let a=aJ(c,["avcC"])[0];e+="."+aM(a[1])+aM(a[2])+aM(a[3]);break}case"mp4a":{let a=aJ(b,[d])[0],c=aJ(a.subarray(28),["esds"])[0];if(c&&c.length>12){let a=4;if(3!==c[a++])break;a=aL(c,a)+2;let b=c[a++];if(128&b&&(a+=2),64&b&&(a+=c[a++]),4!==c[a++])break;a=aL(c,a);let d=c[a++];if(64===d)e+="."+aM(d);else break;if(a+=12,5!==c[a++])break;a=aL(c,a);let f=c[a++],g=(248&f)>>3;31===g&&(g+=1+((7&f)<<3)+((224&c[a])>>5)),e+="."+g}break}case"hvc1":case"hev1":{let a=aJ(c,["hvcC"])[0],b=a[1],d=["","A","B","C"][b>>6],f=aF(a,2),g=a[12],h=a.subarray(6,12);e+="."+d+(31&b),e+="."+f.toString(16).toUpperCase(),e+="."+((32&b)>>5?"H":"L")+g;let i="";for(let a=h.length;a--;){let b=h[a];(b||i)&&(i="."+b.toString(16).toUpperCase()+i)}e+=i;break}case"dvh1":case"dvhe":{let a=aJ(c,["dvcC"])[0],b=a[2]>>1&127,d=a[2]<<5&32|a[3]>>3&31;e+="."+aN(b)+"."+aN(d);break}case"vp09":{let a=aJ(c,["vpcC"])[0],b=a[4],d=a[5],f=a[6]>>4&15;e+="."+aN(b)+"."+aN(d)+"."+aN(f);break}case"av01":{let a=aJ(c,["av1C"])[0],b=a[1]>>>5,d=31&a[1],f=a[2]>>>7?"H":"M",g=(64&a[2])>>6,h=(32&a[2])>>5,i=(16&a[2])>>4,j=(8&a[2])>>3,k=(4&a[2])>>2,l=3&a[2];e+="."+b+"."+aN(d)+f+"."+aN(2===b&&g?h?12:10:g?10:8)+"."+i+"."+j+k+l+"."+aN(1)+"."+aN(1)+"."+aN(1)+".0"}}return{codec:e,encrypted:f}}(aJ(d,["mdia","minf","stbl","stsd"])[0]);b[c]={timescale:e,type:a},b[a]=x({timescale:e,id:c},f)}}}}}return aJ(a,["moov","mvex","trex"]).forEach(a=>{let c=b[aF(a,4)];c&&(c.default={duration:aF(a,12),flags:aF(a,20)})}),b}function aL(a,b){let c=b+5;for(;128&a[b++]&&b<c;);return b}function aM(a){return("0"+a.toString(16).toUpperCase()).slice(-2)}function aN(a){return(a<10?"0":"")+a}function aO(a){let b=aJ(a,["schm"])[0];if(b){let c=aD(b.subarray(4,8));if("cbcs"===c||"cenc"===c)return aJ(a,["schi","tenc"])[0]}return null}function aP(a,b){let c=new Uint8Array(a.length+b.length);return c.set(a),c.set(b,a.length),c}function aQ(a,b){let c=[],d=b.samples,e=b.timescale,f=b.id,g=!1;return aJ(d,["moof"]).map(h=>{let i=h.byteOffset-8;aJ(h,["traf"]).map(h=>{let j=aJ(h,["tfdt"]).map(a=>{let b=a[0],c=aF(a,4);return 1===b&&(c*=0x100000000,c+=aF(a,8)),c/e})[0];return void 0!==j&&(a=j),aJ(h,["tfhd"]).map(j=>{let k=aF(j,4),l=0xffffff&aF(j,0),m=0,n=0,o=8;k===f&&((1&l)!=0&&(o+=8),(2&l)!=0&&(o+=4),(8&l)!=0&&(m=aF(j,o),o+=4),(16&l)!=0&&(n=aF(j,o),o+=4),(32&l)!=0&&(o+=4),"video"===b.type&&(g=function(a){if(!a)return!1;let b=a.indexOf("."),c=b<0?a:a.substring(0,b);return"hvc1"===c||"hev1"===c||"dvh1"===c||"dvhe"===c}(b.codec)),aJ(h,["trun"]).map(f=>{let h=f[0],j=0xffffff&aF(f,0),k=0,l=(256&j)!=0,o=0,p=(512&j)!=0,q=0,r=(1024&j)!=0,s=(2048&j)!=0,t=0,u=aF(f,4),v=8;(1&j)!=0&&(k=aF(f,v),v+=4),(4&j)!=0&&(v+=4);let w=k+i;for(let i=0;i<u;i++){if(l?(o=aF(f,v),v+=4):o=m,p?(q=aF(f,v),v+=4):q=n,r&&(v+=4),s&&(t=0===h?aF(f,v):aH(f,v),v+=4),b.type===P){let b=0;for(;b<q;){let f=aF(d,w);w+=4,function(a,b){if(!a)return 6==(31&b);{let a=b>>1&63;return 39===a||40===a}}(g,d[w])&&aR(d.subarray(w,w+f),g?2:1,a+t/e,c),w+=f,b+=f+4}}a+=o/e}}))})})}),c}function aR(a,b,c,d){let e,f=aS(a);e=0+b;let g=0,h=0,i=0;for(;e<f.length;){g=0;do{if(e>=f.length)break;g+=i=f[e++]}while(255===i)h=0;do{if(e>=f.length)break;h+=i=f[e++]}while(255===i)let a=f.length-e,b=e;if(h<a)e+=h;else if(h>a){I.error(`Malformed SEI payload. ${h} is too small, only ${a} bytes left to parse.`);break}if(4===g){if(181===f[b++]){let a=aE(f,b);if(b+=2,49===a){let a=aF(f,b);if(b+=4,0x47413934===a){let a=f[b++];if(3===a){let e=f[b++],h=31&e,i=64&e,j=i?2+3*h:0,k=new Uint8Array(j);if(i){k[0]=e;for(let a=1;a<j;a++)k[a]=f[b++]}d.push({type:a,payloadType:g,pts:c,bytes:k})}}}}}else if(5===g&&h>16){let a=[];for(let c=0;c<16;c++){let d=f[b++].toString(16);a.push(1==d.length?"0"+d:d),(3===c||5===c||7===c||9===c)&&a.push("-")}let e=h-16,i=new Uint8Array(e);for(let a=0;a<e;a++)i[a]=f[b++];d.push({payloadType:g,pts:c,uuid:a.join(""),userData:az(i),userDataBytes:i})}}}function aS(a){let b=a.byteLength,c=[],d=1;for(;d<b-2;)0===a[d]&&0===a[d+1]&&3===a[d+2]?(c.push(d+2),d+=2):d++;if(0===c.length)return a;let e=b-c.length,f=new Uint8Array(e),g=0;for(d=0;d<e;g++,d++)g===c[0]&&(g++,c.shift()),f[d]=a[g];return f}let aT={};class aU{static clearKeyUriToKeyIdMap(){aT={}}constructor(a,b,c,d=[1],e=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=a,this.uri=b,this.keyFormat=c,this.keyFormatVersions=d,this.iv=e,this.encrypted=!!a&&"NONE"!==a,this.isCommonEncryption=this.encrypted&&"AES-128"!==a}isSupported(){if(this.method){if("AES-128"===this.method||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case ab:case ad:case ac:case aa:return -1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}getDecryptData(a){if(!this.encrypted||!this.uri)return null;if("AES-128"===this.method&&this.uri&&!this.iv){"number"!=typeof a&&("AES-128"!==this.method||this.iv||I.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),a=0);let b=function(a){let b=new Uint8Array(16);for(let c=12;c<16;c++)b[c]=a>>8*(15-c)&255;return b}(a);return new aU(this.method,this.uri,"identity",this.keyFormatVersions,b)}let b=function(a){let b=a.split(":"),c=null;if("data"===b[0]&&2===b.length){let a=b[1].split(";"),d=a[a.length-1].split(",");if(2===d.length){let b="base64"===d[0],e=d[1];if(b)a.splice(-1,1),c=V(e);else{let a,b;a=W(e).subarray(0,16),(b=new Uint8Array(16)).set(a,16-a.length),c=b}}}return c}(this.uri);if(b)switch(this.keyFormat){case ad:this.pssh=b,b.length>=22&&(this.keyId=b.subarray(b.length-22,b.length-6));break;case ac:{let a=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=function(a,b,c){let d,e;if(16!==a.byteLength)throw RangeError("Invalid system id");d=new Uint8Array,e=new Uint8Array;let f=new Uint8Array(4);return c&&c.byteLength>0&&new DataView(f.buffer).setUint32(0,c.byteLength,!1),function(a,...b){let c=b.length,d=8,e=c;for(;e--;)d+=b[e].byteLength;let f=new Uint8Array(d);for(f[0]=d>>24&255,f[1]=d>>16&255,f[2]=d>>8&255,f[3]=255&d,f.set(a,4),e=0,d=8;e<c;e++)f.set(b[e],d),d+=b[e].byteLength;return f}([112,115,115,104],new Uint8Array([0,0,0,0]),a,e,d,f,c||new Uint8Array)}(a,0,b);let c=new Uint16Array(b.buffer,b.byteOffset,b.byteLength/2),d=String.fromCharCode.apply(null,Array.from(c)),e=d.substring(d.indexOf("<"),d.length),f=new DOMParser().parseFromString(e,"text/xml").getElementsByTagName("KID")[0];if(f){let a=f.childNodes[0]?f.childNodes[0].nodeValue:f.getAttribute("VALUE");if(a){let b,c=V(a).subarray(0,16);(b=function(a,b,c){let d=a[b];a[b]=a[c],a[c]=d})(c,0,3),b(c,1,2),b(c,4,5),b(c,6,7),this.keyId=c}}break}default:{let a=b.subarray(0,16);if(16!==a.length){let b=new Uint8Array(16);b.set(a,16-a.length),a=b}this.keyId=a}}if(!this.keyId||16!==this.keyId.byteLength){let a=aT[this.uri];if(!a){let b=Object.keys(aT).length%Number.MAX_SAFE_INTEGER;new DataView((a=new Uint8Array(16)).buffer,12,4).setUint32(0,b),aT[this.uri]=a}this.keyId=a}return this}}let aV=/\{\$([a-zA-Z0-9-_]+)\}/g;function aW(a,b,c){if(null!==a.variableList||a.hasVariableRefs)for(let d=c.length;d--;){let e=c[d],f=b[e];f&&(b[e]=aX(a,f))}}function aX(a,b){if(null!==a.variableList||a.hasVariableRefs){let c=a.variableList;return b.replace(aV,b=>{let d=b.substring(2,b.length-1),e=null==c?void 0:c[d];return void 0===e?(a.playlistParsingError||(a.playlistParsingError=Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${d}"`)),b):e})}return b}function aY(a,b,c){let d,e,f=a.variableList;if(f||(a.variableList=f={}),"QUERYPARAM"in b){d=b.QUERYPARAM;try{let a=new self.URL(c).searchParams;if(a.has(d))e=a.get(d);else throw Error(`"${d}" does not match any query parameter in URI: "${c}"`)}catch(b){a.playlistParsingError||(a.playlistParsingError=Error(`EXT-X-DEFINE QUERYPARAM: ${b.message}`))}}else d=b.NAME,e=b.VALUE;d in f?a.playlistParsingError||(a.playlistParsingError=Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${d}"`)):f[d]=e||""}function aZ(a=!0){if(!("u"<typeof self))return(a||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}let a$={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function a_(a,b,c=!0){return!a.split(",").some(a=>!a0(a,b,c))}function a0(a,b,c=!0){var d;let e=aZ(c);return null!=(d=null==e?void 0:e.isTypeSupported(a1(a,b)))&&d}function a1(a,b){return`${b}/mp4;codecs="${a}"`}function a2(a){if(a){let b=a.substring(0,4);return a$.video[b]}return 2}function a3(a){return a.split(",").reduce((a,b)=>{let c=a$.video[b];return c?(2*c+a)/(a?3:2):(a$.audio[b]+a)/(a?2:1)},0)}let a4={},a5=/flac|opus/i;function a6(a,b=!0){return a.replace(a5,a=>(function(a,b=!0){if(a4[a])return a4[a];let c={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[a];for(let d=0;d<c.length;d++)if(a0(c[d],"audio",b))return a4[a]=c[d],c[d];return a})(a.toLowerCase(),b))}function a7(a,b){return a&&"mp4a"!==a?a:b?b.split(",")[0]:b}let a8=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,a9=/#EXT-X-MEDIA:(.*)/g,ba=/^#EXT(?:INF|-X-TARGETDURATION):/m,bb=RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),bc=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class bd{static findGroup(a,b){for(let c=0;c<a.length;c++){let d=a[c];if(d.id===b)return d}}static resolve(a,b){return v.buildAbsoluteURL(b,a,{alwaysNormalize:!0})}static isMediaPlaylist(a){return ba.test(a)}static parseMasterPlaylist(a,b){var c;let d,e={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:aV.test(a)},f=[];for(a8.lastIndex=0;null!=(d=a8.exec(a));)if(d[1]){let a=new L(d[1]);aW(e,a,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);let g=aX(e,d[2]),h={attrs:a,bitrate:a.decimalInteger("BANDWIDTH")||a.decimalInteger("AVERAGE-BANDWIDTH"),name:a.NAME,url:bd.resolve(g,b)},i=a.decimalResolution("RESOLUTION");i&&(h.width=i.width,h.height=i.height),function(a,b){let c=(a||"").split(/[ ,]+/).filter(a=>a);["video","audio","text"].forEach(a=>{let d=c.filter(b=>{let c;return!!(c=a$[a])&&!!c[b.slice(0,4)]});d.length&&(b[`${a}Codec`]=d.join(","),c=c.filter(a=>-1===d.indexOf(a)))}),b.unknownCodecs=c}(a.CODECS,h),null!=(c=h.unknownCodecs)&&c.length||f.push(h),e.levels.push(h)}else if(d[3]){let a=d[3],c=d[4];switch(a){case"SESSION-DATA":{let a=new L(c);aW(e,a,["DATA-ID","LANGUAGE","VALUE","URI"]);let b=a["DATA-ID"];b&&(null===e.sessionData&&(e.sessionData={}),e.sessionData[b]=a);break}case"SESSION-KEY":{let a=be(c,b,e);a.encrypted&&a.isSupported()?(null===e.sessionKeys&&(e.sessionKeys=[]),e.sessionKeys.push(a)):I.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${c}"`);break}case"DEFINE":{let a=new L(c);aW(e,a,["NAME","VALUE","QUERYPARAM"]),aY(e,a,b)}break;case"CONTENT-STEERING":{let a=new L(c);aW(e,a,["SERVER-URI","PATHWAY-ID"]),e.contentSteering={uri:bd.resolve(a["SERVER-URI"],b),pathwayId:a["PATHWAY-ID"]||"."};break}case"START":e.startTimeOffset=bf(c)}}let g=f.length>0&&f.length<e.levels.length;return e.levels=g?f:e.levels,0===e.levels.length&&(e.playlistParsingError=Error("no levels found in manifest")),e}static parseMasterPlaylistMedia(a,b,c){let d,e={},f=c.levels,g={AUDIO:f.map(a=>({id:a.attrs.AUDIO,audioCodec:a.audioCodec})),SUBTITLES:f.map(a=>({id:a.attrs.SUBTITLES,textCodec:a.textCodec})),"CLOSED-CAPTIONS":[]},h=0;for(a9.lastIndex=0;null!==(d=a9.exec(a));){let a=new L(d[1]),f=a.TYPE;if(f){let d=g[f],i=e[f]||[];e[f]=i,aW(c,a,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);let j=a.LANGUAGE,k=a["ASSOC-LANGUAGE"],l=a.CHANNELS,m=a.CHARACTERISTICS,n=a["INSTREAM-ID"],o={attrs:a,bitrate:0,id:h++,groupId:a["GROUP-ID"]||"",name:a.NAME||j||"",type:f,default:a.bool("DEFAULT"),autoselect:a.bool("AUTOSELECT"),forced:a.bool("FORCED"),lang:j,url:a.URI?bd.resolve(a.URI,b):""};if(k&&(o.assocLang=k),l&&(o.channels=l),m&&(o.characteristics=m),n&&(o.instreamId=n),null!=d&&d.length){let a=bd.findGroup(d,o.groupId)||d[0];bg(o,a,"audioCodec"),bg(o,a,"textCodec")}i.push(o)}}return e}static parseLevelPlaylist(a,b,c,d,e,f){let g,h,i,j=new U(b),k=j.fragments,l=null,m=0,n=0,o=0,p=0,q=null,r=new S(d,b),s=-1,t=!1,u=null;for(bb.lastIndex=0,j.m3u8=a,j.hasVariableRefs=aV.test(a);null!==(g=bb.exec(a));){t&&(t=!1,(r=new S(d,b)).start=o,r.sn=m,r.cc=p,r.level=c,l&&(r.initSegment=l,r.rawProgramDateTime=l.rawProgramDateTime,l.rawProgramDateTime=null,u&&(r.setByteRange(u),u=null)));let a=g[1];if(a){r.duration=parseFloat(a);let b=(" "+g[2]).slice(1);r.title=b||null,r.tagList.push(b?["INF",a,b]:["INF",a])}else if(g[3]){if(z(r.duration)){r.start=o,i&&bj(r,i,j),r.sn=m,r.level=c,r.cc=p,k.push(r);let a=(" "+g[3]).slice(1);r.relurl=aX(j,a),bh(r,q),q=r,o+=r.duration,m++,n=0,t=!0}}else if(g[4]){let a=(" "+g[4]).slice(1);q?r.setByteRange(a,q):r.setByteRange(a)}else if(g[5])r.rawProgramDateTime=(" "+g[5]).slice(1),r.tagList.push(["PROGRAM-DATE-TIME",r.rawProgramDateTime]),-1===s&&(s=k.length);else{if(!(g=g[0].match(bc))){I.warn("No matches on slow regex match for level playlist!");continue}for(h=1;h<g.length&&void 0===g[h];h++);let a=(" "+g[h]).slice(1),e=(" "+g[h+1]).slice(1),o=g[h+2]?(" "+g[h+2]).slice(1):"";switch(a){case"PLAYLIST-TYPE":j.type=e.toUpperCase();break;case"MEDIA-SEQUENCE":m=j.startSN=parseInt(e);break;case"SKIP":{let a=new L(e);aW(j,a,["RECENTLY-REMOVED-DATERANGES"]);let b=a.decimalInteger("SKIPPED-SEGMENTS");if(z(b)){j.skippedSegments=b;for(let a=b;a--;)k.unshift(null);m+=b}let c=a.enumeratedString("RECENTLY-REMOVED-DATERANGES");c&&(j.recentlyRemovedDateranges=c.split("	"));break}case"TARGETDURATION":j.targetduration=Math.max(parseInt(e),1);break;case"VERSION":j.version=parseInt(e);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":j.live=!1;break;case"#":(e||o)&&r.tagList.push(o?[e,o]:[e]);break;case"DISCONTINUITY":p++,r.tagList.push(["DIS"]);break;case"GAP":r.gap=!0,r.tagList.push([a]);break;case"BITRATE":r.tagList.push([a,e]);break;case"DATERANGE":{let a=new L(e);aW(j,a,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),aW(j,a,a.clientAttrs);let b=new M(a,j.dateRanges[a.ID]);b.isValid||j.skippedSegments?j.dateRanges[b.id]=b:I.warn(`Ignoring invalid DATERANGE tag: "${e}"`),r.tagList.push(["EXT-X-DATERANGE",e]);break}case"DEFINE":{let a=new L(e);aW(j,a,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in a?function(a,b,c){let d=b.IMPORT;if(c&&d in c){let b=a.variableList;b||(a.variableList=b={}),b[d]=c[d]}else a.playlistParsingError||(a.playlistParsingError=Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${d}"`))}(j,a,f):aY(j,a,b)}break;case"DISCONTINUITY-SEQUENCE":p=parseInt(e);break;case"KEY":{let a=be(e,b,j);if(a.isSupported()){if("NONE"===a.method){i=void 0;break}i||(i={}),i[a.keyFormat]&&(i=y({},i)),i[a.keyFormat]=a}else I.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${e}"`);break}case"START":j.startTimeOffset=bf(e);break;case"MAP":{let a=new L(e);if(aW(j,a,["BYTERANGE","URI"]),r.duration){let e=new S(d,b);bi(e,a,c,i),l=e,r.initSegment=l,l.rawProgramDateTime&&!r.rawProgramDateTime&&(r.rawProgramDateTime=l.rawProgramDateTime)}else{let b=r.byteRangeEndOffset;if(b){let a=r.byteRangeStartOffset;u=`${b-a}@${a}`}else u=null;bi(r,a,c,i),l=r,t=!0}break}case"SERVER-CONTROL":{let a=new L(e);j.canBlockReload=a.bool("CAN-BLOCK-RELOAD"),j.canSkipUntil=a.optionalFloat("CAN-SKIP-UNTIL",0),j.canSkipDateRanges=j.canSkipUntil>0&&a.bool("CAN-SKIP-DATERANGES"),j.partHoldBack=a.optionalFloat("PART-HOLD-BACK",0),j.holdBack=a.optionalFloat("HOLD-BACK",0);break}case"PART-INF":j.partTarget=new L(e).decimalFloatingPoint("PART-TARGET");break;case"PART":{let a=j.partList;a||(a=j.partList=[]);let c=n>0?a[a.length-1]:void 0,d=n++,f=new L(e);aW(j,f,["BYTERANGE","URI"]);let g=new T(f,r,b,d,c);a.push(g),r.duration+=g.duration;break}case"PRELOAD-HINT":{let a=new L(e);aW(j,a,["URI"]),j.preloadHint=a;break}case"RENDITION-REPORT":{let a=new L(e);aW(j,a,["URI"]),j.renditionReports=j.renditionReports||[],j.renditionReports.push(a);break}default:I.warn(`line parsed but not handled: ${g}`)}}}q&&!q.relurl?(k.pop(),o-=q.duration,j.partList&&(j.fragmentHint=q)):j.partList&&(bh(r,q),r.cc=p,j.fragmentHint=r,i&&bj(r,i,j));let v=k.length,w=k[0],x=k[v-1];if((o+=j.skippedSegments*j.targetduration)>0&&v&&x){j.averagetargetduration=o/v;let a=x.sn;j.endSN="initSegment"!==a?a:0,j.live||(x.endList=!0),w&&(j.startCC=w.cc)}else j.endSN=0,j.startCC=0;return j.fragmentHint&&(o+=j.fragmentHint.duration),j.totalduration=o,j.endCC=p,s>0&&function(a,b){let c=a[b];for(let d=b;d--;){let b=a[d];if(!b)return;b.programDateTime=c.programDateTime-1e3*b.duration,c=b}}(k,s),j}}function be(a,b,c){var d,e;let f=new L(a);aW(c,f,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);let g=null!=(d=f.METHOD)?d:"",h=f.URI,i=f.hexadecimalInteger("IV"),j=f.KEYFORMATVERSIONS,k=null!=(e=f.KEYFORMAT)?e:"identity";return h&&f.IV&&!i&&I.error(`Invalid IV: ${f.IV}`),new aU(g,h?bd.resolve(h,b):"",k,(j||"1").split("/").map(Number).filter(Number.isFinite),i)}function bf(a){let b=new L(a).decimalFloatingPoint("TIME-OFFSET");return z(b)?b:null}function bg(a,b,c){let d=b[c];d&&(a[c]=d)}function bh(a,b){a.rawProgramDateTime?a.programDateTime=Date.parse(a.rawProgramDateTime):null!=b&&b.programDateTime&&(a.programDateTime=b.endProgramDateTime),z(a.programDateTime)||(a.programDateTime=null,a.rawProgramDateTime=null)}function bi(a,b,c,d){a.relurl=b.URI,b.BYTERANGE&&a.setByteRange(b.BYTERANGE),a.level=c,a.sn="initSegment",d&&(a.levelkeys=d),a.initSegment=null}function bj(a,b,c){a.levelkeys=b;let{encryptedFragments:d}=c;(!d.length||d[d.length-1].levelkeys!==b)&&Object.keys(b).some(a=>b[a].isCommonEncryption)&&d.push(a)}var bk="manifest",bl="level",bm="audioTrack",bn="subtitleTrack",bo="main",bp="audio",bq="subtitle";function br(a){let{type:b}=a;switch(b){case bm:return bp;case bn:return bq;default:return bo}}function bs(a,b){let c=a.url;return(void 0===c||0===c.indexOf("data:"))&&(c=b.url),c}class bt{constructor(a){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=a,this.registerListeners()}startLoad(a){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){let{hls:a}=this;a.on(C.MANIFEST_LOADING,this.onManifestLoading,this),a.on(C.LEVEL_LOADING,this.onLevelLoading,this),a.on(C.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),a.on(C.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){let{hls:a}=this;a.off(C.MANIFEST_LOADING,this.onManifestLoading,this),a.off(C.LEVEL_LOADING,this.onLevelLoading,this),a.off(C.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),a.off(C.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(a){let b=this.hls.config,c=b.pLoader,d=b.loader,e=new(c||d)(b);return this.loaders[a.type]=e,e}getInternalLoader(a){return this.loaders[a.type]}resetInternalLoader(a){this.loaders[a]&&delete this.loaders[a]}destroyInternalLoaders(){for(let a in this.loaders){let b=this.loaders[a];b&&b.destroy(),this.resetInternalLoader(a)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(a,b){let{url:c}=b;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:bk,url:c,deliveryDirectives:null})}onLevelLoading(a,b){let{id:c,level:d,pathwayId:e,url:f,deliveryDirectives:g}=b;this.load({id:c,level:d,pathwayId:e,responseType:"text",type:bl,url:f,deliveryDirectives:g})}onAudioTrackLoading(a,b){let{id:c,groupId:d,url:e,deliveryDirectives:f}=b;this.load({id:c,groupId:d,level:null,responseType:"text",type:bm,url:e,deliveryDirectives:f})}onSubtitleTrackLoading(a,b){let{id:c,groupId:d,url:e,deliveryDirectives:f}=b;this.load({id:c,groupId:d,level:null,responseType:"text",type:bn,url:e,deliveryDirectives:f})}load(a){var b;let c,d=this.hls.config,e=this.getInternalLoader(a);if(e){let b=e.context;if(b&&b.url===a.url&&b.level===a.level)return void I.trace("[playlist-loader]: playlist request ongoing");I.log(`[playlist-loader]: aborting previous loader for type: ${a.type}`),e.abort()}if(c=a.type===bk?d.manifestLoadPolicy.default:y({},d.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),e=this.createInternalLoader(a),z(null==(b=a.deliveryDirectives)?void 0:b.part)){let b;if(a.type===bl&&null!==a.level?b=this.hls.levels[a.level].details:a.type===bm&&null!==a.id?b=this.hls.audioTracks[a.id].details:a.type===bn&&null!==a.id&&(b=this.hls.subtitleTracks[a.id].details),b){let a=b.partTarget,d=b.targetduration;if(a&&d){let b=1e3*Math.max(3*a,.8*d);c=y({},c,{maxTimeToFirstByteMs:Math.min(b,c.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(b,c.maxTimeToFirstByteMs)})}}}let f=c.errorRetry||c.timeoutRetry||{},g={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:f.maxNumRetry||0,retryDelay:f.retryDelayMs||0,maxRetryDelay:f.maxRetryDelayMs||0};e.load(a,g,{onSuccess:(a,b,c,d)=>{let e=this.getInternalLoader(c);this.resetInternalLoader(c.type);let f=a.data;0!==f.indexOf("#EXTM3U")?this.handleManifestParsingError(a,c,Error("no EXTM3U delimiter"),d||null,b):(b.parsing.start=performance.now(),bd.isMediaPlaylist(f)?this.handleTrackOrLevelPlaylist(a,b,c,d||null,e):this.handleMasterPlaylist(a,b,c,d))},onError:(a,b,c,d)=>{this.handleNetworkError(b,c,!1,a,d)},onTimeout:(a,b,c)=>{this.handleNetworkError(b,c,!0,void 0,a)}})}handleMasterPlaylist(a,b,c,d){let e=this.hls,f=a.data,g=bs(a,c),h=bd.parseMasterPlaylist(f,g);if(h.playlistParsingError)return void this.handleManifestParsingError(a,c,h.playlistParsingError,d,b);let{contentSteering:i,levels:j,sessionData:k,sessionKeys:l,startTimeOffset:m,variableList:n}=h;this.variableList=n;let{AUDIO:o=[],SUBTITLES:p,"CLOSED-CAPTIONS":q}=bd.parseMasterPlaylistMedia(f,g,h);o.length&&(o.some(a=>!a.url)||!j[0].audioCodec||j[0].attrs.AUDIO||(I.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),o.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new L({}),bitrate:0,url:""}))),e.trigger(C.MANIFEST_LOADED,{levels:j,audioTracks:o,subtitles:p,captions:q,contentSteering:i,url:g,stats:b,networkDetails:d,sessionData:k,sessionKeys:l,startTimeOffset:m,variableList:n})}handleTrackOrLevelPlaylist(a,b,c,d,e){let f=this.hls,{id:g,level:h,type:i}=c,j=bs(a,c),k=z(h)?h:z(g)?g:0,l=br(c),m=bd.parseLevelPlaylist(a.data,j,k,l,0,this.variableList);if(i===bk){let a={attrs:new L({}),bitrate:0,details:m,name:"",url:j};f.trigger(C.MANIFEST_LOADED,{levels:[a],audioTracks:[],url:j,stats:b,networkDetails:d,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}b.parsing.end=performance.now(),c.levelDetails=m,this.handlePlaylistLoaded(m,a,b,c,d,e)}handleManifestParsingError(a,b,c,d,e){this.hls.trigger(C.ERROR,{type:D.NETWORK_ERROR,details:E.MANIFEST_PARSING_ERROR,fatal:b.type===bk,url:a.url,err:c,error:c,reason:c.message,response:a,context:b,networkDetails:d,stats:e})}handleNetworkError(a,b,c=!1,d,e){let f=`A network ${c?"timeout":"error"+(d?" (status "+d.code+")":"")} occurred while loading ${a.type}`;a.type===bl?f+=`: ${a.level} id: ${a.id}`:(a.type===bm||a.type===bn)&&(f+=` id: ${a.id} group-id: "${a.groupId}"`);let g=Error(f);I.warn(`[playlist-loader]: ${f}`);let h=E.UNKNOWN,i=!1,j=this.getInternalLoader(a);switch(a.type){case bk:h=c?E.MANIFEST_LOAD_TIMEOUT:E.MANIFEST_LOAD_ERROR,i=!0;break;case bl:h=c?E.LEVEL_LOAD_TIMEOUT:E.LEVEL_LOAD_ERROR,i=!1;break;case bm:h=c?E.AUDIO_TRACK_LOAD_TIMEOUT:E.AUDIO_TRACK_LOAD_ERROR,i=!1;break;case bn:h=c?E.SUBTITLE_TRACK_LOAD_TIMEOUT:E.SUBTITLE_LOAD_ERROR,i=!1}j&&this.resetInternalLoader(a.type);let k={type:D.NETWORK_ERROR,details:h,fatal:i,url:a.url,loader:j,context:a,error:g,networkDetails:b,stats:e};d&&(k.response=x({url:(null==b?void 0:b.url)||a.url,data:void 0},d)),this.hls.trigger(C.ERROR,k)}handlePlaylistLoaded(a,b,c,d,e,f){let g=this.hls,{type:h,level:i,id:j,groupId:k,deliveryDirectives:l}=d,m=bs(b,d),n=br(d),o="number"==typeof d.level&&n===bo?i:void 0;if(!a.fragments.length){let a=Error("No Segments found in Playlist");g.trigger(C.ERROR,{type:D.NETWORK_ERROR,details:E.LEVEL_EMPTY_ERROR,fatal:!1,url:m,error:a,reason:a.message,response:b,context:d,level:o,parent:n,networkDetails:e,stats:c});return}a.targetduration||(a.playlistParsingError=Error("Missing Target Duration"));let p=a.playlistParsingError;if(p)return void g.trigger(C.ERROR,{type:D.NETWORK_ERROR,details:E.LEVEL_PARSING_ERROR,fatal:!1,url:m,error:p,reason:p.message,response:b,context:d,level:o,parent:n,networkDetails:e,stats:c});switch(a.live&&f&&(f.getCacheAge&&(a.ageHeader=f.getCacheAge()||0),(!f.getCacheAge||isNaN(a.ageHeader))&&(a.ageHeader=0)),h){case bk:case bl:g.trigger(C.LEVEL_LOADED,{details:a,level:o||0,id:j||0,stats:c,networkDetails:e,deliveryDirectives:l});break;case bm:g.trigger(C.AUDIO_TRACK_LOADED,{details:a,id:j||0,groupId:k||"",stats:c,networkDetails:e,deliveryDirectives:l});break;case bn:g.trigger(C.SUBTITLE_TRACK_LOADED,{details:a,id:j||0,groupId:k||"",stats:c,networkDetails:e,deliveryDirectives:l})}}}function bu(a,b){let c;try{c=new Event("addtrack")}catch(a){(c=document.createEvent("Event")).initEvent("addtrack",!1,!1)}c.track=a,b.dispatchEvent(c)}function bv(a,b){let c=a.mode;if("disabled"===c&&(a.mode="hidden"),a.cues&&!a.cues.getCueById(b.id))try{if(a.addCue(b),!a.cues.getCueById(b.id))throw Error(`addCue is failed for: ${b}`)}catch(c){I.debug(`[texttrack-utils]: ${c}`);try{let c=new self.TextTrackCue(b.startTime,b.endTime,b.text);c.id=b.id,a.addCue(c)}catch(a){I.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${a}`)}}"disabled"===c&&(a.mode=c)}function bw(a){let b=a.mode;if("disabled"===b&&(a.mode="hidden"),a.cues)for(let b=a.cues.length;b--;)a.removeCue(a.cues[b]);"disabled"===b&&(a.mode=b)}function bx(a,b,c,d){let e=a.mode;if("disabled"===e&&(a.mode="hidden"),a.cues&&a.cues.length>0){let e=function(a,b,c){let d=[],e=function(a,b){if(b<a[0].startTime)return 0;let c=a.length-1;if(b>a[c].endTime)return -1;let d=0,e=c;for(;d<=e;){let f=Math.floor((e+d)/2);if(b<a[f].startTime)e=f-1;else{if(!(b>a[f].startTime)||!(d<c))return f;d=f+1}}return a[d].startTime-b<b-a[e].startTime?d:e}(a,b);if(e>-1)for(let f=e,g=a.length;f<g;f++){let e=a[f];if(e.startTime>=b&&e.endTime<=c)d.push(e);else if(e.startTime>c)break}return d}(a.cues,b,c);for(let b=0;b<e.length;b++)(!d||d(e[b]))&&a.removeCue(e[b])}"disabled"===e&&(a.mode=e)}function by(a){let b=[];for(let c=0;c<a.length;c++){let d=a[c];("subtitles"===d.kind||"captions"===d.kind)&&d.label&&b.push(a[c])}return b}var bz="org.id3",bA="https://aomedia.org/emsg/ID3";function bB(){if("u">typeof self)return self.VTTCue||self.TextTrackCue}function bC(a,b,c,d,e){let f=new a(b,c,"");try{f.value=d,e&&(f.type=e)}catch(g){f=new a(b,c,JSON.stringify(e?x({type:e},d):d))}return f}let bD=(()=>{let a=bB();try{a&&new a(0,1/0,"")}catch(a){return Number.MAX_VALUE}return 1/0})();function bE(a,b){return a.getTime()/1e3-b}class bF{constructor(a){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=a,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){let{hls:a}=this;a.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),a.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),a.on(C.MANIFEST_LOADING,this.onManifestLoading,this),a.on(C.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),a.on(C.BUFFER_FLUSHING,this.onBufferFlushing,this),a.on(C.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){let{hls:a}=this;a.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),a.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),a.off(C.MANIFEST_LOADING,this.onManifestLoading,this),a.off(C.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),a.off(C.BUFFER_FLUSHING,this.onBufferFlushing,this),a.off(C.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(a,b){this.media=b.media}onMediaDetaching(){this.id3Track&&(bw(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(a){let b=this.getID3Track(a.textTracks);return b.mode="hidden",b}getID3Track(a){if(this.media){for(let b=0;b<a.length;b++){let c=a[b];if("metadata"===c.kind&&"id3"===c.label)return bu(c,this.media),c}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(a,b){if(!this.media)return;let{hls:{config:{enableEmsgMetadataCues:c,enableID3MetadataCues:d}}}=this;if(!c&&!d)return;let{samples:e}=b;this.id3Track||(this.id3Track=this.createTrack(this.media));let f=bB();if(f)for(let a=0;a<e.length;a++){let b=e[a].type;if(b===bA&&!c||!d)continue;let g=at(e[a].data);{let c=e[a].pts,d=c+e[a].duration;d>bD&&(d=bD),d-c<=0&&(d=c+.25);for(let a=0;a<g.length;a++){let e=g[a];if(!ar(e)){this.updateId3CueEnds(c,b);let a=bC(f,c,d,e,b);a&&this.id3Track.addCue(a)}}}}}updateId3CueEnds(a,b){var c;let d=null==(c=this.id3Track)?void 0:c.cues;if(d)for(let c=d.length;c--;){let e=d[c];e.type===b&&e.startTime<a&&e.endTime===bD&&(e.endTime=a)}}onBufferFlushing(a,{startOffset:b,endOffset:c,type:d}){let{id3Track:e,hls:f}=this;if(!f)return;let{config:{enableEmsgMetadataCues:g,enableID3MetadataCues:h}}=f;e&&(g||h)&&bx(e,b,c,"audio"===d?a=>a.type===bz&&h:"video"===d?a=>a.type===bA&&g:a=>a.type===bz&&h||a.type===bA&&g)}onLevelUpdated(a,{details:b}){if(!this.media||!b.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;let{dateRangeCuesAppended:c,id3Track:d}=this,{dateRanges:e}=b,f=Object.keys(e);if(d){let a=Object.keys(c).filter(a=>!f.includes(a));for(let b=a.length;b--;){let e=a[b];Object.keys(c[e].cues).forEach(a=>{d.removeCue(c[e].cues[a])}),delete c[e]}}let g=b.fragments[b.fragments.length-1];if(0===f.length||!z(null==g?void 0:g.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));let h=g.programDateTime/1e3-g.start,i=bB();for(let a=0;a<f.length;a++){let b=f[a],d=e[b],g=bE(d.startDate,h),k=c[b],l=(null==k?void 0:k.cues)||{},m=(null==k?void 0:k.durationKnown)||!1,n=bD,o=d.endDate;if(o)n=bE(o,h),m=!0;else if(d.endOnNext&&!m){let a=f.reduce((a,b)=>{if(b!==d.id){let c=e[b];if(c.class===d.class&&c.startDate>d.startDate&&(!a||d.startDate<a.startDate))return c}return a},null);a&&(n=bE(a.startDate,h),m=!0)}let p=Object.keys(d.attr);for(let a=0;a<p.length;a++){var j;let c=p[a];if("ID"===c||"CLASS"===c||"START-DATE"===c||"DURATION"===c||"END-DATE"===c||"END-ON-NEXT"===c)continue;let e=l[c];if(e)m&&!k.durationKnown&&(e.endTime=n);else if(i){let a=d.attr[c];("SCTE35-OUT"===c||"SCTE35-IN"===c)&&(j=a,a=Uint8Array.from(j.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer);let e=bC(i,g,n,{key:c,data:a},"com.apple.quicktime.HLS");e&&(e.id=b,this.id3Track.addCue(e),l[c]=e)}}c[b]={cues:l,dateRange:d,durationKnown:m}}}}class bG{constructor(a){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=a,this.config=a.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){let{config:a,levelDetails:b}=this;return void 0!==a.liveMaxLatencyDuration?a.liveMaxLatencyDuration:b?a.liveMaxLatencyDurationCount*b.targetduration:0}get targetLatency(){let{levelDetails:a}=this;if(null===a)return null;let{holdBack:b,partHoldBack:c,targetduration:d}=a,{liveSyncDuration:e,liveSyncDurationCount:f,lowLatencyMode:g}=this.config,h=this.hls.userConfig,i=g&&c||b;return(h.liveSyncDuration||h.liveSyncDurationCount||0===i)&&(i=void 0!==e?e:f*d),i+Math.min(+this.stallCount,d)}get liveSyncPosition(){let a=this.estimateLiveEdge(),b=this.targetLatency,c=this.levelDetails;if(null===a||null===b||null===c)return null;let d=c.edge,e=a-b-this.edgeStalled;return Math.min(Math.max(d-c.totalduration,e),d-(this.config.lowLatencyMode&&c.partTarget||c.targetduration))}get drift(){let{levelDetails:a}=this;return null===a?1:a.drift}get edgeStalled(){let{levelDetails:a}=this;if(null===a)return 0;let b=3*(this.config.lowLatencyMode&&a.partTarget||a.targetduration);return Math.max(a.age-b,0)}get forwardBufferLength(){let{media:a,levelDetails:b}=this;if(!a||!b)return 0;let c=a.buffered.length;return(c?a.buffered.end(c-1):b.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(C.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(C.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(C.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(C.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(C.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(C.ERROR,this.onError,this)}onMediaAttached(a,b){this.media=b.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(a,{details:b}){this.levelDetails=b,b.advanced&&this.timeupdate(),!b.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(a,b){var c;b.details===E.BUFFER_STALLED_ERROR&&(this.stallCount++,null!=(c=this.levelDetails)&&c.live&&I.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){let{media:a,levelDetails:b}=this;if(!a||!b)return;this.currentTime=a.currentTime;let c=this.computeLatency();if(null===c)return;this._latency=c;let{lowLatencyMode:d,maxLiveSyncPlaybackRate:e}=this.config;if(!d||1===e||!b.live)return;let f=this.targetLatency;if(null===f)return;let g=c-f;g<Math.min(this.maxLatency,f+b.targetduration)&&g>.05&&this.forwardBufferLength>1?a.playbackRate=Math.min(Math.min(2,Math.max(1,e)),Math.max(1,Math.round(2/(1+Math.exp(-.75*g-this.edgeStalled))*20)/20)):1!==a.playbackRate&&0!==a.playbackRate&&(a.playbackRate=1)}estimateLiveEdge(){let{levelDetails:a}=this;return null===a?null:a.edge+a.age}computeLatency(){let a=this.estimateLiveEdge();return null===a?null:a-this.currentTime}}let bH=["NONE","TYPE-0","TYPE-1",null],bI=["SDR","PQ","HLG"];function bJ(a){let{canSkipUntil:b,canSkipDateRanges:c,age:d}=a;return b&&d<b/2?c?"v2":"YES":""}class bK{constructor(a,b,c){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=a,this.part=b,this.skip=c}addDirectives(a){let b=new self.URL(a);return void 0!==this.msn&&b.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&b.searchParams.set("_HLS_part",this.part.toString()),this.skip&&b.searchParams.set("_HLS_skip",this.skip),b.href}}class bL{constructor(a){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[a.url],this._attrs=[a.attrs],this.bitrate=a.bitrate,a.details&&(this.details=a.details),this.id=a.id||0,this.name=a.name,this.width=a.width||0,this.height=a.height||0,this.frameRate=a.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=a.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=a.audioCodec,this.videoCodec=a.videoCodec,this.codecSet=[a.videoCodec,a.audioCodec].filter(a=>!!a).map(a=>a.substring(0,4)).join(","),this.addGroupId("audio",a.attrs.AUDIO),this.addGroupId("text",a.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(a){return bM(this._audioGroups,a)}hasSubtitleGroup(a){return bM(this._subtitleGroups,a)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(a,b){if(b){if("audio"===a){let a=this._audioGroups;a||(a=this._audioGroups=[]),-1===a.indexOf(b)&&a.push(b)}else if("text"===a){let a=this._subtitleGroups;a||(a=this._subtitleGroups=[]),-1===a.indexOf(b)&&a.push(b)}}}get urlId(){return 0}set urlId(a){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var a;return null==(a=this.audioGroups)?void 0:a[0]}get textGroupId(){var a;return null==(a=this.subtitleGroups)?void 0:a[0]}addFallback(){}}function bM(a,b){return!!b&&!!a&&-1!==a.indexOf(b)}function bN(a,b){let c=b.startPTS;if(z(c)){let d,e=0;b.sn>a.sn?(e=c-a.start,d=a):(e=a.start-c,d=b),d.duration!==e&&(d.duration=e)}else b.sn>a.sn?a.cc===b.cc&&a.minEndPTS?b.start=a.start+(a.minEndPTS-a.start):b.start=a.start+a.duration:b.start=Math.max(a.start-b.duration,0)}function bO(a,b,c,d,e,f){let g;d-c<=0&&(I.warn("Fragment should have a positive duration",b),d=c+b.duration,f=e+b.duration);let h=c,i=d,j=b.startPTS,k=b.endPTS;if(z(j)){let a=Math.abs(j-c);z(b.deltaPTS)?b.deltaPTS=Math.max(a,b.deltaPTS):b.deltaPTS=a,h=Math.max(c,j),c=Math.min(c,j),e=Math.min(e,b.startDTS),i=Math.min(d,k),d=Math.max(d,k),f=Math.max(f,b.endDTS)}let l=c-b.start;0!==b.start&&(b.start=c),b.duration=d-b.start,b.startPTS=c,b.maxStartPTS=h,b.startDTS=e,b.endPTS=d,b.minEndPTS=i,b.endDTS=f;let m=b.sn;if(!a||m<a.startSN||m>a.endSN)return 0;let n=m-a.startSN,o=a.fragments;for(o[n]=b,g=n;g>0;g--)bN(o[g],o[g-1]);for(g=n;g<o.length-1;g++)bN(o[g],o[g+1]);return a.fragmentHint&&bN(o[o.length-1],a.fragmentHint),a.PTSKnown=a.alignedSliding=!0,l}function bP(a,b){let c=b.startSN+b.skippedSegments-a.startSN,d=a.fragments;c<0||c>=d.length||bQ(b,d[c].start)}function bQ(a,b){if(b){let c=a.fragments;for(let d=a.skippedSegments;d<c.length;d++)c[d].start+=b;a.fragmentHint&&(a.fragmentHint.start+=b)}}function bR(a,b,c){var d;return null!=a&&a.details?bS(null==(d=a.details)?void 0:d.partList,b,c):null}function bS(a,b,c){if(a)for(let d=a.length;d--;){let e=a[d];if(e.index===c&&e.fragment.sn===b)return e}return null}function bT(a){a.forEach((a,b)=>{let{details:c}=a;null!=c&&c.fragments&&c.fragments.forEach(a=>{a.level=b})})}function bU(a){switch(a.details){case E.FRAG_LOAD_TIMEOUT:case E.KEY_LOAD_TIMEOUT:case E.LEVEL_LOAD_TIMEOUT:case E.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function bV(a,b){let c=bU(b);return a.default[`${c?"timeout":"error"}Retry`]}function bW(a,b){return Math.min(("linear"===a.backoff?1:Math.pow(2,b))*a.retryDelayMs,a.maxRetryDelayMs)}function bX(a){return x(x({},a),{errorRetry:null,timeoutRetry:null})}function bY(a,b,c,d){var e;if(!a)return!1;let f=null==d?void 0:d.code,g=b<a.maxNumRetry&&(0===(e=f)&&!1===navigator.onLine||!!e&&(e<400||e>499)||!!c);return a.shouldRetry?a.shouldRetry(a,b,c,d,g):g}let bZ=function(a,b){let c=0,d=a.length-1,e=null,f=null;for(;c<=d;){let g=b(f=a[e=(c+d)/2|0]);if(g>0)c=e+1;else{if(!(g<0))return f;d=e-1}}return null};function b$(a,b,c=0,d=0,e=.005){let f=null;if(a){f=b[a.sn-b[0].sn+1]||null;let d=a.endDTS-c;d>0&&d<15e-7&&(c+=15e-7)}else 0===c&&0===b[0].start&&(f=b[0]);if(f&&((!a||a.level===f.level)&&0===b_(c,d,f)||function(a,b,c){if(b&&0===b.start&&b.level<a.level&&(b.endPTS||0)>0){let d=b.tagList.reduce((a,b)=>("INF"===b[0]&&(a+=parseFloat(b[1])),a),c);return a.start<=d}return!1}(f,a,Math.min(e,d))))return f;let g=bZ(b,b_.bind(null,c,d));return g&&(g!==a||!f)?g:f}function b_(a=0,b=0,c){if(c.start<=a&&c.start+c.duration>a)return 0;let d=Math.min(b,c.duration+(c.deltaPTS?c.deltaPTS:0));return c.start+c.duration-d<=a?1:c.start-d>a&&c.start?-1:0}class b0{constructor(a,b){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=I.log.bind(I,`${b}:`),this.warn=I.warn.bind(I,`${b}:`),this.hls=a}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){-1!==this.timer&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(a,b,c){let d=null==b?void 0:b.renditionReports;if(d){let e=-1;for(let c=0;c<d.length;c++){let f,g=d[c];try{f=new self.URL(g.URI,b.url).href}catch(a){I.warn(`Could not construct new URL for Rendition Report: ${a}`),f=g.URI||""}if(f===a){e=c;break}f===a.substring(0,f.length)&&(e=c)}if(-1!==e){let a=d[e],f=parseInt(a["LAST-MSN"])||(null==b?void 0:b.lastPartSn),g=parseInt(a["LAST-PART"])||(null==b?void 0:b.lastPartIndex);if(this.hls.config.lowLatencyMode){let a=Math.min(b.age-b.partTarget,b.targetduration);g>=0&&a>b.partTarget&&(g+=1)}return new bK(f,g>=0?g:void 0,c&&bJ(c))}}}loadPlaylist(a){-1===this.requestScheduled&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(a){return this.canLoad&&!!a&&!!a.url&&(!a.details||a.details.live)}shouldReloadPlaylist(a){return -1===this.timer&&-1===this.requestScheduled&&this.shouldLoadPlaylist(a)}playlistLoaded(a,b,c){let{details:d,stats:e}=b,f=self.performance.now(),g=e.loading.first?Math.max(0,f-e.loading.first):0;if(d.advancedDateTime=Date.now()-g,d.live||null!=c&&c.live){let g,h,i;if(d.reloaded(c),c&&this.log(`live playlist ${a} ${d.advanced?"REFRESHED "+d.lastPartSn+"-"+d.lastPartIndex:d.updated?"UPDATED":"MISSED"}`),c&&d.fragments.length>0&&function(a,b){let c,d=null,e=a.fragments;for(let a=e.length-1;a>=0;a--){let b=e[a].initSegment;if(b){d=b;break}}a.fragmentHint&&delete a.fragmentHint.endPTS;let f=0;if(function(a,b,c){let d=b.skippedSegments,e=Math.max(a.startSN,b.startSN)-b.startSN,f=+!!a.fragmentHint+(d?b.endSN:Math.min(a.endSN,b.endSN))-b.startSN,g=b.startSN-a.startSN,h=b.fragmentHint?b.fragments.concat(b.fragmentHint):b.fragments,i=a.fragmentHint?a.fragments.concat(a.fragmentHint):a.fragments;for(let a=e;a<=f;a++){let e=i[g+a],f=h[a];d&&!f&&a<d&&(f=b.fragments[a]=e),e&&f&&c(e,f)}}(a,b,(a,e)=>{a.relurl&&(f=a.cc-e.cc),z(a.startPTS)&&z(a.endPTS)&&(e.start=e.startPTS=a.startPTS,e.startDTS=a.startDTS,e.maxStartPTS=a.maxStartPTS,e.endPTS=a.endPTS,e.endDTS=a.endDTS,e.minEndPTS=a.minEndPTS,e.duration=a.endPTS-a.startPTS,e.duration&&(c=e),b.PTSKnown=b.alignedSliding=!0),e.elementaryStreams=a.elementaryStreams,e.loader=a.loader,e.stats=a.stats,a.initSegment&&(e.initSegment=a.initSegment,d=a.initSegment)}),d&&(b.fragmentHint?b.fragments.concat(b.fragmentHint):b.fragments).forEach(a=>{var b;a&&(!a.initSegment||a.initSegment.relurl===(null==(b=d)?void 0:b.relurl))&&(a.initSegment=d)}),b.skippedSegments)if(b.deltaUpdateFailed=b.fragments.some(a=>!a),b.deltaUpdateFailed){I.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let a=b.skippedSegments;a--;)b.fragments.shift();b.startSN=b.fragments[0].sn,b.startCC=b.fragments[0].cc}else{var g,h,i;let c;b.canSkipDateRanges&&(g=a.dateRanges,h=b.dateRanges,i=b.recentlyRemovedDateranges,c=y({},g),i&&i.forEach(a=>{delete c[a]}),Object.keys(h).forEach(a=>{let b=new M(h[a].attr,c[a]);b.isValid?c[a]=b:I.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(h[a].attr)}"`)}),b.dateRanges=c)}let j=b.fragments;if(f){I.warn("discontinuity sliding from playlist, take drift into account");for(let a=0;a<j.length;a++)j[a].cc+=f}b.skippedSegments&&(b.startCC=b.fragments[0].cc),function(a,b,c){if(a&&b){let d=0;for(let e=0,f=a.length;e<=f;e++){let f=a[e],g=b[e+d];f&&g&&f.index===g.index&&f.fragment.sn===g.fragment.sn?c(f,g):d--}}}(a.partList,b.partList,(a,b)=>{b.elementaryStreams=a.elementaryStreams,b.stats=a.stats}),c?bO(b,c,c.startPTS,c.endPTS,c.startDTS,c.endDTS):bP(a,b),j.length&&(b.totalduration=b.edge-j[0].start),b.driftStartTime=a.driftStartTime,b.driftStart=a.driftStart;let k=b.advancedDateTime;if(b.advanced&&k){let a=b.edge;b.driftStart||(b.driftStartTime=k,b.driftStart=a),b.driftEndTime=k,b.driftEnd=a}else b.driftEndTime=a.driftEndTime,b.driftEnd=a.driftEnd,b.advancedDateTime=a.advancedDateTime}(c,d),!this.canLoad||!d.live)return;if(d.canBlockReload&&d.endSN&&d.advanced){let a=this.hls.config.lowLatencyMode,e=d.lastPartSn,f=d.endSN,j=d.lastPartIndex,k=e===f;-1!==j?(h=k?f+1:e,i=k?a?0:j:j+1):h=f+1;let l=d.age,m=Math.min(l+d.ageHeader-d.partTarget,1.5*d.targetduration);if(m>0){if(c&&m>c.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${c.tuneInGoal} to: ${m} with playlist age: ${d.age}`),m=0;else{let a=Math.floor(m/d.targetduration);h+=a,void 0!==i&&(i+=Math.round(m%d.targetduration/d.partTarget)),this.log(`CDN Tune-in age: ${d.ageHeader}s last advanced ${l.toFixed(2)}s goal: ${m} skip sn ${a} to part ${i}`)}d.tuneInGoal=m}if(g=this.getDeliveryDirectives(d,b.deliveryDirectives,h,i),a||!k)return void this.loadPlaylist(g)}else(d.canBlockReload||d.canSkipUntil)&&(g=this.getDeliveryDirectives(d,b.deliveryDirectives,h,i));let j=this.hls.mainForwardBufferInfo,k=j?j.end-j.len:0,l=(d.edge-k)*1e3,m=function(a,b=1/0){let c=1e3*a.targetduration;if(a.updated){let d=a.fragments;if(d.length&&4*c>b){let a=1e3*d[d.length-1].duration;a<c&&(c=a)}}else c/=2;return Math.round(c)}(d,l);d.updated&&f>this.requestScheduled+m&&(this.requestScheduled=e.loading.start),void 0!==h&&d.canBlockReload?this.requestScheduled=e.loading.first+m-(1e3*d.partTarget||1e3):-1===this.requestScheduled||this.requestScheduled+m<f?this.requestScheduled=f:this.requestScheduled-f<=0&&(this.requestScheduled+=m);let n=this.requestScheduled-f;n=Math.max(0,n),this.log(`reload live playlist ${a} in ${Math.round(n)} ms`),this.timer=self.setTimeout(()=>this.loadPlaylist(g),n)}else this.clearTimer()}getDeliveryDirectives(a,b,c,d){let e=bJ(a);return null!=b&&b.skip&&a.deltaUpdateFailed&&(c=b.msn,d=b.part,e=""),new bK(c,d,e)}checkRetry(a){let b=a.details,c=bU(a),d=a.errorAction,{action:e,retryCount:f=0,retryConfig:g}=d||{},h=!!d&&!!g&&(5===e||!d.resolved&&2===e);if(h){var i;if(this.requestScheduled=-1,f>=g.maxNumRetry)return!1;if(c&&null!=(i=a.context)&&i.deliveryDirectives)this.warn(`Retrying playlist loading ${f+1}/${g.maxNumRetry} after "${b}" without delivery-directives`),this.loadPlaylist();else{let a=bW(g,f);this.timer=self.setTimeout(()=>this.loadPlaylist(),a),this.warn(`Retrying playlist loading ${f+1}/${g.maxNumRetry} after "${b}" in ${a}ms`)}a.levelRetry=!0,d.resolved=!0}return h}}class b1{constructor(a,b=0,c=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=a,this.alpha_=a?Math.exp(Math.log(.5)/a):0,this.estimate_=b,this.totalWeight_=c}sample(a,b){let c=Math.pow(this.alpha_,a);this.estimate_=b*(1-c)+c*this.estimate_,this.totalWeight_+=a}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){let a=1-Math.pow(this.alpha_,this.totalWeight_);if(a)return this.estimate_/a}return this.estimate_}}class b2{constructor(a,b,c,d=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=c,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new b1(a),this.fast_=new b1(b),this.defaultTTFB_=d,this.ttfb_=new b1(a)}update(a,b){let{slow_:c,fast_:d,ttfb_:e}=this;c.halfLife!==a&&(this.slow_=new b1(a,c.getEstimate(),c.getTotalWeight())),d.halfLife!==b&&(this.fast_=new b1(b,d.getEstimate(),d.getTotalWeight())),e.halfLife!==a&&(this.ttfb_=new b1(a,e.getEstimate(),e.getTotalWeight()))}sample(a,b){let c=(a=Math.max(a,this.minDelayMs_))/1e3,d=8*b/c;this.fast_.sample(c,d),this.slow_.sample(c,d)}sampleTTFB(a){let b=Math.sqrt(2)*Math.exp(-Math.pow(a/1e3,2)/2);this.ttfb_.sample(b,Math.max(a,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}let b3={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},b4={};function b5(a,b){I.log(`[abr] start candidates with "${a}" ignored because ${b}`)}function b6(a,b,c){if("attrs"in a){let c=b.indexOf(a);if(-1!==c)return c}for(let d=0;d<b.length;d++)if(b7(a,b[d],c))return d;return -1}function b7(a,b,c){let{groupId:d,name:e,lang:f,assocLang:g,characteristics:h,default:i}=a,j=a.forced;return(void 0===d||b.groupId===d)&&(void 0===e||b.name===e)&&(void 0===f||b.lang===f)&&(void 0===f||b.assocLang===g)&&(void 0===i||b.default===i)&&(void 0===j||b.forced===j)&&(void 0===h||function(a,b=""){let c=a.split(","),d=b.split(",");return c.length===d.length&&!c.some(a=>-1===d.indexOf(a))}(h,b.characteristics))&&(void 0===c||c(a,b))}function b8(a,b){let{audioCodec:c,channels:d}=a;return(void 0===c||(b.audioCodec||"").substring(0,4)===c.substring(0,4))&&(void 0===d||d===(b.channels||"2"))}function b9(a,b,c){for(let d=b;d>-1;d--)if(c(a[d]))return d;for(let d=b+1;d<a.length;d++)if(c(a[d]))return d;return -1}class ca{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(a){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,a),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}var cb="NOT_LOADED",cc="APPENDING",cd="PARTIAL";class ce{constructor(a){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=a,this._registerListeners()}_registerListeners(){let{hls:a}=this;a.on(C.BUFFER_APPENDED,this.onBufferAppended,this),a.on(C.FRAG_BUFFERED,this.onFragBuffered,this),a.on(C.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){let{hls:a}=this;a.off(C.BUFFER_APPENDED,this.onBufferAppended,this),a.off(C.FRAG_BUFFERED,this.onFragBuffered,this),a.off(C.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(a,b){let c=this.activePartLists[b];if(c)for(let b=c.length;b--;){let d=c[b];if(!d)break;let e=d.end;if(d.start<=a&&null!==e&&a<=e)return d}return this.getBufferedFrag(a,b)}getBufferedFrag(a,b){let{fragments:c}=this,d=Object.keys(c);for(let e=d.length;e--;){let f=c[d[e]];if((null==f?void 0:f.body.type)===b&&f.buffered){let b=f.body;if(b.start<=a&&a<=b.end)return b}}return null}detectEvictedFragments(a,b,c,d){this.timeRanges&&(this.timeRanges[a]=b);let e=(null==d?void 0:d.fragment.sn)||-1;Object.keys(this.fragments).forEach(d=>{let f=this.fragments[d];if(!f||e>=f.body.sn)return;if(!f.buffered&&!f.loaded){f.body.type===c&&this.removeFragment(f.body);return}let g=f.range[a];g&&g.time.some(a=>{let c=!this.isTimeBuffered(a.startPTS,a.endPTS,b);return c&&this.removeFragment(f.body),c})})}detectPartialFragments(a){let b=this.timeRanges,{frag:c,part:d}=a;if(!b||"initSegment"===c.sn)return;let e=cg(c),f=this.fragments[e];if(!f||f.buffered&&c.gap)return;let g=!c.relurl;Object.keys(b).forEach(a=>{let e=c.elementaryStreams[a];if(!e)return;let h=b[a],i=g||!0===e.partial;f.range[a]=this.getBufferedTimes(c,d,i,h)}),f.loaded=null,Object.keys(f.range).length?(f.buffered=!0,(f.body.endList=c.endList||f.body.endList)&&(this.endListFragments[f.body.type]=f),cf(f)||this.removeParts(c.sn-1,c.type)):this.removeFragment(f.body)}removeParts(a,b){let c=this.activePartLists[b];c&&(this.activePartLists[b]=c.filter(b=>b.fragment.sn>=a))}fragBuffered(a,b){let c=cg(a),d=this.fragments[c];!d&&b&&(d=this.fragments[c]={body:a,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},a.gap&&(this.hasGaps=!0)),d&&(d.loaded=null,d.buffered=!0)}getBufferedTimes(a,b,c,d){let e={time:[],partial:c},f=a.start,g=a.end,h=a.minEndPTS||g,i=a.maxStartPTS||f;for(let a=0;a<d.length;a++){let b=d.start(a)-this.bufferPadding,c=d.end(a)+this.bufferPadding;if(i>=b&&h<=c){e.time.push({startPTS:Math.max(f,d.start(a)),endPTS:Math.min(g,d.end(a))});break}if(f<c&&g>b){let b=Math.max(f,d.start(a)),c=Math.min(g,d.end(a));c>b&&(e.partial=!0,e.time.push({startPTS:b,endPTS:c}))}else if(g<=b)break}return e}getPartialFragment(a){let b,c,d,e=null,f=0,{bufferPadding:g,fragments:h}=this;return Object.keys(h).forEach(i=>{let j=h[i];j&&cf(j)&&(c=j.body.start-g,d=j.body.end+g,a>=c&&a<=d&&f<=(b=Math.min(a-c,d-a))&&(e=j.body,f=b))}),e}isEndListAppended(a){let b=this.endListFragments[a];return void 0!==b&&(b.buffered||cf(b))}getState(a){let b=cg(a),c=this.fragments[b];if(c)if(!c.buffered)return cc;else if(cf(c))return cd;else return"OK";return cb}isTimeBuffered(a,b,c){let d,e;for(let f=0;f<c.length;f++){if(d=c.start(f)-this.bufferPadding,e=c.end(f)+this.bufferPadding,a>=d&&b<=e)return!0;if(b<=d)break}return!1}onFragLoaded(a,b){let{frag:c,part:d}=b;if("initSegment"===c.sn||c.bitrateTest)return;let e=cg(c);this.fragments[e]={body:c,appendedPTS:null,loaded:d?null:b,buffered:!1,range:Object.create(null)}}onBufferAppended(a,b){let{frag:c,part:d,timeRanges:e}=b;if("initSegment"===c.sn)return;let f=c.type;if(d){let a=this.activePartLists[f];a||(this.activePartLists[f]=a=[]),a.push(d)}this.timeRanges=e,Object.keys(e).forEach(a=>{let b=e[a];this.detectEvictedFragments(a,b,f,d)})}onFragBuffered(a,b){this.detectPartialFragments(b)}hasFragment(a){let b=cg(a);return!!this.fragments[b]}hasParts(a){var b;return!!(null!=(b=this.activePartLists[a])&&b.length)}removeFragmentsInRange(a,b,c,d,e){(!d||this.hasGaps)&&Object.keys(this.fragments).forEach(f=>{let g=this.fragments[f];if(!g)return;let h=g.body;h.type===c&&(!d||h.gap)&&h.start<b&&h.end>a&&(g.buffered||e)&&this.removeFragment(h)})}removeFragment(a){let b=cg(a);a.stats.loaded=0,a.clearElementaryStreamInfo();let c=this.activePartLists[a.type];if(c){let b=a.sn;this.activePartLists[a.type]=c.filter(a=>a.fragment.sn!==b)}delete this.fragments[b],a.endList&&delete this.endListFragments[a.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function cf(a){var b,c,d;return a.buffered&&(a.body.gap||(null==(b=a.range.video)?void 0:b.partial)||(null==(c=a.range.audio)?void 0:c.partial)||(null==(d=a.range.audiovideo)?void 0:d.partial))}function cg(a){return`${a.type}_${a.level}_${a.sn}`}let ch={length:0,start:()=>0,end:()=>0};class ci{static isBuffered(a,b){try{if(a){let c=ci.getBuffered(a);for(let a=0;a<c.length;a++)if(b>=c.start(a)&&b<=c.end(a))return!0}}catch(a){}return!1}static bufferInfo(a,b,c){try{if(a){let d,e=ci.getBuffered(a),f=[];for(d=0;d<e.length;d++)f.push({start:e.start(d),end:e.end(d)});return this.bufferedInfo(f,b,c)}}catch(a){}return{len:0,start:b,end:b,nextStart:void 0}}static bufferedInfo(a,b,c){let d;b=Math.max(0,b),a.sort(function(a,b){let c=a.start-b.start;return c||b.end-a.end});let e=[];if(c)for(let b=0;b<a.length;b++){let d=e.length;if(d){let f=e[d-1].end;a[b].start-f<c?a[b].end>f&&(e[d-1].end=a[b].end):e.push(a[b])}else e.push(a[b])}else e=a;let f=0,g=b,h=b;for(let a=0;a<e.length;a++){let i=e[a].start,j=e[a].end;if(b+c>=i&&b<j)g=i,f=(h=j)-b;else if(b+c<i){d=i;break}}return{len:f,start:g||0,end:h||0,nextStart:d}}static getBuffered(a){try{return a.buffered}catch(a){return I.log("failed to get media.buffered",a),ch}}}class cj{constructor(a,b,c,d=0,e=-1,f=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=ck(),this.buffering={audio:ck(),video:ck(),audiovideo:ck()},this.level=a,this.sn=b,this.id=c,this.size=d,this.part=e,this.partial=f}}function ck(){return{start:0,executeStart:0,executeEnd:0,end:0}}function cl(a,b){for(let d=0,e=a.length;d<e;d++){var c;if((null==(c=a[d])?void 0:c.cc)===b)return a[d]}return null}function cm(a,b){if(a){let c=a.start+b;a.start=a.startPTS=c,a.endPTS=c+a.duration}}function cn(a,b){let c=b.fragments;for(let b=0,d=c.length;b<d;b++)cm(c[b],a);b.fragmentHint&&cm(b.fragmentHint,a),b.alignedSliding=!0}function co(a,b){let c,d;if(!a.hasProgramDateTime||!b.hasProgramDateTime)return;let e=a.fragments,f=b.fragments;if(!e.length||!f.length)return;let g=Math.min(b.endCC,a.endCC);b.startCC<g&&a.startCC<g&&(c=cl(f,g),d=cl(e,g)),c&&d||(d=cl(e,(c=f[Math.floor(f.length/2)]).cc)||e[Math.floor(e.length/2)]);let h=c.programDateTime,i=d.programDateTime;h&&i&&cn((i-h)/1e3-(d.start-c.start),a)}class cp{constructor(a){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=a}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(a,b){let c=a.url;if(!c)return Promise.reject(new cs({type:D.NETWORK_ERROR,details:E.FRAG_LOAD_ERROR,fatal:!1,frag:a,error:Error(`Fragment does not have a ${c?"part list":"url"}`),networkDetails:null}));this.abort();let d=this.config,e=d.fLoader,f=d.loader;return new Promise((g,h)=>{if(this.loader&&this.loader.destroy(),a.gap)if(a.tagList.some(a=>"GAP"===a[0]))return void h(cr(a));else a.gap=!1;let i=this.loader=a.loader=e?new e(d):new f(d),j=cq(a),k=bX(d.fragLoadPolicy.default),l={loadPolicy:k,timeout:k.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===a.sn?1/0:131072};a.stats=i.stats,i.load(j,l,{onSuccess:(b,c,d,e)=>{this.resetLoader(a,i);let f=b.data;d.resetIV&&a.decryptdata&&(a.decryptdata.iv=new Uint8Array(f.slice(0,16)),f=f.slice(16)),g({frag:a,part:null,payload:f,networkDetails:e})},onError:(b,d,e,f)=>{this.resetLoader(a,i),h(new cs({type:D.NETWORK_ERROR,details:E.FRAG_LOAD_ERROR,fatal:!1,frag:a,response:x({url:c,data:void 0},b),error:Error(`HTTP Error ${b.code} ${b.text}`),networkDetails:e,stats:f}))},onAbort:(b,c,d)=>{this.resetLoader(a,i),h(new cs({type:D.NETWORK_ERROR,details:E.INTERNAL_ABORTED,fatal:!1,frag:a,error:Error("Aborted"),networkDetails:d,stats:b}))},onTimeout:(b,c,d)=>{this.resetLoader(a,i),h(new cs({type:D.NETWORK_ERROR,details:E.FRAG_LOAD_TIMEOUT,fatal:!1,frag:a,error:Error(`Timeout after ${l.timeout}ms`),networkDetails:d,stats:b}))},onProgress:(c,d,e,f)=>{b&&b({frag:a,part:null,payload:e,networkDetails:f})}})})}loadPart(a,b,c){this.abort();let d=this.config,e=d.fLoader,f=d.loader;return new Promise((g,h)=>{if(this.loader&&this.loader.destroy(),a.gap||b.gap)return void h(cr(a,b));let i=this.loader=a.loader=e?new e(d):new f(d),j=cq(a,b),k=bX(d.fragLoadPolicy.default),l={loadPolicy:k,timeout:k.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:131072};b.stats=i.stats,i.load(j,l,{onSuccess:(d,e,f,h)=>{this.resetLoader(a,i),this.updateStatsFromPart(a,b);let j={frag:a,part:b,payload:d.data,networkDetails:h};c(j),g(j)},onError:(c,d,e,f)=>{this.resetLoader(a,i),h(new cs({type:D.NETWORK_ERROR,details:E.FRAG_LOAD_ERROR,fatal:!1,frag:a,part:b,response:x({url:j.url,data:void 0},c),error:Error(`HTTP Error ${c.code} ${c.text}`),networkDetails:e,stats:f}))},onAbort:(c,d,e)=>{a.stats.aborted=b.stats.aborted,this.resetLoader(a,i),h(new cs({type:D.NETWORK_ERROR,details:E.INTERNAL_ABORTED,fatal:!1,frag:a,part:b,error:Error("Aborted"),networkDetails:e,stats:c}))},onTimeout:(c,d,e)=>{this.resetLoader(a,i),h(new cs({type:D.NETWORK_ERROR,details:E.FRAG_LOAD_TIMEOUT,fatal:!1,frag:a,part:b,error:Error(`Timeout after ${l.timeout}ms`),networkDetails:e,stats:c}))}})})}updateStatsFromPart(a,b){let c=a.stats,d=b.stats,e=d.total;if(c.loaded+=d.loaded,e){let d=Math.round(a.duration/b.duration),f=Math.min(Math.round(c.loaded/e),d),g=(d-f)*Math.round(c.loaded/f);c.total=c.loaded+g}else c.total=Math.max(c.loaded,c.total);let f=c.loading,g=d.loading;f.start?f.first+=g.first-g.start:(f.start=g.start,f.first=g.first),f.end=g.end}resetLoader(a,b){a.loader=null,this.loader===b&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),b.destroy()}}function cq(a,b=null){let c=b||a,d={frag:a,part:b,responseType:"arraybuffer",url:c.url,headers:{},rangeStart:0,rangeEnd:0},e=c.byteRangeStartOffset,f=c.byteRangeEndOffset;if(z(e)&&z(f)){var g;let b=e,c=f;if("initSegment"===a.sn&&(null==(g=a.decryptdata)?void 0:g.method)==="AES-128"){let a=f-e;a%16&&(c=f+(16-a%16)),0!==e&&(d.resetIV=!0,b=e-16)}d.rangeStart=b,d.rangeEnd=c}return d}function cr(a,b){let c=Error(`GAP ${a.gap?"tag":"attribute"} found`),d={type:D.MEDIA_ERROR,details:E.FRAG_GAP,fatal:!1,frag:a,error:c,networkDetails:null};return b&&(d.part=b),(b||a).stats.aborted=!0,new cs(d)}class cs extends Error{constructor(a){super(a.error.message),this.data=void 0,this.data=a}}class ct{constructor(a,b){this.subtle=void 0,this.aesIV=void 0,this.subtle=a,this.aesIV=b}decrypt(a,b){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},b,a)}}class cu{constructor(a,b){this.subtle=void 0,this.key=void 0,this.subtle=a,this.key=b}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}class cv{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(a){let b=new DataView(a),c=new Uint32Array(4);for(let a=0;a<4;a++)c[a]=b.getUint32(4*a);return c}initTable(){let a=this.sBox,b=this.invSBox,c=this.subMix,d=c[0],e=c[1],f=c[2],g=c[3],h=this.invSubMix,i=h[0],j=h[1],k=h[2],l=h[3],m=new Uint32Array(256),n=0,o=0,p=0;for(p=0;p<256;p++)p<128?m[p]=p<<1:m[p]=p<<1^283;for(p=0;p<256;p++){let c=o^o<<1^o<<2^o<<3^o<<4;c=c>>>8^255&c^99,a[n]=c,b[c]=n;let h=m[n],p=m[h],q=m[p],r=257*m[c]^0x1010100*c;d[n]=r<<24|r>>>8,e[n]=r<<16|r>>>16,f[n]=r<<8|r>>>24,g[n]=r,r=0x1010101*q^65537*p^257*h^0x1010100*n,i[c]=r<<24|r>>>8,j[c]=r<<16|r>>>16,k[c]=r<<8|r>>>24,l[c]=r,n?(n=h^m[m[m[q^h]]],o^=m[m[o]]):n=o=1}}expandKey(a){let b,c,d,e,f=this.uint8ArrayToUint32Array_(a),g=!0,h=0;for(;h<f.length&&g;)g=f[h]===this.key[h],h++;if(g)return;this.key=f;let i=this.keySize=f.length;if(4!==i&&6!==i&&8!==i)throw Error("Invalid aes key size="+i);let j=this.ksRows=(i+6+1)*4,k=this.keySchedule=new Uint32Array(j),l=this.invKeySchedule=new Uint32Array(j),m=this.sBox,n=this.rcon,o=this.invSubMix,p=o[0],q=o[1],r=o[2],s=o[3];for(b=0;b<j;b++){if(b<i){d=k[b]=f[b];continue}e=d,b%i==0?e=(m[(e=e<<8|e>>>24)>>>24]<<24|m[e>>>16&255]<<16|m[e>>>8&255]<<8|m[255&e])^n[b/i|0]<<24:i>6&&b%i==4&&(e=m[e>>>24]<<24|m[e>>>16&255]<<16|m[e>>>8&255]<<8|m[255&e]),k[b]=d=(k[b-i]^e)>>>0}for(c=0;c<j;c++)b=j-c,e=3&c?k[b]:k[b-4],c<4||b<=4?l[c]=e:l[c]=p[m[e>>>24]]^q[m[e>>>16&255]]^r[m[e>>>8&255]]^s[m[255&e]],l[c]=l[c]>>>0}networkToHostOrderSwap(a){return a<<24|(65280&a)<<8|(0xff0000&a)>>8|a>>>24}decrypt(a,b,c){let d,e,f,g,h,i,j,k,l,m,n,o,p,q,r=this.keySize+6,s=this.invKeySchedule,t=this.invSBox,u=this.invSubMix,v=u[0],w=u[1],x=u[2],y=u[3],z=this.uint8ArrayToUint32Array_(c),A=z[0],B=z[1],C=z[2],D=z[3],E=new Int32Array(a),F=new Int32Array(E.length),G=this.networkToHostOrderSwap;for(;b<E.length;){for(q=1,l=G(E[b]),m=G(E[b+1]),n=G(E[b+2]),o=G(E[b+3]),h=l^s[0],i=o^s[1],j=n^s[2],k=m^s[3],p=4;q<r;q++)d=v[h>>>24]^w[i>>16&255]^x[j>>8&255]^y[255&k]^s[p],e=v[i>>>24]^w[j>>16&255]^x[k>>8&255]^y[255&h]^s[p+1],f=v[j>>>24]^w[k>>16&255]^x[h>>8&255]^y[255&i]^s[p+2],g=v[k>>>24]^w[h>>16&255]^x[i>>8&255]^y[255&j]^s[p+3],h=d,i=e,j=f,k=g,p+=4;d=t[h>>>24]<<24^t[i>>16&255]<<16^t[j>>8&255]<<8^t[255&k]^s[p],e=t[i>>>24]<<24^t[j>>16&255]<<16^t[k>>8&255]<<8^t[255&h]^s[p+1],f=t[j>>>24]<<24^t[k>>16&255]<<16^t[h>>8&255]<<8^t[255&i]^s[p+2],g=t[k>>>24]<<24^t[h>>16&255]<<16^t[i>>8&255]<<8^t[255&j]^s[p+3],F[b]=G(d^A),F[b+1]=G(g^B),F[b+2]=G(f^C),F[b+3]=G(e^D),A=l,B=m,C=n,D=o,b+=4}return F.buffer}}class cw{constructor(a,{removePKCS7Padding:b=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=a.enableSoftwareAES,this.removePKCS7Padding=b,b)try{const a=self.crypto;a&&(this.subtle=a.subtle||a.webkitSubtle)}catch(a){}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){let{currentResult:a,remainderData:b}=this;if(!a||b)return this.reset(),null;let c=new Uint8Array(a);if(this.reset(),this.removePKCS7Padding){let a,b;return(b=(a=c.byteLength)&&new DataView(c.buffer).getUint8(a-1))?ak(c,0,a-b):c}return c}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(a,b,c){return this.useSoftware?new Promise((d,e)=>{this.softwareDecrypt(new Uint8Array(a),b,c);let f=this.flush();f?d(f.buffer):e(Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(a),b,c)}softwareDecrypt(a,b,c){let{currentIV:d,currentResult:e,remainderData:f}=this;this.logOnce("JS AES decrypt"),f&&(a=aP(f,a),this.remainderData=null);let g=this.getValidChunk(a);if(!g.length)return null;d&&(c=d);let h=this.softwareDecrypter;return(h||(h=this.softwareDecrypter=new cv),h.expandKey(b),this.currentResult=h.decrypt(g.buffer,0,c),this.currentIV=ak(g,-16).buffer,e)?e:null}webCryptoDecrypt(a,b,c){if(this.key!==b||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(a,b,c));this.key=b,this.fastAesKey=new cu(this.subtle,b)}return this.fastAesKey.expandKey().then(b=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new ct(this.subtle,new Uint8Array(c)).decrypt(a.buffer,b)):Promise.reject(Error("web crypto not initialized"))).catch(d=>(I.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${d.name}: ${d.message}`),this.onWebCryptoError(a,b,c)))}onWebCryptoError(a,b,c){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(a,b,c);let d=this.flush();if(d)return d.buffer;throw Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(a){let b=a,c=a.length-a.length%16;return c!==a.length&&(b=ak(a,0,c),this.remainderData=ak(a,c)),b}logOnce(a){this.logEnabled&&(I.log(`[decrypter]: ${a}`),this.logEnabled=!1)}}let cx=function(a){let b="",c=a.length;for(let d=0;d<c;d++)b+=`[${a.start(d).toFixed(3)}-${a.end(d).toFixed(3)}]`;return b},cy="STOPPED",cz="IDLE",cA="KEY_LOADING",cB="FRAG_LOADING",cC="FRAG_LOADING_WAITING_RETRY",cD="WAITING_TRACK",cE="PARSING",cF="PARSED",cG="ENDED",cH="ERROR",cI="WAITING_INIT_PTS",cJ="WAITING_LEVEL";class cK extends ca{constructor(a,b,c,d,e){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=cy,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=e,this.logPrefix=d,this.log=I.log.bind(I,`${d}:`),this.warn=I.warn.bind(I,`${d}:`),this.hls=a,this.fragmentLoader=new cp(a.config),this.keyLoader=c,this.fragmentTracker=b,this.config=a.config,this.decrypter=new cw(a.config),a.on(C.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(a){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);let a=this.fragCurrent;null!=a&&a.loader&&(a.abortRequests(),this.fragmentTracker.removeFragment(a)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=cy}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}_streamEnded(a,b){if(b.live||a.nextStart||!a.end||!this.media)return!1;let c=b.partList;if(null!=c&&c.length){let a=c[c.length-1];return ci.isBuffered(this.media,a.start+a.duration/2)}let d=b.fragments[b.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(d)}getLevelDetails(){if(this.levels&&null!==this.levelLastLoaded){var a;return null==(a=this.levelLastLoaded)?void 0:a.details}}onMediaAttached(a,b){let c=this.media=this.mediaBuffer=b.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),c.addEventListener("seeking",this.onvseeking),c.addEventListener("ended",this.onvended);let d=this.config;this.levels&&d.autoStartLoad&&this.state===cy&&this.startLoad(d.startPosition)}onMediaDetaching(){let a=this.media;null!=a&&a.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),a&&this.onvseeking&&this.onvended&&(a.removeEventListener("seeking",this.onvseeking),a.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){let{config:a,fragCurrent:b,media:c,mediaBuffer:d,state:e}=this,f=c?c.currentTime:0,g=ci.bufferInfo(d||c,f,a.maxBufferHole);if(this.log(`media seeking to ${z(f)?f.toFixed(3):f}, state: ${e}`),this.state===cG)this.resetLoadingState();else if(b){let c=a.maxFragLookUpTolerance,d=b.start-c,e=b.start+b.duration+c;if(!g.len||e<g.start||d>g.end){let a=f>e;(f<d||a)&&(a&&b.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),b.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}c&&(this.fragmentTracker.removeFragmentsInRange(f,1/0,this.playlistType,!0),this.lastCurrentTime=f),this.loadedmetadata||g.len||(this.nextLoadPosition=this.startPosition=f),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(a,b){this.startTimeOffset=b.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(C.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state=cy,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(a,b,c){this._loadFragForPlayback(a,b,c)}_loadFragForPlayback(a,b,c){let d=b=>{if(this.fragContextChanged(a)){this.warn(`Fragment ${a.sn}${b.part?" p: "+b.part.index:""} of level ${a.level} was dropped during download.`),this.fragmentTracker.removeFragment(a);return}a.stats.chunkCount++,this._handleFragmentLoadProgress(b)};this._doFragLoad(a,b,c,d).then(b=>{if(!b)return;let c=this.state;if(this.fragContextChanged(a)){c!==cB&&(this.fragCurrent||c!==cE)||(this.fragmentTracker.removeFragment(a),this.state=cz);return}"payload"in b&&(this.log(`Loaded fragment ${a.sn} of level ${a.level}`),this.hls.trigger(C.FRAG_LOADED,b)),this._handleFragmentLoadComplete(b)}).catch(b=>{this.state!==cy&&this.state!==cH&&(this.warn(`Frag error: ${(null==b?void 0:b.message)||b}`),this.resetFragmentLoading(a))})}clearTrackerIfNeeded(a){var b;let{fragmentTracker:c}=this;if(c.getState(a)===cc){let b=a.type,d=this.getFwdBufferInfo(this.mediaBuffer,b),e=Math.max(a.duration,d?d.len:this.config.maxBufferLength),f=this.backtrackFragment;(1==(f?a.sn-f.sn:0)||this.reduceMaxBufferLength(e,a.duration))&&c.removeFragment(a)}else(null==(b=this.mediaBuffer)?void 0:b.buffered.length)===0?c.removeAllFragments():c.hasParts(a.type)&&(c.detectPartialFragments({frag:a,part:null,stats:a.stats,id:a.type}),c.getState(a)===cd&&c.removeFragment(a))}checkLiveUpdate(a){if(a.updated&&!a.live){let b=a.fragments[a.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:b,part:null,stats:b.stats,id:b.type})}a.fragments[0]||(a.deltaUpdateFailed=!0)}flushMainBuffer(a,b,c=null){a-b&&this.hls.trigger(C.BUFFER_FLUSHING,{startOffset:a,endOffset:b,type:c})}_loadInitSegment(a,b){this._doFragLoad(a,b).then(b=>{if(!b||this.fragContextChanged(a)||!this.levels)throw Error("init load aborted");return b}).then(b=>{let{hls:c}=this,{payload:d}=b,e=a.decryptdata;if(d&&d.byteLength>0&&null!=e&&e.key&&e.iv&&"AES-128"===e.method){let f=self.performance.now();return this.decrypter.decrypt(new Uint8Array(d),e.key.buffer,e.iv.buffer).catch(b=>{throw c.trigger(C.ERROR,{type:D.MEDIA_ERROR,details:E.FRAG_DECRYPT_ERROR,fatal:!1,error:b,reason:b.message,frag:a}),b}).then(d=>{let e=self.performance.now();return c.trigger(C.FRAG_DECRYPTED,{frag:a,payload:d,stats:{tstart:f,tdecrypt:e}}),b.payload=d,this.completeInitSegmentLoad(b)})}return this.completeInitSegmentLoad(b)}).catch(b=>{this.state!==cy&&this.state!==cH&&(this.warn(b),this.resetFragmentLoading(a))})}completeInitSegmentLoad(a){let{levels:b}=this;if(!b)throw Error("init load aborted, missing levels");let c=a.frag.stats;this.state=cz,a.frag.data=new Uint8Array(a.payload),c.parsing.start=c.buffering.start=self.performance.now(),c.parsing.end=c.buffering.end=self.performance.now(),this.tick()}fragContextChanged(a){let{fragCurrent:b}=this;return!a||!b||a.sn!==b.sn||a.level!==b.level}fragBufferedComplete(a,b){var c,d,e,f,g;let h=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${a.type} sn: ${a.sn}${b?" part: "+b.index:""} of ${this.playlistType===bo?"level":"track"} ${a.level} (frag:[${(null!=(c=a.startPTS)?c:NaN).toFixed(3)}-${(null!=(d=a.endPTS)?d:NaN).toFixed(3)}] > buffer:${h?cx(ci.getBuffered(h)):"(detached)"})`),"initSegment"!==a.sn){if(a.type!==bq){let b=a.elementaryStreams;if(!Object.keys(b).some(a=>!!b[a])){this.state=cz;return}}let b=null==(g=this.levels)?void 0:g[a.level];null!=b&&b.fragmentError&&(this.log(`Resetting level fragment error count of ${b.fragmentError} on frag buffered`),b.fragmentError=0)}this.state=cz,h&&(!this.loadedmetadata&&a.type==bo&&h.buffered.length&&(null==(e=this.fragCurrent)?void 0:e.sn)===(null==(f=this.fragPrevious)?void 0:f.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(a){let{transmuxer:b}=this;if(!b)return;let{frag:c,part:d,partsLoaded:e}=a,f=!e||0===e.length||e.some(a=>!a),g=new cj(c.level,c.sn,c.stats.chunkCount+1,0,d?d.index:-1,!f);b.flush(g)}_handleFragmentLoadProgress(a){}_doFragLoad(a,b,c=null,d){var e;let f,g=null==b?void 0:b.details;if(!this.levels||!g)throw Error(`frag load aborted, missing level${g?"":" detail"}s`);let h=null;if(a.encrypted&&!(null!=(e=a.decryptdata)&&e.key)?(this.log(`Loading key for ${a.sn} of [${g.startSN}-${g.endSN}], ${"[stream-controller]"===this.logPrefix?"level":"track"} ${a.level}`),this.state=cA,this.fragCurrent=a,h=this.keyLoader.load(a).then(a=>{if(!this.fragContextChanged(a.frag))return this.hls.trigger(C.KEY_LOADED,a),this.state===cA&&(this.state=cz),a}),this.hls.trigger(C.KEY_LOADING,{frag:a}),null===this.fragCurrent&&(h=Promise.reject(Error("frag load aborted, context changed in KEY_LOADING")))):!a.encrypted&&g.encryptedFragments.length&&this.keyLoader.loadClear(a,g.encryptedFragments),c=Math.max(a.start,c||0),this.config.lowLatencyMode&&"initSegment"!==a.sn){let e=g.partList;if(e&&d){c>a.end&&g.fragmentHint&&(a=g.fragmentHint);let f=this.getNextPart(e,a,c);if(f>-1){let i,j=e[f];return(this.log(`Loading part sn: ${a.sn} p: ${j.index} cc: ${a.cc} of playlist [${g.startSN}-${g.endSN}] parts [0-${f}-${e.length-1}] ${"[stream-controller]"===this.logPrefix?"level":"track"}: ${a.level}, target: ${parseFloat(c.toFixed(3))}`),this.nextLoadPosition=j.start+j.duration,this.state=cB,i=h?h.then(c=>!c||this.fragContextChanged(c.frag)?null:this.doFragPartsLoad(a,j,b,d)).catch(a=>this.handleFragLoadError(a)):this.doFragPartsLoad(a,j,b,d).catch(a=>this.handleFragLoadError(a)),this.hls.trigger(C.FRAG_LOADING,{frag:a,part:j,targetBufferTime:c}),null===this.fragCurrent)?Promise.reject(Error("frag load aborted, context changed in FRAG_LOADING parts")):i}if(!a.url||this.loadedEndOfParts(e,c))return Promise.resolve(null)}}this.log(`Loading fragment ${a.sn} cc: ${a.cc} ${g?"of ["+g.startSN+"-"+g.endSN+"] ":""}${"[stream-controller]"===this.logPrefix?"level":"track"}: ${a.level}, target: ${parseFloat(c.toFixed(3))}`),z(a.sn)&&!this.bitrateTest&&(this.nextLoadPosition=a.start+a.duration),this.state=cB;let i=this.config.progressive;return(f=i&&h?h.then(b=>!b||this.fragContextChanged(null==b?void 0:b.frag)?null:this.fragmentLoader.load(a,d)).catch(a=>this.handleFragLoadError(a)):Promise.all([this.fragmentLoader.load(a,i?d:void 0),h]).then(([a])=>(!i&&a&&d&&d(a),a)).catch(a=>this.handleFragLoadError(a)),this.hls.trigger(C.FRAG_LOADING,{frag:a,targetBufferTime:c}),null===this.fragCurrent)?Promise.reject(Error("frag load aborted, context changed in FRAG_LOADING")):f}doFragPartsLoad(a,b,c,d){return new Promise((e,f)=>{var g;let h=[],i=null==(g=c.details)?void 0:g.partList,j=b=>{this.fragmentLoader.loadPart(a,b,d).then(d=>{h[b.index]=d;let f=d.part;this.hls.trigger(C.FRAG_LOADED,d);let g=bR(c,a.sn,b.index+1)||bS(i,a.sn,b.index+1);if(!g)return e({frag:a,part:f,partsLoaded:h});j(g)}).catch(f)};j(b)})}handleFragLoadError(a){if("data"in a){let b=a.data;a.data&&b.details===E.INTERNAL_ABORTED?this.handleFragLoadAborted(b.frag,b.part):this.hls.trigger(C.ERROR,b)}else this.hls.trigger(C.ERROR,{type:D.OTHER_ERROR,details:E.INTERNAL_EXCEPTION,err:a,error:a,fatal:!0});return null}_handleTransmuxerFlush(a){let b=this.getCurrentContext(a);if(!b||this.state!==cE){this.fragCurrent||this.state===cy||this.state===cH||(this.state=cz);return}let{frag:c,part:d,level:e}=b,f=self.performance.now();c.stats.parsing.end=f,d&&(d.stats.parsing.end=f),this.updateLevelTiming(c,d,e,a.partial)}getCurrentContext(a){let{levels:b,fragCurrent:c}=this,{level:d,sn:e,part:f}=a;if(!(null!=b&&b[d]))return this.warn(`Levels object was unset while buffering fragment ${e} of level ${d}. The current chunk will not be buffered.`),null;let g=b[d],h=f>-1?bR(g,e,f):null,i=h?h.fragment:function(a,b,c){if(!(null!=a&&a.details))return null;let d=a.details,e=d.fragments[b-d.startSN];return e||(e=d.fragmentHint)&&e.sn===b?e:b<d.startSN&&c&&c.sn===b?c:null}(g,e,c);return i?(c&&c!==i&&(i.stats=c.stats),{frag:i,part:h,level:g}):null}bufferFragmentData(a,b,c,d,e){var f;if(!a||this.state!==cE)return;let{data1:g,data2:h}=a,i=g;if(g&&h&&(i=aP(g,h)),!(null!=(f=i)&&f.length))return;let j={type:a.type,frag:b,part:c,chunkMeta:d,parent:b.type,data:i};if(this.hls.trigger(C.BUFFER_APPENDING,j),a.dropped&&a.independent&&!c){if(e)return;this.flushBufferGap(b)}}flushBufferGap(a){let b=this.media;if(!b)return;if(!ci.isBuffered(b,b.currentTime))return void this.flushMainBuffer(0,a.start);let c=b.currentTime,d=ci.bufferInfo(b,c,0),e=a.duration,f=Math.min(2*this.config.maxFragLookUpTolerance,.25*e),g=Math.max(Math.min(a.start-f,d.end-f),c+f);a.start-g>f&&this.flushMainBuffer(g,a.start)}getFwdBufferInfo(a,b){let c=this.getLoadPosition();return z(c)?this.getFwdBufferInfoAtPos(a,c,b):null}getFwdBufferInfoAtPos(a,b,c){let{config:{maxBufferHole:d}}=this,e=ci.bufferInfo(a,b,d);if(0===e.len&&void 0!==e.nextStart){let f=this.fragmentTracker.getBufferedFrag(b,c);if(f&&e.nextStart<f.end)return ci.bufferInfo(a,b,Math.max(e.nextStart,d))}return e}getMaxBufferLength(a){let{config:b}=this;return Math.min(a?Math.max(8*b.maxBufferSize/a,b.maxBufferLength):b.maxBufferLength,b.maxMaxBufferLength)}reduceMaxBufferLength(a,b){let c=this.config,d=Math.max(Math.min(a-b,c.maxBufferLength),b),e=Math.max(a-3*b,c.maxMaxBufferLength/2,d);return e>=d&&(c.maxMaxBufferLength=e,this.warn(`Reduce max buffer length to ${e}s`),!0)}getAppendedFrag(a,b=bo){let c=this.fragmentTracker.getAppendedFrag(a,bo);return c&&"fragment"in c?c.fragment:c}getNextFragment(a,b){let c,d=b.fragments,e=d.length;if(!e)return null;let{config:f}=this,g=d[0].start;if(b.live){let h=f.initialLiveManifestSize;if(e<h)return this.warn(`Not enough fragments to start playback (have: ${e}, need: ${h})`),null;(b.PTSKnown||this.startFragRequested||-1!==this.startPosition)&&!(a<g)||(c=this.getInitialLiveFragment(b,d),this.startPosition=this.nextLoadPosition=c?this.hls.liveSyncPosition||c.start:a)}else a<=g&&(c=d[0]);if(!c){let d=f.lowLatencyMode?b.partEnd:b.fragmentEnd;c=this.getFragmentAtPosition(a,d,b)}return this.mapToInitFragWhenRequired(c)}isLoopLoading(a,b){let c=this.fragmentTracker.getState(a);return("OK"===c||c===cd&&!!a.gap)&&this.nextLoadPosition>b}getNextFragmentLoopLoading(a,b,c,d,e){let f=a.gap,g=this.getNextFragment(this.nextLoadPosition,b);if(null===g)return g;if(a=g,f&&a&&!a.gap&&c.nextStart){let b=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,c.nextStart,d);if(null!==b&&c.len+b.len>=e)return this.log(`buffer full after gaps in "${d}" playlist starting at sn: ${a.sn}`),null}return a}mapToInitFragWhenRequired(a){return null==a||!a.initSegment||null!=a&&a.initSegment.data||this.bitrateTest?a:a.initSegment}getNextPart(a,b,c){let d=-1,e=!1,f=!0;for(let g=0,h=a.length;g<h;g++){let h=a[g];if(f=f&&!h.independent,d>-1&&c<h.start)break;let i=h.loaded;i?d=-1:(e||h.independent||f)&&h.fragment===b&&(d=g),e=i}return d}loadedEndOfParts(a,b){let c=a[a.length-1];return c&&b>c.start&&c.loaded}getInitialLiveFragment(a,b){let c=this.fragPrevious,d=null;if(c){if(a.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${c.programDateTime}`),d=function(a,b,c){if(null===b||!Array.isArray(a)||!a.length||!z(b)||b<(a[0].programDateTime||0)||b>=(a[a.length-1].endProgramDateTime||0))return null;c=c||0;for(let d=0;d<a.length;++d){let e=a[d];if(function(a,b,c){let d=1e3*Math.min(b,c.duration+(c.deltaPTS?c.deltaPTS:0));return(c.endProgramDateTime||0)-d>a}(b,c,e))return e}return null}(b,c.endProgramDateTime,this.config.maxFragLookUpTolerance)),!d){let f=c.sn+1;if(f>=a.startSN&&f<=a.endSN){let e=b[f-a.startSN];c.cc===e.cc&&(d=e,this.log(`Live playlist, switching playlist, load frag with next SN: ${d.sn}`))}if(!d){var e;e=c.cc,(d=bZ(b,a=>a.cc<e?1:a.cc>e?-1:0))&&this.log(`Live playlist, switching playlist, load frag with same CC: ${d.sn}`)}}}else{let b=this.hls.liveSyncPosition;null!==b&&(d=this.getFragmentAtPosition(b,this.bitrateTest?a.fragmentEnd:a.edge,a))}return d}getFragmentAtPosition(a,b,c){let d,{config:e}=this,{fragPrevious:f}=this,{fragments:g,endSN:h}=c,{fragmentHint:i}=c,{maxFragLookUpTolerance:j}=e,k=c.partList,l=!!(e.lowLatencyMode&&null!=k&&k.length&&i);if(l&&i&&!this.bitrateTest&&(g=g.concat(i),h=i.sn),d=a<b?b$(f,g,a,a>b-j?0:j):g[g.length-1]){let a=d.sn-c.startSN,b=this.fragmentTracker.getState(d);if(("OK"===b||b===cd&&d.gap)&&(f=d),f&&d.sn===f.sn&&(!l||k[0].fragment.sn>d.sn)&&f&&d.level===f.level){let b=g[a+1];d=d.sn<h&&"OK"!==this.fragmentTracker.getState(b)?b:null}}return d}synchronizeToLiveEdge(a){let{config:b,media:c}=this;if(!c)return;let d=this.hls.liveSyncPosition,e=c.currentTime,f=a.fragments[0].start,g=a.edge,h=e>=f-b.maxFragLookUpTolerance&&e<=g;if(null!==d&&c.duration>d&&(e<d||!h)){let f=void 0!==b.liveMaxLatencyDuration?b.liveMaxLatencyDuration:b.liveMaxLatencyDurationCount*a.targetduration;(!h&&c.readyState<4||e<g-f)&&(this.loadedmetadata||(this.nextLoadPosition=d),c.readyState&&(this.warn(`Playback: ${e.toFixed(3)} is located too far from the end of live sliding playlist: ${g}, reset currentTime to : ${d.toFixed(3)}`),c.currentTime=d))}}alignPlaylists(a,b,c){let d=a.fragments.length;if(!d)return this.warn("No fragments in live playlist"),0;let e=a.fragments[0].start,f=!b,g=a.alignedSliding&&z(e);if(f||!g&&!e){let{fragPrevious:e}=this;c&&(function(a,b,c){if(c&&(b.endCC>b.startCC||a&&a.cc<b.startCC)){let a=function(a,b){let c=a.fragments,d=b.fragments;if(!d.length||!c.length)return void I.log("No fragments to align");let e=cl(c,d[0].cc);return e&&(!e||e.startPTS)?e:void I.log("No frag in previous level to align on")}(c,b);a&&z(a.start)&&(I.log(`Adjusting PTS using last level due to CC increase within current level ${b.url}`),cn(a.start,b))}}(e,a,c),!a.alignedSliding&&c&&co(a,c),a.alignedSliding||!c||a.skippedSegments||bP(c,a));let f=a.fragments[0].start;return this.log(`Live playlist sliding: ${f.toFixed(2)} start-sn: ${b?b.startSN:"na"}->${a.startSN} prev-sn: ${e?e.sn:"na"} fragments: ${d}`),f}return e}waitForCdnTuneIn(a){return a.live&&a.canBlockReload&&a.partTarget&&a.tuneInGoal>Math.max(a.partHoldBack,3*a.partTarget)}setStartPosition(a,b){let c=this.startPosition;if(c<b&&(c=-1),-1===c||-1===this.lastCurrentTime){let d=null!==this.startTimeOffset,e=d?this.startTimeOffset:a.startTimeOffset;null!==e&&z(e)?(c=b+e,e<0&&(c+=a.totalduration),c=Math.min(Math.max(b,c),b+a.totalduration),this.log(`Start time offset ${e} found in ${d?"multivariant":"media"} playlist, adjust startPosition to ${c}`),this.startPosition=c):a.live?c=this.hls.liveSyncPosition||b:this.startPosition=c=0,this.lastCurrentTime=c}this.nextLoadPosition=c}getLoadPosition(){let{media:a}=this,b=0;return this.loadedmetadata&&a?b=a.currentTime:this.nextLoadPosition&&(b=this.nextLoadPosition),b}handleFragLoadAborted(a,b){this.transmuxer&&"initSegment"!==a.sn&&a.stats.aborted&&(this.warn(`Fragment ${a.sn}${b?" part "+b.index:""} of level ${a.level} was aborted`),this.resetFragmentLoading(a))}resetFragmentLoading(a){this.fragCurrent&&(this.fragContextChanged(a)||this.state===cC)||(this.state=cz)}onFragmentOrKeyLoadError(a,b){if(b.chunkMeta&&!b.frag){let a=this.getCurrentContext(b.chunkMeta);a&&(b.frag=a.frag)}let c=b.frag;if(!c||c.type!==a||!this.levels)return;if(this.fragContextChanged(c)){var d;this.warn(`Frag load error must match current frag to retry ${c.url} > ${null==(d=this.fragCurrent)?void 0:d.url}`);return}let e=b.details===E.FRAG_GAP;e&&this.fragmentTracker.fragBuffered(c,!0);let f=b.errorAction,{action:g,retryCount:h=0,retryConfig:i}=f||{};if(f&&5===g&&i){this.resetStartWhenNotLoaded(this.levelLastLoaded);let d=bW(i,h);this.warn(`Fragment ${c.sn} of ${a} ${c.level} errored with ${b.details}, retrying loading ${h+1}/${i.maxNumRetry} in ${d}ms`),f.resolved=!0,this.retryDate=self.performance.now()+d,this.state=cC}else if(i&&f){if(this.resetFragmentErrors(a),!(h<i.maxNumRetry))return void I.warn(`${b.details} reached or exceeded max retry (${h})`);e||3===g||(f.resolved=!0)}else(null==f?void 0:f.action)===2?this.state=cJ:this.state=cH;this.tickImmediate()}reduceLengthAndFlushBuffer(a){if(this.state===cE||this.state===cF){let b=a.frag,c=a.parent,d=this.getFwdBufferInfo(this.mediaBuffer,c),e=d&&d.len>.5;e&&this.reduceMaxBufferLength(d.len,(null==b?void 0:b.duration)||10);let f=!e;return f&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${c} buffer`),b&&(this.fragmentTracker.removeFragment(b),this.nextLoadPosition=b.start),this.resetLoadingState(),f}return!1}resetFragmentErrors(a){a===bp&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==cy&&(this.state=cz)}afterBufferFlushed(a,b,c){if(!a)return;let d=ci.getBuffered(a);this.fragmentTracker.detectEvictedFragments(b,d,c),this.state===cG&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=cz}resetStartWhenNotLoaded(a){if(!this.loadedmetadata){this.startFragRequested=!1;let b=a?a.details:null;null!=b&&b.live?(this.startPosition=-1,this.setStartPosition(b,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(a){this.warn(`The loading context changed while buffering fragment ${a.sn} of level ${a.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(a=0){this.fragmentTracker.removeFragmentsInRange(a,1/0,this.playlistType,!1,!0)}updateLevelTiming(a,b,c,d){var e;let f=c.details;if(!f)return void this.warn("level.details undefined");if(!Object.keys(a.elementaryStreams).reduce((b,e)=>{let g=a.elementaryStreams[e];if(g){let h=g.endPTS-g.startPTS;if(h<=0)return this.warn(`Could not parse fragment ${a.sn} ${e} duration reliably (${h})`),b||!1;let i=d?0:bO(f,a,g.startPTS,g.endPTS,g.startDTS,g.endDTS);return this.hls.trigger(C.LEVEL_PTS_UPDATED,{details:f,level:c,drift:i,type:e,frag:a,start:g.startPTS,end:g.endPTS}),!0}return b},!1)&&(null==(e=this.transmuxer)?void 0:e.error)===null){let b=Error(`Found no media in fragment ${a.sn} of level ${a.level} resetting transmuxer to fallback to playlist timing`);if(0===c.fragmentError&&(c.fragmentError++,a.gap=!0,this.fragmentTracker.removeFragment(a),this.fragmentTracker.fragBuffered(a,!0)),this.warn(b.message),this.hls.trigger(C.ERROR,{type:D.MEDIA_ERROR,details:E.FRAG_PARSING_ERROR,fatal:!1,error:b,frag:a,reason:`Found no media in msn ${a.sn} of level "${c.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=cF,this.hls.trigger(C.FRAG_PARSED,{frag:a,part:b})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(a){"demuxerWorker"===a.event&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(a){let b=this._state;b!==a&&(this._state=a,this.log(`${b}->${a}`))}get state(){return this._state}}class cL{constructor(){this.chunks=[],this.dataLength=0}push(a){this.chunks.push(a),this.dataLength+=a.length}flush(){let a,{chunks:b,dataLength:c}=this;return b.length?(a=1===b.length?b[0]:function(a,b){let c=new Uint8Array(b),d=0;for(let b=0;b<a.length;b++){let e=a[b];c.set(e,d),d+=e.length}return c}(b,c),this.reset(),a):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}function cM(a="",b=9e4){return{type:a,id:-1,pid:-1,inputTimeScale:b,sequenceNumber:-1,samples:[],dropped:0}}class cN{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(a,b,c,d){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(a){this.initPTS=a,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(a,b){return!1}appendFrame(a,b,c){}demux(a,b){let c;this.cachedData&&(a=aP(this.cachedData,a),this.cachedData=null);let d=an(a,0),e=d?d.length:0,f=this._audioTrack,g=this._id3Track,h=d?aq(d):void 0,i=a.length;for((null===this.basePTS||0===this.frameIndex&&z(h))&&(this.basePTS=cO(h,b,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),d&&d.length>0&&g.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:d,type:bz,duration:1/0});e<i;){if(this.canParse(a,e)){let b=this.appendFrame(f,a,e);b?(this.frameIndex++,this.lastPTS=b.sample.pts,e+=b.length,c=e):e=i}else ap(a,e)?(d=an(a,e),g.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:d,type:bz,duration:1/0}),e+=d.length,c=e):e++;if(e===i&&c!==i){let b=ak(a,c);this.cachedData?this.cachedData=aP(this.cachedData,b):this.cachedData=b}}return{audioTrack:f,videoTrack:cM(),id3Track:g,textTrack:cM()}}demuxSampleAes(a,b,c){return Promise.reject(Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(a){let b=this.cachedData;return b&&(this.cachedData=null,this.demux(b,0)),{audioTrack:this._audioTrack,videoTrack:cM(),id3Track:this._id3Track,textTrack:cM()}}destroy(){}}let cO=(a,b,c)=>z(a)?90*a:9e4*b+(c?9e4*c.baseTime/c.timescale:0);function cP(a,b){return 255===a[b]&&(246&a[b+1])==240}function cQ(a,b){return 1&a[b+1]?7:9}function cR(a,b){return(3&a[b+3])<<11|a[b+4]<<3|(224&a[b+5])>>>5}function cS(a,b){return b+1<a.length&&cP(a,b)}function cT(a,b,c,d,e){if(!a.samplerate){let f=function(a,b,c,d){let e,f,g,h,i=navigator.userAgent.toLowerCase(),j=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];e=((192&b[c+2])>>>6)+1;let k=(60&b[c+2])>>>2;if(k>j.length-1){let b=Error(`invalid ADTS sampling index:${k}`);a.emit(C.ERROR,C.ERROR,{type:D.MEDIA_ERROR,details:E.FRAG_PARSING_ERROR,fatal:!0,error:b,reason:b.message});return}return g=(1&b[c+2])<<2|(192&b[c+3])>>>6,I.log(`manifest codec:${d}, ADTS type:${e}, samplingIndex:${k}`),/firefox/i.test(i)?k>=6?(e=5,h=[,,,,],f=k-3):(e=2,h=[,,],f=k):-1!==i.indexOf("android")?(e=2,h=[,,],f=k):(e=5,h=[,,,,],d&&(-1!==d.indexOf("mp4a.40.29")||-1!==d.indexOf("mp4a.40.5"))||!d&&k>=6?f=k-3:((d&&-1!==d.indexOf("mp4a.40.2")&&(k>=6&&1===g||/vivaldi/i.test(i))||!d&&1===g)&&(e=2,h=[,,]),f=k)),h[0]=e<<3,h[0]|=(14&k)>>1,h[1]|=(1&k)<<7,h[1]|=g<<3,5===e&&(h[1]|=(14&f)>>1,h[2]=(1&f)<<7,h[2]|=8,h[3]=0),{config:h,samplerate:j[k],channelCount:g,codec:"mp4a.40."+e,manifestCodec:d}}(b,c,d,e);f&&(a.config=f.config,a.samplerate=f.samplerate,a.channelCount=f.channelCount,a.codec=f.codec,a.manifestCodec=f.manifestCodec,I.log(`parsed codec:${a.codec}, rate:${f.samplerate}, channels:${f.channelCount}`))}}function cU(a,b,c,d,e){let f,g=d+e*(9216e4/a.samplerate),h=function(a,b){let c=cQ(a,b);if(b+c<=a.length){let d=cR(a,b)-c;if(d>0)return{headerLength:c,frameLength:d}}}(b,c);if(h){let{frameLength:d,headerLength:e}=h,i=e+d,j=Math.max(0,c+i-b.length);j?(f=new Uint8Array(i-e)).set(b.subarray(c+e,b.length),0):f=b.subarray(c+e,c+i);let k={unit:f,pts:g};return j||a.samples.push(k),{sample:k,length:i,missing:j}}let i=b.length-c;return(f=new Uint8Array(i)).set(b.subarray(c,b.length),0),{sample:{unit:f,pts:g},length:i,missing:-1}}let cV=null,cW=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],cX=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],cY=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],cZ=[0,1,1,4];function c$(a,b,c,d,e){if(c+24>b.length)return;let f=c_(b,c);if(f&&c+f.frameLength<=b.length){let g=d+e*(9e4*f.samplesPerFrame/f.sampleRate),h={unit:b.subarray(c,c+f.frameLength),pts:g,dts:g};return a.config=[],a.channelCount=f.channelCount,a.samplerate=f.sampleRate,a.samples.push(h),{sample:h,length:f.frameLength,missing:0}}}function c_(a,b){let c=a[b+1]>>3&3,d=a[b+1]>>1&3,e=a[b+2]>>4&15,f=a[b+2]>>2&3;if(1!==c&&0!==e&&15!==e&&3!==f){let g=a[b+2]>>1&1,h=a[b+3]>>6,i=1e3*cW[14*(3===c?3-d:3===d?3:4)+e-1],j=cX[3*(3===c?0:2===c?1:2)+f],k=cY[c][d],l=cZ[d],m=Math.floor(k*i/j+g)*l;if(null===cV){let a=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);cV=a?parseInt(a[1]):0}return cV&&cV<=87&&2===d&&i>=224e3&&0===h&&(a[b+3]=128|a[b+3]),{sampleRate:j,channelCount:3===h?1:2,frameLength:m,samplesPerFrame:8*k*l}}}function c0(a,b){return 255===a[b]&&(224&a[b+1])==224&&(6&a[b+1])!=0}function c1(a,b){return b+1<a.length&&c0(a,b)}function c2(a,b){if(b+1<a.length&&c0(a,b)){let c=c_(a,b),d=4;null!=c&&c.frameLength&&(d=c.frameLength);let e=b+d;return e===a.length||c1(a,e)}return!1}let c3=/\/emsg[-/]ID3/i,c4=(a,b)=>{let c=0,d=5;b+=5;let e=new Uint32Array(1),f=new Uint32Array(1),g=new Uint8Array(1);for(;d>0;){g[0]=a[b];let h=Math.min(d,8),i=8-h;f[0]=0xff000000>>>24+i<<i,e[0]=(g[0]&f[0])>>i,c=c?c<<h|e[0]:e[0],b+=1,d-=h}return c};function c5(a,b,c,d,e){if(c+8>b.length||11!==b[c]||119!==b[c+1])return -1;let f=b[c+4]>>6;if(f>=3)return -1;let g=[48e3,44100,32e3][f],h=63&b[c+4],i=2*[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][3*h+f];if(c+i>b.length)return -1;let j=b[c+6]>>5,k=0;2===j?k+=2:(1&j&&1!==j&&(k+=2),4&j&&(k+=2));let l=(b[c+6]<<8|b[c+7])>>12-k&1,m=[2,1,2,3,3,4,4,5][j]+l,n=b[c+5]>>3,o=7&b[c+5],p=new Uint8Array([f<<6|n<<1|o>>2,(3&o)<<6|j<<3|l<<2|h>>4,h<<4&224]),q=b.subarray(c,c+i);return a.config=p,a.channelCount=m,a.samplerate=g,a.samples.push({unit:q,pts:d+1536/g*9e4*e}),i}class c6{constructor(){this.VideoSample=null}createVideoSample(a,b,c,d){return{key:a,frame:!1,pts:b,dts:c,units:[],debug:d,length:0}}getLastNalUnit(a){var b;let c,d=this.VideoSample;if(d&&0!==d.units.length||(d=a[a.length-1]),null!=(b=d)&&b.units){let a=d.units;c=a[a.length-1]}return c}pushAccessUnit(a,b){if(a.units.length&&a.frame){if(void 0===a.pts){let c=b.samples,d=c.length;if(!d)return void b.dropped++;{let b=c[d-1];a.pts=b.pts,a.dts=b.dts}}b.samples.push(a)}a.debug.length&&I.log(a.pts+"/"+a.dts+":"+a.debug)}}class c7{constructor(a){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=a,this.bytesAvailable=a.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){let a=this.data,b=this.bytesAvailable,c=a.byteLength-b,d=new Uint8Array(4),e=Math.min(4,b);if(0===e)throw Error("no bytes available");d.set(a.subarray(c,c+e)),this.word=new DataView(d.buffer).getUint32(0),this.bitsAvailable=8*e,this.bytesAvailable-=e}skipBits(a){let b;a=Math.min(a,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>a||(a-=this.bitsAvailable,b=a>>3,a-=b<<3,this.bytesAvailable-=b,this.loadWord()),this.word<<=a,this.bitsAvailable-=a}readBits(a){let b=Math.min(this.bitsAvailable,a),c=this.word>>>32-b;if(a>32&&I.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=b,this.bitsAvailable>0)this.word<<=b;else if(this.bytesAvailable>0)this.loadWord();else throw Error("no bits available");return(b=a-b)>0&&this.bitsAvailable?c<<b|this.readBits(b):c}skipLZ(){let a;for(a=0;a<this.bitsAvailable;++a)if((this.word&0x80000000>>>a)!=0)return this.word<<=a,this.bitsAvailable-=a,a;return this.loadWord(),a+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){let a=this.skipLZ();return this.readBits(a+1)-1}readEG(){let a=this.readUEG();return 1&a?1+a>>>1:-1*(a>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(a){let b=8,c=8;for(let d=0;d<a;d++)0!==c&&(c=(b+this.readEG()+256)%256),b=0===c?b:c}readSPS(){let a,b,c,d=0,e=0,f=0,g=0,h=this.readUByte.bind(this),i=this.readBits.bind(this),j=this.readUEG.bind(this),k=this.readBoolean.bind(this),l=this.skipBits.bind(this),m=this.skipEG.bind(this),n=this.skipUEG.bind(this),o=this.skipScalingList.bind(this);h();let p=h();if(i(5),l(3),h(),n(),100===p||110===p||122===p||244===p||44===p||83===p||86===p||118===p||128===p){let a=j();if(3===a&&l(1),n(),n(),l(1),k())for(c=0,b=3!==a?8:12;c<b;c++)k()&&o(c<6?16:64)}n();let q=j();if(0===q)j();else if(1===q)for(l(1),m(),m(),a=j(),c=0;c<a;c++)m();n(),l(1);let r=j(),s=j(),t=i(1);0===t&&l(1),l(1),k()&&(d=j(),e=j(),f=j(),g=j());let u=[1,1];if(k()&&k())switch(h()){case 1:u=[1,1];break;case 2:u=[12,11];break;case 3:u=[10,11];break;case 4:u=[16,11];break;case 5:u=[40,33];break;case 6:u=[24,11];break;case 7:u=[20,11];break;case 8:u=[32,11];break;case 9:u=[80,33];break;case 10:u=[18,11];break;case 11:u=[15,11];break;case 12:u=[64,33];break;case 13:u=[160,99];break;case 14:u=[4,3];break;case 15:u=[3,2];break;case 16:u=[2,1];break;case 255:u=[h()<<8|h(),h()<<8|h()]}return{width:Math.ceil((r+1)*16-2*d-2*e),height:(2-t)*(s+1)*16-(t?2:4)*(f+g),pixelRatio:u}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class c8 extends c6{parseAVCPES(a,b,c,d,e){let f,g=this.parseAVCNALu(a,c.data),h=this.VideoSample,i=!1;c.data=null,h&&g.length&&!a.audFound&&(this.pushAccessUnit(h,a),h=this.VideoSample=this.createVideoSample(!1,c.pts,c.dts,"")),g.forEach(d=>{var g,j,k,l;switch(d.type){case 1:{let b=!1;f=!0;let e=d.data;if(i&&e.length>4){let a=new c7(e).readSliceType();(2===a||4===a||7===a||9===a)&&(b=!0)}b&&null!=(j=h)&&j.frame&&!h.key&&(this.pushAccessUnit(h,a),h=this.VideoSample=null),h||(h=this.VideoSample=this.createVideoSample(!0,c.pts,c.dts,"")),h.frame=!0,h.key=b;break}case 5:f=!0,null!=(g=h)&&g.frame&&!h.key&&(this.pushAccessUnit(h,a),h=this.VideoSample=null),h||(h=this.VideoSample=this.createVideoSample(!0,c.pts,c.dts,"")),h.key=!0,h.frame=!0;break;case 6:f=!0,aR(d.data,1,c.pts,b.samples);break;case 7:{f=!0,i=!0;let b=d.data,c=new c7(b).readSPS();if(!a.sps||a.width!==c.width||a.height!==c.height||(null==(k=a.pixelRatio)?void 0:k[0])!==c.pixelRatio[0]||(null==(l=a.pixelRatio)?void 0:l[1])!==c.pixelRatio[1]){a.width=c.width,a.height=c.height,a.pixelRatio=c.pixelRatio,a.sps=[b],a.duration=e;let d=b.subarray(1,4),f="avc1.";for(let a=0;a<3;a++){let b=d[a].toString(16);b.length<2&&(b="0"+b),f+=b}a.codec=f}break}case 8:f=!0,a.pps=[d.data];break;case 9:f=!0,a.audFound=!0,h&&this.pushAccessUnit(h,a),h=this.VideoSample=this.createVideoSample(!1,c.pts,c.dts,"");break;case 12:f=!0;break;default:f=!1,h&&(h.debug+="unknown NAL "+d.type+" ")}h&&f&&h.units.push(d)}),d&&h&&(this.pushAccessUnit(h,a),this.VideoSample=null)}parseAVCNALu(a,b){let c,d,e,f=b.byteLength,g=a.naluState||0,h=g,i=[],j=0,k=-1,l=0;for(-1===g&&(k=0,l=31&b[0],g=0,j=1);j<f;){if(c=b[j++],!g){g=+!c;continue}if(1===g){g=2*!c;continue}if(c)if(1===c){if(d=j-g-1,k>=0){let a={data:b.subarray(k,d),type:l};i.push(a)}else{let c=this.getLastNalUnit(a.samples);c&&(h&&j<=4-h&&c.state&&(c.data=c.data.subarray(0,c.data.byteLength-h)),d>0&&(c.data=aP(c.data,b.subarray(0,d)),c.state=0))}j<f?(e=31&b[j],k=j,l=e,g=0):g=-1}else g=0;else g=3}if(k>=0&&g>=0){let a={data:b.subarray(k,f),type:l,state:g};i.push(a)}if(0===i.length){let c=this.getLastNalUnit(a.samples);c&&(c.data=aP(c.data,b))}return a.naluState=g,i}}class c9{constructor(a,b,c){this.keyData=void 0,this.decrypter=void 0,this.keyData=c,this.decrypter=new cw(b,{removePKCS7Padding:!1})}decryptBuffer(a){return this.decrypter.decrypt(a,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(a,b,c){let d=a[b].unit;if(d.length<=16)return;let e=d.subarray(16,d.length-d.length%16),f=e.buffer.slice(e.byteOffset,e.byteOffset+e.length);this.decryptBuffer(f).then(e=>{let f=new Uint8Array(e);d.set(f,16),this.decrypter.isSync()||this.decryptAacSamples(a,b+1,c)})}decryptAacSamples(a,b,c){for(;;b++){if(b>=a.length)return void c();if(!(a[b].unit.length<32)&&(this.decryptAacSample(a,b,c),!this.decrypter.isSync()))return}}getAvcEncryptedData(a){let b=new Int8Array(16*Math.floor((a.length-48)/160)+16),c=0;for(let d=32;d<a.length-16;d+=160,c+=16)b.set(a.subarray(d,d+16),c);return b}getAvcDecryptedUnit(a,b){let c=new Uint8Array(b),d=0;for(let b=32;b<a.length-16;b+=160,d+=16)a.set(c.subarray(d,d+16),b);return a}decryptAvcSample(a,b,c,d,e){let f=aS(e.data),g=this.getAvcEncryptedData(f);this.decryptBuffer(g.buffer).then(g=>{e.data=this.getAvcDecryptedUnit(f,g),this.decrypter.isSync()||this.decryptAvcSamples(a,b,c+1,d)})}decryptAvcSamples(a,b,c,d){if(a instanceof Uint8Array)throw Error("Cannot decrypt samples of type Uint8Array");for(;;b++,c=0){if(b>=a.length)return void d();let e=a[b].units;for(;!(c>=e.length);c++){let f=e[c];if(!(f.data.length<=48)&&(1===f.type||5===f.type)&&(this.decryptAvcSample(a,b,c,d,f),!this.decrypter.isSync()))return}}}}class da{constructor(a,b,c){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=a,this.config=b,this.typeSupported=c,this.videoParser=new c8}static probe(a){let b=da.syncOffset(a);return b>0&&I.warn(`MPEG2-TS detected but first sync word found @ offset ${b}`),-1!==b}static syncOffset(a){let b=a.length,c=Math.min(940,b-188)+1,d=0;for(;d<c;){let e=!1,f=-1,g=0;for(let h=d;h<b;h+=188)if(71===a[h]&&(b-h==188||71===a[h+188])){if(g++,-1===f&&0!==(f=h)&&(c=Math.min(f+18612,a.length-188)+1),e||(e=0===db(a,h)),e&&g>1&&(0===f&&g>2||h+188>c))return f}else if(g)return -1;else break;d++}return -1}static createTrack(a,b){return{container:"video"===a||"audio"===a?"video/mp2t":void 0,type:a,id:aC[a],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===a?b:void 0}}resetInitSegment(a,b,c,d){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=da.createTrack("video"),this._audioTrack=da.createTrack("audio",d),this._id3Track=da.createTrack("id3"),this._txtTrack=da.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=b,this.videoCodec=c,this._duration=d}resetTimeStamp(){}resetContiguity(){let{_audioTrack:a,_videoTrack:b,_id3Track:c}=this;a&&(a.pesData=null),b&&(b.pesData=null),c&&(c.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(a,b,c=!1,d=!1){let e;c||(this.sampleAes=null);let f=this._videoTrack,g=this._audioTrack,h=this._id3Track,i=this._txtTrack,j=f.pid,k=f.pesData,l=g.pid,m=h.pid,n=g.pesData,o=h.pesData,p=null,q=this.pmtParsed,r=this._pmtId,s=a.length;if(this.remainderData&&(s=(a=aP(this.remainderData,a)).length,this.remainderData=null),s<188&&!d)return this.remainderData=a,{audioTrack:g,videoTrack:f,id3Track:h,textTrack:i};let t=Math.max(0,da.syncOffset(a));(s-=(s-t)%188)<a.byteLength&&!d&&(this.remainderData=new Uint8Array(a.buffer,s,a.buffer.byteLength-s));let u=0;for(let b=t;b<s;b+=188)if(71===a[b]){let d,s=!!(64&a[b+1]),u=db(a,b);if((48&a[b+3])>>4>1){if((d=b+5+a[b+4])===b+188)continue}else d=b+4;switch(u){case j:s&&(k&&(e=de(k))&&this.videoParser.parseAVCPES(f,i,e,!1,this._duration),k={data:[],size:0}),k&&(k.data.push(a.subarray(d,b+188)),k.size+=b+188-d);break;case l:if(s){if(n&&(e=de(n)))switch(g.segmentCodec){case"aac":this.parseAACPES(g,e);break;case"mp3":this.parseMPEGPES(g,e);break;case"ac3":this.parseAC3PES(g,e)}n={data:[],size:0}}n&&(n.data.push(a.subarray(d,b+188)),n.size+=b+188-d);break;case m:s&&(o&&(e=de(o))&&this.parseID3PES(h,e),o={data:[],size:0}),o&&(o.data.push(a.subarray(d,b+188)),o.size+=b+188-d);break;case 0:var v,w;s&&(d+=a[d]+1),r=this._pmtId=(31&(v=a)[(w=d)+10])<<8|v[w+11];break;case r:{s&&(d+=a[d]+1);let e=function(a,b,c,d,e){let f={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},g=(15&a[b+1])<<8|a[b+2],h=b+3+g-4,i=(15&a[b+10])<<8|a[b+11];for(b+=12+i;b<h;){let g=db(a,b),h=(15&a[b+3])<<8|a[b+4];switch(a[b]){case 207:if(!d){dd("ADTS AAC");break}case 15:-1===f.audioPid&&(f.audioPid=g);break;case 21:-1===f.id3Pid&&(f.id3Pid=g);break;case 219:if(!d){dd("H.264");break}case 27:-1===f.videoPid&&(f.videoPid=g,f.segmentVideoCodec="avc");break;case 3:case 4:c.mpeg||c.mp3?-1===f.audioPid&&(f.audioPid=g,f.segmentAudioCodec="mp3"):I.log("MPEG audio found, not supported in this browser");break;case 193:if(!d){dd("AC-3");break}case 129:c.ac3?-1===f.audioPid&&(f.audioPid=g,f.segmentAudioCodec="ac3"):I.log("AC-3 audio found, not supported in this browser");break;case 6:if(-1===f.audioPid&&h>0){let d=b+5,e=h;for(;e>2;){106===a[d]&&(!0!==c.ac3?I.log("AC-3 audio found, not supported in this browser for now"):(f.audioPid=g,f.segmentAudioCodec="ac3"));let b=a[d+1]+2;d+=b,e-=b}}break;case 194:case 135:return dc(e,Error("Unsupported EC-3 in M2TS found")),f;case 36:return dc(e,Error("Unsupported HEVC in M2TS found")),f}b+=h+5}return f}(a,d,this.typeSupported,c,this.observer);(j=e.videoPid)>0&&(f.pid=j,f.segmentCodec=e.segmentVideoCodec),(l=e.audioPid)>0&&(g.pid=l,g.segmentCodec=e.segmentAudioCodec),(m=e.id3Pid)>0&&(h.pid=m),null===p||q||(I.warn(`MPEG-TS PMT found at ${b} after unknown PID '${p}'. Backtracking to sync byte @${t} to parse all TS packets.`),p=null,b=t-188),q=this.pmtParsed=!0;break}case 17:case 8191:break;default:p=u}}else u++;u>0&&dc(this.observer,Error(`Found ${u} TS packet/s that do not start with 0x47`)),f.pesData=k,g.pesData=n,h.pesData=o;let x={audioTrack:g,videoTrack:f,id3Track:h,textTrack:i};return d&&this.extractRemainingSamples(x),x}flush(){let a,{remainderData:b}=this;return(this.remainderData=null,a=b?this.demux(b,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(a),this.sampleAes)?this.decrypt(a,this.sampleAes):a}extractRemainingSamples(a){let b,{audioTrack:c,videoTrack:d,id3Track:e,textTrack:f}=a,g=d.pesData,h=c.pesData,i=e.pesData;if(g&&(b=de(g))?(this.videoParser.parseAVCPES(d,f,b,!0,this._duration),d.pesData=null):d.pesData=g,h&&(b=de(h))){switch(c.segmentCodec){case"aac":this.parseAACPES(c,b);break;case"mp3":this.parseMPEGPES(c,b);break;case"ac3":this.parseAC3PES(c,b)}c.pesData=null}else null!=h&&h.size&&I.log("last AAC PES packet truncated,might overlap between fragments"),c.pesData=h;i&&(b=de(i))?(this.parseID3PES(e,b),e.pesData=null):e.pesData=i}demuxSampleAes(a,b,c){let d=this.demux(a,c,!0,!this.config.progressive),e=this.sampleAes=new c9(this.observer,this.config,b);return this.decrypt(d,e)}decrypt(a,b){return new Promise(c=>{let{audioTrack:d,videoTrack:e}=a;d.samples&&"aac"===d.segmentCodec?b.decryptAacSamples(d.samples,0,()=>{e.samples?b.decryptAvcSamples(e.samples,0,0,()=>{c(a)}):c(a)}):e.samples&&b.decryptAvcSamples(e.samples,0,0,()=>{c(a)})})}destroy(){this._duration=0}parseAACPES(a,b){let c,d,e,f,g=0,h=this.aacOverFlow,i=b.data;if(h){this.aacOverFlow=null;let b=h.missing,c=h.sample.unit.byteLength;-1===b?i=aP(h.sample.unit,i):(h.sample.unit.set(i.subarray(0,b),c-b),a.samples.push(h.sample),g=h.missing)}for(c=g,d=i.length;c<d-1&&!cS(i,c);c++);if(c!==g){let a,b=c<d-1;if(a=b?`AAC PES did not start with ADTS header,offset:${c}`:"No ADTS header found in AAC PES",dc(this.observer,Error(a),b),!b)return}if(cT(a,this.observer,i,c,this.audioCodec),void 0!==b.pts)e=b.pts;else{if(!h)return void I.warn("[tsdemuxer]: AAC PES unknown PTS");let b=9216e4/a.samplerate;e=h.sample.pts+b}let j=0;for(;c<d;){if(f=cU(a,i,c,e,j),c+=f.length,f.missing){this.aacOverFlow=f;break}for(j++;c<d-1&&!cS(i,c);c++);}}parseMPEGPES(a,b){let c=b.data,d=c.length,e=0,f=0,g=b.pts;if(void 0===g)return void I.warn("[tsdemuxer]: MPEG PES unknown PTS");for(;f<d;)if(c1(c,f)){let b=c$(a,c,f,g,e);if(b)f+=b.length,e++;else break}else f++}parseAC3PES(a,b){{let c,d=b.data,e=b.pts;if(void 0===e)return void I.warn("[tsdemuxer]: AC3 PES unknown PTS");let f=d.length,g=0,h=0;for(;h<f&&(c=c5(a,d,h,e,g++))>0;)h+=c}}parseID3PES(a,b){if(void 0===b.pts)return void I.warn("[tsdemuxer]: ID3 PES unknown PTS");let c=y({},b,{type:this._videoTrack?bA:bz,duration:1/0});a.samples.push(c)}}function db(a,b){return((31&a[b+1])<<8)+a[b+2]}function dc(a,b,c){I.warn(`parsing error: ${b.message}`),a.emit(C.ERROR,C.ERROR,{type:D.MEDIA_ERROR,details:E.FRAG_PARSING_ERROR,fatal:!1,levelRetry:c,error:b,reason:b.message})}function dd(a){I.log(`${a} with AES-128-CBC encryption found in unencrypted stream`)}function de(a){let b,c,d,e,f,g=0,h=a.data;if(!a||0===a.size)return null;for(;h[0].length<19&&h.length>1;)h[0]=aP(h[0],h[1]),h.splice(1,1);if(1===((b=h[0])[0]<<16)+(b[1]<<8)+b[2]){if((c=(b[4]<<8)+b[5])&&c>a.size-6)return null;let i=b[7];192&i&&(e=(14&b[9])*0x20000000+(255&b[10])*4194304+(254&b[11])*16384+(255&b[12])*128+(254&b[13])/2,64&i?e-(f=(14&b[14])*0x20000000+(255&b[15])*4194304+(254&b[16])*16384+(255&b[17])*128+(254&b[18])/2)>54e5&&(I.warn(`${Math.round((e-f)/9e4)}s delta between PTS and DTS, align them`),e=f):f=e);let j=(d=b[8])+9;if(a.size<=j)return null;a.size-=j;let k=new Uint8Array(a.size);for(let a=0,c=h.length;a<c;a++){let c=(b=h[a]).byteLength;if(j)if(j>c){j-=c;continue}else b=b.subarray(j),c-=j,j=0;k.set(b,g),g+=c}return c&&(c-=d+3),{data:k,pts:e,dts:f,len:c}}return null}class df{static getSilentFrame(a,b){if("mp4a.40.2"===a){if(1===b)return new Uint8Array([0,200,0,128,35,128]);if(2===b)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===b)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);else if(4===b)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);else if(5===b)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);else if(6===b)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===b)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===b)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===b)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}class dg{static init(){let a;for(a in dg.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},dg.types)dg.types.hasOwnProperty(a)&&(dg.types[a]=[a.charCodeAt(0),a.charCodeAt(1),a.charCodeAt(2),a.charCodeAt(3)]);dg.HDLR_TYPES={video:new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audio:new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0])};let b=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]);dg.STTS=dg.STSC=dg.STCO=new Uint8Array([0,0,0,0,0,0,0,0]),dg.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),dg.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),dg.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),dg.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);let c=new Uint8Array([105,115,111,109]),d=new Uint8Array([97,118,99,49]),e=new Uint8Array([0,0,0,1]);dg.FTYP=dg.box(dg.types.ftyp,c,e,c,d),dg.DINF=dg.box(dg.types.dinf,dg.box(dg.types.dref,b))}static box(a,...b){let c=8,d=b.length,e=d;for(;d--;)c+=b[d].byteLength;let f=new Uint8Array(c);for(f[0]=c>>24&255,f[1]=c>>16&255,f[2]=c>>8&255,f[3]=255&c,f.set(a,4),d=0,c=8;d<e;d++)f.set(b[d],c),c+=b[d].byteLength;return f}static hdlr(a){return dg.box(dg.types.hdlr,dg.HDLR_TYPES[a])}static mdat(a){return dg.box(dg.types.mdat,a)}static mdhd(a,b){let c=Math.floor((b*=a)/0x100000000),d=Math.floor(b%0x100000000);return dg.box(dg.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,a>>24&255,a>>16&255,a>>8&255,255&a,c>>24,c>>16&255,c>>8&255,255&c,d>>24,d>>16&255,d>>8&255,255&d,85,196,0,0]))}static mdia(a){return dg.box(dg.types.mdia,dg.mdhd(a.timescale,a.duration),dg.hdlr(a.type),dg.minf(a))}static mfhd(a){return dg.box(dg.types.mfhd,new Uint8Array([0,0,0,0,a>>24,a>>16&255,a>>8&255,255&a]))}static minf(a){return"audio"===a.type?dg.box(dg.types.minf,dg.box(dg.types.smhd,dg.SMHD),dg.DINF,dg.stbl(a)):dg.box(dg.types.minf,dg.box(dg.types.vmhd,dg.VMHD),dg.DINF,dg.stbl(a))}static moof(a,b,c){return dg.box(dg.types.moof,dg.mfhd(a),dg.traf(c,b))}static moov(a){let b=a.length,c=[];for(;b--;)c[b]=dg.trak(a[b]);return dg.box.apply(null,[dg.types.moov,dg.mvhd(a[0].timescale,a[0].duration)].concat(c).concat(dg.mvex(a)))}static mvex(a){let b=a.length,c=[];for(;b--;)c[b]=dg.trex(a[b]);return dg.box.apply(null,[dg.types.mvex,...c])}static mvhd(a,b){let c=Math.floor((b*=a)/0x100000000),d=Math.floor(b%0x100000000),e=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,a>>24&255,a>>16&255,a>>8&255,255&a,c>>24,c>>16&255,c>>8&255,255&c,d>>24,d>>16&255,d>>8&255,255&d,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return dg.box(dg.types.mvhd,e)}static sdtp(a){let b,c,d=a.samples||[],e=new Uint8Array(4+d.length);for(b=0;b<d.length;b++)c=d[b].flags,e[b+4]=c.dependsOn<<4|c.isDependedOn<<2|c.hasRedundancy;return dg.box(dg.types.sdtp,e)}static stbl(a){return dg.box(dg.types.stbl,dg.stsd(a),dg.box(dg.types.stts,dg.STTS),dg.box(dg.types.stsc,dg.STSC),dg.box(dg.types.stsz,dg.STSZ),dg.box(dg.types.stco,dg.STCO))}static avc1(a){let b,c,d,e=[],f=[];for(b=0;b<a.sps.length;b++)d=(c=a.sps[b]).byteLength,e.push(d>>>8&255),e.push(255&d),e=e.concat(Array.prototype.slice.call(c));for(b=0;b<a.pps.length;b++)d=(c=a.pps[b]).byteLength,f.push(d>>>8&255),f.push(255&d),f=f.concat(Array.prototype.slice.call(c));let g=dg.box(dg.types.avcC,new Uint8Array([1,e[3],e[4],e[5],255,224|a.sps.length].concat(e).concat([a.pps.length]).concat(f))),h=a.width,i=a.height,j=a.pixelRatio[0],k=a.pixelRatio[1];return dg.box(dg.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,h>>8&255,255&h,i>>8&255,255&i,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),g,dg.box(dg.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),dg.box(dg.types.pasp,new Uint8Array([j>>24,j>>16&255,j>>8&255,255&j,k>>24,k>>16&255,k>>8&255,255&k])))}static esds(a){let b=a.config.length;return new Uint8Array([0,0,0,0,3,23+b,0,1,0,4,15+b,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([b]).concat(a.config).concat([6,1,2]))}static audioStsd(a){let b=a.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,a.channelCount,0,16,0,0,0,0,b>>8&255,255&b,0,0])}static mp4a(a){return dg.box(dg.types.mp4a,dg.audioStsd(a),dg.box(dg.types.esds,dg.esds(a)))}static mp3(a){return dg.box(dg.types[".mp3"],dg.audioStsd(a))}static ac3(a){return dg.box(dg.types["ac-3"],dg.audioStsd(a),dg.box(dg.types.dac3,a.config))}static stsd(a){return"audio"!==a.type?dg.box(dg.types.stsd,dg.STSD,dg.avc1(a)):"mp3"===a.segmentCodec&&"mp3"===a.codec?dg.box(dg.types.stsd,dg.STSD,dg.mp3(a)):"ac3"===a.segmentCodec?dg.box(dg.types.stsd,dg.STSD,dg.ac3(a)):dg.box(dg.types.stsd,dg.STSD,dg.mp4a(a))}static tkhd(a){let b=a.id,c=a.duration*a.timescale,d=a.width,e=a.height,f=Math.floor(c/0x100000000),g=Math.floor(c%0x100000000);return dg.box(dg.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,b>>24&255,b>>16&255,b>>8&255,255&b,0,0,0,0,f>>24,f>>16&255,f>>8&255,255&f,g>>24,g>>16&255,g>>8&255,255&g,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,d>>8&255,255&d,0,0,e>>8&255,255&e,0,0]))}static traf(a,b){let c=dg.sdtp(a),d=a.id,e=Math.floor(b/0x100000000),f=Math.floor(b%0x100000000);return dg.box(dg.types.traf,dg.box(dg.types.tfhd,new Uint8Array([0,0,0,0,d>>24,d>>16&255,d>>8&255,255&d])),dg.box(dg.types.tfdt,new Uint8Array([1,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,f>>24,f>>16&255,f>>8&255,255&f])),dg.trun(a,c.length+16+20+8+16+8+8),c)}static trak(a){return a.duration=a.duration||0xffffffff,dg.box(dg.types.trak,dg.tkhd(a),dg.mdia(a))}static trex(a){let b=a.id;return dg.box(dg.types.trex,new Uint8Array([0,0,0,0,b>>24,b>>16&255,b>>8&255,255&b,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(a,b){let c,d,e,f,g,h,i=a.samples||[],j=i.length,k=12+16*j,l=new Uint8Array(k);for(b+=8+k,l.set([+("video"===a.type),0,15,1,j>>>24&255,j>>>16&255,j>>>8&255,255&j,b>>>24&255,b>>>16&255,b>>>8&255,255&b],0),c=0;c<j;c++)e=(d=i[c]).duration,f=d.size,g=d.flags,h=d.cts,l.set([e>>>24&255,e>>>16&255,e>>>8&255,255&e,f>>>24&255,f>>>16&255,f>>>8&255,255&f,g.isLeading<<2|g.dependsOn,g.isDependedOn<<6|g.hasRedundancy<<4|g.paddingValue<<1|g.isNonSync,61440&g.degradPrio,15&g.degradPrio,h>>>24&255,h>>>16&255,h>>>8&255,255&h],12+16*c);return dg.box(dg.types.trun,l)}static initSegment(a){dg.types||dg.init();let b=dg.moov(a);return aP(dg.FTYP,b)}}function dh(a,b,c=1,d=!1){let e=a*b*c;return d?Math.round(e):e}function di(a,b=!1){return dh(a,1e3,11111111111111112e-21,b)}dg.types=void 0,dg.HDLR_TYPES=void 0,dg.STTS=void 0,dg.STSC=void 0,dg.STCO=void 0,dg.STSZ=void 0,dg.VMHD=void 0,dg.SMHD=void 0,dg.STSD=void 0,dg.FTYP=void 0,dg.DINF=void 0;let dj=null,dk=null;class dl{constructor(a,b,c,d=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=a,this.config=b,this.typeSupported=c,this.ISGenerated=!1,null===dj){const a=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);dj=a?parseInt(a[1]):0}if(null===dk){const a=navigator.userAgent.match(/Safari\/(\d+)/i);dk=a?parseInt(a[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(a){I.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=a}resetNextTimestamp(){I.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){I.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(a){let b=!1,c=a[0].pts,d=a.reduce((a,d)=>{let e=d.pts,f=e-a;return(f<-0x100000000&&(b=!0,f=(e=dm(e,c))-a),f>0)?a:e},c);return b&&I.debug("PTS rollover detected"),d}remux(a,b,c,d,e,f,g,h){let i,j,k,l,m,n,o=e,p=e,q=a.pid>-1,r=b.pid>-1,s=b.samples.length,t=a.samples.length>0,u=g&&s>0||s>1;if((!q||t)&&(!r||u)||this.ISGenerated||g){let c;if(this.ISGenerated){var v,w,x,y;let a=this.videoTrackConfig;a&&(b.width!==a.width||b.height!==a.height||(null==(v=b.pixelRatio)?void 0:v[0])!==(null==(w=a.pixelRatio)?void 0:w[0])||(null==(x=b.pixelRatio)?void 0:x[1])!==(null==(y=a.pixelRatio)?void 0:y[1]))&&this.resetInitSegment()}else k=this.generateIS(a,b,e,f);let d=this.isVideoContiguous,g=-1;if(u&&(g=function(a){for(let b=0;b<a.length;b++)if(a[b].key)return b;return -1}(b.samples),!d&&this.config.forceKeyFrameOnDiscontinuity))if(n=!0,g>0){I.warn(`[mp4-remuxer]: Dropped ${g} out of ${s} video samples due to a missing keyframe`);let a=this.getVideoStartPts(b.samples);b.samples=b.samples.slice(g),b.dropped+=g,p+=(b.samples[0].pts-a)/b.inputTimeScale,c=p}else -1===g&&(I.warn(`[mp4-remuxer]: No keyframe found out of ${s} video samples`),n=!1);if(this.ISGenerated){if(t&&u){let c=this.getVideoStartPts(b.samples),d=(dm(a.samples[0].pts,c)-c)/b.inputTimeScale;o+=Math.max(0,d),p+=Math.max(0,-d)}if(t){if(a.samplerate||(I.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),k=this.generateIS(a,b,e,f)),j=this.remuxAudio(a,o,this.isAudioContiguous,f,r||u||h===bp?p:void 0),u){let c=j?j.endPTS-j.startPTS:0;b.inputTimeScale||(I.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),k=this.generateIS(a,b,e,f)),i=this.remuxVideo(b,p,d,c)}}else u&&(i=this.remuxVideo(b,p,d,0));i&&(i.firstKeyFrame=g,i.independent=-1!==g,i.firstKeyFramePTS=c)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(c.samples.length&&(m=dn(c,e,this._initPTS,this._initDTS)),d.samples.length&&(l=dp(d,e,this._initPTS))),{audio:j,video:i,initSegment:k,independent:n,text:l,id3:m}}generateIS(a,b,c,d){let e,f,g,h=a.samples,i=b.samples,j=this.typeSupported,k={},l=this._initPTS,m=!l||d,n="audio/mp4";if(m&&(e=f=1/0),a.config&&h.length){switch(a.timescale=a.samplerate,a.segmentCodec){case"mp3":j.mpeg?(n="audio/mpeg",a.codec=""):j.mp3&&(a.codec="mp3");break;case"ac3":a.codec="ac-3"}k.audio={id:"audio",container:n,codec:a.codec,initSegment:"mp3"===a.segmentCodec&&j.mpeg?new Uint8Array(0):dg.initSegment([a]),metadata:{channelCount:a.channelCount}},m&&(g=a.inputTimeScale,l&&g===l.timescale?m=!1:e=f=h[0].pts-Math.round(g*c))}if(b.sps&&b.pps&&i.length){if(b.timescale=b.inputTimeScale,k.video={id:"main",container:"video/mp4",codec:b.codec,initSegment:dg.initSegment([b]),metadata:{width:b.width,height:b.height}},m)if(g=b.inputTimeScale,l&&g===l.timescale)m=!1;else{let a=this.getVideoStartPts(i),b=Math.round(g*c);f=Math.min(f,dm(i[0].dts,a)-b),e=Math.min(e,a-b)}this.videoTrackConfig={width:b.width,height:b.height,pixelRatio:b.pixelRatio}}if(Object.keys(k).length)return this.ISGenerated=!0,m?(this._initPTS={baseTime:e,timescale:g},this._initDTS={baseTime:f,timescale:g}):e=g=void 0,{tracks:k,initPTS:e,timescale:g}}remuxVideo(a,b,c,d){let e,f,g,h=a.inputTimeScale,i=a.samples,j=[],k=i.length,l=this._initPTS,m=this.nextAvcDts,n=8,o=this.videoSampleDuration,p=1/0,q=-1/0,r=!1;if(!c||null===m){let a=b*h,d=i[0].pts-dm(i[0].dts,i[0].pts);dj&&null!==m&&15e3>Math.abs(a-d-m)?c=!0:m=a-d}let s=l.baseTime*h/l.timescale;for(let a=0;a<k;a++){let b=i[a];b.pts=dm(b.pts-s,m),b.dts=dm(b.dts-s,m),b.dts<i[a>0?a-1:a].dts&&(r=!0)}r&&i.sort(function(a,b){let c=a.dts-b.dts,d=a.pts-b.pts;return c||d}),e=i[0].dts;let t=(f=i[i.length-1].dts)-e,u=t?Math.round(t/(k-1)):o||a.inputTimeScale/30;if(c){let a=e-m,c=a>u,d=a<-1;if((c||d)&&(c?I.warn(`AVC: ${di(a,!0)} ms (${a}dts) hole between fragments detected at ${b.toFixed(3)}`):I.warn(`AVC: ${di(-a,!0)} ms (${a}dts) overlapping between fragments detected at ${b.toFixed(3)}`),!d||m>=i[0].pts||dj)){e=m;let b=i[0].pts-a;if(c)i[0].dts=e,i[0].pts=b;else for(let c=0;c<i.length&&!(i[c].dts>b);c++)i[c].dts-=a,i[c].pts-=a;I.log(`Video: Initial PTS/DTS adjusted: ${di(b,!0)}/${di(e,!0)}, delta: ${di(a,!0)} ms`)}}let v=0,w=0,x=e=Math.max(0,e);for(let a=0;a<k;a++){let b=i[a],c=b.units,d=c.length,e=0;for(let a=0;a<d;a++)e+=c[a].data.length;w+=e,v+=d,b.length=e,b.dts<x?(b.dts=x,x+=u/4|0||1):x=b.dts,p=Math.min(b.pts,p),q=Math.max(b.pts,q)}f=i[k-1].dts;let z=w+4*v+8;try{g=new Uint8Array(z)}catch(a){this.observer.emit(C.ERROR,C.ERROR,{type:D.MUX_ERROR,details:E.REMUX_ALLOC_ERROR,fatal:!1,error:a,bytes:z,reason:`fail allocating video mdat ${z}`});return}let A=new DataView(g.buffer);A.setUint32(0,z),g.set(dg.types.mdat,4);let B=!1,F=1/0,G=1/0,H=-1/0,J=-1/0;for(let a=0;a<k;a++){let b,c=i[a],e=c.units,f=0;for(let a=0,b=e.length;a<b;a++){let b=e[a],c=b.data,d=b.data.byteLength;A.setUint32(n,d),n+=4,g.set(c,n),n+=d,f+=4+d}if(a<k-1)o=i[a+1].dts-c.dts,b=i[a+1].pts-c.pts;else{let e=this.config,f=a>0?c.dts-i[a-1].dts:u;if(b=a>0?c.pts-i[a-1].pts:u,e.stretchShortVideoTrack&&null!==this.nextAudioPts){let a=Math.floor(e.maxBufferHole*h),b=(d?p+d*h:this.nextAudioPts)-c.pts;b>a?((o=b-f)<0?o=f:B=!0,I.log(`[mp4-remuxer]: It is approximately ${b/90} ms to the next segment; using duration ${o/90} ms for the last video frame.`)):o=f}else o=f}let l=Math.round(c.pts-c.dts);F=Math.min(F,o),H=Math.max(H,o),G=Math.min(G,b),J=Math.max(J,b),j.push(new dq(c.key,o,f,l))}if(j.length){if(dj){if(dj<70){let a=j[0].flags;a.dependsOn=2,a.isNonSync=0}}else if(dk&&J-G<H-F&&u/H<.025&&0===j[0].cts){I.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let a=e;for(let b=0,c=j.length;b<c;b++){let d=a+j[b].duration,e=a+j[b].cts;if(b<c-1){let a=d+j[b+1].cts;j[b].duration=a-e}else j[b].duration=b?j[b-1].duration:u;j[b].cts=0,a=d}}}o=B||!o?u:o,this.nextAvcDts=m=f+o,this.videoSampleDuration=o,this.isVideoContiguous=!0;let K={data1:dg.moof(a.sequenceNumber++,e,y({},a,{samples:j})),data2:g,startPTS:p/h,endPTS:(q+o)/h,startDTS:e/h,endDTS:m/h,type:"video",hasAudio:!1,hasVideo:!0,nb:j.length,dropped:a.dropped};return a.samples=[],a.dropped=0,K}getSamplesPerFrame(a){switch(a.segmentCodec){case"mp3":return 1152;case"ac3":return 1536;default:return 1024}}remuxAudio(a,b,c,d,e){let f,g=a.inputTimeScale,h=a.samplerate?a.samplerate:g,i=g/h,j=this.getSamplesPerFrame(a),k=j*i,l=this._initPTS,m="mp3"===a.segmentCodec&&this.typeSupported.mpeg,n=[],o=void 0!==e,p=a.samples,q=8*!m,r=this.nextAudioPts||-1,s=b*g,t=l.baseTime*g/l.timescale;if(this.isAudioContiguous=c=c||p.length&&r>0&&(d&&9e3>Math.abs(s-r)||Math.abs(dm(p[0].pts-t,s)-r)<20*k),p.forEach(function(a){a.pts=dm(a.pts-t,s)}),!c||r<0){if(!(p=p.filter(a=>a.pts>=0)).length)return;r=0===e?0:d&&!o?Math.max(0,s):p[0].pts}if("aac"===a.segmentCodec){let b=this.config.maxAudioFramesDrift;for(let c=0,d=r;c<p.length;c++){let e=p[c],f=e.pts,h=f-d,i=Math.abs(1e3*h/g);if(h<=-b*k&&o)0===c&&(I.warn(`Audio frame @ ${(f/g).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*h/g)} ms.`),this.nextAudioPts=r=d=f);else if(h>=b*k&&i<1e4&&o){let b=Math.round(h/k);(d=f-b*k)<0&&(b--,d+=k),0===c&&(this.nextAudioPts=r=d),I.warn(`[mp4-remuxer]: Injecting ${b} audio frame @ ${(d/g).toFixed(3)}s due to ${Math.round(1e3*h/g)} ms gap.`);for(let f=0;f<b;f++){let b=Math.max(d,0),f=df.getSilentFrame(a.manifestCodec||a.codec,a.channelCount);f||(I.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),f=e.unit.subarray()),p.splice(c,0,{unit:f,pts:b}),d+=k,c++}}e.pts=d,d+=k}}let u=null,v=null,w=0,x=p.length;for(;x--;)w+=p[x].unit.byteLength;for(let b=0,d=p.length;b<d;b++){let d=p[b],e=d.unit,g=d.pts;if(null!==v)n[b-1].duration=Math.round((g-v)/i);else{if(c&&"aac"===a.segmentCodec&&(g=r),u=g,!(w>0))return;w+=q;try{f=new Uint8Array(w)}catch(a){this.observer.emit(C.ERROR,C.ERROR,{type:D.MUX_ERROR,details:E.REMUX_ALLOC_ERROR,fatal:!1,error:a,bytes:w,reason:`fail allocating audio mdat ${w}`});return}m||(new DataView(f.buffer).setUint32(0,w),f.set(dg.types.mdat,4))}f.set(e,q);let h=e.byteLength;q+=h,n.push(new dq(!0,j,h,0)),v=g}let z=n.length;if(!z)return;let A=n[n.length-1];this.nextAudioPts=r=v+i*A.duration;let B=m?new Uint8Array(0):dg.moof(a.sequenceNumber++,u/i,y({},a,{samples:n}));a.samples=[];let F=u/g,G=r/g,H={data1:B,data2:f,startPTS:F,endPTS:G,startDTS:F,endDTS:G,type:"audio",hasAudio:!0,hasVideo:!1,nb:z};return this.isAudioContiguous=!0,H}remuxEmptyAudio(a,b,c,d){let e=a.inputTimeScale,f=a.samplerate?a.samplerate:e,g=this.nextAudioPts,h=this._initDTS,i=9e4*h.baseTime/h.timescale,j=(null!==g?g:d.startDTS*e)+i,k=d.endDTS*e+i,l=e/f*1024,m=Math.ceil((k-j)/l),n=df.getSilentFrame(a.manifestCodec||a.codec,a.channelCount);if(I.warn("[mp4-remuxer]: remux empty Audio"),!n)return void I.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");let o=[];for(let a=0;a<m;a++){let b=j+a*l;o.push({unit:n,pts:b,dts:b})}return a.samples=o,this.remuxAudio(a,b,c,!1)}}function dm(a,b){let c;if(null===b)return a;for(c=b<a?-0x200000000:0x200000000;Math.abs(a-b)>0x100000000;)a+=c;return a}function dn(a,b,c,d){let e=a.samples.length;if(!e)return;let f=a.inputTimeScale;for(let g=0;g<e;g++){let e=a.samples[g];e.pts=dm(e.pts-c.baseTime*f/c.timescale,b*f)/f,e.dts=dm(e.dts-d.baseTime*f/d.timescale,b*f)/f}let g=a.samples;return a.samples=[],{samples:g}}function dp(a,b,c){let d=a.samples.length;if(!d)return;let e=a.inputTimeScale;for(let f=0;f<d;f++){let d=a.samples[f];d.pts=dm(d.pts-c.baseTime*e/c.timescale,b*e)/e}a.samples.sort((a,b)=>a.pts-b.pts);let f=a.samples;return a.samples=[],{samples:f}}class dq{constructor(a,b,c,d){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=b,this.size=c,this.cts=d,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:a?2:1,isNonSync:+!a}}}function dr(a,b){let c=null==a?void 0:a.codec;if(c&&c.length>4)return c;if(b===O){if("ec-3"===c||"ac-3"===c||"alac"===c)return c;if("fLaC"===c||"Opus"===c)return a6(c,!1);let a="mp4a.40.5";return I.info(`Parsed audio codec "${c}" or audio object type not handled. Using "${a}"`),a}return(I.warn(`Unhandled video codec "${c}"`),"hvc1"===c||"hev1"===c)?"hvc1.1.6.L120.90":"av01"===c?"av01.0.04M.08":"avc1.42e01e"}try{c=self.performance.now.bind(self.performance)}catch(a){I.debug("Unable to use Performance API on this environment"),c=null==X?void 0:X.Date.now}let ds=[{demux:class{constructor(a,b){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=b}resetTimeStamp(){}resetInitSegment(a,b,c,d){let e=this.videoTrack=cM("video",1),f=this.audioTrack=cM("audio",1),g=this.txtTrack=cM("text",1);if(this.id3Track=cM("id3",1),this.timeOffset=0,!(null!=a&&a.byteLength))return;let h=aK(a);if(h.video){let{id:a,timescale:b,codec:c}=h.video;e.id=a,e.timescale=g.timescale=b,e.codec=c}if(h.audio){let{id:a,timescale:b,codec:c}=h.audio;f.id=a,f.timescale=b,f.codec=c}g.id=aC.text,e.sampleDuration=0,e.duration=f.duration=d}resetContiguity(){this.remainderData=null}static probe(a){let b=a.byteLength;for(let c=0;c<b;){let d=aF(a,c);if(d>8&&109===a[c+4]&&111===a[c+5]&&111===a[c+6]&&102===a[c+7])return!0;c=d>1?c+d:b}return!1}demux(a,b){this.timeOffset=b;let c=a,d=this.videoTrack,e=this.txtTrack;if(this.config.progressive){this.remainderData&&(c=aP(this.remainderData,a));let b=function(a){let b={valid:null,remainder:null},c=aJ(a,["moof"]);if(c.length<2)return b.remainder=a,b;let d=c[c.length-1];return b.valid=ak(a,0,d.byteOffset-8),b.remainder=ak(a,d.byteOffset-8),b}(c);this.remainderData=b.remainder,d.samples=b.valid||new Uint8Array}else d.samples=c;let f=this.extractID3Track(d,b);return e.samples=aQ(b,d),{videoTrack:d,audioTrack:this.audioTrack,id3Track:f,textTrack:this.txtTrack}}flush(){let a=this.timeOffset,b=this.videoTrack,c=this.txtTrack;b.samples=this.remainderData||new Uint8Array,this.remainderData=null;let d=this.extractID3Track(b,this.timeOffset);return c.samples=aQ(a,b),{videoTrack:b,audioTrack:cM(),id3Track:d,textTrack:cM()}}extractID3Track(a,b){let c=this.id3Track;return a.samples.length&&aJ(a.samples,["emsg"]).forEach(a=>{let d=function(a){let b=a[0],c="",d="",e=0,f=0,g=0,h=0,i=0,j=0;if(0===b){for(;"\0"!==aD(a.subarray(j,j+1));)c+=aD(a.subarray(j,j+1)),j+=1;for(c+=aD(a.subarray(j,j+1)),j+=1;"\0"!==aD(a.subarray(j,j+1));)d+=aD(a.subarray(j,j+1)),j+=1;d+=aD(a.subarray(j,j+1)),j+=1,e=aF(a,12),f=aF(a,16),h=aF(a,20),i=aF(a,24),j=28}else if(1===b){j+=4,e=aF(a,j);let b=aF(a,j+=4),f=aF(a,j+=4);for(j+=4,A(g=0x100000000*b+f)||(g=Number.MAX_SAFE_INTEGER,I.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),h=aF(a,j),j+=4,i=aF(a,j),j+=4;"\0"!==aD(a.subarray(j,j+1));)c+=aD(a.subarray(j,j+1)),j+=1;for(c+=aD(a.subarray(j,j+1)),j+=1;"\0"!==aD(a.subarray(j,j+1));)d+=aD(a.subarray(j,j+1)),j+=1;d+=aD(a.subarray(j,j+1)),j+=1}return{schemeIdUri:c,value:d,timeScale:e,presentationTime:g,presentationTimeDelta:f,eventDuration:h,id:i,payload:a.subarray(j,a.byteLength)}}(a);if(c3.test(d.schemeIdUri)){let a=z(d.presentationTime)?d.presentationTime/d.timeScale:b+d.presentationTimeDelta/d.timeScale,e=0xffffffff===d.eventDuration?1/0:d.eventDuration/d.timeScale;e<=.001&&(e=1/0);let f=d.payload;c.samples.push({data:f,len:f.byteLength,dts:a,pts:a,type:bA,duration:e})}}),c}demuxSampleAes(a,b,c){return Promise.reject(Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}},remux:class{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(a){this.initPTS=a,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(a,b,c,d){this.audioCodec=b,this.videoCodec=c,this.generateInitSegment(function(a,b){if(!a||!b)return a;let c=b.keyId;return c&&b.isCommonEncryption&&aJ(a,["moov","trak"]).forEach(a=>{let b=aJ(a,["mdia","minf","stbl","stsd"])[0].subarray(8),d=aJ(b,["enca"]),e=d.length>0;e||(d=aJ(b,["encv"])),d.forEach(a=>{aJ(e?a.subarray(28):a.subarray(78),["sinf"]).forEach(a=>{let b=aO(a);if(b){let a=b.subarray(8,24);a.some(a=>0!==a)||(I.log(`[eme] Patching keyId in 'enc${e?"a":"v"}>sinf>>tenc' box: ${aA(a)} -> ${aA(c)}`),b.set(c,8))}})})}),a}(a,d)),this.emitInitSegment=!0}generateInitSegment(a){let{audioCodec:b,videoCodec:c}=this;if(!(null!=a&&a.byteLength)){this.initTracks=void 0,this.initData=void 0;return}let d=this.initData=aK(a);d.audio&&(b=dr(d.audio,O)),d.video&&(c=dr(d.video,P));let e={};d.audio&&d.video?e.audiovideo={container:"video/mp4",codec:b+","+c,initSegment:a,id:"main"}:d.audio?e.audio={container:"audio/mp4",codec:b,initSegment:a,id:"audio"}:d.video?e.video={container:"video/mp4",codec:c,initSegment:a,id:"main"}:I.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=e}remux(a,b,c,d,e,f){var g,h,i,j,k;let{initPTS:l,lastEndTime:m}=this,n={audio:void 0,video:void 0,text:d,id3:c,initSegment:void 0};z(m)||(m=this.lastEndTime=e||0);let o=b.samples;if(!(null!=o&&o.length))return n;let p={initPTS:void 0,timescale:1},q=this.initData;if(null!=(g=q)&&g.length||(this.generateInitSegment(o),q=this.initData),!(null!=(h=q)&&h.length))return I.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),n;this.emitInitSegment&&(p.tracks=this.initTracks,this.emitInitSegment=!1);let r=function(a,b){let c=0,d=0,e=0,f=aJ(a,["moof","traf"]);for(let a=0;a<f.length;a++){let g=f[a],h=aJ(g,["tfhd"])[0],i=b[aF(h,4)];if(!i)continue;let j=i.default,k=aF(h,0)|(null==j?void 0:j.flags),l=null==j?void 0:j.duration;8&k&&(l=2&k?aF(h,12):aF(h,8));let m=i.timescale||9e4,n=aJ(g,["trun"]);for(let a=0;a<n.length;a++)(c=function(a){let b=aF(a,0),c=8;1&b&&(c+=4),4&b&&(c+=4);let d=0,e=aF(a,4);for(let f=0;f<e;f++)256&b&&(d+=aF(a,c),c+=4),512&b&&(c+=4),1024&b&&(c+=4),2048&b&&(c+=4);return d}(n[a]))||!l||(c=l*aF(n[a],4)),i.type===P?d+=c/m:i.type===O&&(e+=c/m)}if(0===d&&0===e){let b=1/0,c=0,d=0,e=aJ(a,["sidx"]);for(let a=0;a<e.length;a++){let f=function(a){let b=[],c=a[0],d=8,e=aF(a,8);d+=4;let f=0,g=0;0===c?(f=aF(a,d),g=aF(a,d+4),d+=8):(f=aG(a,d),g=aG(a,d+8),d+=16),d+=2;let h=a.length+g,i=aE(a,d);d+=2;for(let c=0;c<i;c++){let c=d,f=aF(a,c);c+=4;let g=0x7fffffff&f;if(1==(0x80000000&f)>>>31)return I.warn("SIDX has hierarchical references (not supported)"),null;let i=aF(a,c);c+=4,b.push({referenceSize:g,subsegmentDuration:i,info:{duration:i/e,start:h,end:h+g-1}}),h+=g,c+=4,d=c}return{earliestPresentationTime:f,timescale:e,version:c,referencesCount:i,references:b}}(e[a]);null!=f&&f.references&&(b=Math.min(b,f.earliestPresentationTime/f.timescale),d=(c=Math.max(c,f.references.reduce((a,b)=>a+b.info.duration||0,0)+f.earliestPresentationTime/f.timescale))-b)}if(d&&z(d))return d}return d||e}(o,q),s=(i=q,aJ(o,["moof","traf"]).reduce((a,b)=>{let c=aJ(b,["tfdt"])[0],d=c[0],e=aJ(b,["tfhd"]).reduce((a,b)=>{let e=i[aF(b,4)];if(e){let b=aF(c,4);if(1===d){if(0xffffffff===b)return I.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),a;b*=0x100000000,b+=aF(c,8)}let f=b/(e.timescale||9e4);if(z(f)&&(null===a||f<a))return f}return a},null);return null!==e&&z(e)&&(null===a||e<a)?e:a},null)),t=null===s?e:s;((function(a,b,c,d){if(null===a)return!0;let e=Math.max(d,1);return Math.abs(b-a.baseTime/a.timescale-c)>e})(l,t,e,r)||p.timescale!==l.timescale&&f)&&(p.initPTS=t-e,l&&1===l.timescale&&I.warn(`Adjusting initPTS by ${p.initPTS-l.baseTime}`),this.initPTS=l={baseTime:p.initPTS,timescale:1});let u=a?t-l.baseTime/l.timescale:m,v=u+r;j=q,k=l.baseTime/l.timescale,aJ(o,["moof","traf"]).forEach(a=>{aJ(a,["tfhd"]).forEach(b=>{let c=j[aF(b,4)];if(!c)return;let d=c.timescale||9e4;aJ(a,["tfdt"]).forEach(a=>{let b=a[0],c=k*d;if(c){let d=aF(a,4);if(0===b)d-=c,aI(a,4,d=Math.max(d,0));else{d*=0x100000000,d+=aF(a,8),d-=c;let b=Math.floor((d=Math.max(d,0))/0x100000000),e=Math.floor(d%0x100000000);aI(a,4,b),aI(a,8,e)}}})})}),r>0?this.lastEndTime=v:(I.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());let w=!!q.audio,x=!!q.video,y="";w&&(y+="audio"),x&&(y+="video");let A={data1:o,startPTS:u,startDTS:u,endPTS:v,endDTS:v,type:y,hasAudio:w,hasVideo:x,nb:1,dropped:0};return n.audio="audio"===A.type?A:void 0,n.video="audio"!==A.type?A:void 0,n.initSegment=p,n.id3=dn(c,e,l,l),d.samples.length&&(n.text=dp(d,e,l)),n}}},{demux:da,remux:dl},{demux:class extends cN{constructor(a,b){super(),this.observer=void 0,this.config=void 0,this.observer=a,this.config=b}resetInitSegment(a,b,c,d){super.resetInitSegment(a,b,c,d),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:b,duration:d,inputTimeScale:9e4,dropped:0}}static probe(a){if(!a)return!1;let b=an(a,0),c=(null==b?void 0:b.length)||0;if(c2(a,c))return!1;for(let b=a.length;c<b;c++)if(function(a,b){if(cS(a,b)){let c=cQ(a,b);if(b+c>=a.length)return!1;let d=cR(a,b);if(d<=c)return!1;let e=b+d;return e===a.length||cS(a,e)}return!1}(a,c))return I.log("ADTS sync word found !"),!0;return!1}canParse(a,b){return b+5<a.length&&cP(a,b)&&cR(a,b)<=a.length-b}appendFrame(a,b,c){cT(a,this.observer,b,c,a.manifestCodec);let d=cU(a,b,c,this.basePTS,this.frameIndex);if(d&&0===d.missing)return d}},remux:dl},{demux:class extends cN{resetInitSegment(a,b,c,d){super.resetInitSegment(a,b,c,d),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:b,duration:d,inputTimeScale:9e4,dropped:0}}static probe(a){if(!a)return!1;let b=an(a,0),c=(null==b?void 0:b.length)||0;if(b&&11===a[c]&&119===a[c+1]&&void 0!==aq(b)&&16>=c4(a,c))return!1;for(let b=a.length;c<b;c++)if(c2(a,c))return I.log("MPEG Audio sync word found !"),!0;return!1}canParse(a,b){return c0(a,b)&&4<=a.length-b}appendFrame(a,b,c){if(null!==this.basePTS)return c$(a,b,c,this.basePTS,this.frameIndex)}},remux:dl}];ds.splice(2,0,{demux:class extends cN{constructor(a){super(),this.observer=void 0,this.observer=a}resetInitSegment(a,b,c,d){super.resetInitSegment(a,b,c,d),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:b,duration:d,inputTimeScale:9e4,dropped:0}}canParse(a,b){return b+64<a.length}appendFrame(a,b,c){let d=c5(a,b,c,this.basePTS,this.frameIndex);if(-1!==d)return{sample:a.samples[a.samples.length-1],length:d,missing:0}}static probe(a){if(!a)return!1;let b=an(a,0);if(!b)return!1;let c=b.length;return!!(11===a[c]&&119===a[c+1]&&void 0!==aq(b)&&16>c4(a,c))}},remux:dl});class dt{constructor(a,b,c,d,e){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=a,this.typeSupported=b,this.config=c,this.vendor=d,this.id=e}configure(a){this.transmuxConfig=a,this.decrypter&&this.decrypter.reset()}push(a,b,d,e){var f,g;let h,i=d.transmuxing;i.executeStart=c();let j=new Uint8Array(a),{currentTransmuxState:k,transmuxConfig:l}=this;e&&(this.currentTransmuxState=e);let{contiguous:m,discontinuity:n,trackSwitch:o,accurateTimeOffset:p,timeOffset:q,initSegmentChange:r}=e||k,{audioCodec:s,videoCodec:t,defaultInitPts:u,duration:v,initSegmentData:w}=l,x=(f=j,g=b,h=null,f.byteLength>0&&(null==g?void 0:g.key)!=null&&null!==g.iv&&null!=g.method&&(h=g),h);if(x&&"AES-128"===x.method){let a=this.getDecrypter();if(!a.isSync())return this.decryptionPromise=a.webCryptoDecrypt(j,x.key.buffer,x.iv.buffer).then(a=>{let b=this.push(a,null,d);return this.decryptionPromise=null,b}),this.decryptionPromise;{let b=a.softwareDecrypt(j,x.key.buffer,x.iv.buffer);if(d.part>-1&&(b=a.flush()),!b)return i.executeEnd=c(),du(d);j=new Uint8Array(b)}}let y=this.needsProbing(n,o);if(y){let a=this.configureTransmuxer(j);if(a)return I.warn(`[transmuxer] ${a.message}`),this.observer.emit(C.ERROR,C.ERROR,{type:D.MEDIA_ERROR,details:E.FRAG_PARSING_ERROR,fatal:!1,error:a,reason:a.message}),i.executeEnd=c(),du(d)}(n||o||r||y)&&this.resetInitSegment(w,s,t,v,b),(n||r||y)&&this.resetInitialTimestamp(u),m||this.resetContiguity();let z=this.transmux(j,x,q,p,d),A=this.currentTransmuxState;return A.contiguous=!0,A.discontinuity=!1,A.trackSwitch=!1,i.executeEnd=c(),z}flush(a){let b=a.transmuxing;b.executeStart=c();let{decrypter:d,currentTransmuxState:e,decryptionPromise:f}=this;if(f)return f.then(()=>this.flush(a));let g=[],{timeOffset:h}=e;if(d){let b=d.flush();b&&g.push(this.push(b,null,a))}let{demuxer:i,remuxer:j}=this;if(!i||!j)return b.executeEnd=c(),[du(a)];let k=i.flush(h);return dv(k)?k.then(b=>(this.flushRemux(g,b,a),g)):(this.flushRemux(g,k,a),g)}flushRemux(a,b,d){let{audioTrack:e,videoTrack:f,id3Track:g,textTrack:h}=b,{accurateTimeOffset:i,timeOffset:j}=this.currentTransmuxState;I.log(`[transmuxer.ts]: Flushed fragment ${d.sn}${d.part>-1?" p: "+d.part:""} of level ${d.level}`);let k=this.remuxer.remux(e,f,g,h,j,i,!0,this.id);a.push({remuxResult:k,chunkMeta:d}),d.transmuxing.executeEnd=c()}resetInitialTimestamp(a){let{demuxer:b,remuxer:c}=this;b&&c&&(b.resetTimeStamp(a),c.resetTimeStamp(a))}resetContiguity(){let{demuxer:a,remuxer:b}=this;a&&b&&(a.resetContiguity(),b.resetNextTimestamp())}resetInitSegment(a,b,c,d,e){let{demuxer:f,remuxer:g}=this;f&&g&&(f.resetInitSegment(a,b,c,d),g.resetInitSegment(a,b,c,e))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(a,b,c,d,e){return b&&"SAMPLE-AES"===b.method?this.transmuxSampleAes(a,b,c,d,e):this.transmuxUnencrypted(a,c,d,e)}transmuxUnencrypted(a,b,c,d){let{audioTrack:e,videoTrack:f,id3Track:g,textTrack:h}=this.demuxer.demux(a,b,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(e,f,g,h,b,c,!1,this.id),chunkMeta:d}}transmuxSampleAes(a,b,c,d,e){return this.demuxer.demuxSampleAes(a,b,c).then(a=>({remuxResult:this.remuxer.remux(a.audioTrack,a.videoTrack,a.id3Track,a.textTrack,c,d,!1,this.id),chunkMeta:e}))}configureTransmuxer(a){let b,{config:c,observer:d,typeSupported:e,vendor:f}=this;for(let c=0,d=ds.length;c<d;c++){var g;if(null!=(g=ds[c].demux)&&g.probe(a)){b=ds[c];break}}if(!b)return Error("Failed to find demuxer by probing fragment data");let h=this.demuxer,i=this.remuxer,j=b.remux,k=b.demux;i&&i instanceof j||(this.remuxer=new j(d,c,e,f)),h&&h instanceof k||(this.demuxer=new k(d,c,e),this.probe=k.probe)}needsProbing(a,b){return!this.demuxer||!this.remuxer||a||b}getDecrypter(){let a=this.decrypter;return a||(a=this.decrypter=new cw(this.config)),a}}let du=a=>({remuxResult:{},chunkMeta:a});function dv(a){return"then"in a&&a.then instanceof Function}class dw{constructor(a,b,c,d,e){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=a,this.videoCodec=b,this.initSegmentData=c,this.duration=d,this.defaultInitPts=e||null}}class dx{constructor(a,b,c,d,e,f){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=a,this.contiguous=b,this.accurateTimeOffset=c,this.trackSwitch=d,this.timeOffset=e,this.initSegmentChange=f}}var dy={exports:{}};!function(a){var b=Object.prototype.hasOwnProperty,c="~";function d(){}function e(a,b,c){this.fn=a,this.context=b,this.once=c||!1}function f(a,b,d,f,g){if("function"!=typeof d)throw TypeError("The listener must be a function");var h=new e(d,f||a,g),i=c?c+b:b;return a._events[i]?a._events[i].fn?a._events[i]=[a._events[i],h]:a._events[i].push(h):(a._events[i]=h,a._eventsCount++),a}function g(a,b){0==--a._eventsCount?a._events=new d:delete a._events[b]}function h(){this._events=new d,this._eventsCount=0}Object.create&&(d.prototype=Object.create(null),new d().__proto__||(c=!1)),h.prototype.eventNames=function(){var a,d,e=[];if(0===this._eventsCount)return e;for(d in a=this._events)b.call(a,d)&&e.push(c?d.slice(1):d);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(a)):e},h.prototype.listeners=function(a){var b=c?c+a:a,d=this._events[b];if(!d)return[];if(d.fn)return[d.fn];for(var e=0,f=d.length,g=Array(f);e<f;e++)g[e]=d[e].fn;return g},h.prototype.listenerCount=function(a){var b=c?c+a:a,d=this._events[b];return d?d.fn?1:d.length:0},h.prototype.emit=function(a,b,d,e,f,g){var h=c?c+a:a;if(!this._events[h])return!1;var i,j,k=this._events[h],l=arguments.length;if(k.fn){switch(k.once&&this.removeListener(a,k.fn,void 0,!0),l){case 1:return k.fn.call(k.context),!0;case 2:return k.fn.call(k.context,b),!0;case 3:return k.fn.call(k.context,b,d),!0;case 4:return k.fn.call(k.context,b,d,e),!0;case 5:return k.fn.call(k.context,b,d,e,f),!0;case 6:return k.fn.call(k.context,b,d,e,f,g),!0}for(j=1,i=Array(l-1);j<l;j++)i[j-1]=arguments[j];k.fn.apply(k.context,i)}else{var m,n=k.length;for(j=0;j<n;j++)switch(k[j].once&&this.removeListener(a,k[j].fn,void 0,!0),l){case 1:k[j].fn.call(k[j].context);break;case 2:k[j].fn.call(k[j].context,b);break;case 3:k[j].fn.call(k[j].context,b,d);break;case 4:k[j].fn.call(k[j].context,b,d,e);break;default:if(!i)for(m=1,i=Array(l-1);m<l;m++)i[m-1]=arguments[m];k[j].fn.apply(k[j].context,i)}}return!0},h.prototype.on=function(a,b,c){return f(this,a,b,c,!1)},h.prototype.once=function(a,b,c){return f(this,a,b,c,!0)},h.prototype.removeListener=function(a,b,d,e){var f=c?c+a:a;if(!this._events[f])return this;if(!b)return g(this,f),this;var h=this._events[f];if(h.fn)h.fn!==b||e&&!h.once||d&&h.context!==d||g(this,f);else{for(var i=0,j=[],k=h.length;i<k;i++)(h[i].fn!==b||e&&!h[i].once||d&&h[i].context!==d)&&j.push(h[i]);j.length?this._events[f]=1===j.length?j[0]:j:g(this,f)}return this},h.prototype.removeAllListeners=function(a){var b;return a?(b=c?c+a:a,this._events[b]&&g(this,b)):(this._events=new d,this._eventsCount=0),this},h.prototype.off=h.prototype.removeListener,h.prototype.addListener=h.prototype.on,h.prefixed=c,h.EventEmitter=h,a.exports=h}(dy);var dz=(n=dy.exports)&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n;class dA{constructor(a,b,c,d){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const e=a.config;this.hls=a,this.id=b,this.useWorker=!!e.enableWorker,this.onTransmuxComplete=c,this.onFlush=d;const f=(a,b)=>{(b=b||{}).frag=this.frag,b.id=this.id,a===C.ERROR&&(this.error=b.error),this.hls.trigger(a,b)};this.observer=new dz,this.observer.on(C.FRAG_DECRYPTED,f),this.observer.on(C.ERROR,f);const g=aZ(e.preferManagedMediaSource)||{isTypeSupported:()=>!1},h={mpeg:g.isTypeSupported("audio/mpeg"),mp3:g.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:g.isTypeSupported('audio/mp4; codecs="ac-3"')};if(this.useWorker&&"u">typeof Worker&&(e.workerPath||"function"==typeof __HLS_WORKER_BUNDLE__)){try{e.workerPath?(I.log(`loading Web Worker ${e.workerPath} for "${b}"`),this.workerContext=function(a){let b=new self.URL(a,self.location.href).href;return{worker:new self.Worker(b),scriptURL:b}}(e.workerPath)):(I.log(`injecting Web Worker for "${b}"`),this.workerContext=function(){let a=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),b=self.URL.createObjectURL(a);return{worker:new self.Worker(b),objectURL:b}}()),this.onwmsg=a=>this.onWorkerMessage(a);const{worker:a}=this.workerContext;a.addEventListener("message",this.onwmsg),a.onerror=a=>{let c=Error(`${a.message}  (${a.filename}:${a.lineno})`);e.enableWorker=!1,I.warn(`Error in "${b}" Web Worker, fallback to inline`),this.hls.trigger(C.ERROR,{type:D.OTHER_ERROR,details:E.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:c})},a.postMessage({cmd:"init",typeSupported:h,vendor:"",id:b,config:JSON.stringify(e)})}catch(a){I.warn(`Error setting up "${b}" Web Worker, fallback to inline`,a),this.resetWorker(),this.error=null,this.transmuxer=new dt(this.observer,h,e,"",b)}return}this.transmuxer=new dt(this.observer,h,e,"",b)}resetWorker(){if(this.workerContext){let{worker:a,objectURL:b}=this.workerContext;b&&self.URL.revokeObjectURL(b),a.removeEventListener("message",this.onwmsg),a.onerror=null,a.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{let a=this.transmuxer;a&&(a.destroy(),this.transmuxer=null)}let a=this.observer;a&&a.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(a,b,c,d,e,f,g,h,i,j){var k,l;i.transmuxing.start=self.performance.now();let{transmuxer:m}=this,n=f?f.start:e.start,o=e.decryptdata,p=this.frag,q=!(p&&e.cc===p.cc),r=!(p&&i.level===p.level),s=p?i.sn-p.sn:-1,t=this.part?i.part-this.part.index:-1,u=0===s&&i.id>1&&i.id===(null==p?void 0:p.stats.chunkCount),v=!r&&(1===s||0===s&&(1===t||u&&t<=0)),w=self.performance.now();(r||s||0===e.stats.parsing.start)&&(e.stats.parsing.start=w),f&&(t||!v)&&(f.stats.parsing.start=w);let x=!(p&&(null==(k=e.initSegment)?void 0:k.url)===(null==(l=p.initSegment)?void 0:l.url)),y=new dx(q,v,h,r,n,x);if(!v||q||x){I.log(`[transmuxer-interface, ${e.type}]: Starting new transmux session for sn: ${i.sn} p: ${i.part} level: ${i.level} id: ${i.id}
        discontinuity: ${q}
        trackSwitch: ${r}
        contiguous: ${v}
        accurateTimeOffset: ${h}
        timeOffset: ${n}
        initSegmentChange: ${x}`);let a=new dw(c,d,b,g,j);this.configureTransmuxer(a)}if(this.frag=e,this.part=f,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:a,decryptdata:o,chunkMeta:i,state:y},a instanceof ArrayBuffer?[a]:[]);else if(m){let b=m.push(a,o,i,y);dv(b)?(m.async=!0,b.then(a=>{this.handleTransmuxComplete(a)}).catch(a=>{this.transmuxerError(a,i,"transmuxer-interface push error")})):(m.async=!1,this.handleTransmuxComplete(b))}}flush(a){a.transmuxing.start=self.performance.now();let{transmuxer:b}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:a});else if(b){let c=b.flush(a);dv(c)||b.async?(dv(c)||(c=Promise.resolve(c)),c.then(b=>{this.handleFlushResult(b,a)}).catch(b=>{this.transmuxerError(b,a,"transmuxer-interface flush error")})):this.handleFlushResult(c,a)}}transmuxerError(a,b,c){this.hls&&(this.error=a,this.hls.trigger(C.ERROR,{type:D.MEDIA_ERROR,details:E.FRAG_PARSING_ERROR,chunkMeta:b,frag:this.frag||void 0,fatal:!1,error:a,err:a,reason:c}))}handleFlushResult(a,b){a.forEach(a=>{this.handleTransmuxComplete(a)}),this.onFlush(b)}onWorkerMessage(a){let b=a.data;if(!(null!=b&&b.event))return void I.warn(`worker message received with no ${b?"event name":"data"}`);let c=this.hls;if(this.hls)switch(b.event){case"init":{var d;let a=null==(d=this.workerContext)?void 0:d.objectURL;a&&self.URL.revokeObjectURL(a);break}case"transmuxComplete":this.handleTransmuxComplete(b.data);break;case"flush":this.onFlush(b.data);break;case"workerLog":I[b.data.logType]&&I[b.data.logType](b.data.message);break;default:b.data=b.data||{},b.data.frag=this.frag,b.data.id=this.id,c.trigger(b.event,b.data)}}configureTransmuxer(a){let{transmuxer:b}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:a}):b&&b.configure(a)}handleTransmuxComplete(a){a.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(a)}}function dB(a,b){if(a.length!==b.length)return!1;for(let c=0;c<a.length;c++)if(!dC(a[c].attrs,b[c].attrs))return!1;return!0}function dC(a,b,c){let d=a["STABLE-RENDITION-ID"];return d&&!c?d===b["STABLE-RENDITION-ID"]:!(c||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(c=>a[c]!==b[c])}function dD(a,b){return b.label.toLowerCase()===a.name.toLowerCase()&&(!b.language||b.language.toLowerCase()===(a.lang||"").toLowerCase())}class dE{constructor(a){this.buffered=void 0;const b=(b,c,d)=>{if((c>>>=0)>d-1)throw new DOMException(`Failed to execute '${b}' on 'TimeRanges': The index provided (${c}) is greater than the maximum bound (${d})`);return a[c][b]};this.buffered={get length(){return a.length},end:c=>b("end",c,a.length),start:c=>b("start",c,a.length)}}}class dF{constructor(a){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=a}append(a,b,c){let d=this.queues[b];d.push(a),1!==d.length||c||this.executeNext(b)}insertAbort(a,b){this.queues[b].unshift(a),this.executeNext(b)}appendBlocker(a){let b,c=new Promise(a=>{b=a}),d={execute:b,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(d,a),c}executeNext(a){let b=this.queues[a];if(b.length){let c=b[0];try{c.execute()}catch(d){I.warn(`[buffer-operation-queue]: Exception executing "${a}" SourceBuffer operation: ${d}`),c.onError(d);let b=this.buffers[a];null!=b&&b.updating||this.shiftAndExecuteNext(a)}}}shiftAndExecuteNext(a){this.queues[a].shift(),this.executeNext(a)}current(a){return this.queues[a][0]}}let dG=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;function dH(a){let b=a.querySelectorAll("source");[].slice.call(b).forEach(b=>{a.removeChild(b)})}let dI={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},dJ=a=>String.fromCharCode(dI[a]||a),dK={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},dL={17:2,18:4,21:6,22:8,23:10,19:13,20:15},dM={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},dN={25:2,26:4,29:6,30:8,31:10,27:13,28:15},dO=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class dP{constructor(){this.time=null,this.verboseLevel=0}log(a,b){if(this.verboseLevel>=a){let c="function"==typeof b?b():b;I.log(`${this.time} [${a}] ${c}`)}}}let dQ=function(a){let b=[];for(let c=0;c<a.length;c++)b.push(a[c].toString(16));return b};class dR{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(a){let b=["foreground","underline","italics","background","flash"];for(let c=0;c<b.length;c++){let d=b[c];a.hasOwnProperty(d)&&(this[d]=a[d])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(a){return this.foreground===a.foreground&&this.underline===a.underline&&this.italics===a.italics&&this.background===a.background&&this.flash===a.flash}copy(a){this.foreground=a.foreground,this.underline=a.underline,this.italics=a.italics,this.background=a.background,this.flash=a.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class dS{constructor(){this.uchar=" ",this.penState=new dR}reset(){this.uchar=" ",this.penState.reset()}setChar(a,b){this.uchar=a,this.penState.copy(b)}setPenState(a){this.penState.copy(a)}equals(a){return this.uchar===a.uchar&&this.penState.equals(a.penState)}copy(a){this.uchar=a.uchar,this.penState.copy(a.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class dT{constructor(a){this.chars=[],this.pos=0,this.currPenState=new dR,this.cueStartTime=null,this.logger=void 0;for(let a=0;a<100;a++)this.chars.push(new dS);this.logger=a}equals(a){for(let b=0;b<100;b++)if(!this.chars[b].equals(a.chars[b]))return!1;return!0}copy(a){for(let b=0;b<100;b++)this.chars[b].copy(a.chars[b])}isEmpty(){let a=!0;for(let b=0;b<100;b++)if(!this.chars[b].isEmpty()){a=!1;break}return a}setCursor(a){this.pos!==a&&(this.pos=a),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>100&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=100)}moveCursor(a){let b=this.pos+a;if(a>1)for(let a=this.pos+1;a<b+1;a++)this.chars[a].setPenState(this.currPenState);this.setCursor(b)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(a){a>=144&&this.backSpace();let b=dJ(a);this.pos>=100?this.logger.log(0,()=>"Cannot insert "+a.toString(16)+" ("+b+") at position "+this.pos+". Skipping it!"):(this.chars[this.pos].setChar(b,this.currPenState),this.moveCursor(1))}clearFromPos(a){let b;for(b=a;b<100;b++)this.chars[b].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){let a=[],b=!0;for(let c=0;c<100;c++){let d=this.chars[c].uchar;" "!==d&&(b=!1),a.push(d)}return b?"":a.join("")}setPenStyles(a){this.currPenState.setStyles(a),this.chars[this.pos].setPenState(this.currPenState)}}class dU{constructor(a){this.rows=[],this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let b=0;b<15;b++)this.rows.push(new dT(a));this.logger=a}reset(){for(let a=0;a<15;a++)this.rows[a].clear();this.currRow=14}equals(a){let b=!0;for(let c=0;c<15;c++)if(!this.rows[c].equals(a.rows[c])){b=!1;break}return b}copy(a){for(let b=0;b<15;b++)this.rows[b].copy(a.rows[b])}isEmpty(){let a=!0;for(let b=0;b<15;b++)if(!this.rows[b].isEmpty()){a=!1;break}return a}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(a){this.rows[this.currRow].insertChar(a)}setPen(a){this.rows[this.currRow].setPenStyles(a)}moveCursor(a){this.rows[this.currRow].moveCursor(a)}setCursor(a){this.logger.log(2,"setCursor: "+a),this.rows[this.currRow].setCursor(a)}setPAC(a){this.logger.log(2,()=>"pacData = "+JSON.stringify(a));let b=a.row-1;if(this.nrRollUpRows&&b<this.nrRollUpRows-1&&(b=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==b){for(let a=0;a<15;a++)this.rows[a].clear();let a=this.currRow+1-this.nrRollUpRows,c=this.lastOutputScreen;if(c){let d=c.rows[a].cueStartTime,e=this.logger.time;if(null!==d&&null!==e&&d<e)for(let d=0;d<this.nrRollUpRows;d++)this.rows[b-this.nrRollUpRows+d+1].copy(c.rows[a+d])}}this.currRow=b;let c=this.rows[this.currRow];if(null!==a.indent){let b=Math.max(a.indent-1,0);c.setCursor(a.indent),a.color=c.chars[b].penState.foreground}let d={foreground:a.color,underline:a.underline,italics:a.italics,background:"black",flash:!1};this.setPen(d)}setBkgData(a){this.logger.log(2,()=>"bkgData = "+JSON.stringify(a)),this.backSpace(),this.setPen(a),this.insertChar(32)}setRollUpRows(a){this.nrRollUpRows=a}rollUp(){if(null===this.nrRollUpRows)return void this.logger.log(3,"roll_up but nrRollUpRows not set yet");this.logger.log(1,()=>this.getDisplayText());let a=this.currRow+1-this.nrRollUpRows,b=this.rows.splice(a,1)[0];b.clear(),this.rows.splice(this.currRow,0,b),this.logger.log(2,"Rolling up")}getDisplayText(a){a=a||!1;let b=[],c="",d=-1;for(let c=0;c<15;c++){let e=this.rows[c].getTextString();e&&(d=c+1,a?b.push("Row "+d+": '"+e+"'"):b.push(e.trim()))}return b.length>0&&(c=a?"["+b.join(" | ")+"]":b.join("\n")),c}getTextAndFormat(){return this.rows}}class dV{constructor(a,b,c){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=a,this.outputFilter=b,this.mode=null,this.verbose=0,this.displayedMemory=new dU(c),this.nonDisplayedMemory=new dU(c),this.lastOutputScreen=new dU(c),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=c}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(a){this.outputFilter=a}setPAC(a){this.writeScreen.setPAC(a)}setBkgData(a){this.writeScreen.setBkgData(a)}setMode(a){a!==this.mode&&(this.mode=a,this.logger.log(2,()=>"MODE="+a),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=a)}insertChars(a){for(let b=0;b<a.length;b++)this.writeScreen.insertChar(a[b]);let b=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>b+": "+this.writeScreen.getDisplayText(!0)),("MODE_PAINT-ON"===this.mode||"MODE_ROLL-UP"===this.mode)&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(a){this.logger.log(2,"RU("+a+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(a)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){let a=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=a,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(a){this.logger.log(2,"TO("+a+") - Tab Offset"),this.writeScreen.moveCursor(a)}ccMIDROW(a){let b={flash:!1};(b.underline=a%2==1,b.italics=a>=46,b.italics)?b.foreground="white":b.foreground=["white","green","blue","cyan","red","yellow","magenta"][Math.floor(a/2)-16],this.logger.log(2,"MIDROW: "+JSON.stringify(b)),this.writeScreen.setPen(b)}outputDataUpdate(a=!1){let b=this.logger.time;null!==b&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,b,this.lastOutputScreen),a&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:b):this.cueStartTime=b,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(a){this.outputFilter&&!this.displayedMemory.isEmpty()&&(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,a,this.displayedMemory),this.cueStartTime=a)}}class dW{constructor(a,b,c){this.channels=void 0,this.currentChannel=0,this.cmdHistory={a:null,b:null},this.logger=void 0;const d=this.logger=new dP;this.channels=[null,new dV(a,b,d),new dV(a+1,c,d)]}getHandler(a){return this.channels[a].getHandler()}setHandler(a,b){this.channels[a].setHandler(b)}addData(a,b){this.logger.time=a;for(let a=0;a<b.length;a+=2){var c,d,e,f,g,h,i,j;let k=127&b[a],l=127&b[a+1],m=!1,n=null;if(0===k&&0===l)continue;this.logger.log(3,()=>"["+dQ([b[a],b[a+1]])+"] -> ("+dQ([k,l])+")");let o=this.cmdHistory;if(k>=16&&k<=31){if(c=k,d=l,(e=o).a===c&&e.b===d){(f=o).a=null,f.b=null,this.logger.log(3,()=>"Repeated command ("+dQ([k,l])+") is dropped");continue}g=k,h=l,(i=this.cmdHistory).a=g,i.b=h,(m=this.parseCmd(k,l))||(m=this.parseMidrow(k,l)),m||(m=this.parsePAC(k,l)),m||(m=this.parseBackgroundAttributes(k,l))}else{(j=o).a=null,j.b=null}if(!m&&(n=this.parseChars(k,l))){let a=this.currentChannel;a&&a>0?this.channels[a].insertChars(n):this.logger.log(2,"No channel found yet. TEXT-MODE?")}m||n||this.logger.log(2,()=>"Couldn't parse cleaned data "+dQ([k,l])+" orig: "+dQ([b[a],b[a+1]]))}}parseCmd(a,b){if(!((20===a||28===a||21===a||29===a)&&b>=32&&b<=47||(23===a||31===a)&&b>=33&&b<=35))return!1;let c=20===a||21===a||23===a?1:2,d=this.channels[c];return 20===a||21===a||28===a||29===a?32===b?d.ccRCL():33===b?d.ccBS():34===b?d.ccAOF():35===b?d.ccAON():36===b?d.ccDER():37===b?d.ccRU(2):38===b?d.ccRU(3):39===b?d.ccRU(4):40===b?d.ccFON():41===b?d.ccRDC():42===b?d.ccTR():43===b?d.ccRTD():44===b?d.ccEDM():45===b?d.ccCR():46===b?d.ccENM():47===b&&d.ccEOC():d.ccTO(b-32),this.currentChannel=c,!0}parseMidrow(a,b){let c=0;if((17===a||25===a)&&b>=32&&b<=47){if((c=17===a?1:2)!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;let d=this.channels[c];return!!d&&(d.ccMIDROW(b),this.logger.log(3,()=>"MIDROW ("+dQ([a,b])+")"),!0)}return!1}parsePAC(a,b){let c,d=(a>=17&&a<=23||a>=25&&a<=31)&&b>=64&&b<=127,e=(16===a||24===a)&&b>=64&&b<=95;if(!(d||e))return!1;let f=a<=23?1:2;c=b>=64&&b<=95?1===f?dK[a]:dM[a]:1===f?dL[a]:dN[a];let g=this.channels[f];return!!g&&(g.setPAC(this.interpretPAC(c,b)),this.currentChannel=f,!0)}interpretPAC(a,b){let c,d={color:null,italics:!1,indent:null,underline:!1,row:a};return d.underline=(1&(c=b>95?b-96:b-64))==1,c<=13?d.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(c/2)]:c<=15?(d.italics=!0,d.color="white"):d.indent=4*Math.floor((c-16)/2),d}parseChars(a,b){let c,d=null,e=null;if(a>=25?(c=2,e=a-8):(c=1,e=a),e>=17&&e<=19){let a;a=17===e?b+80:18===e?b+112:b+144,this.logger.log(2,()=>"Special char '"+dJ(a)+"' in channel "+c),d=[a]}else a>=32&&a<=127&&(d=0===b?[a]:[a,b]);return d&&this.logger.log(3,()=>"Char codes =  "+dQ(d).join(",")),d}parseBackgroundAttributes(a,b){if(!((16===a||24===a)&&b>=32&&b<=47||(23===a||31===a)&&b>=45&&b<=47))return!1;let c={};return 16===a||24===a?(c.background=dO[Math.floor((b-32)/2)],b%2==1&&(c.background=c.background+"_semi")):45===b?c.background="transparent":(c.foreground="black",47===b&&(c.underline=!0)),this.channels[a<=23?1:2].setBkgData(c),!0}reset(){var a;for(let a=0;a<Object.keys(this.channels).length;a++){let b=this.channels[a];b&&b.reset()}(a=this.cmdHistory).a=null,a.b=null}cueSplitAtTime(a){for(let b=0;b<this.channels.length;b++){let c=this.channels[b];c&&c.cueSplitAtTime(a)}}}class dX{constructor(a,b){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=a,this.trackName=b}dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(a,b,c){(null===this.startTime||this.startTime>a)&&(this.startTime=a),this.endTime=b,this.screen=c,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var dY=function(){if(null!=X&&X.VTTCue)return self.VTTCue;let a=["","lr","rl"],b=["start","middle","end","left","right"];function c(a,b){if("string"!=typeof b||!Array.isArray(a))return!1;let c=b.toLowerCase();return!!~a.indexOf(c)&&c}function d(a){let b=1;for(;b<arguments.length;b++){let c=arguments[b];for(let b in c)a[b]=c[b]}return a}function e(e,f,g){let h={enumerable:!0};this.hasBeenReset=!1;let i="",j=!1,k=e,l=f,m=g,n=null,o="",p=!0,q="auto",r="start",s=50,t="middle",u=50,v="middle";Object.defineProperty(this,"id",d({},h,{get:function(){return i},set:function(a){i=""+a}})),Object.defineProperty(this,"pauseOnExit",d({},h,{get:function(){return j},set:function(a){j=!!a}})),Object.defineProperty(this,"startTime",d({},h,{get:function(){return k},set:function(a){if("number"!=typeof a)throw TypeError("Start time must be set to a number.");k=a,this.hasBeenReset=!0}})),Object.defineProperty(this,"endTime",d({},h,{get:function(){return l},set:function(a){if("number"!=typeof a)throw TypeError("End time must be set to a number.");l=a,this.hasBeenReset=!0}})),Object.defineProperty(this,"text",d({},h,{get:function(){return m},set:function(a){m=""+a,this.hasBeenReset=!0}})),Object.defineProperty(this,"region",d({},h,{get:function(){return n},set:function(a){n=a,this.hasBeenReset=!0}})),Object.defineProperty(this,"vertical",d({},h,{get:function(){return o},set:function(b){let d=c(a,b);if(!1===d)throw SyntaxError("An invalid or illegal string was specified.");o=d,this.hasBeenReset=!0}})),Object.defineProperty(this,"snapToLines",d({},h,{get:function(){return p},set:function(a){p=!!a,this.hasBeenReset=!0}})),Object.defineProperty(this,"line",d({},h,{get:function(){return q},set:function(a){if("number"!=typeof a&&"auto"!==a)throw SyntaxError("An invalid number or illegal string was specified.");q=a,this.hasBeenReset=!0}})),Object.defineProperty(this,"lineAlign",d({},h,{get:function(){return r},set:function(a){let d=c(b,a);if(!d)throw SyntaxError("An invalid or illegal string was specified.");r=d,this.hasBeenReset=!0}})),Object.defineProperty(this,"position",d({},h,{get:function(){return s},set:function(a){if(a<0||a>100)throw Error("Position must be between 0 and 100.");s=a,this.hasBeenReset=!0}})),Object.defineProperty(this,"positionAlign",d({},h,{get:function(){return t},set:function(a){let d=c(b,a);if(!d)throw SyntaxError("An invalid or illegal string was specified.");t=d,this.hasBeenReset=!0}})),Object.defineProperty(this,"size",d({},h,{get:function(){return u},set:function(a){if(a<0||a>100)throw Error("Size must be between 0 and 100.");u=a,this.hasBeenReset=!0}})),Object.defineProperty(this,"align",d({},h,{get:function(){return v},set:function(a){let d=c(b,a);if(!d)throw SyntaxError("An invalid or illegal string was specified.");v=d,this.hasBeenReset=!0}})),this.displayState=void 0}return e.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},e}();class dZ{decode(a,b){if(!a)return"";if("string"!=typeof a)throw Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(a))}}function d$(a){function b(a,b,c,d){return(0|a)*3600+(0|b)*60+(0|c)+parseFloat(d||0)}let c=a.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return c?parseFloat(c[2])>59?b(c[2],c[3],0,c[4]):b(c[1],c[2],c[3],c[4]):null}class d_{constructor(){this.values=Object.create(null)}set(a,b){this.get(a)||""===b||(this.values[a]=b)}get(a,b,c){return c?this.has(a)?this.values[a]:b[c]:this.has(a)?this.values[a]:b}has(a){return a in this.values}alt(a,b,c){for(let d=0;d<c.length;++d)if(b===c[d]){this.set(a,b);break}}integer(a,b){/^-?\d+$/.test(b)&&this.set(a,parseInt(b,10))}percent(a,b){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(b)){let c=parseFloat(b);if(c>=0&&c<=100)return this.set(a,c),!0}return!1}}function d0(a,b,c,d){let e=d?a.split(d):[a];for(let a in e){if("string"!=typeof e[a])continue;let d=e[a].split(c);if(2===d.length)b(d[0],d[1])}}let d1=new dY(0,0,""),d2="middle"===d1.align?"middle":"center";function d3(a){return a.replace(/<br(?: \/)?>/gi,"\n")}class d4{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new dZ,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(a){let b=this;function c(){let a=b.buffer,c=0;for(a=d3(a);c<a.length&&"\r"!==a[c]&&"\n"!==a[c];)++c;let d=a.slice(0,c);return"\r"===a[c]&&++c,"\n"===a[c]&&++c,b.buffer=a.slice(c),d}a&&(b.buffer+=b.decoder.decode(a,{stream:!0}));try{let a="";if("INITIAL"===b.state){if(!/\r\n|\n/.test(b.buffer))return this;let d=(a=c()).match(/^()?WEBVTT([ \t].*)?$/);if(!(null!=d&&d[0]))throw Error("Malformed WebVTT signature.");b.state="HEADER"}let e=!1;for(;b.buffer&&/\r\n|\n/.test(b.buffer);)switch(e?e=!1:a=c(),b.state){case"HEADER":if(/:/.test(a)){var d;d=a,d0(d,function(a,b){},/:/)}else a||(b.state="ID");continue;case"NOTE":a||(b.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(a)){b.state="NOTE";break}if(!a)continue;if(b.cue=new dY(0,0,""),b.state="CUE",-1===a.indexOf("-->")){b.cue.id=a;continue}case"CUE":if(!b.cue){b.state="BADCUE";continue}try{!function(a,b,c){var d;let e,f,g,h=a;function i(){let b=d$(a);if(null===b)throw Error("Malformed timestamp: "+h);return a=a.replace(/^[^\sa-zA-Z-]+/,""),b}function j(){a=a.replace(/^\s+/,"")}if(j(),b.startTime=i(),j(),"-->"!==a.slice(0,3))throw Error("Malformed time stamp (time stamps must be separated by '-->'): "+h);a=a.slice(3),j(),b.endTime=i(),j(),d=a,e=new d_,d0(d,function(a,b){let d;switch(a){case"region":for(let d=c.length-1;d>=0;d--)if(c[d].id===b){e.set(a,c[d].region);break}break;case"vertical":e.alt(a,b,["rl","lr"]);break;case"line":d=b.split(","),e.integer(a,d[0]),e.percent(a,d[0])&&e.set("snapToLines",!1),e.alt(a,d[0],["auto"]),2===d.length&&e.alt("lineAlign",d[1],["start",d2,"end"]);break;case"position":d=b.split(","),e.percent(a,d[0]),2===d.length&&e.alt("positionAlign",d[1],["start",d2,"end","line-left","line-right","auto"]);break;case"size":e.percent(a,b);break;case"align":e.alt(a,b,["start",d2,"end","left","right"])}},/:/,/\s/),b.region=e.get("region",null),b.vertical=e.get("vertical",""),"auto"===(f=e.get("line","auto"))&&-1===d1.line&&(f=-1),b.line=f,b.lineAlign=e.get("lineAlign","start"),b.snapToLines=e.get("snapToLines",!0),b.size=e.get("size",100),b.align=e.get("align",d2),"auto"===(g=e.get("position","auto"))&&50===d1.position&&(g="start"===b.align||"left"===b.align?0:"end"===b.align||"right"===b.align?100:50),b.position=g}(a,b.cue,b.regionList)}catch(a){b.cue=null,b.state="BADCUE";continue}b.state="CUETEXT";continue;case"CUETEXT":{let c=-1!==a.indexOf("-->");if(!a||c&&(e=!0)){b.oncue&&b.cue&&b.oncue(b.cue),b.cue=null,b.state="ID";continue}if(null===b.cue)continue;b.cue.text&&(b.cue.text+="\n"),b.cue.text+=a}continue;case"BADCUE":a||(b.state="ID")}}catch(a){"CUETEXT"===b.state&&b.cue&&b.oncue&&b.oncue(b.cue),b.cue=null,b.state="INITIAL"===b.state?"BADWEBVTT":"BADCUE"}return this}flush(){try{if((this.cue||"HEADER"===this.state)&&(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state||"BADWEBVTT"===this.state)throw Error("Malformed WebVTT signature.")}catch(a){this.onparsingerror&&this.onparsingerror(a)}return this.onflush&&this.onflush(),this}}let d5=/\r\n|\n\r|\n|\r/g,d6=function(a,b,c=0){return a.slice(c,c+b.length)===b},d7=function(a){let b=parseInt(a.slice(-3)),c=parseInt(a.slice(-6,-4)),d=parseInt(a.slice(-9,-7)),e=a.length>9?parseInt(a.substring(0,a.indexOf(":"))):0;if(!z(b)||!z(c)||!z(d)||!z(e))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${a}`);return b+=1e3*c,b+=6e4*d,b+=36e5*e},d8=function(a){let b=5381,c=a.length;for(;c;)b=33*b^a.charCodeAt(--c);return(b>>>0).toString()};function d9(a,b,c){return d8(a.toString())+d8(b.toString())+d8(c)}let ea=function(a,b,c){let d=a[b],e=a[d.prevCC];if(!e||!e.new&&d.new){a.ccOffset=a.presentationOffset=d.start,d.new=!1;return}for(;null!=(f=e)&&f.new;){var f;a.ccOffset+=d.start-e.start,d.new=!1,e=a[(d=e).prevCC]}a.presentationOffset=c},eb="stpp.ttml.im1t",ec=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,ed=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,ee={left:"start",center:"center",right:"end",start:"start",end:"end"};function ef(a,b,c,d){let e=aJ(new Uint8Array(a),["mdat"]);if(0===e.length)return void d(Error("Could not parse IMSC1 mdat"));let f=e.map(a=>az(a)),g=function(a,b,c=1,d=!1){return dh(a,1,1/c,d)}(b.baseTime,0,b.timescale);try{f.forEach(a=>c(function(a,b){let c=new DOMParser().parseFromString(a,"text/xml").getElementsByTagName("tt")[0];if(!c)throw Error("Invalid ttml");let d={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},e=Object.keys(d).reduce((a,b)=>(a[b]=c.getAttribute(`ttp:${b}`)||d[b],a),{}),f="preserve"!==c.getAttribute("xml:space"),g=eh(eg(c,"styling","style")),h=eh(eg(c,"layout","region")),i=eg(c,"body","[begin]");return[].map.call(i,a=>{var c,d,i;let j,k,l,m=function a(b,c){return[].slice.call(b.childNodes).reduce((b,d,e)=>{var f;return"br"===d.nodeName&&e?b+"\n":null!=(f=d.childNodes)&&f.length?a(d,c):c?b+d.textContent.trim().replace(/\s+/g," "):b+d.textContent},"")}(a,f);if(!m||!a.hasAttribute("begin"))return null;let n=ek(a.getAttribute("begin"),e),o=ek(a.getAttribute("dur"),e),p=ek(a.getAttribute("end"),e);if(null===n)throw ej(a);if(null===p){if(null===o)throw ej(a);p=n+o}let q=new dY(n-b,p-b,m);q.id=d9(q.startTime,q.endTime,q.text);let r=(c=h[a.getAttribute("region")],d=g[a.getAttribute("style")],i=g,j="http://www.w3.org/ns/ttml#styling",k=null,(l=null!=c&&c.hasAttribute("style")?c.getAttribute("style"):null)&&i.hasOwnProperty(l)&&(k=i[l]),["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"].reduce((a,b)=>{let e=ei(d,j,b)||ei(c,j,b)||ei(k,j,b);return e&&(a[b]=e),a},{})),{textAlign:s}=r;if(s){let a=ee[s];a&&(q.lineAlign=a),q.align=s}return y(q,r),q}).filter(a=>null!==a)}(a,g)))}catch(a){d(a)}}function eg(a,b,c){let d=a.getElementsByTagName(b)[0];return d?[].slice.call(d.querySelectorAll(c)):[]}function eh(a){return a.reduce((a,b)=>{let c=b.getAttribute("xml:id");return c&&(a[c]=b),a},{})}function ei(a,b,c){return a&&a.hasAttributeNS(b,c)?a.getAttributeNS(b,c):null}function ej(a){return Error(`Could not parse ttml timestamp ${a}`)}function ek(a,b){var c,d;let e,f;if(!a)return null;let g=d$(a);return null===g&&(ec.test(a)?(c=a,d=b,f=(0|(e=ec.exec(c))[4])+(0|e[5])/d.subFrameRate,g=(0|e[1])*3600+(0|e[2])*60+(0|e[3])+f/d.frameRate):ed.test(a)&&(g=function(a,b){let c=ed.exec(a),d=Number(c[1]);switch(c[2]){case"h":return 3600*d;case"m":return 60*d;case"ms":return 1e3*d;case"f":return d/b.frameRate;case"t":return d/b.tickRate}return d}(a,b))),g}function el(a){return a.characteristics&&/transcribes-spoken-dialog/gi.test(a.characteristics)&&/describes-music-and-sound/gi.test(a.characteristics)?"captions":"subtitles"}function em(a,b){return!!a&&a.kind===el(b)&&dD(b,a)}function en(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}class eo{constructor(a){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=a,this.autoLevelCapping=1/0,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(a){this.streamController=a}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){let{hls:a}=this;a.on(C.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),a.on(C.MEDIA_ATTACHING,this.onMediaAttaching,this),a.on(C.MANIFEST_PARSED,this.onManifestParsed,this),a.on(C.LEVELS_UPDATED,this.onLevelsUpdated,this),a.on(C.BUFFER_CODECS,this.onBufferCodecs,this),a.on(C.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){let{hls:a}=this;a.off(C.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),a.off(C.MEDIA_ATTACHING,this.onMediaAttaching,this),a.off(C.MANIFEST_PARSED,this.onManifestParsed,this),a.off(C.LEVELS_UPDATED,this.onLevelsUpdated,this),a.off(C.BUFFER_CODECS,this.onBufferCodecs,this),a.off(C.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(a,b){let c=this.hls.levels[b.droppedLevel];this.isLevelAllowed(c)&&this.restrictedLevels.push({bitrate:c.bitrate,height:c.height,width:c.width})}onMediaAttaching(a,b){this.media=b.media instanceof HTMLVideoElement?b.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(a,b){let c=this.hls;this.restrictedLevels=[],this.firstLevel=b.firstLevel,c.config.capLevelToPlayerSize&&b.video&&this.startCapping()}onLevelsUpdated(a,b){this.timer&&z(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(a,b){this.hls.config.capLevelToPlayerSize&&b.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}let a=this.hls.levels;if(a.length){let b=this.hls,c=this.getMaxLevel(a.length-1);c!==this.autoLevelCapping&&I.log(`Setting autoLevelCapping to ${c}: ${a[c].height}p@${a[c].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),b.autoLevelCapping=c,b.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=b.autoLevelCapping}}}getMaxLevel(a){let b=this.hls.levels;if(!b.length)return -1;let c=b.filter((b,c)=>this.isLevelAllowed(b)&&c<=a);return this.clientRect=null,eo.getMaxLevelByMediaSize(c,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=1/0,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=1/0,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;let a=this.media,b={width:0,height:0};if(a){let c=a.getBoundingClientRect();b.width=c.width,b.height=c.height,b.width||b.height||(b.width=c.right-c.left||a.width||0,b.height=c.bottom-c.top||a.height||0)}return this.clientRect=b,b}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let a=1;if(!this.hls.config.ignoreDevicePixelRatio)try{a=self.devicePixelRatio}catch(a){}return a}isLevelAllowed(a){return!this.restrictedLevels.some(b=>a.bitrate===b.bitrate&&a.width===b.width&&a.height===b.height)}static getMaxLevelByMediaSize(a,b,c){if(!(null!=a&&a.length))return -1;let d=(a,b)=>!b||a.width!==b.width||a.height!==b.height,e=a.length-1,f=Math.max(b,c);for(let b=0;b<a.length;b+=1){let c=a[b];if((c.width>=f||c.height>=f)&&d(c,a[b+1])){e=b;break}}return e}}let ep="[eme]";class eq{constructor(a){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=eq.CDMCleanupPromise?[eq.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=I.debug.bind(I,ep),this.log=I.log.bind(I,ep),this.warn=I.warn.bind(I,ep),this.error=I.error.bind(I,ep),this.hls=a,this.config=a.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();let a=this.config;a.requestMediaKeySystemAccessFunc=null,a.licenseXhrSetup=a.licenseResponseCallback=void 0,a.drmSystems=a.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}registerListeners(){this.hls.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(C.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(C.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(C.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(C.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(C.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(C.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(a){let{drmSystems:b,widevineLicenseUrl:c}=this.config,d=b[a];if(d)return d.licenseUrl;if(a===_&&c)return c;throw Error(`no license server URL configured for key-system "${a}"`)}getServerCertificateUrl(a){let{drmSystems:b}=this.config,c=b[a];if(c)return c.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${a}"]`)}attemptKeySystemAccess(a){let b=this.hls.levels,c=(a,b,c)=>!!a&&c.indexOf(a)===b,d=b.map(a=>a.audioCodec).filter(c),e=b.map(a=>a.videoCodec).filter(c);return d.length+e.length===0&&e.push("avc1.42e01e"),new Promise((b,c)=>{let f=a=>{let g=a.shift();this.getMediaKeysPromise(g,d,e).then(a=>b({keySystem:g,mediaKeys:a})).catch(b=>{a.length?f(a):b instanceof er?c(b):c(new er({type:D.KEY_SYSTEM_ERROR,details:E.KEY_SYSTEM_NO_ACCESS,error:b,fatal:!0},b.message))})};f(a)})}requestMediaKeySystemAccess(a,b){let{requestMediaKeySystemAccessFunc:c}=this.config;if("function"!=typeof c){let a=`Configured requestMediaKeySystemAccess is not a function ${c}`;return null===aj&&"http:"===self.location.protocol&&(a=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(Error(a))}return c(a,b)}getMediaKeysPromise(a,b,c){let d=function(a,b,c,d){var e,f,g,h;let i;switch(a){case Z:i=["cenc","sinf"];break;case _:case $:i=["cenc"];break;case Y:i=["cenc","keyids"];break;default:throw Error(`Unknown key-system: ${a}`)}return e=i,f=b,g=c,[{initDataTypes:e,persistentState:(h=d).persistentState||"optional",distinctiveIdentifier:h.distinctiveIdentifier||"optional",sessionTypes:h.sessionTypes||[h.sessionType||"temporary"],audioCapabilities:f.map(a=>({contentType:`audio/mp4; codecs="${a}"`,robustness:h.audioRobustness||"",encryptionScheme:h.audioEncryptionScheme||null})),videoCapabilities:g.map(a=>({contentType:`video/mp4; codecs="${a}"`,robustness:h.videoRobustness||"",encryptionScheme:h.videoEncryptionScheme||null}))}]}(a,b,c,this.config.drmSystemOptions),e=this.keySystemAccessPromises[a],f=null==e?void 0:e.keySystemAccess;if(!f){this.log(`Requesting encrypted media "${a}" key-system access with config: ${JSON.stringify(d)}`),f=this.requestMediaKeySystemAccess(a,d);let b=this.keySystemAccessPromises[a]={keySystemAccess:f};return f.catch(b=>{this.log(`Failed to obtain access to key-system "${a}": ${b}`)}),f.then(c=>{this.log(`Access for key-system "${c.keySystem}" obtained`);let d=this.fetchServerCertificate(a);return this.log(`Create media-keys for "${a}"`),b.mediaKeys=c.createMediaKeys().then(b=>(this.log(`Media-keys created for "${a}"`),d.then(c=>c?this.setMediaKeysServerCertificate(b,a,c):b))),b.mediaKeys.catch(b=>{this.error(`Failed to create media-keys for "${a}"}: ${b}`)}),b.mediaKeys})}return f.then(()=>e.mediaKeys)}createMediaKeySessionContext({decryptdata:a,keySystem:b,mediaKeys:c}){this.log(`Creating key-system session "${b}" keyId: ${aA(a.keyId||[])}`);let d=c.createSession(),e={decryptdata:a,keySystem:b,mediaKeys:c,mediaKeysSession:d,keyStatus:"status-pending"};return this.mediaKeySessions.push(e),e}renewKeySession(a){let b=a.decryptdata;if(b.pssh){let c=this.createMediaKeySessionContext(a),d=this.getKeyIdString(b);this.keyIdToKeySessionPromise[d]=this.generateRequestWithPreferredKeySession(c,"cenc",b.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(a)}getKeyIdString(a){if(!a)throw Error("Could not read keyId of undefined decryptdata");if(null===a.keyId)throw Error("keyId is null");return aA(a.keyId)}updateKeySession(a,b){var c;let d=a.mediaKeysSession;return this.log(`Updating key-session "${d.sessionId}" for keyID ${aA((null==(c=a.decryptdata)?void 0:c.keyId)||[])}
      } (data length: ${b?b.byteLength:b})`),d.update(b)}selectKeySystemFormat(a){let b=Object.keys(a.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${a.sn} ${a.type}: ${a.level}) key formats ${b.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(b)),this.keyFormatPromise}getKeyFormatPromise(a){return new Promise((b,c)=>{let d=ai(this.config),e=a.map(ae).filter(a=>!!a&&-1!==d.indexOf(a));return this.getKeySystemSelectionPromise(e).then(({keySystem:a})=>{let d=ah(a);d?b(d):c(Error(`Unable to find format for key-system "${a}"`))}).catch(c)})}loadKey(a){let b=a.keyInfo.decryptdata,c=this.getKeyIdString(b),d=`(keyId: ${c} format: "${b.keyFormat}" method: ${b.method} uri: ${b.uri})`;this.log(`Starting session for key ${d}`);let e=this.keyIdToKeySessionPromise[c];return e||(e=this.keyIdToKeySessionPromise[c]=this.getKeySystemForKeyPromise(b).then(({keySystem:c,mediaKeys:e})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${a.frag.sn} ${a.frag.type}: ${a.frag.level} using key ${d}`),this.attemptSetMediaKeys(c,e).then(()=>{this.throwIfDestroyed();let a=this.createMediaKeySessionContext({keySystem:c,mediaKeys:e,decryptdata:b});return this.generateRequestWithPreferredKeySession(a,"cenc",b.pssh,"playlist-key")})))).catch(a=>this.handleError(a)),e}throwIfDestroyed(a="Invalid state"){if(!this.hls)throw Error("invalid state")}handleError(a){this.hls&&(this.error(a.message),a instanceof er?this.hls.trigger(C.ERROR,a.data):this.hls.trigger(C.ERROR,{type:D.KEY_SYSTEM_ERROR,details:E.KEY_SYSTEM_NO_KEYS,error:a,fatal:!0}))}getKeySystemForKeyPromise(a){let b=this.getKeyIdString(a),c=this.keyIdToKeySessionPromise[b];if(!c){let b=ae(a.keyFormat),c=b?[b]:ai(this.config);return this.attemptKeySystemAccess(c)}return c}getKeySystemSelectionPromise(a){if(a.length||(a=ai(this.config)),0===a.length)throw new er({type:D.KEY_SYSTEM_ERROR,details:E.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(a)}_onMediaEncrypted(a){let b,c,{initDataType:d,initData:e}=a,f=`"${a.type}" event: init data type: "${d}"`;if(this.debug(f),null===e)return;if("sinf"===d&&this.config.drmSystems[Z]){let a=aD(new Uint8Array(e));try{let d=V(JSON.parse(a).sinf),e=aO(new Uint8Array(d));if(!e)throw Error("'schm' box missing or not cbcs/cenc with schi > tenc");b=e.subarray(8,24),c=Z}catch(a){this.warn(`${f} Failed to parse sinf: ${a}`);return}}else{let a=function(a){let b=[];if(a instanceof ArrayBuffer){let c=a.byteLength,d=0;for(;d+32<c;){let c=function(a){let b=a.getUint32(0),c=a.byteOffset,d=a.byteLength;if(d<b)return{offset:c,size:d};if(0x70737368!==a.getUint32(4))return{offset:c,size:b};let e=a.getUint32(8)>>>24;if(0!==e&&1!==e)return{offset:c,size:b};let f=a.buffer,g=aA(new Uint8Array(f,c+12,16)),h=a.getUint32(28),i=null,j=null;if(0===e){if(b-32<h||h<22)return{offset:c,size:b};j=new Uint8Array(f,c+32,h)}else if(1===e){if(!h||d<c+32+16*h+16)return{offset:c,size:b};i=[];for(let a=0;a<h;a++)i.push(new Uint8Array(f,c+32+16*a,16))}return{version:e,systemId:g,kids:i,data:j,offset:c,size:b}}(new DataView(a,d));b.push(c),d+=c.size}}return b}(e),d=a.filter(a=>a.systemId===af)[0];if(!d)return void(0===a.length||a.some(a=>!a.systemId)?this.warn(`${f} contains incomplete or invalid pssh data`):this.log(`ignoring ${f} for ${a.map(a=>ag(a.systemId)).join(",")} pssh data in favor of playlist keys`));if(c=ag(d.systemId),0===d.version&&d.data){let a=d.data.length-22;b=d.data.subarray(a,a+16)}}if(!c||!b)return;let g=aA(b),{keyIdToKeySessionPromise:h,mediaKeySessions:i}=this,j=h[g];for(let a=0;a<i.length;a++){let c=i[a],f=c.decryptdata;if(!f.keyId)continue;let k=aA(f.keyId);if(g===k||-1!==f.uri.replace(/-/g,"").indexOf(g)){if(j=h[k],f.pssh)break;delete h[k],f.pssh=new Uint8Array(e),f.keyId=b,j=h[g]=j.then(()=>this.generateRequestWithPreferredKeySession(c,d,e,"encrypted-event-key-match"));break}}j||(j=h[g]=this.getKeySystemSelectionPromise([c]).then(({keySystem:a,mediaKeys:c})=>{var f;this.throwIfDestroyed();let h=new aU("ISO-23001-7",g,null!=(f=ah(a))?f:"");return h.pssh=new Uint8Array(e),h.keyId=b,this.attemptSetMediaKeys(a,c).then(()=>{this.throwIfDestroyed();let b=this.createMediaKeySessionContext({decryptdata:h,keySystem:a,mediaKeys:c});return this.generateRequestWithPreferredKeySession(b,d,e,"encrypted-event-no-match")})})),j.catch(a=>this.handleError(a))}_onWaitingForKey(a){this.log(`"${a.type}" event`)}attemptSetMediaKeys(a,b){let c=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${a}"`);let d=Promise.all(c).then(()=>{if(!this.media)throw Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(b)});return this.setMediaKeysQueue.push(d),d.then(()=>{this.log(`Media-keys set for "${a}"`),c.push(d),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(a=>-1===c.indexOf(a))})}generateRequestWithPreferredKeySession(a,b,c,d){var e,f,g;let h=null==(e=this.config.drmSystems)||null==(f=e[a.keySystem])?void 0:f.generateRequest;if(h)try{let d=h.call(this.hls,b,c,a);if(!d)throw Error("Invalid response from configured generateRequest filter");b=d.initDataType,c=a.decryptdata.pssh=d.initData?new Uint8Array(d.initData):null}catch(a){if(this.warn(a.message),null!=(g=this.hls)&&g.config.debug)throw a}if(null===c)return this.log(`Skipping key-session request for "${d}" (no initData)`),Promise.resolve(a);let i=this.getKeyIdString(a.decryptdata);this.log(`Generating key-session request for "${d}": ${i} (init data type: ${b} length: ${c?c.byteLength:null})`);let j=new dz,k=a._onmessage=b=>{let c=a.mediaKeysSession;if(!c)return void j.emit("error",Error("invalid state"));let{messageType:d,message:e}=b;this.log(`"${d}" message event for session "${c.sessionId}" message size: ${e.byteLength}`),"license-request"===d||"license-renewal"===d?this.renewLicense(a,e).catch(a=>{this.handleError(a),j.emit("error",a)}):"license-release"===d?a.keySystem===Z&&(this.updateKeySession(a,W("acknowledged")),this.removeSession(a)):this.warn(`unhandled media key message type "${d}"`)},l=a._onkeystatuseschange=b=>{if(!a.mediaKeysSession)return void j.emit("error",Error("invalid state"));this.onKeyStatusChange(a);let c=a.keyStatus;j.emit("keyStatus",c),"expired"===c&&(this.warn(`${a.keySystem} expired for key ${i}`),this.renewKeySession(a))};a.mediaKeysSession.addEventListener("message",k),a.mediaKeysSession.addEventListener("keystatuseschange",l);let m=new Promise((a,b)=>{j.on("error",b),j.on("keyStatus",c=>{c.startsWith("usable")?a():"output-restricted"===c?b(new er({type:D.KEY_SYSTEM_ERROR,details:E.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===c?b(new er({type:D.KEY_SYSTEM_ERROR,details:E.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${c}"`)):"expired"===c?b(Error("key expired while generating request")):this.warn(`unhandled key status change "${c}"`)})});return a.mediaKeysSession.generateRequest(b,c).then(()=>{var b;this.log(`Request generated for key-session "${null==(b=a.mediaKeysSession)?void 0:b.sessionId}" keyId: ${i}`)}).catch(a=>{throw new er({type:D.KEY_SYSTEM_ERROR,details:E.KEY_SYSTEM_NO_SESSION,error:a,fatal:!1},`Error generating key-session request: ${a}`)}).then(()=>m).catch(b=>{throw j.removeAllListeners(),this.removeSession(a),b}).then(()=>(j.removeAllListeners(),a))}onKeyStatusChange(a){a.mediaKeysSession.keyStatuses.forEach((b,c)=>{this.log(`key status change "${b}" for keyStatuses keyId: ${aA("buffer"in c?new Uint8Array(c.buffer,c.byteOffset,c.byteLength):new Uint8Array(c))} session keyId: ${aA(new Uint8Array(a.decryptdata.keyId||[]))} uri: ${a.decryptdata.uri}`),a.keyStatus=b})}fetchServerCertificate(a){let b=this.config,c=new b.loader(b),d=this.getServerCertificateUrl(a);return d?(this.log(`Fetching server certificate for "${a}"`),new Promise((e,f)=>{let g={responseType:"arraybuffer",url:d},h=b.certLoadPolicy.default,i={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0};c.load(g,i,{onSuccess:(a,b,c,d)=>{e(a.data)},onError:(b,c,e,h)=>{f(new er({type:D.KEY_SYSTEM_ERROR,details:E.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:e,response:x({url:g.url,data:void 0},b)},`"${a}" certificate request failed (${d}). Status: ${b.code} (${b.text})`))},onTimeout:(b,c,e)=>{f(new er({type:D.KEY_SYSTEM_ERROR,details:E.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:e,response:{url:g.url,data:void 0}},`"${a}" certificate request timed out (${d})`))},onAbort:(a,b,c)=>{f(Error("aborted"))}})})):Promise.resolve()}setMediaKeysServerCertificate(a,b,c){return new Promise((d,e)=>{a.setServerCertificate(c).then(e=>{this.log(`setServerCertificate ${e?"success":"not supported by CDM"} (${null==c?void 0:c.byteLength}) on "${b}"`),d(a)}).catch(a=>{e(new er({type:D.KEY_SYSTEM_ERROR,details:E.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:a,fatal:!0},a.message))})})}renewLicense(a,b){return this.requestLicense(a,new Uint8Array(b)).then(b=>this.updateKeySession(a,new Uint8Array(b)).catch(a=>{throw new er({type:D.KEY_SYSTEM_ERROR,details:E.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:a,fatal:!0},a.message)}))}unpackPlayReadyKeyMessage(a,b){let c=String.fromCharCode.apply(null,new Uint16Array(b.buffer));if(!c.includes("PlayReadyKeyMessage"))return a.setRequestHeader("Content-Type","text/xml; charset=utf-8"),b;let d=new DOMParser().parseFromString(c,"application/xml"),e=d.querySelectorAll("HttpHeader");if(e.length>0){let b;for(let c=0,d=e.length;c<d;c++){var f,g;let d=null==(f=(b=e[c]).querySelector("name"))?void 0:f.textContent,h=null==(g=b.querySelector("value"))?void 0:g.textContent;d&&h&&a.setRequestHeader(d,h)}}let h=d.querySelector("Challenge"),i=null==h?void 0:h.textContent;if(!i)throw Error("Cannot find <Challenge> in key message");return W(atob(i))}setupLicenseXHR(a,b,c,d){let e=this.config.licenseXhrSetup;return e?Promise.resolve().then(()=>{if(!c.decryptdata)throw Error("Key removed");return e.call(this.hls,a,b,c,d)}).catch(f=>{if(!c.decryptdata)throw f;return a.open("POST",b,!0),e.call(this.hls,a,b,c,d)}).then(c=>(a.readyState||a.open("POST",b,!0),{xhr:a,licenseChallenge:c||d})):(a.open("POST",b,!0),Promise.resolve({xhr:a,licenseChallenge:d}))}requestLicense(a,b){let c=this.config.keyLoadPolicy.default;return new Promise((d,e)=>{let f=this.getLicenseServerUrl(a.keySystem);this.log(`Sending license request to URL: ${f}`);let g=new XMLHttpRequest;g.responseType="arraybuffer",g.onreadystatechange=()=>{if(!this.hls||!a.mediaKeysSession)return e(Error("invalid state"));if(4===g.readyState)if(200===g.status){this._requestLicenseFailureCount=0;let b=g.response;this.log(`License received ${b instanceof ArrayBuffer?b.byteLength:b}`);let c=this.config.licenseResponseCallback;if(c)try{b=c.call(this.hls,g,f,a)}catch(a){this.error(a)}d(b)}else{let h=c.errorRetry,i=h?h.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>i||g.status>=400&&g.status<500)e(new er({type:D.KEY_SYSTEM_ERROR,details:E.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:g,response:{url:f,data:void 0,code:g.status,text:g.statusText}},`License Request XHR failed (${f}). Status: ${g.status} (${g.statusText})`));else{let c=i-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${c} attempts left`),this.requestLicense(a,b).then(d,e)}}},a.licenseXhr&&a.licenseXhr.readyState!==XMLHttpRequest.DONE&&a.licenseXhr.abort(),a.licenseXhr=g,this.setupLicenseXHR(g,f,a,b).then(({xhr:b,licenseChallenge:c})=>{a.keySystem==$&&(c=this.unpackPlayReadyKeyMessage(b,c)),b.send(c)})})}onMediaAttached(a,b){if(!this.config.emeEnabled)return;let c=b.media;this.media=c,c.addEventListener("encrypted",this.onMediaEncrypted),c.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){let a=this.media,b=this.mediaKeySessions;a&&(a.removeEventListener("encrypted",this.onMediaEncrypted),a.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},aU.clearKeyUriToKeyIdMap();let c=b.length;eq.CDMCleanupPromise=Promise.all(b.map(a=>this.removeSession(a)).concat(null==a?void 0:a.setMediaKeys(null).catch(a=>{this.log(`Could not clear media keys: ${a}`)}))).then(()=>{c&&(this.log("finished closing key sessions and clearing media keys"),b.length=0)}).catch(a=>{this.log(`Could not close sessions and clear media keys: ${a}`)})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(a,{sessionKeys:b}){if(b&&this.config.emeEnabled&&!this.keyFormatPromise){let a=b.reduce((a,b)=>(-1===a.indexOf(b.keyFormat)&&a.push(b.keyFormat),a),[]);this.log(`Selecting key-system from session-keys ${a.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(a)}}removeSession(a){let{mediaKeysSession:b,licenseXhr:c}=a;if(b){this.log(`Remove licenses and keys and close session ${b.sessionId}`),a._onmessage&&(b.removeEventListener("message",a._onmessage),a._onmessage=void 0),a._onkeystatuseschange&&(b.removeEventListener("keystatuseschange",a._onkeystatuseschange),a._onkeystatuseschange=void 0),c&&c.readyState!==XMLHttpRequest.DONE&&c.abort(),a.mediaKeysSession=a.decryptdata=a.licenseXhr=void 0;let d=this.mediaKeySessions.indexOf(a);return d>-1&&this.mediaKeySessions.splice(d,1),b.remove().catch(a=>{this.log(`Could not remove session: ${a}`)}).then(()=>b.close()).catch(a=>{this.log(`Could not close session: ${a}`)})}}}eq.CDMCleanupPromise=void 0;class er extends Error{constructor(a,b){super(b),this.data=void 0,a.error||(a.error=Error(b)),this.data=a,a.err=a.error}}(o=r||(r={})).MANIFEST="m",o.AUDIO="a",o.VIDEO="v",o.MUXED="av",o.INIT="i",o.CAPTION="c",o.TIMED_TEXT="tt",o.KEY="k",o.OTHER="o",(p=s||(s={})).DASH="d",p.HLS="h",p.SMOOTH="s",p.OTHER="o",(q=t||(t={})).OBJECT="CMCD-Object",q.REQUEST="CMCD-Request",q.SESSION="CMCD-Session",q.STATUS="CMCD-Status";let es={[t.OBJECT]:["br","d","ot","tb"],[t.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[t.SESSION]:["cid","pr","sf","sid","st","v"],[t.STATUS]:["bs","rtp"]};class et{constructor(a,b){this.value=void 0,this.params=void 0,Array.isArray(a)&&(a=a.map(a=>a instanceof et?a:new et(a))),this.value=a,this.params=b}}class eu{constructor(a){this.description=void 0,this.description=a}}let ev="Bare Item",ew=/[\x00-\x1f\x7f]+/;function ex(a,b,c){return Error(`failed to serialize "${Array.isArray(a)?JSON.stringify(a):a instanceof Map?"Map{}":a instanceof Set?"Set{}":"object"==typeof a?JSON.stringify(a):String(a)}" as ${b}`,{cause:c})}function ey(a){if(a<-0x38d7ea4c67fff||0x38d7ea4c67fff<a)throw ex(a,"Integer");return a.toString()}function ez(a){let b=a.description||a.toString().slice(7,-1);if(!1===/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(b))throw ex(b,"Token");return b}function eA(a){switch(typeof a){case"number":if(!z(a))throw ex(a,ev);if(Number.isInteger(a))return ey(a);let b=function a(b,c){if(b<0)return-a(-b,c);let d=Math.pow(10,c);if(!(Math.abs(b*d%1-.5)<Number.EPSILON))return Math.round(b*d)/d;{let a=Math.floor(b*d);return(a%2==0?a:a+1)/d}}(a,3);if(Math.floor(Math.abs(b)).toString().length>12)throw ex(a,"Decimal");let c=b.toString();return c.includes(".")?c:`${c}.0`;case"string":if(ew.test(a))throw ex(a,"String");return`"${a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`;case"symbol":return ez(a);case"boolean":if("boolean"!=typeof a)throw ex(a,"Boolean");return a?"?1":"?0";case"object":if(a instanceof Date)return`@${ey(a.getTime()/1e3)}`;if(a instanceof Uint8Array){if(!1===ArrayBuffer.isView(a))throw ex(a,"Byte Sequence");return`:${btoa(String.fromCharCode(...a))}:`}if(a instanceof eu)return ez(a);default:throw ex(a,ev)}}function eB(a){if(!1===/^[a-z*][a-z0-9\-_.*]*$/.test(a))throw ex(a,"Key");return a}function eC(a){return null==a?"":Object.entries(a).map(([a,b])=>!0===b?`;${eB(a)}`:`;${eB(a)}=${eA(b)}`).join("")}function eD(a){return a instanceof et?`${eA(a.value)}${eC(a.params)}`:eA(a)}let eE=a=>Math.round(a),eF=a=>100*eE(a/100),eG={br:eE,d:eE,bl:eF,dl:eF,mtp:eF,nor:(a,b)=>(null!=b&&b.baseUrl&&(a=function(a,b){let c=new URL(a),d=new URL(b);if(c.origin!==d.origin)return a;let e=c.pathname.split("/").slice(1),f=d.pathname.split("/").slice(1,-1);for(;e[0]===f[0];)e.shift(),f.shift();for(;f.length;)f.shift(),e.unshift("..");return e.join("/")}(a,b.baseUrl)),encodeURIComponent(a)),rtp:eF,tb:eE};function eH(a,b={}){return a?function(a,b={whitespace:!0}){if("object"!=typeof a)throw ex(a,"Dict");let c=a instanceof Map?a.entries():Object.entries(a),d=null!=b&&b.whitespace?" ":"";return Array.from(c).map(([a,b])=>{b instanceof et==!1&&(b=new et(b));let c=eB(a);if(!0===b.value)c+=eC(b.params);else if(c+="=",Array.isArray(b.value)){var d;c+=(d=b,`(${d.value.map(eD).join(" ")})${eC(d.params)}`)}else c+=eD(b);return c}).join(`,${d}`)}(function(a,b){let c={};if(null==a||"object"!=typeof a)return c;let d=Object.keys(a).sort(),e=y({},eG,null==b?void 0:b.formatters),f=null==b?void 0:b.filter;return d.forEach(d=>{var g;if(null!=f&&f(d))return;let h=a[d],i=e[d];(i&&(h=i(h,b)),("v"!==d||1!==h)&&("pr"!=d||1!==h))&&("number"==typeof(g=h)?z(g):null!=g&&""!==g&&!1!==g)&&(("ot"===d||"sf"===d||"st"===d)&&"string"==typeof h&&(h=new eu(h)),c[d]=h)}),c}(a,b),y({whitespace:!1},b)):""}let eI=/CMCD=[^&#]+/;function eJ(a,b,c,d){a&&Object.keys(b).forEach(e=>{let f=a.filter(a=>a.groupId===e).map(a=>{let f=y({},a);return f.details=void 0,f.attrs=new L(f.attrs),f.url=f.attrs.URI=eK(a.url,a.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",c),f.groupId=f.attrs["GROUP-ID"]=b[e],f.attrs["PATHWAY-ID"]=d,f});a.push(...f)})}function eK(a,b,c,d){let e,{HOST:f,PARAMS:g,[c]:h}=d;b&&(e=null==h?void 0:h[b])&&(a=e);let i=new self.URL(a);return f&&!e&&(i.host=f),g&&Object.keys(g).sort().forEach(a=>{a&&i.searchParams.set(a,g[a])}),i.href}let eL=/^age:\s*[\d.]+\s*$/im;class eM{constructor(a){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=a&&a.xhrSetup||null,this.stats=new N,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){let a=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),a&&(a.onreadystatechange=null,a.onprogress=null,4!==a.readyState&&(this.stats.aborted=!0,a.abort()))}abort(){var a;this.abortInternal(),null!=(a=this.callbacks)&&a.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(a,b,c){if(this.stats.loading.start)throw Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=a,this.config=b,this.callbacks=c,this.loadInternal()}loadInternal(){let{config:a,context:b}=this;if(!a||!b)return;let c=this.loader=new self.XMLHttpRequest,d=this.stats;d.loading.first=0,d.loaded=0,d.aborted=!1;let e=this.xhrSetup;e?Promise.resolve().then(()=>{if(this.loader===c&&!this.stats.aborted)return e(c,b.url)}).catch(a=>{if(this.loader===c&&!this.stats.aborted)return c.open("GET",b.url,!0),e(c,b.url)}).then(()=>{this.loader!==c||this.stats.aborted||this.openAndSendXhr(c,b,a)}).catch(a=>{this.callbacks.onError({code:c.status,text:a.message},b,c,d)}):this.openAndSendXhr(c,b,a)}openAndSendXhr(a,b,c){a.readyState||a.open("GET",b.url,!0);let d=b.headers,{maxTimeToFirstByteMs:e,maxLoadTimeMs:f}=c.loadPolicy;if(d)for(let b in d)a.setRequestHeader(b,d[b]);b.rangeEnd&&a.setRequestHeader("Range","bytes="+b.rangeStart+"-"+(b.rangeEnd-1)),a.onreadystatechange=this.readystatechange.bind(this),a.onprogress=this.loadprogress.bind(this),a.responseType=b.responseType,self.clearTimeout(this.requestTimeout),c.timeout=e&&z(e)?e:f,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),c.timeout),a.send()}readystatechange(){let{context:a,loader:b,stats:c}=this;if(!a||!b)return;let d=b.readyState,e=this.config;if(!c.aborted&&d>=2&&(0===c.loading.first&&(c.loading.first=Math.max(self.performance.now(),c.loading.start),e.timeout!==e.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),e.timeout=e.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),e.loadPolicy.maxLoadTimeMs-(c.loading.first-c.loading.start)))),4===d)){self.clearTimeout(this.requestTimeout),b.onreadystatechange=null,b.onprogress=null;let d=b.status,f="text"===b.responseType?b.responseText:null;if(d>=200&&d<300){let e=null!=f?f:b.response;if(null!=e){if(c.loading.end=Math.max(self.performance.now(),c.loading.first),c.loaded=c.total="arraybuffer"===b.responseType?e.byteLength:e.length,c.bwEstimate=8e3*c.total/(c.loading.end-c.loading.first),!this.callbacks)return;let f=this.callbacks.onProgress;if(f&&f(c,a,e,b),!this.callbacks)return;let g={url:b.responseURL,data:e,code:d};this.callbacks.onSuccess(g,c,a,b);return}}let g=e.loadPolicy.errorRetry;bY(g,c.retry,!1,{url:a.url,data:void 0,code:d})?this.retry(g):(I.error(`${d} while loading ${a.url}`),this.callbacks.onError({code:d,text:b.statusText},a,b,c))}}loadtimeout(){if(!this.config)return;let a=this.config.loadPolicy.timeoutRetry;if(bY(a,this.stats.retry,!0))this.retry(a);else{var b;I.warn(`timeout while loading ${null==(b=this.context)?void 0:b.url}`);let a=this.callbacks;a&&(this.abortInternal(),a.onTimeout(this.stats,this.context,this.loader))}}retry(a){let{context:b,stats:c}=this;this.retryDelay=bW(a,c.retry),c.retry++,I.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${null==b?void 0:b.url}, retrying ${c.retry}/${a.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(a){let b=this.stats;b.loaded=a.loaded,a.lengthComputable&&(b.total=a.total)}getCacheAge(){let a=null;if(this.loader&&eL.test(this.loader.getAllResponseHeaders())){let b=this.loader.getResponseHeader("age");a=b?parseFloat(b):null}return a}getResponseHeader(a){return this.loader&&RegExp(`^${a}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(a):null}}let eN=/(\d+)-(\d+)\/(\d+)/;class eO{constructor(a){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=a.fetchSetup||eP,this.controller=new self.AbortController,this.stats=new N}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var a;this.abortInternal(),null!=(a=this.callbacks)&&a.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(a,b,c){var d;let e,f=this.stats;if(f.loading.start)throw Error("Loader can only be used once.");f.loading.start=self.performance.now();let g=(d=a,e={method:"GET",mode:"cors",credentials:"same-origin",signal:this.controller.signal,headers:new self.Headers(y({},d.headers))},d.rangeEnd&&e.headers.set("Range","bytes="+d.rangeStart+"-"+String(d.rangeEnd-1)),e),h=c.onProgress,i="arraybuffer"===a.responseType,j=i?"byteLength":"length",{maxTimeToFirstByteMs:k,maxLoadTimeMs:l}=b.loadPolicy;this.context=a,this.config=b,this.callbacks=c,this.request=this.fetchSetup(a,g),self.clearTimeout(this.requestTimeout),b.timeout=k&&z(k)?k:l,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),c.onTimeout(f,a,this.response)},b.timeout),self.fetch(this.request).then(d=>{this.response=this.loader=d;let e=Math.max(self.performance.now(),f.loading.start);if(self.clearTimeout(this.requestTimeout),b.timeout=l,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),c.onTimeout(f,a,this.response)},l-(e-f.loading.start)),!d.ok){let{status:a,statusText:b}=d;throw new eQ(b||"fetch, bad network response",a,d)}return(f.loading.first=e,f.total=function(a){let b=a.get("Content-Range");if(b){let a=function(a){let b=eN.exec(a);if(b)return parseInt(b[2])-parseInt(b[1])+1}(b);if(z(a))return a}let c=a.get("Content-Length");if(c)return parseInt(c)}(d.headers)||f.total,h&&z(b.highWaterMark))?this.loadProgressively(d,f,a,b.highWaterMark,h):i?d.arrayBuffer():"json"===a.responseType?d.json():d.text()}).then(d=>{let e=this.response;if(!e)throw Error("loader destroyed");self.clearTimeout(this.requestTimeout),f.loading.end=Math.max(self.performance.now(),f.loading.first);let g=d[j];g&&(f.loaded=f.total=g);let i={url:e.url,data:d,code:e.status};h&&!z(b.highWaterMark)&&h(f,a,d,e),c.onSuccess(i,f,a,e)}).catch(b=>{if(self.clearTimeout(this.requestTimeout),f.aborted)return;let d=b&&b.code||0,e=b?b.message:null;c.onError({code:d,text:e},a,b?b.details:null,f)})}getCacheAge(){let a=null;if(this.response){let b=this.response.headers.get("age");a=b?parseFloat(b):null}return a}getResponseHeader(a){return this.response?this.response.headers.get(a):null}loadProgressively(a,b,c,d=0,e){let f=new cL,g=a.body.getReader(),h=()=>g.read().then(g=>{if(g.done)return f.dataLength&&e(b,c,f.flush(),a),Promise.resolve(new ArrayBuffer(0));let i=g.value,j=i.length;return b.loaded+=j,j<d||f.dataLength?(f.push(i),f.dataLength>=d&&e(b,c,f.flush(),a)):e(b,c,i,a),h()}).catch(()=>Promise.reject());return h()}}function eP(a,b){return new self.Request(a.url,b)}class eQ extends Error{constructor(a,b,c){super(a),this.code=void 0,this.details=void 0,this.code=b,this.details=c}}let eR=/\s/,eS={newCue(a,b,c,d){let e,f,g,h,i,j=[],k=self.VTTCue||self.TextTrackCue;for(let m=0;m<d.rows.length;m++)if(e=d.rows[m],g=!0,h=0,i="",!e.isEmpty()){var l;for(let a=0;a<e.chars.length;a++)eR.test(e.chars[a].uchar)&&g?h++:(i+=e.chars[a].uchar,g=!1);e.cueStartTime=b,b===c&&(c+=1e-4),h>=16?h--:h++;let d=d3(i.trim()),n=d9(b,c,d);null!=a&&null!=(l=a.cues)&&l.getCueById(n)||((f=new k(b,c,d)).id=n,f.line=m+1,f.align="left",f.position=10+Math.min(80,10*Math.floor(8*h/32)),j.push(f))}return a&&j.length&&(j.sort((a,b)=>"auto"===a.line||"auto"===b.line?0:a.line>8&&b.line>8?b.line-a.line:a.line-b.line),j.forEach(b=>bv(a,b))),j}},eT=x(x({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:eM,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:class{constructor(a){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{let a,{fragCurrent:b,partCurrent:c,hls:d}=this,{autoLevelEnabled:e,media:f}=d;if(!b||!f)return;let g=performance.now(),h=c?c.stats:b.stats,i=c?c.duration:b.duration,j=g-h.loading.start,k=d.minAutoLevel;if(h.aborted||h.loaded&&h.loaded===h.total||b.level<=k){this.clearTimer(),this._nextAutoLevel=-1;return}if(!e||f.paused||!f.playbackRate||!f.readyState)return;let l=d.mainForwardBufferInfo;if(null===l)return;let m=this.bwEstimator.getEstimateTTFB(),n=Math.abs(f.playbackRate);if(j<=Math.max(m,i/(2*n)*1e3))return;let o=l.len/n,p=h.loading.first?h.loading.first-h.loading.start:-1,q=h.loaded&&p>-1,r=this.getBwEstimate(),s=d.levels,t=s[b.level],u=h.total||Math.max(h.loaded,Math.round(i*t.averageBitrate/8)),v=q?j-p:j;v<1&&q&&(v=Math.min(j,8*h.loaded/r));let w=q?1e3*h.loaded/v:0,x=w?(u-h.loaded)/w:8*u/r+m/1e3;if(x<=o)return;let y=w?8*w:r,A=1/0;for(a=b.level-1;a>k;a--){let b=s[a].maxBitrate;if((A=this.getTimeToLoadFrag(m/1e3,y,i*b,!s[a].details))<o)break}if(A>=x||A>10*i)return;d.nextLoadLevel=d.nextAutoLevel=a,q?this.bwEstimator.sample(j-Math.min(m,p),h.loaded):this.bwEstimator.sampleTTFB(j);let B=s[a].maxBitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>B&&this.resetEstimator(B),this.clearTimer(),I.warn(`[abr] Fragment ${b.sn}${c?" part "+c.index:""} of level ${b.level} is loading too slowly;
      Time to underbuffer: ${o.toFixed(3)} s
      Estimated load time for current fragment: ${x.toFixed(3)} s
      Estimated load time for down switch fragment: ${A.toFixed(3)} s
      TTFB estimate: ${0|p} ms
      Current BW estimate: ${z(r)?0|r:"Unknown"} bps
      New BW estimate: ${0|this.getBwEstimate()} bps
      Switching to level ${a} @ ${0|B} bps`),d.trigger(C.FRAG_LOAD_EMERGENCY_ABORTED,{frag:b,part:c,stats:h})},this.hls=a,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(a){a&&(I.log(`setting initial bwe to ${a}`),this.hls.config.abrEwmaDefaultEstimate=a),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){let a=this.hls.config;return new b2(a.abrEwmaSlowVoD,a.abrEwmaFastVoD,a.abrEwmaDefaultEstimate)}registerListeners(){let{hls:a}=this;a.on(C.MANIFEST_LOADING,this.onManifestLoading,this),a.on(C.FRAG_LOADING,this.onFragLoading,this),a.on(C.FRAG_LOADED,this.onFragLoaded,this),a.on(C.FRAG_BUFFERED,this.onFragBuffered,this),a.on(C.LEVEL_SWITCHING,this.onLevelSwitching,this),a.on(C.LEVEL_LOADED,this.onLevelLoaded,this),a.on(C.LEVELS_UPDATED,this.onLevelsUpdated,this),a.on(C.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),a.on(C.ERROR,this.onError,this)}unregisterListeners(){let{hls:a}=this;a&&(a.off(C.MANIFEST_LOADING,this.onManifestLoading,this),a.off(C.FRAG_LOADING,this.onFragLoading,this),a.off(C.FRAG_LOADED,this.onFragLoaded,this),a.off(C.FRAG_BUFFERED,this.onFragBuffered,this),a.off(C.LEVEL_SWITCHING,this.onLevelSwitching,this),a.off(C.LEVEL_LOADED,this.onLevelLoaded,this),a.off(C.LEVELS_UPDATED,this.onLevelsUpdated,this),a.off(C.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),a.off(C.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(a,b){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(a,b){let c=b.frag;if(!this.ignoreFragment(c)){if(!c.bitrateTest){var d;this.fragCurrent=c,this.partCurrent=null!=(d=b.part)?d:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(a,b){this.clearTimer()}onError(a,b){if(!b.fatal)switch(b.details){case E.BUFFER_ADD_CODEC_ERROR:case E.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case E.FRAG_LOAD_TIMEOUT:{let a=b.frag,{fragCurrent:c,partCurrent:d}=this;if(a&&c&&a.sn===c.sn&&a.level===c.level){let b=performance.now(),c=d?d.stats:a.stats,e=b-c.loading.start,f=c.loading.first?c.loading.first-c.loading.start:-1;if(c.loaded&&f>-1){let a=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(e-Math.min(a,f),c.loaded)}else this.bwEstimator.sampleTTFB(e)}}}}getTimeToLoadFrag(a,b,c,d){return a+c/b+(d?this.lastLevelLoadSec:0)}onLevelLoaded(a,b){let c=this.hls.config,{loading:d}=b.stats,e=d.end-d.start;z(e)&&(this.lastLevelLoadSec=e/1e3),b.details.live?this.bwEstimator.update(c.abrEwmaSlowLive,c.abrEwmaFastLive):this.bwEstimator.update(c.abrEwmaSlowVoD,c.abrEwmaFastVoD)}onFragLoaded(a,{frag:b,part:c}){let d=c?c.stats:b.stats;if(b.type===bo&&this.bwEstimator.sampleTTFB(d.loading.first-d.loading.start),!this.ignoreFragment(b)){if(this.clearTimer(),b.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){let a=c?c.duration:b.duration,e=this.hls.levels[b.level],f=(e.loaded?e.loaded.bytes:0)+d.loaded,g=(e.loaded?e.loaded.duration:0)+a;e.loaded={bytes:f,duration:g},e.realBitrate=Math.round(8*f/g)}if(b.bitrateTest){let a={stats:d,frag:b,part:c,id:b.type};this.onFragBuffered(C.FRAG_BUFFERED,a),b.bitrateTest=!1}else this.lastLoadedFragLevel=b.level}}onFragBuffered(a,b){let{frag:c,part:d}=b,e=null!=d&&d.stats.loaded?d.stats:c.stats;if(e.aborted||this.ignoreFragment(c))return;let f=e.parsing.end-e.loading.start-Math.min(e.loading.first-e.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(f,e.loaded),e.bwEstimate=this.getBwEstimate(),c.bitrateTest?this.bitrateTestDelay=f/1e3:this.bitrateTestDelay=0}ignoreFragment(a){return a.type!==bo||"initSegment"===a.sn}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){let{maxAutoLevel:a,minAutoLevel:b}=this.hls,c=this.getBwEstimate(),d=this.hls.config.maxStarvationDelay,e=this.findBestLevel(c,b,a,0,d,1,1);if(e>-1)return e;let f=this.hls.firstLevel,g=Math.min(Math.max(f,b),a);return I.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${f} clamped to ${g}`),g}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){let a=this.forcedAutoLevel,b=this.bwEstimator.canEstimate(),c=this.lastLoadedFragLevel>-1;if(-1!==a&&(!b||!c||this.nextAutoLevelKey===this.getAutoLevelKey()))return a;let d=b&&c?this.getNextABRAutoLevel():this.firstAutoLevel;if(-1!==a){let b=this.hls.levels;if(b.length>Math.max(a,d)&&b[a].loadError<=b[d].loadError)return a}return this._nextAutoLevel=d,this.nextAutoLevelKey=this.getAutoLevelKey(),d}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){let{fragCurrent:a,partCurrent:b,hls:c}=this,{maxAutoLevel:d,config:e,minAutoLevel:f}=c,g=b?b.duration:a?a.duration:0,h=this.getBwEstimate(),i=this.getStarvationDelay(),j=e.abrBandWidthFactor,k=e.abrBandWidthUpFactor;if(i){let a=this.findBestLevel(h,f,d,i,0,j,k);if(a>=0)return a}let l=g?Math.min(g,e.maxStarvationDelay):e.maxStarvationDelay;if(!i){let a=this.bitrateTestDelay;a&&(l=(g?Math.min(g,e.maxLoadingDelay):e.maxLoadingDelay)-a,I.info(`[abr] bitrate test took ${Math.round(1e3*a)}ms, set first fragment max fetchDuration to ${Math.round(1e3*l)} ms`),j=k=1)}let m=this.findBestLevel(h,f,d,i,l,j,k);if(I.info(`[abr] ${i?"rebuffering expected":"buffer is empty"}, optimal quality level ${m}`),m>-1)return m;let n=c.levels[f],o=c.levels[c.loadLevel];return(null==n?void 0:n.bitrate)<(null==o?void 0:o.bitrate)?f:c.loadLevel}getStarvationDelay(){let a=this.hls,b=a.media;if(!b)return 1/0;let c=b&&0!==b.playbackRate?Math.abs(b.playbackRate):1,d=a.mainForwardBufferInfo;return(d?d.len:0)/c}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(a,b,c,d,e,f,g){var h,i;let j,k=d+e,l=this.lastLoadedFragLevel,m=-1===l?this.hls.firstLevel:l,{fragCurrent:n,partCurrent:o}=this,{levels:p,allAudioTracks:q,loadLevel:r,config:s}=this.hls;if(1===p.length)return 0;let t=p[m],u=!!(null!=t&&null!=(h=t.details)&&h.live),v=-1===r||-1===l,w="SDR",y=(null==t?void 0:t.frameRate)||0,{audioPreference:A,videoPreference:B}=s,C=this.audioTracksByGroup||(this.audioTracksByGroup=q.reduce((a,b)=>{let c=a.groups[b.groupId];c||(c=a.groups[b.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),c.tracks.push(b);let d=b.channels||"2";return c.channels[d]=(c.channels[d]||0)+1,c.hasDefault=c.hasDefault||b.default,c.hasAutoSelect=c.hasAutoSelect||b.autoselect,c.hasDefault&&(a.hasDefaultAudio=!0),c.hasAutoSelect&&(a.hasAutoSelectAudio=!0),a},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}}));if(v){if(-1!==this.firstSelection)return this.firstSelection;let d=function(a,b,c,d,e){var f;let g,h,i=Object.keys(a),j=null==d?void 0:d.channels,k=null==d?void 0:d.audioCodec,l=j&&2===parseInt(j),m=!0,n=!1,o=1/0,p=1/0,q=1/0,r=0,s=[],{preferHDR:t,allowedVideoRanges:u}=(g=!1,h=[],(f=b)&&(g="SDR"!==f,h=[f]),e&&(h=e.allowedVideoRanges||bI.slice(0),h=(g=void 0!==e.preferHDR?e.preferHDR:function(){if("function"==typeof matchMedia){let a=matchMedia("(dynamic-range: high)"),b=matchMedia("bad query");if(a.media!==b.media)return!0===a.matches}return!1}())?h.filter(a=>"SDR"!==a):["SDR"]),{preferHDR:g,allowedVideoRanges:h});for(let b=i.length;b--;){let c=a[i[b]];m=c.channels[2]>0,o=Math.min(o,c.minHeight),p=Math.min(p,c.minFramerate),q=Math.min(q,c.minBitrate);let d=u.filter(a=>c.videoRanges[a]>0);d.length>0&&(n=!0,s=d)}o=z(o)?o:0,p=z(p)?p:0;let v=Math.max(1080,o),w=Math.max(30,p);return c=Math.max(q=z(q)?q:c,c),n||(b=void 0,s=[]),{codecSet:i.reduce((b,d)=>{let e=a[d];if(d===b)return b;if(e.minBitrate>c)return b5(d,`min bitrate of ${e.minBitrate} > current estimate of ${c}`),b;if(!e.hasDefaultAudio)return b5(d,"no renditions with default or auto-select sound found"),b;if(k&&d.indexOf(k.substring(0,4))%5!=0)return b5(d,`audio codec preference "${k}" not found`),b;if(j&&!l){if(!e.channels[j])return b5(d,`no renditions with ${j} channel sound found (channels options: ${Object.keys(e.channels)})`),b}else if((!k||l)&&m&&0===e.channels["2"])return b5(d,"no renditions with stereo sound found"),b;return e.minHeight>v?(b5(d,`min resolution of ${e.minHeight} > maximum of ${v}`),b):e.minFramerate>w?(b5(d,`min framerate of ${e.minFramerate} > maximum of ${w}`),b):s.some(a=>e.videoRanges[a]>0)?e.maxScore<r?(b5(d,`max score of ${e.maxScore} < selected max of ${r}`),b):b&&(a3(d)>=a3(b)||e.fragmentError>a[b].fragmentError)?b:(r=e.maxScore,d):(b5(d,`no variants with VIDEO-RANGE of ${JSON.stringify(s)} found`),b)},void 0),videoRanges:s,preferHDR:t,minFramerate:p,minBitrate:q}}(this.codecTiers||(this.codecTiers=p.slice(b,c+1).reduce((a,b)=>{if(!b.codecSet)return a;let c=b.audioGroups,d=a[b.codecSet];d||(a[b.codecSet]=d={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!c,fragmentError:0}),d.minBitrate=Math.min(d.minBitrate,b.bitrate);let e=Math.min(b.height,b.width);return d.minHeight=Math.min(d.minHeight,e),d.minFramerate=Math.min(d.minFramerate,b.frameRate),d.maxScore=Math.max(d.maxScore,b.score),d.fragmentError+=b.fragmentError,d.videoRanges[b.videoRange]=(d.videoRanges[b.videoRange]||0)+1,c&&c.forEach(a=>{if(!a)return;let b=C.groups[a];b&&(d.hasDefaultAudio=d.hasDefaultAudio||C.hasDefaultAudio?b.hasDefault:b.hasAutoSelect||!C.hasDefaultAudio&&!C.hasAutoSelectAudio,Object.keys(b.channels).forEach(a=>{d.channels[a]=(d.channels[a]||0)+b.channels[a]}))}),a},{})),w,a,A,B),{codecSet:e,videoRanges:f,minFramerate:g,minBitrate:h,preferHDR:i}=d;j=e,w=i?f[f.length-1]:f[0],y=g,a=Math.max(a,h),I.log(`[abr] picked start tier ${JSON.stringify(d)}`)}else j=null==t?void 0:t.codecSet,w=null==t?void 0:t.videoRange;let D=o?o.duration:n?n.duration:0,E=this.bwEstimator.getEstimateTTFB()/1e3,F=[];for(let h=c;h>=b;h--){let b,n=p[h],q=h>m;if(!n)continue;if(s.useMediaCapabilities&&!n.supportedResult&&!n.supportedPromise){let b=navigator.mediaCapabilities;"function"==typeof(null==b?void 0:b.decodingInfo)&&function(a,b,c,d,e,f){let g=a.audioCodec?a.audioGroups:null,h=null==f?void 0:f.audioCodec,i=null==f?void 0:f.channels,j=i?parseInt(i):h?1/0:2,k=null;if(null!=g&&g.length)try{k=1===g.length&&g[0]?b.groups[g[0]].channels:g.reduce((a,c)=>{if(c){let d=b.groups[c];if(!d)throw Error(`Audio track group ${c} not found`);Object.keys(d.channels).forEach(b=>{a[b]=(a[b]||0)+d.channels[b]})}return a},{2:0})}catch(a){return!0}return void 0!==a.videoCodec&&(a.width>1920&&a.height>1088||a.height>1920&&a.width>1088||a.frameRate>Math.max(d,30)||"SDR"!==a.videoRange&&a.videoRange!==c||a.bitrate>Math.max(e,8e6))||!!k&&z(j)&&Object.keys(k).some(a=>parseInt(a)>j)}(n,C,w,y,a,A)?(n.supportedPromise=function(a,b,c){let d=a.videoCodec,e=a.audioCodec;if(!d||!e||!c)return Promise.resolve(b3);let f={width:a.width,height:a.height,bitrate:Math.ceil(Math.max(.9*a.bitrate,a.averageBitrate)),framerate:a.frameRate||30},g=a.videoRange;"SDR"!==g&&(f.transferFunction=g.toLowerCase());let h=d.split(",").map(a=>({type:"media-source",video:x(x({},f),{},{contentType:a1(a,"video")})}));return e&&a.audioGroups&&a.audioGroups.forEach(a=>{var c;a&&(null==(c=b.groups[a])||c.tracks.forEach(b=>{if(b.groupId===a){let a=parseFloat(b.channels||"");z(a)&&a>2&&h.push.apply(h,e.split(",").map(b=>({type:"media-source",audio:{contentType:a1(b,"audio"),channels:""+a}})))}}))}),Promise.all(h.map(a=>{let b=function(a){let{audio:b,video:c}=a,d=c||b;if(d){let a=d.contentType.split('"')[1];if(c)return`r${c.height}x${c.width}f${Math.ceil(c.framerate)}${c.transferFunction||"sd"}_${a}_${Math.ceil(c.bitrate/1e5)}`;if(b)return`c${b.channels}${b.spatialRendering?"s":"n"}_${a}`}return""}(a);return b4[b]||(b4[b]=c.decodingInfo(a))})).then(a=>({supported:!a.some(a=>!a.supported),configurations:h,decodingInfoResults:a})).catch(a=>({supported:!1,configurations:h,decodingInfoResults:[],error:a}))}(n,C,b),n.supportedPromise.then(a=>{if(!this.hls)return;n.supportedResult=a;let b=this.hls.levels,c=b.indexOf(n);a.error?I.warn(`[abr] MediaCapabilities decodingInfo error: "${a.error}" for level ${c} ${JSON.stringify(a)}`):!a.supported&&(I.warn(`[abr] Unsupported MediaCapabilities decodingInfo result for level ${c} ${JSON.stringify(a)}`),c>-1&&b.length>1&&(I.log(`[abr] Removing unsupported level ${c}`),this.hls.removeLevel(c)))})):n.supportedResult=b3}if(j&&n.codecSet!==j||w&&n.videoRange!==w||q&&y>n.frameRate||!q&&y>0&&y<n.frameRate||n.supportedResult&&!(null!=(i=n.supportedResult.decodingInfoResults)&&i[0].smooth)){F.push(h);continue}let B=n.details,G=(o?null==B?void 0:B.partTarget:null==B?void 0:B.averagetargetduration)||D;b=q?g*a:f*a;let H=D&&d>=2*D&&0===e?p[h].averageBitrate:p[h].maxBitrate,J=this.getTimeToLoadFrag(E,b,H*G,void 0===B);if(b>=H&&(h===l||0===n.loadError&&0===n.fragmentError)&&(J<=E||!z(J)||u&&!this.bitrateTestDelay||J<k)){let a=this.forcedAutoLevel;return h!==r&&(-1===a||a!==r)&&(F.length&&I.trace(`[abr] Skipped level(s) ${F.join(",")} of ${c} max with CODECS and VIDEO-RANGE:"${p[F[0]].codecs}" ${p[F[0]].videoRange}; not compatible with "${t.codecs}" ${w}`),I.info(`[abr] switch candidate:${m}->${h} adjustedbw(${Math.round(b)})-bitrate=${Math.round(b-H)} ttfb:${E.toFixed(1)} avgDuration:${G.toFixed(1)} maxFetchDuration:${k.toFixed(1)} fetchDuration:${J.toFixed(1)} firstSelection:${v} codecSet:${j} videoRange:${w} hls.loadLevel:${r}`)),v&&(this.firstSelection=h),h}}return -1}set nextAutoLevel(a){let{maxAutoLevel:b,minAutoLevel:c}=this.hls,d=Math.min(Math.max(a,c),b);this._nextAutoLevel!==d&&(this.nextAutoLevelKey="",this._nextAutoLevel=d)}},bufferController:class{constructor(a){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=a=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=a=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{let{media:a,mediaSource:b}=this;this.log("Media source opened"),a&&(a.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(C.MEDIA_ATTACHED,{media:a,mediaSource:b})),b&&b.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{let{mediaSrc:a,_objectUrl:b}=this;a!==b&&I.error(`Media element src was set while attaching MediaSource (${b} > ${a})`)},this.hls=a;const b="[buffer-controller]";this.appendSource=function(a){return"u">typeof self&&a===self.ManagedMediaSource}(aZ(a.config.preferManagedMediaSource)),this.log=I.log.bind(I,b),this.warn=I.warn.bind(I,b),this.error=I.error.bind(I,b),this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){let{hls:a}=this;a.on(C.MEDIA_ATTACHING,this.onMediaAttaching,this),a.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),a.on(C.MANIFEST_LOADING,this.onManifestLoading,this),a.on(C.MANIFEST_PARSED,this.onManifestParsed,this),a.on(C.BUFFER_RESET,this.onBufferReset,this),a.on(C.BUFFER_APPENDING,this.onBufferAppending,this),a.on(C.BUFFER_CODECS,this.onBufferCodecs,this),a.on(C.BUFFER_EOS,this.onBufferEos,this),a.on(C.BUFFER_FLUSHING,this.onBufferFlushing,this),a.on(C.LEVEL_UPDATED,this.onLevelUpdated,this),a.on(C.FRAG_PARSED,this.onFragParsed,this),a.on(C.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){let{hls:a}=this;a.off(C.MEDIA_ATTACHING,this.onMediaAttaching,this),a.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),a.off(C.MANIFEST_LOADING,this.onManifestLoading,this),a.off(C.MANIFEST_PARSED,this.onManifestParsed,this),a.off(C.BUFFER_RESET,this.onBufferReset,this),a.off(C.BUFFER_APPENDING,this.onBufferAppending,this),a.off(C.BUFFER_CODECS,this.onBufferCodecs,this),a.off(C.BUFFER_EOS,this.onBufferEos,this),a.off(C.BUFFER_FLUSHING,this.onBufferFlushing,this),a.off(C.LEVEL_UPDATED,this.onLevelUpdated,this),a.off(C.FRAG_PARSED,this.onFragParsed,this),a.off(C.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new dF(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(a,b){let c=2;(!b.audio||b.video)&&b.altAudio||(c=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=c,this.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(a,b){let c=this.media=b.media,d=aZ(this.appendSource);if(c&&d){var e,f,g;let a=this.mediaSource=new d;this.log(`created media source: ${null==(e=a.constructor)?void 0:e.name}`),a.addEventListener("sourceopen",this._onMediaSourceOpen),a.addEventListener("sourceended",this._onMediaSourceEnded),a.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(a.addEventListener("startstreaming",this._onStartStreaming),a.addEventListener("endstreaming",this._onEndStreaming));let b=this._objectUrl=self.URL.createObjectURL(a);if(this.appendSource)try{let d;c.removeAttribute("src");let e=self.ManagedMediaSource;c.disableRemotePlayback=c.disableRemotePlayback||e&&a instanceof e,dH(c),f=c,g=b,(d=self.document.createElement("source")).type="video/mp4",d.src=g,f.appendChild(d),c.load()}catch(a){c.src=b}else c.src=b;c.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){let{media:a,mediaSource:b,_objectUrl:c}=this;if(b){if(this.log("media source detaching"),"open"===b.readyState)try{b.endOfStream()}catch(a){this.warn(`onMediaDetaching: ${a.message} while calling endOfStream`)}this.onBufferReset(),b.removeEventListener("sourceopen",this._onMediaSourceOpen),b.removeEventListener("sourceended",this._onMediaSourceEnded),b.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(b.removeEventListener("startstreaming",this._onStartStreaming),b.removeEventListener("endstreaming",this._onEndStreaming)),a&&(a.removeEventListener("emptied",this._onMediaEmptied),c&&self.URL.revokeObjectURL(c),this.mediaSrc===c?(a.removeAttribute("src"),this.appendSource&&dH(a),a.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(C.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach(a=>{this.resetBuffer(a)}),this._initSourceBuffer(),this.hls.resumeBuffering()}resetBuffer(a){let b=this.sourceBuffer[a];try{if(b){var c;this.removeBufferListeners(a),this.sourceBuffer[a]=void 0,null!=(c=this.mediaSource)&&c.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(b)}}catch(b){this.warn(`onBufferReset ${a}`,b)}}onBufferCodecs(a,b){let c=this.getSourceBufferTypes().length,d=Object.keys(b);if(d.forEach(a=>{if(c){let c=this.tracks[a];if(c&&"function"==typeof c.buffer.changeType){var d;let{id:e,codec:f,levelCodec:g,container:h,metadata:i}=b[a],j=a7(c.codec,c.levelCodec),k=null==j?void 0:j.replace(dG,"$1"),l=a7(f,g),m=null==(d=l)?void 0:d.replace(dG,"$1");if(l&&k!==m){"audio"===a.slice(0,5)&&(l=a6(l,this.appendSource));let b=`${h};codecs=${l}`;this.appendChangeType(a,b),this.log(`switching codec ${j} to ${l}`),this.tracks[a]={buffer:c.buffer,codec:f,container:h,levelCodec:g,metadata:i,id:e}}}}else this.pendingTracks[a]=b[a]}),c)return;let e=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==e&&(this.log(`${e} bufferCodec event(s) expected ${d.join(",")}`),this.bufferCodecEventsExpected=e),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks()}appendChangeType(a,b){let{operationQueue:c}=this;c.append({execute:()=>{let d=this.sourceBuffer[a];d&&(this.log(`changing ${a} sourceBuffer type to ${b}`),d.changeType(b)),c.shiftAndExecuteNext(a)},onStart:()=>{},onComplete:()=>{},onError:b=>{this.warn(`Failed to change ${a} SourceBuffer type`,b)}},a,!!this.pendingTracks[a])}onBufferAppending(a,b){let{hls:c,operationQueue:d,tracks:e}=this,{data:f,type:g,frag:h,part:i,chunkMeta:j}=b,k=j.buffering[g],l=self.performance.now();k.start=l;let m=h.stats.buffering,n=i?i.stats.buffering:null;0===m.start&&(m.start=l),n&&0===n.start&&(n.start=l);let o=e.audio,p=!1;"audio"===g&&(null==o?void 0:o.container)==="audio/mpeg"&&(p=!this.lastMpegAudioChunk||1===j.id||this.lastMpegAudioChunk.sn!==j.sn,this.lastMpegAudioChunk=j);let q=h.start;d.append({execute:()=>{if(k.executeStart=self.performance.now(),p){let a=this.sourceBuffer[g];if(a){let b=q-a.timestampOffset;Math.abs(b)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${q} (delta: ${b}) sn: ${h.sn})`),a.timestampOffset=q)}}this.appendExecutor(f,g)},onStart:()=>{},onComplete:()=>{let a=self.performance.now();k.executeEnd=k.end=a,0===m.first&&(m.first=a),n&&0===n.first&&(n.first=a);let{sourceBuffer:b}=this,c={};for(let a in b)c[a]=ci.getBuffered(b[a]);this.appendErrors[g]=0,"audio"===g||"video"===g?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(C.BUFFER_APPENDED,{type:g,frag:h,part:i,chunkMeta:j,parent:h.type,timeRanges:c})},onError:a=>{let b={type:D.MEDIA_ERROR,parent:h.type,details:E.BUFFER_APPEND_ERROR,sourceBufferName:g,frag:h,part:i,chunkMeta:j,error:a,err:a,fatal:!1};if(a.code===DOMException.QUOTA_EXCEEDED_ERR)b.details=E.BUFFER_FULL_ERROR;else{let a=++this.appendErrors[g];b.details=E.BUFFER_APPEND_ERROR,this.warn(`Failed ${a}/${c.config.appendErrorMaxRetry} times to append segment in "${g}" sourceBuffer`),a>=c.config.appendErrorMaxRetry&&(b.fatal=!0)}c.trigger(C.ERROR,b)}},g,!!this.pendingTracks[g])}onBufferFlushing(a,b){let{operationQueue:c}=this,d=a=>({execute:this.removeExecutor.bind(this,a,b.startOffset,b.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(C.BUFFER_FLUSHED,{type:a})},onError:b=>{this.warn(`Failed to remove from ${a} SourceBuffer`,b)}});b.type?c.append(d(b.type),b.type):this.getSourceBufferTypes().forEach(a=>{c.append(d(a),a)})}onFragParsed(a,b){let{frag:c,part:d}=b,e=[],f=d?d.elementaryStreams:c.elementaryStreams;f[Q]?e.push("audiovideo"):(f[O]&&e.push("audio"),f[P]&&e.push("video"));let g=()=>{let a=self.performance.now();c.stats.buffering.end=a,d&&(d.stats.buffering.end=a);let b=d?d.stats:c.stats;this.hls.trigger(C.FRAG_BUFFERED,{frag:c,part:d,stats:b,id:c.type})};0===e.length&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${c.type} level: ${c.level} sn: ${c.sn}`),this.blockBuffers(g,e)}onFragChanged(a,b){this.trimBuffers()}onBufferEos(a,b){this.getSourceBufferTypes().reduce((a,c)=>{let d=this.sourceBuffer[c];return d&&(!b.type||b.type===c)&&(d.ending=!0,d.ended||(d.ended=!0,this.log(`${c} sourceBuffer now EOS`))),a&&!!(!d||d.ended)},!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers(()=>{this.getSourceBufferTypes().forEach(a=>{let b=this.sourceBuffer[a];b&&(b.ending=!1)});let{mediaSource:a}=this;if(!a||"open"!==a.readyState){a&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${a.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),a.endOfStream()}))}onLevelUpdated(a,{details:b}){b.fragments.length&&(this.details=b,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){let{hls:a,details:b,media:c}=this;if(!c||null===b||!this.getSourceBufferTypes().length)return;let d=a.config,e=c.currentTime,f=b.levelTargetDuration,g=b.live&&null!==d.liveBackBufferLength?d.liveBackBufferLength:d.backBufferLength;if(z(g)&&g>0){let a=Math.max(g,f),b=Math.floor(e/f)*f-a;this.flushBackBuffer(e,f,b)}if(z(d.frontBufferFlushThreshold)&&d.frontBufferFlushThreshold>0){let a=Math.max(Math.max(d.maxBufferLength,d.frontBufferFlushThreshold),f),b=Math.floor(e/f)*f+a;this.flushFrontBuffer(e,f,b)}}flushBackBuffer(a,b,c){let{details:d,sourceBuffer:e}=this;this.getSourceBufferTypes().forEach(f=>{let g=e[f];if(g){let e=ci.getBuffered(g);if(e.length>0&&c>e.start(0)){if(this.hls.trigger(C.BACK_BUFFER_REACHED,{bufferEnd:c}),null!=d&&d.live)this.hls.trigger(C.LIVE_BACK_BUFFER_REACHED,{bufferEnd:c});else if(g.ended&&e.end(e.length-1)-a<2*b)return void this.log(`Cannot flush ${f} back buffer while SourceBuffer is in ended state`);this.hls.trigger(C.BUFFER_FLUSHING,{startOffset:0,endOffset:c,type:f})}}})}flushFrontBuffer(a,b,c){let{sourceBuffer:d}=this;this.getSourceBufferTypes().forEach(e=>{let f=d[e];if(f){let d=ci.getBuffered(f),g=d.length;if(g<2)return;let h=d.start(g-1),i=d.end(g-1);if(c>h||a>=h&&a<=i)return;if(f.ended&&a-i<2*b)return void this.log(`Cannot flush ${e} front buffer while SourceBuffer is in ended state`);this.hls.trigger(C.BUFFER_FLUSHING,{startOffset:h,endOffset:1/0,type:e})}})}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||"open"!==this.mediaSource.readyState)return;let{details:a,hls:b,media:c,mediaSource:d}=this,e=a.fragments[0].start+a.totalduration,f=c.duration,g=z(d.duration)?d.duration:0;a.live&&b.config.liveDurationInfinity?(d.duration=1/0,this.updateSeekableRange(a)):(e>g&&e>f||!z(f))&&(this.log(`Updating Media Source duration to ${e.toFixed(3)}`),d.duration=e)}updateSeekableRange(a){let b=this.mediaSource,c=a.fragments;if(c.length&&a.live&&null!=b&&b.setLiveSeekableRange){let d=Math.max(0,c[0].start),e=Math.max(d,d+a.totalduration);this.log(`Media Source duration is set to ${b.duration}. Setting seekable range to ${d}-${e}.`),b.setLiveSeekableRange(d,e)}}checkPendingTracks(){let{bufferCodecEventsExpected:a,operationQueue:b,pendingTracks:c}=this,d=Object.keys(c).length;if(d&&(!a||2===d||"audiovideo"in c)){this.createSourceBuffers(c),this.pendingTracks={};let a=this.getSourceBufferTypes();if(a.length)this.hls.trigger(C.BUFFER_CREATED,{tracks:this.tracks}),a.forEach(a=>{b.executeNext(a)});else{let a=Error("could not create source buffer for media codec(s)");this.hls.trigger(C.ERROR,{type:D.MEDIA_ERROR,details:E.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:a,reason:a.message})}}}createSourceBuffers(a){let{sourceBuffer:b,mediaSource:c}=this;if(!c)throw Error("createSourceBuffers called when mediaSource was null");for(let e in a)if(!b[e]){var d;let f=a[e];if(!f)throw Error(`source buffer exists for track ${e}, however track does not`);let g=(null==(d=f.levelCodec)?void 0:d.indexOf(","))===-1?f.levelCodec:f.codec;g&&"audio"===e.slice(0,5)&&(g=a6(g,this.appendSource));let h=`${f.container};codecs=${g}`;this.log(`creating sourceBuffer(${h})`);try{let a=b[e]=c.addSourceBuffer(h);this.addBufferListener(e,"updatestart",this._onSBUpdateStart),this.addBufferListener(e,"updateend",this._onSBUpdateEnd),this.addBufferListener(e,"error",this._onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(a,b)=>{let c=b.removedRanges;null!=c&&c.length&&this.hls.trigger(C.BUFFER_FLUSHED,{type:e})}),this.tracks[e]={buffer:a,codec:g,container:f.container,levelCodec:f.levelCodec,metadata:f.metadata,id:f.id}}catch(a){this.error(`error while trying to add sourceBuffer: ${a.message}`),this.hls.trigger(C.ERROR,{type:D.MEDIA_ERROR,details:E.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:a,sourceBufferName:e,mimeType:h})}}}get mediaSrc(){var a,b;let c=(null==(a=this.media)||null==(b=a.querySelector)?void 0:b.call(a,"source"))||this.media;return null==c?void 0:c.src}_onSBUpdateStart(a){let{operationQueue:b}=this;b.current(a).onStart()}_onSBUpdateEnd(a){var b;if((null==(b=this.mediaSource)?void 0:b.readyState)==="closed")return void this.resetBuffer(a);let{operationQueue:c}=this;c.current(a).onComplete(),c.shiftAndExecuteNext(a)}_onSBUpdateError(a,b){var c;let d=Error(`${a} SourceBuffer error. MediaSource readyState: ${null==(c=this.mediaSource)?void 0:c.readyState}`);this.error(`${d}`,b),this.hls.trigger(C.ERROR,{type:D.MEDIA_ERROR,details:E.BUFFER_APPENDING_ERROR,sourceBufferName:a,error:d,fatal:!1});let e=this.operationQueue.current(a);e&&e.onError(d)}removeExecutor(a,b,c){let{media:d,mediaSource:e,operationQueue:f,sourceBuffer:g}=this,h=g[a];if(!d||!e||!h){this.warn(`Attempting to remove from the ${a} SourceBuffer, but it does not exist`),f.shiftAndExecuteNext(a);return}let i=z(d.duration)?d.duration:1/0,j=z(e.duration)?e.duration:1/0,k=Math.max(0,b),l=Math.min(c,i,j);l>k&&(!h.ending||h.ended)?(h.ended=!1,this.log(`Removing [${k},${l}] from the ${a} SourceBuffer`),h.remove(k,l)):f.shiftAndExecuteNext(a)}appendExecutor(a,b){let c=this.sourceBuffer[b];if(!c){if(!this.pendingTracks[b])throw Error(`Attempting to append to the ${b} SourceBuffer, but it does not exist`);return}c.ended=!1,c.appendBuffer(a)}blockBuffers(a,b=this.getSourceBufferTypes()){if(!b.length){this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(a);return}let{operationQueue:c}=this;Promise.all(b.map(a=>c.appendBlocker(a))).then(()=>{a(),b.forEach(a=>{let b=this.sourceBuffer[a];null!=b&&b.updating||c.shiftAndExecuteNext(a)})})}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(a,b,c){let d=this.sourceBuffer[a];if(!d)return;let e=c.bind(this,a);this.listeners[a].push({event:b,listener:e}),d.addEventListener(b,e)}removeBufferListeners(a){let b=this.sourceBuffer[a];b&&this.listeners[a].forEach(a=>{b.removeEventListener(a.event,a.listener)})}},capLevelController:eo,errorController:class{constructor(a){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=a,this.log=I.log.bind(I,"[info]:"),this.warn=I.warn.bind(I,"[warning]:"),this.error=I.error.bind(I,"[error]:"),this.registerListeners()}registerListeners(){let a=this.hls;a.on(C.ERROR,this.onError,this),a.on(C.MANIFEST_LOADING,this.onManifestLoading,this),a.on(C.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){let a=this.hls;a&&(a.off(C.ERROR,this.onError,this),a.off(C.ERROR,this.onErrorOut,this),a.off(C.MANIFEST_LOADING,this.onManifestLoading,this),a.off(C.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(a){}stopLoad(){this.playlistError=0}getVariantLevelIndex(a){return(null==a?void 0:a.type)===bo?a.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(a,b){var c,d,e,f;if(b.fatal)return;let g=this.hls,h=b.context;switch(b.details){case E.FRAG_LOAD_ERROR:case E.FRAG_LOAD_TIMEOUT:case E.KEY_LOAD_ERROR:case E.KEY_LOAD_TIMEOUT:b.errorAction=this.getFragRetryOrSwitchAction(b);return;case E.FRAG_PARSING_ERROR:if(null!=(c=b.frag)&&c.gap){b.errorAction={action:0,flags:0};return}case E.FRAG_GAP:case E.FRAG_DECRYPT_ERROR:b.errorAction=this.getFragRetryOrSwitchAction(b),b.errorAction.action=2;return;case E.LEVEL_EMPTY_ERROR:case E.LEVEL_PARSING_ERROR:{let a=b.parent===bo?b.level:g.loadLevel;b.details===E.LEVEL_EMPTY_ERROR&&null!=(e=b.context)&&null!=(f=e.levelDetails)&&f.live?b.errorAction=this.getPlaylistRetryOrSwitchAction(b,a):(b.levelRetry=!1,b.errorAction=this.getLevelSwitchAction(b,a))}return;case E.LEVEL_LOAD_ERROR:case E.LEVEL_LOAD_TIMEOUT:"number"==typeof(null==h?void 0:h.level)&&(b.errorAction=this.getPlaylistRetryOrSwitchAction(b,h.level));return;case E.AUDIO_TRACK_LOAD_ERROR:case E.AUDIO_TRACK_LOAD_TIMEOUT:case E.SUBTITLE_LOAD_ERROR:case E.SUBTITLE_TRACK_LOAD_TIMEOUT:if(h){let a=g.levels[g.loadLevel];a&&(h.type===bm&&a.hasAudioGroup(h.groupId)||h.type===bn&&a.hasSubtitleGroup(h.groupId))&&(b.errorAction=this.getPlaylistRetryOrSwitchAction(b,g.loadLevel),b.errorAction.action=2,b.errorAction.flags=1)}return;case E.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{let a=g.levels[g.loadLevel],c=null==a?void 0:a.attrs["HDCP-LEVEL"];c?b.errorAction={action:2,flags:2,hdcpLevel:c}:this.keySystemError(b)}return;case E.BUFFER_ADD_CODEC_ERROR:case E.REMUX_ALLOC_ERROR:case E.BUFFER_APPEND_ERROR:b.errorAction=this.getLevelSwitchAction(b,null!=(d=b.level)?d:g.loadLevel);return;case E.INTERNAL_EXCEPTION:case E.BUFFER_APPENDING_ERROR:case E.BUFFER_FULL_ERROR:case E.LEVEL_SWITCH_ERROR:case E.BUFFER_STALLED_ERROR:case E.BUFFER_SEEK_OVER_HOLE:case E.BUFFER_NUDGE_ON_STALL:b.errorAction={action:0,flags:0};return}b.type===D.KEY_SYSTEM_ERROR&&this.keySystemError(b)}keySystemError(a){let b=this.getVariantLevelIndex(a.frag);a.levelRetry=!1,a.errorAction=this.getLevelSwitchAction(a,b)}getPlaylistRetryOrSwitchAction(a,b){let c=bV(this.hls.config.playlistLoadPolicy,a),d=this.playlistError++;if(bY(c,d,bU(a),a.response))return{action:5,flags:0,retryConfig:c,retryCount:d};let e=this.getLevelSwitchAction(a,b);return c&&(e.retryConfig=c,e.retryCount=d),e}getFragRetryOrSwitchAction(a){let b=this.hls,c=this.getVariantLevelIndex(a.frag),d=b.levels[c],{fragLoadPolicy:e,keyLoadPolicy:f}=b.config,g=bV(a.details.startsWith("key")?f:e,a),h=b.levels.reduce((a,b)=>a+b.fragmentError,0);if(d&&(a.details!==E.FRAG_GAP&&d.fragmentError++,bY(g,h,bU(a),a.response)))return{action:5,flags:0,retryConfig:g,retryCount:h};let i=this.getLevelSwitchAction(a,c);return g&&(i.retryConfig=g,i.retryCount=h),i}getLevelSwitchAction(a,b){let c=this.hls;null==b&&(b=c.loadLevel);let d=this.hls.levels[b];if(d){var e,f,g,h;let b=a.details;d.loadError++,b===E.BUFFER_APPEND_ERROR&&d.fragmentError++;let i=-1,{levels:j,loadLevel:k,minAutoLevel:l,maxAutoLevel:m}=c;c.autoLevelEnabled||(c.loadLevel=-1);let n=null==(e=a.frag)?void 0:e.type,o=(n===bp&&b===E.FRAG_PARSING_ERROR||"audio"===a.sourceBufferName&&(b===E.BUFFER_ADD_CODEC_ERROR||b===E.BUFFER_APPEND_ERROR))&&j.some(({audioCodec:a})=>d.audioCodec!==a),p="video"===a.sourceBufferName&&(b===E.BUFFER_ADD_CODEC_ERROR||b===E.BUFFER_APPEND_ERROR)&&j.some(({codecSet:a,audioCodec:b})=>d.codecSet!==a&&d.audioCodec===b),{type:q,groupId:r}=null!=(f=a.context)?f:{};for(let c=j.length;c--;){let e=(c+k)%j.length;if(e!==k&&e>=l&&e<=m&&0===j[e].loadError){let c=j[e];if(b===E.FRAG_GAP&&n===bo&&a.frag){let b=j[e].details;if(b){let c=b$(a.frag,b.fragments,a.frag.start);if(null!=c&&c.gap)continue}}else if(q===bm&&c.hasAudioGroup(r)||q===bn&&c.hasSubtitleGroup(r))continue;else if(n===bp&&null!=(g=d.audioGroups)&&g.some(a=>c.hasAudioGroup(a))||n===bq&&null!=(h=d.subtitleGroups)&&h.some(a=>c.hasSubtitleGroup(a))||o&&d.audioCodec===c.audioCodec||!o&&d.audioCodec!==c.audioCodec||p&&d.codecSet===c.codecSet)continue;i=e;break}}if(i>-1&&c.loadLevel!==i)return a.levelRetry=!0,this.playlistError=0,{action:2,flags:0,nextAutoLevel:i}}return{action:2,flags:1}}onErrorOut(a,b){var c;switch(null==(c=b.errorAction)?void 0:c.action){case 0:break;case 2:this.sendAlternateToPenaltyBox(b),b.errorAction.resolved||b.details===E.FRAG_GAP?/MediaSource readyState: ended/.test(b.error.message)&&(this.warn(`MediaSource ended after "${b.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError()):b.fatal=!0}if(b.fatal)return void this.hls.stopLoad()}sendAlternateToPenaltyBox(a){let b=this.hls,c=a.errorAction;if(!c)return;let{flags:d,hdcpLevel:e,nextAutoLevel:f}=c;switch(d){case 0:this.switchLevel(a,f);break;case 2:e&&(b.maxHdcpLevel=bH[bH.indexOf(e)-1],c.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${b.maxHdcpLevel}" or lower`)}c.resolved||this.switchLevel(a,f)}switchLevel(a,b){void 0!==b&&a.errorAction&&(this.warn(`switching to level ${b} after ${a.details}`),this.hls.nextAutoLevel=b,a.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}},fpsController:class{constructor(a){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=a,this.registerListeners()}setStreamController(a){this.streamController=a}registerListeners(){this.hls.on(C.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(C.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(a,b){let c=this.hls.config;if(c.capLevelOnFPSDrop){let a=b.media instanceof self.HTMLVideoElement?b.media:null;this.media=a,a&&"function"==typeof a.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),c.fpsDroppedMonitoringPeriod)}}checkFPS(a,b,c){let d=performance.now();if(b){if(this.lastTime){let a=d-this.lastTime,e=c-this.lastDroppedFrames,f=b-this.lastDecodedFrames,g=1e3*e/a,h=this.hls;if(h.trigger(C.FPS_DROP,{currentDropped:e,currentDecoded:f,totalDroppedFrames:c}),g>0&&e>h.config.fpsDroppedMonitoringThreshold*f){let a=h.currentLevel;I.warn("drop FPS ratio greater than max allowed value for currentLevel: "+a),a>0&&(-1===h.autoLevelCapping||h.autoLevelCapping>=a)&&(a-=1,h.trigger(C.FPS_DROP_LEVEL_CAPPING,{level:a,droppedLevel:h.currentLevel}),h.autoLevelCapping=a,this.streamController.nextLevelSwitch())}}this.lastTime=d,this.lastDroppedFrames=c,this.lastDecodedFrames=b}}checkFPSInterval(){let a=this.media;if(a)if(this.isVideoPlaybackQualityAvailable){let b=a.getVideoPlaybackQuality();this.checkFPS(a,b.totalVideoFrames,b.droppedVideoFrames)}else this.checkFPS(a,a.webkitDecodedFrameCount,a.webkitDroppedFrameCount)}},stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:aj,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},{cueHandler:eS,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:class extends cK{constructor(a,b,c){super(a,b,c,"[subtitle-stream-controller]",bq),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}_registerListeners(){let{hls:a}=this;a.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),a.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),a.on(C.MANIFEST_LOADING,this.onManifestLoading,this),a.on(C.LEVEL_LOADED,this.onLevelLoaded,this),a.on(C.ERROR,this.onError,this),a.on(C.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),a.on(C.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),a.on(C.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),a.on(C.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),a.on(C.BUFFER_FLUSHING,this.onBufferFlushing,this),a.on(C.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){let{hls:a}=this;a.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),a.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),a.off(C.MANIFEST_LOADING,this.onManifestLoading,this),a.off(C.LEVEL_LOADED,this.onLevelLoaded,this),a.off(C.ERROR,this.onError,this),a.off(C.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),a.off(C.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),a.off(C.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),a.off(C.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),a.off(C.BUFFER_FLUSHING,this.onBufferFlushing,this),a.off(C.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(a){this.stopLoad(),this.state=cz,this.setInterval(500),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=a,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(a,b){this.mainDetails=b.details}onSubtitleFragProcessed(a,b){let c,{frag:d,success:e}=b;if(this.fragPrevious=d,this.state=cz,!e)return;let f=this.tracksBuffered[this.currentTrackId];if(!f)return;let g=d.start;for(let a=0;a<f.length;a++)if(g>=f[a].start&&g<=f[a].end){c=f[a];break}let h=d.start+d.duration;c?c.end=h:(c={start:g,end:h},f.push(c)),this.fragmentTracker.fragBuffered(d),this.fragBufferedComplete(d,null)}onBufferFlushing(a,b){let{startOffset:c,endOffset:d}=b;if(0===c&&d!==1/0){let a=d-1;if(a<=0)return;b.endOffsetSubtitles=Math.max(0,a),this.tracksBuffered.forEach(b=>{for(let c=0;c<b.length;){if(b[c].end<=a){b.shift();continue}if(b[c].start<a)b[c].start=a;else break;c++}}),this.fragmentTracker.removeFragmentsInRange(c,a,bq)}}onFragBuffered(a,b){if(!this.loadedmetadata&&b.frag.type===bo){var c;null!=(c=this.media)&&c.buffered.length&&(this.loadedmetadata=!0)}}onError(a,b){let c=b.frag;(null==c?void 0:c.type)===bq&&(b.details===E.FRAG_GAP&&this.fragmentTracker.fragBuffered(c,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==cy&&(this.state=cz))}onSubtitleTracksUpdated(a,{subtitleTracks:b}){if(this.levels&&dB(this.levels,b)){this.levels=b.map(a=>new bL(a));return}this.tracksBuffered=[],this.levels=b.map(a=>{let b=new bL(a);return this.tracksBuffered[b.id]=[],b}),this.fragmentTracker.removeFragmentsInRange(0,1/0,bq),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(a,b){var c;if(this.currentTrackId=b.id,!(null!=(c=this.levels)&&c.length)||-1===this.currentTrackId)return void this.clearInterval();let d=this.levels[this.currentTrackId];null!=d&&d.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,d&&this.setInterval(500)}onSubtitleTrackLoaded(a,b){var c,d;let{currentTrackId:e,levels:f}=this,{details:g,id:h}=b;if(!f)return void this.warn(`Subtitle tracks were reset while loading level ${h}`);let i=f[h];if(h>=f.length||!i)return;this.log(`Subtitle track ${h} loaded [${g.startSN},${g.endSN}]${g.lastPartSn?`[part-${g.lastPartSn}-${g.lastPartIndex}]`:""},duration:${g.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let j=0;if(g.live||null!=(c=i.details)&&c.live){let a=this.mainDetails;if(g.deltaUpdateFailed||!a)return;let b=a.fragments[0];i.details?0===(j=this.alignPlaylists(g,i.details,null==(d=this.levelLastLoaded)?void 0:d.details))&&b&&bQ(g,j=b.start):g.hasProgramDateTime&&a.hasProgramDateTime?(co(g,a),j=g.fragments[0].start):b&&bQ(g,j=b.start)}i.details=g,this.levelLastLoaded=i,h===e&&(this.startFragRequested||!this.mainDetails&&g.live||this.setStartPosition(this.mainDetails||g,j),this.tick(),g.live&&!this.fragCurrent&&this.media&&this.state===cz&&(b$(null,g.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),i.details=void 0)))}_handleFragmentLoadComplete(a){let{frag:b,payload:c}=a,d=b.decryptdata,e=this.hls;if(!this.fragContextChanged(b)&&c&&c.byteLength>0&&null!=d&&d.key&&d.iv&&"AES-128"===d.method){let a=performance.now();this.decrypter.decrypt(new Uint8Array(c),d.key.buffer,d.iv.buffer).catch(a=>{throw e.trigger(C.ERROR,{type:D.MEDIA_ERROR,details:E.FRAG_DECRYPT_ERROR,fatal:!1,error:a,reason:a.message,frag:b}),a}).then(c=>{let d=performance.now();e.trigger(C.FRAG_DECRYPTED,{frag:b,payload:c,stats:{tstart:a,tdecrypt:d}})}).catch(a=>{this.warn(`${a.name}: ${a.message}`),this.state=cz})}}doTick(){if(!this.media){this.state=cz;return}if(this.state===cz){let{currentTrackId:a,levels:b}=this,c=null==b?void 0:b[a];if(!c||!b.length||!c.details)return;let{config:d}=this,e=this.getLoadPosition(),{end:f,len:g}=ci.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],e,d.maxBufferHole),h=this.getFwdBufferInfo(this.media,bo),i=c.details;if(g>this.getMaxBufferLength(null==h?void 0:h.len)+i.levelTargetDuration)return;let j=i.fragments,k=j.length,l=i.edge,m=null,n=this.fragPrevious;if(f<l){let a=d.maxFragLookUpTolerance;(m=b$(n,j,Math.max(j[0].start,f),f>l-a?0:a))||!n||!(n.start<j[0].start)||(m=j[0])}else m=j[k-1];if(!m)return;if("initSegment"!==(m=this.mapToInitFragWhenRequired(m)).sn){let a=j[m.sn-i.startSN-1];a&&a.cc===m.cc&&this.fragmentTracker.getState(a)===cb&&(m=a)}this.fragmentTracker.getState(m)===cb&&this.loadFragment(m,c,f)}}getMaxBufferLength(a){let b=super.getMaxBufferLength();return a?Math.max(b,a):b}loadFragment(a,b,c){this.fragCurrent=a,"initSegment"===a.sn?this._loadInitSegment(a,b):(this.startFragRequested=!0,super.loadFragment(a,b,c))}get mediaBufferTimeRanges(){return new dE(this.tracksBuffered[this.currentTrackId]||[])}},subtitleTrackController:class extends b0{constructor(a){super(a,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let a=null,b=by(this.media.textTracks);for(let c=0;c<b.length;c++)if("hidden"===b[c].mode)a=b[c];else if("showing"===b[c].mode){a=b[c];break}let c=this.findTrackForTextTrack(a);this.subtitleTrack!==c&&this.setSubtitleTrack(c)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(a){this._subtitleDisplay=a,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){let{hls:a}=this;a.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),a.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),a.on(C.MANIFEST_LOADING,this.onManifestLoading,this),a.on(C.MANIFEST_PARSED,this.onManifestParsed,this),a.on(C.LEVEL_LOADING,this.onLevelLoading,this),a.on(C.LEVEL_SWITCHING,this.onLevelSwitching,this),a.on(C.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),a.on(C.ERROR,this.onError,this)}unregisterListeners(){let{hls:a}=this;a.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),a.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),a.off(C.MANIFEST_LOADING,this.onManifestLoading,this),a.off(C.MANIFEST_PARSED,this.onManifestParsed,this),a.off(C.LEVEL_LOADING,this.onLevelLoading,this),a.off(C.LEVEL_SWITCHING,this.onLevelSwitching,this),a.off(C.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),a.off(C.ERROR,this.onError,this)}onMediaAttached(a,b){this.media=b.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(a){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,a)}onMediaDetaching(){this.media&&(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),by(this.media.textTracks).forEach(a=>{bw(a)}),this.subtitleTrack=-1,this.media=null)}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(a,b){this.tracks=b.subtitleTracks}onSubtitleTrackLoaded(a,b){let{id:c,groupId:d,details:e}=b,f=this.tracksInGroup[c];if(!f||f.groupId!==d)return void this.warn(`Subtitle track with id:${c} and group:${d} not found in active group ${null==f?void 0:f.groupId}`);let g=f.details;f.details=b.details,this.log(`Subtitle track ${c} "${f.name}" lang:${f.lang} group:${d} loaded [${e.startSN}-${e.endSN}]`),c===this.trackId&&this.playlistLoaded(c,b,g)}onLevelLoading(a,b){this.switchLevel(b.level)}onLevelSwitching(a,b){this.switchLevel(b.level)}switchLevel(a){let b=this.hls.levels[a];if(!b)return;let c=b.subtitleGroups||null,d=this.groupIds,e=this.currentTrack;if(!c||(null==d?void 0:d.length)!==(null==c?void 0:c.length)||null!=c&&c.some(a=>(null==d?void 0:d.indexOf(a))===-1)){this.groupIds=c,this.trackId=-1,this.currentTrack=null;let a=this.tracks.filter(a=>!c||-1!==c.indexOf(a.groupId));if(a.length)this.selectDefaultTrack&&!a.some(a=>a.default)&&(this.selectDefaultTrack=!1),a.forEach((a,b)=>{a.id=b});else if(!e&&!this.tracksInGroup.length)return;this.tracksInGroup=a;let b=this.hls.config.subtitlePreference;if(!e&&b){this.selectDefaultTrack=!1;let c=b6(b,a);if(c>-1)e=a[c];else{let a=b6(b,this.tracks);e=this.tracks[a]}}let d=this.findTrackId(e);-1===d&&e&&(d=this.findTrackId(null)),this.log(`Updating subtitle tracks, ${a.length} track(s) found in "${null==c?void 0:c.join(",")}" group-id`),this.hls.trigger(C.SUBTITLE_TRACKS_UPDATED,{subtitleTracks:a}),-1!==d&&-1===this.trackId&&this.setSubtitleTrack(d)}else this.shouldReloadPlaylist(e)&&this.setSubtitleTrack(this.trackId)}findTrackId(a){let b=this.tracksInGroup,c=this.selectDefaultTrack;for(let d=0;d<b.length;d++){let e=b[d];if((!c||e.default)&&(c||a)&&(!a||b7(e,a)))return d}if(a){for(let c=0;c<b.length;c++){let d=b[c];if(dC(a.attrs,d.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return c}for(let c=0;c<b.length;c++){let d=b[c];if(dC(a.attrs,d.attrs,["LANGUAGE"]))return c}}return -1}findTrackForTextTrack(a){if(a){let b=this.tracksInGroup;for(let c=0;c<b.length;c++)if(dD(b[c],a))return c}return -1}onError(a,b){!b.fatal&&b.context&&(b.context.type!==bn||b.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(b.context.groupId)||this.checkRetry(b))}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(a){this.selectDefaultTrack=!1,this.setSubtitleTrack(a)}setSubtitleOption(a){if(this.hls.config.subtitlePreference=a,a){let b=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,b.length){let c=this.currentTrack;if(c&&b7(a,c))return c;let d=b6(a,this.tracksInGroup);if(d>-1){let a=this.tracksInGroup[d];return this.setSubtitleTrack(d),a}{if(c)return null;let d=b6(a,b);if(d>-1)return b[d]}}}return null}loadPlaylist(a){super.loadPlaylist();let b=this.currentTrack;if(this.shouldLoadPlaylist(b)&&b){let c=b.id,d=b.groupId,e=b.url;if(a)try{e=a.addDirectives(e)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}this.log(`Loading subtitle playlist for id ${c}`),this.hls.trigger(C.SUBTITLE_TRACK_LOADING,{url:e,id:c,groupId:d,deliveryDirectives:a||null})}}toggleTrackModes(){let a,{media:b}=this;if(!b)return;let c=by(b.textTracks),d=this.currentTrack;if(d&&((a=c.filter(a=>dD(d,a))[0])||this.warn(`Unable to find subtitle TextTrack with name "${d.name}" and language "${d.lang}"`)),[].slice.call(c).forEach(b=>{"disabled"!==b.mode&&b!==a&&(b.mode="disabled")}),a){let b=this.subtitleDisplay?"showing":"hidden";a.mode!==b&&(a.mode=b)}}setSubtitleTrack(a){let b=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=a;return}if(a<-1||a>=b.length||!z(a))return void this.warn(`Invalid subtitle track id: ${a}`);this.clearTimer(),this.selectDefaultTrack=!1;let c=this.currentTrack,d=b[a]||null;if(this.trackId=a,this.currentTrack=d,this.toggleTrackModes(),!d)return void this.hls.trigger(C.SUBTITLE_TRACK_SWITCH,{id:a});let e=!!d.details&&!d.details.live;if(a===this.trackId&&d===c&&e)return;this.log(`Switching to subtitle-track ${a}`+(d?` "${d.name}" lang:${d.lang} group:${d.groupId}`:""));let{id:f,groupId:g="",name:h,type:i,url:j}=d;this.hls.trigger(C.SUBTITLE_TRACK_SWITCH,{id:f,groupId:g,name:h,type:i,url:j});let k=this.switchParams(d.url,null==c?void 0:c.details,d.details);this.loadPlaylist(k)}},timelineController:class{constructor(a){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=en(),this.captionsProperties=void 0,this.hls=a,this.config=a.config,this.Cues=a.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},a.on(C.MEDIA_ATTACHING,this.onMediaAttaching,this),a.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),a.on(C.MANIFEST_LOADING,this.onManifestLoading,this),a.on(C.MANIFEST_LOADED,this.onManifestLoaded,this),a.on(C.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),a.on(C.FRAG_LOADING,this.onFragLoading,this),a.on(C.FRAG_LOADED,this.onFragLoaded,this),a.on(C.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),a.on(C.FRAG_DECRYPTED,this.onFragDecrypted,this),a.on(C.INIT_PTS_FOUND,this.onInitPtsFound,this),a.on(C.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),a.on(C.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){let{hls:a}=this;a.off(C.MEDIA_ATTACHING,this.onMediaAttaching,this),a.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),a.off(C.MANIFEST_LOADING,this.onManifestLoading,this),a.off(C.MANIFEST_LOADED,this.onManifestLoaded,this),a.off(C.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),a.off(C.FRAG_LOADING,this.onFragLoading,this),a.off(C.FRAG_LOADED,this.onFragLoaded,this),a.off(C.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),a.off(C.FRAG_DECRYPTED,this.onFragDecrypted,this),a.off(C.INIT_PTS_FOUND,this.onInitPtsFound,this),a.off(C.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),a.off(C.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){let a=new dX(this,"textTrack1"),b=new dX(this,"textTrack2"),c=new dX(this,"textTrack3"),d=new dX(this,"textTrack4");this.cea608Parser1=new dW(1,a,b),this.cea608Parser2=new dW(3,c,d)}}addCues(a,b,c,d,e){let f=!1;for(let a=e.length;a--;){var g,h;let d=e[a],i=(g=d[0],h=d[1],Math.min(h,c)-Math.max(g,b));if(i>=0&&(d[0]=Math.min(d[0],b),d[1]=Math.max(d[1],c),f=!0,i/(c-b)>.5))return}if(f||e.push([b,c]),this.config.renderTextTracksNatively){let e=this.captionsTracks[a];this.Cues.newCue(e,b,c,d)}else{let e=this.Cues.newCue(null,b,c,d);this.hls.trigger(C.CUES_PARSED,{type:"captions",cues:e,track:a})}}onInitPtsFound(a,{frag:b,id:c,initPTS:d,timescale:e}){let{unparsedVttFrags:f}=this;"main"===c&&(this.initPTS[b.cc]={baseTime:d,timescale:e}),f.length&&(this.unparsedVttFrags=[],f.forEach(a=>{this.onFragLoaded(C.FRAG_LOADED,a)}))}getExistingTrack(a,b){let{media:c}=this;if(c)for(let d=0;d<c.textTracks.length;d++){let e=c.textTracks[d];if(em(e,{name:a,lang:b,attrs:{}}))return e}return null}createCaptionsTrack(a){this.config.renderTextTracksNatively?this.createNativeTrack(a):this.createNonNativeTrack(a)}createNativeTrack(a){if(this.captionsTracks[a])return;let{captionsProperties:b,captionsTracks:c,media:d}=this,{label:e,languageCode:f}=b[a],g=this.getExistingTrack(e,f);if(g)c[a]=g,bw(c[a]),bu(c[a],d);else{let b=this.createTextTrack("captions",e,f);b&&(b[a]=!0,c[a]=b)}}createNonNativeTrack(a){if(this.nonNativeCaptionsTracks[a])return;let b=this.captionsProperties[a];if(!b)return;let c={_id:a,label:b.label,kind:"captions",default:!!b.media&&!!b.media.default,closedCaptions:b.media};this.nonNativeCaptionsTracks[a]=c,this.hls.trigger(C.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[c]})}createTextTrack(a,b,c){let d=this.media;if(d)return d.addTextTrack(a,b,c)}onMediaAttaching(a,b){this.media=b.media,this._cleanTracks()}onMediaDetaching(){let{captionsTracks:a}=this;Object.keys(a).forEach(b=>{bw(a[b]),delete a[b]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=en(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){let{media:a}=this;if(!a)return;let b=a.textTracks;if(b)for(let a=0;a<b.length;a++)bw(b[a])}onSubtitleTracksUpdated(a,b){let c=b.subtitleTracks||[],d=c.some(a=>a.textCodec===eb);if(this.config.enableWebVTT||d&&this.config.enableIMSC1){if(dB(this.tracks,c)){this.tracks=c;return}if(this.textTracks=[],this.tracks=c,this.config.renderTextTracksNatively){let a=this.media,b=a?by(a.textTracks):null;if(this.tracks.forEach((a,c)=>{let d;if(b){let c=null;for(let d=0;d<b.length;d++)if(b[d]&&em(b[d],a)){c=b[d],b[d]=null;break}c&&(d=c)}if(d)bw(d);else{let b=el(a);(d=this.createTextTrack(b,a.name,a.lang))&&(d.mode="disabled")}d&&this.textTracks.push(d)}),null!=b&&b.length){let a=b.filter(a=>null!==a).map(a=>a.label);a.length&&I.warn(`Media element contains unused subtitle tracks: ${a.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){let a=this.tracks.map(a=>({label:a.name,kind:a.type.toLowerCase(),default:a.default,subtitleTrack:a}));this.hls.trigger(C.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:a})}}}onManifestLoaded(a,b){this.config.enableCEA708Captions&&b.captions&&b.captions.forEach(a=>{let b=/(?:CC|SERVICE)([1-4])/.exec(a.instreamId);if(!b)return;let c=`textTrack${b[1]}`,d=this.captionsProperties[c];d&&(d.label=a.name,a.lang&&(d.languageCode=a.lang),d.media=a)})}closedCaptionsForLevel(a){let b=this.hls.levels[a.level];return null==b?void 0:b.attrs["CLOSED-CAPTIONS"]}onFragLoading(a,b){if(this.enabled&&b.frag.type===bo){var c,d;let{cea608Parser1:a,cea608Parser2:e,lastSn:f}=this,{cc:g,sn:h}=b.frag,i=null!=(c=null==(d=b.part)?void 0:d.index)?c:-1;a&&e&&(h!==f+1||h===f&&i!==this.lastPartIndex+1||g!==this.lastCc)&&(a.reset(),e.reset()),this.lastCc=g,this.lastSn=h,this.lastPartIndex=i}}onFragLoaded(a,b){let{frag:c,payload:d}=b;if(c.type===bq)if(d.byteLength){let a=c.decryptdata,e="stats"in b;if(null==a||!a.encrypted||e){let a=this.tracks[c.level],e=this.vttCCs;e[c.cc]||(e[c.cc]={start:c.start,prevCC:this.prevCC,new:!0},this.prevCC=c.cc),a&&a.textCodec===eb?this._parseIMSC1(c,d):this._parseVTTs(b)}}else this.hls.trigger(C.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:c,error:Error("Empty subtitle payload")})}_parseIMSC1(a,b){let c=this.hls;ef(b,this.initPTS[a.cc],b=>{this._appendCues(b,a.level),c.trigger(C.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:a})},b=>{I.log(`Failed to parse IMSC1: ${b}`),c.trigger(C.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:a,error:b})})}_parseVTTs(a){var b,c,d,e,f,g,h,i;let j,k,l,m,n,o,p,q,r,{frag:s,payload:t}=a,{initPTS:u,unparsedVttFrags:v}=this,w=u.length-1;if(!u[s.cc]&&-1===w)return void v.push(a);let x=this.hls;c=null!=(b=s.initSegment)&&b.data?aP(s.initSegment.data,new Uint8Array(t)):t,d=this.initPTS[s.cc],e=this.vttCCs,f=s.cc,g=s.start,h=a=>{this._appendCues(a,s.level),x.trigger(C.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:s})},i=b=>{let c="Missing initPTS for VTT MPEGTS"===b.message;c?v.push(a):this._fallbackToIMSC1(s,t),I.log(`Failed to parse VTT cue: ${b}`),c&&w>s.cc||x.trigger(C.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:s,error:b})},k=new d4,l=az(new Uint8Array(c)).trim().replace(d5,"\n").split("\n"),m=[],n=d?function(a,b=1){return dh(a,9e4,1/b)}(d.baseTime,d.timescale):0,o="00:00.000",p=0,q=0,r=!0,k.oncue=function(a){let b=e[f],c=e.ccOffset,h=(p-n)/9e4;if(null!=b&&b.new&&(void 0!==q?c=e.ccOffset=b.start:ea(e,f,h)),h){if(!d){j=Error("Missing initPTS for VTT MPEGTS");return}c=h-e.presentationOffset}let i=a.endTime-a.startTime,k=dm((a.startTime+c-q)*9e4,9e4*g)/9e4;a.startTime=Math.max(k,0),a.endTime=Math.max(k+i,0);let l=a.text.trim();a.text=decodeURIComponent(encodeURIComponent(l)),a.id||(a.id=d9(a.startTime,a.endTime,l)),a.endTime>0&&m.push(a)},k.onparsingerror=function(a){j=a},k.onflush=function(){j?i(j):h(m)},l.forEach(a=>{if(r)if(d6(a,"X-TIMESTAMP-MAP=")){r=!1,a.slice(16).split(",").forEach(a=>{d6(a,"LOCAL:")?o=a.slice(6):d6(a,"MPEGTS:")&&(p=parseInt(a.slice(7)))});try{q=d7(o)/1e3}catch(a){j=a}return}else""===a&&(r=!1);k.parse(a+"\n")}),k.flush()}_fallbackToIMSC1(a,b){let c=this.tracks[a.level];c.textCodec||ef(b,this.initPTS[a.cc],()=>{c.textCodec=eb,this._parseIMSC1(a,b)},()=>{c.textCodec="wvtt"})}_appendCues(a,b){let c=this.hls;if(this.config.renderTextTracksNatively){let c=this.textTracks[b];if(!c||"disabled"===c.mode)return;a.forEach(a=>bv(c,a))}else{let d=this.tracks[b];if(!d)return;let e=d.default?"default":"subtitles"+b;c.trigger(C.CUES_PARSED,{type:"subtitles",cues:a,track:e})}}onFragDecrypted(a,b){let{frag:c}=b;c.type===bq&&this.onFragLoaded(C.FRAG_LOADED,b)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(a,b){this.initCea608Parsers();let{cea608Parser1:c,cea608Parser2:d}=this;if(!this.enabled||!c||!d)return;let{frag:e,samples:f}=b;if(e.type!==bo||"NONE"!==this.closedCaptionsForLevel(e))for(let a=0;a<f.length;a++){let b=f[a].bytes;if(b){let e=this.extractCea608Data(b);c.addData(f[a].pts,e[0]),d.addData(f[a].pts,e[1])}}}onBufferFlushing(a,{startOffset:b,endOffset:c,endOffsetSubtitles:d,type:e}){let{media:f}=this;if(f&&!(f.currentTime<c)){if(!e||"video"===e){let{captionsTracks:a}=this;Object.keys(a).forEach(d=>bx(a[d],b,c))}if(this.config.renderTextTracksNatively&&0===b&&void 0!==d){let{textTracks:a}=this;Object.keys(a).forEach(c=>bx(a[c],b,d))}}}extractCea608Data(a){let b=[[],[]],c=31&a[0],d=2;for(let e=0;e<c;e++){let c=a[d++],e=127&a[d++],f=127&a[d++];if((0!==e||0!==f)&&(4&c)!=0){let a=3&c;(0===a||1===a)&&(b[a].push(e),b[a].push(f))}}return b}},audioStreamController:class extends cK{constructor(a,b,c){super(a,b,c,"[audio-stream-controller]",bp),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){let{hls:a}=this;a.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),a.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),a.on(C.MANIFEST_LOADING,this.onManifestLoading,this),a.on(C.LEVEL_LOADED,this.onLevelLoaded,this),a.on(C.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),a.on(C.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),a.on(C.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),a.on(C.ERROR,this.onError,this),a.on(C.BUFFER_RESET,this.onBufferReset,this),a.on(C.BUFFER_CREATED,this.onBufferCreated,this),a.on(C.BUFFER_FLUSHING,this.onBufferFlushing,this),a.on(C.BUFFER_FLUSHED,this.onBufferFlushed,this),a.on(C.INIT_PTS_FOUND,this.onInitPtsFound,this),a.on(C.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){let{hls:a}=this;a.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),a.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),a.off(C.MANIFEST_LOADING,this.onManifestLoading,this),a.off(C.LEVEL_LOADED,this.onLevelLoaded,this),a.off(C.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),a.off(C.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),a.off(C.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),a.off(C.ERROR,this.onError,this),a.off(C.BUFFER_RESET,this.onBufferReset,this),a.off(C.BUFFER_CREATED,this.onBufferCreated,this),a.off(C.BUFFER_FLUSHING,this.onBufferFlushing,this),a.off(C.BUFFER_FLUSHED,this.onBufferFlushed,this),a.off(C.INIT_PTS_FOUND,this.onInitPtsFound,this),a.off(C.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(a,{frag:b,id:c,initPTS:d,timescale:e}){if("main"===c){let a=b.cc;this.initPTS[b.cc]={baseTime:d,timescale:e},this.log(`InitPTS for cc: ${a} found from main: ${d}`),this.videoTrackCC=a,this.state===cI&&this.tick()}}startLoad(a){if(!this.levels){this.startPosition=a,this.state=cy;return}let b=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),b>0&&-1===a?(this.log(`Override startPosition with lastCurrentTime @${b.toFixed(3)}`),a=b,this.state=cz):(this.loadedmetadata=!1,this.state=cD),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=a,this.tick()}doTick(){var a,b;switch(this.state){case cz:this.doTickIdle();break;case cD:{let{levels:b,trackId:c}=this,d=null==b||null==(a=b[c])?void 0:a.details;if(d){if(this.waitForCdnTuneIn(d))break;this.state=cI}break}case cC:{let a=performance.now(),c=this.retryDate;if(!c||a>=c||null!=(b=this.media)&&b.seeking){let{levels:a,trackId:b}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((null==a?void 0:a[b])||null),this.state=cz}break}case cI:{let a=this.waitingData;if(a){let{frag:b,part:c,cache:d,complete:e}=a;if(void 0!==this.initPTS[b.cc]){this.waitingData=null,this.waitingVideoCC=-1,this.state=cB;let a={frag:b,part:c,payload:d.flush(),networkDetails:null};this._handleFragmentLoadProgress(a),e&&super._handleFragmentLoadComplete(a)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${b.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{let a=this.getLoadPosition(),c=ci.bufferInfo(this.mediaBuffer,a,this.config.maxBufferHole);0>b_(c.end,this.config.maxFragLookUpTolerance,b)&&(this.log(`Waiting fragment cc (${b.cc}) @ ${b.start} cancelled because another fragment at ${c.end} is needed`),this.clearWaitingFragment())}}else this.state=cz}}this.onTickEnd()}clearWaitingFragment(){let a=this.waitingData;a&&(this.fragmentTracker.removeFragment(a.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=cz)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){let{media:a}=this;null!=a&&a.readyState&&(this.lastCurrentTime=a.currentTime)}doTickIdle(){let{hls:a,levels:b,media:c,trackId:d}=this,e=a.config;if(!this.buffering||!c&&(this.startFragRequested||!e.startFragPrefetch)||!(null!=b&&b[d]))return;let f=b[d],g=f.details;if(!g||g.live&&this.levelLastLoaded!==f||this.waitForCdnTuneIn(g)){this.state=cD;return}let h=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&h&&(this.bufferFlushed=!1,this.afterBufferFlushed(h,O,bp));let i=this.getFwdBufferInfo(h,bp);if(null===i)return;let{bufferedTrack:j,switchingTrack:k}=this;if(!k&&this._streamEnded(i,g)){a.trigger(C.BUFFER_EOS,{type:"audio"}),this.state=cG;return}let l=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,bo),m=i.len,n=this.getMaxBufferLength(null==l?void 0:l.len),o=g.fragments,p=o[0].start,q=this.flushing?this.getLoadPosition():i.end;if(k&&c){let a=this.getLoadPosition();j&&!dC(k.attrs,j.attrs)&&(q=a),g.PTSKnown&&a<p&&(i.end>p||i.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),c.currentTime=p+.05)}if(m>=n&&!k&&q<o[o.length-1].start)return;let r=this.getNextFragment(q,g),s=!1;if(r&&this.isLoopLoading(r,q)&&(s=!!r.gap,r=this.getNextFragmentLoopLoading(r,g,i,bo,n)),!r){this.bufferFlushed=!0;return}let t=l&&r.start>l.end+g.targetduration;if(t||!(null!=l&&l.len)&&i.len){let a=this.getAppendedFrag(r.start,bo);if(null===a||(s||(s=!!a.gap||!!t&&0===l.len),t&&!s||s&&i.nextStart&&i.nextStart<a.end))return}this.loadFragment(r,f,q)}getMaxBufferLength(a){let b=super.getMaxBufferLength();return a?Math.min(Math.max(b,a),this.config.maxMaxBufferLength):b}onMediaDetaching(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,super.onMediaDetaching()}onAudioTracksUpdated(a,{audioTracks:b}){this.resetTransmuxer(),this.levels=b.map(a=>new bL(a))}onAudioTrackSwitching(a,b){let c=!!b.url;this.trackId=b.id;let{fragCurrent:d}=this;d&&(d.abortRequests(),this.removeUnbufferedFrags(d.start)),this.resetLoadingState(),c?this.setInterval(100):this.resetTransmuxer(),c?(this.switchingTrack=b,this.state=cz,this.flushAudioIfNeeded(b)):(this.switchingTrack=null,this.bufferedTrack=b,this.state=cy),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(a,b){this.mainDetails=b.details,null!==this.cachedTrackLoadedData&&(this.hls.trigger(C.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(a,b){var c,d;if(null==this.mainDetails){this.cachedTrackLoadedData=b;return}let{levels:e}=this,{details:f,id:g}=b;if(!e)return void this.warn(`Audio tracks were reset while loading level ${g}`);this.log(`Audio track ${g} loaded [${f.startSN},${f.endSN}]${f.lastPartSn?`[part-${f.lastPartSn}-${f.lastPartIndex}]`:""},duration:${f.totalduration}`);let h=e[g],i=0;if(f.live||null!=(c=h.details)&&c.live){this.checkLiveUpdate(f);let a=this.mainDetails;if(f.deltaUpdateFailed||!a)return;!h.details&&f.hasProgramDateTime&&a.hasProgramDateTime?(co(f,a),i=f.fragments[0].start):i=this.alignPlaylists(f,h.details,null==(d=this.levelLastLoaded)?void 0:d.details)}h.details=f,this.levelLastLoaded=h,this.startFragRequested||!this.mainDetails&&f.live||this.setStartPosition(this.mainDetails||f,i),this.state!==cD||this.waitForCdnTuneIn(f)||(this.state=cz),this.tick()}_handleFragmentLoadProgress(a){var b;let{frag:c,part:d,payload:e}=a,{config:f,trackId:g,levels:h}=this;if(!h)return void this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${c.sn} of level ${c.level} will not be buffered`);let i=h[g];if(!i)return void this.warn("Audio track is undefined on fragment load progress");let j=i.details;if(!j){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(c.start);return}let k=f.defaultAudioCodec||i.audioCodec||"mp4a.40.2",l=this.transmuxer;l||(l=this.transmuxer=new dA(this.hls,bp,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));let m=this.initPTS[c.cc],n=null==(b=c.initSegment)?void 0:b.data;if(void 0!==m){let a=d?d.index:-1,b=new cj(c.level,c.sn,c.stats.chunkCount,e.byteLength,a,-1!==a);l.push(e,n,k,"",c,d,j.totalduration,!1,b,m)}else{this.log(`Unknown video PTS for cc ${c.cc}, waiting for video PTS before demuxing audio frag ${c.sn} of [${j.startSN} ,${j.endSN}],track ${g}`);let{cache:a}=this.waitingData=this.waitingData||{frag:c,part:d,cache:new cL,complete:!1};a.push(new Uint8Array(e)),this.waitingVideoCC=this.videoTrackCC,this.state=cI}}_handleFragmentLoadComplete(a){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(a)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(a,b){let c=b.tracks.audio;c&&(this.mediaBuffer=c.buffer||null),b.tracks.video&&(this.videoBuffer=b.tracks.video.buffer||null)}onFragBuffered(a,b){let{frag:c,part:d}=b;if(c.type!==bp){if(!this.loadedmetadata&&c.type===bo){let a=this.videoBuffer||this.media;a&&ci.getBuffered(a).length&&(this.loadedmetadata=!0)}return}if(this.fragContextChanged(c))return void this.warn(`Fragment ${c.sn}${d?" p: "+d.index:""} of level ${c.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);if("initSegment"!==c.sn){this.fragPrevious=c;let a=this.switchingTrack;a&&(this.bufferedTrack=a,this.switchingTrack=null,this.hls.trigger(C.AUDIO_TRACK_SWITCHED,x({},a)))}this.fragBufferedComplete(c,d)}onError(a,b){var c;if(b.fatal){this.state=cH;return}switch(b.details){case E.FRAG_GAP:case E.FRAG_PARSING_ERROR:case E.FRAG_DECRYPT_ERROR:case E.FRAG_LOAD_ERROR:case E.FRAG_LOAD_TIMEOUT:case E.KEY_LOAD_ERROR:case E.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(bp,b);break;case E.AUDIO_TRACK_LOAD_ERROR:case E.AUDIO_TRACK_LOAD_TIMEOUT:case E.LEVEL_PARSING_ERROR:b.levelRetry||this.state!==cD||(null==(c=b.context)?void 0:c.type)!==bm||(this.state=cz);break;case E.BUFFER_APPEND_ERROR:case E.BUFFER_FULL_ERROR:if(!b.parent||"audio"!==b.parent)return;if(b.details===E.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(b)&&(this.bufferedTrack=null,super.flushMainBuffer(0,1/0,"audio"));break;case E.INTERNAL_EXCEPTION:this.recoverWorkerError(b)}}onBufferFlushing(a,{type:b}){b!==P&&(this.flushing=!0)}onBufferFlushed(a,{type:b}){if(b!==P){this.flushing=!1,this.bufferFlushed=!0,this.state===cG&&(this.state=cz);let a=this.mediaBuffer||this.media;a&&(this.afterBufferFlushed(a,b,bp),this.tick())}}_handleTransmuxComplete(a){var b;let c="audio",{hls:d}=this,{remuxResult:e,chunkMeta:f}=a,g=this.getCurrentContext(f);if(!g)return void this.resetWhenMissingContext(f);let{frag:h,part:i,level:j}=g,{details:k}=j,{audio:l,text:m,id3:n,initSegment:o}=e;if(this.fragContextChanged(h)||!k)return void this.fragmentTracker.removeFragment(h);if(this.state=cE,this.switchingTrack&&l&&this.completeAudioSwitch(this.switchingTrack),null!=o&&o.tracks){let a=h.initSegment||h;this._bufferInitSegment(j,o.tracks,a,f),d.trigger(C.FRAG_PARSING_INIT_SEGMENT,{frag:a,id:c,tracks:o.tracks})}if(l){let{startPTS:a,endPTS:b,startDTS:c,endDTS:d}=l;i&&(i.elementaryStreams[O]={startPTS:a,endPTS:b,startDTS:c,endDTS:d}),h.setElementaryStreamInfo(O,a,b,c,d),this.bufferFragmentData(l,h,i,f)}if(null!=n&&null!=(b=n.samples)&&b.length){let a=y({id:c,frag:h,details:k},n);d.trigger(C.FRAG_PARSING_METADATA,a)}if(m){let a=y({id:c,frag:h,details:k},m);d.trigger(C.FRAG_PARSING_USERDATA,a)}}_bufferInitSegment(a,b,c,d){if(this.state!==cE)return;b.video&&delete b.video;let e=b.audio;if(!e)return;e.id="audio";let f=a.audioCodec;this.log(`Init audio buffer, container:${e.container}, codecs[level/parsed]=[${f}/${e.codec}]`),f&&1===f.split(",").length&&(e.levelCodec=f),this.hls.trigger(C.BUFFER_CODECS,b);let g=e.initSegment;if(null!=g&&g.byteLength){let a={type:"audio",frag:c,part:null,chunkMeta:d,parent:c.type,data:g};this.hls.trigger(C.BUFFER_APPENDING,a)}this.tickImmediate()}loadFragment(a,b,c){let d=this.fragmentTracker.getState(a);if(this.fragCurrent=a,this.switchingTrack||d===cb||d===cd){var e;if("initSegment"===a.sn)this._loadInitSegment(a,b);else if(null!=(e=b.details)&&e.live&&!this.initPTS[a.cc]){this.log(`Waiting for video PTS in continuity counter ${a.cc} of live stream before loading audio fragment ${a.sn} of level ${this.trackId}`),this.state=cI;let c=this.mainDetails;c&&c.fragments[0].start!==b.details.fragments[0].start&&co(b.details,c)}else this.startFragRequested=!0,super.loadFragment(a,b,c)}else this.clearTrackerIfNeeded(a)}flushAudioIfNeeded(a){let{media:b,bufferedTrack:c}=this,d=null==c?void 0:c.attrs,e=a.attrs;b&&d&&(d.CHANNELS!==e.CHANNELS||c.name!==a.name||c.lang!==a.lang)&&(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,1/0,"audio"),this.bufferedTrack=null)}completeAudioSwitch(a){let{hls:b}=this;this.flushAudioIfNeeded(a),this.bufferedTrack=a,this.switchingTrack=null,b.trigger(C.AUDIO_TRACK_SWITCHED,x({},a))}},audioTrackController:class extends b0{constructor(a){super(a,"[audio-track-controller]"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){let{hls:a}=this;a.on(C.MANIFEST_LOADING,this.onManifestLoading,this),a.on(C.MANIFEST_PARSED,this.onManifestParsed,this),a.on(C.LEVEL_LOADING,this.onLevelLoading,this),a.on(C.LEVEL_SWITCHING,this.onLevelSwitching,this),a.on(C.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),a.on(C.ERROR,this.onError,this)}unregisterListeners(){let{hls:a}=this;a.off(C.MANIFEST_LOADING,this.onManifestLoading,this),a.off(C.MANIFEST_PARSED,this.onManifestParsed,this),a.off(C.LEVEL_LOADING,this.onLevelLoading,this),a.off(C.LEVEL_SWITCHING,this.onLevelSwitching,this),a.off(C.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),a.off(C.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(a,b){this.tracks=b.audioTracks||[]}onAudioTrackLoaded(a,b){let{id:c,groupId:d,details:e}=b,f=this.tracksInGroup[c];if(!f||f.groupId!==d)return void this.warn(`Audio track with id:${c} and group:${d} not found in active group ${null==f?void 0:f.groupId}`);let g=f.details;f.details=b.details,this.log(`Audio track ${c} "${f.name}" lang:${f.lang} group:${d} loaded [${e.startSN}-${e.endSN}]`),c===this.trackId&&this.playlistLoaded(c,b,g)}onLevelLoading(a,b){this.switchLevel(b.level)}onLevelSwitching(a,b){this.switchLevel(b.level)}switchLevel(a){let b=this.hls.levels[a];if(!b)return;let c=b.audioGroups||null,d=this.groupIds,e=this.currentTrack;if(!c||(null==d?void 0:d.length)!==(null==c?void 0:c.length)||null!=c&&c.some(a=>(null==d?void 0:d.indexOf(a))===-1)){this.groupIds=c,this.trackId=-1,this.currentTrack=null;let a=this.tracks.filter(a=>!c||-1!==c.indexOf(a.groupId));if(a.length)this.selectDefaultTrack&&!a.some(a=>a.default)&&(this.selectDefaultTrack=!1),a.forEach((a,b)=>{a.id=b});else if(!e&&!this.tracksInGroup.length)return;this.tracksInGroup=a;let b=this.hls.config.audioPreference;if(!e&&b){let c=b6(b,a,b8);if(c>-1)e=a[c];else{let a=b6(b,this.tracks);e=this.tracks[a]}}let d=this.findTrackId(e);-1===d&&e&&(d=this.findTrackId(null)),this.log(`Updating audio tracks, ${a.length} track(s) found in group(s): ${null==c?void 0:c.join(",")}`),this.hls.trigger(C.AUDIO_TRACKS_UPDATED,{audioTracks:a});let g=this.trackId;if(-1!==d&&-1===g)this.setAudioTrack(d);else if(a.length&&-1===g){var f;let b=Error(`No audio track selected for current audio group-ID(s): ${null==(f=this.groupIds)?void 0:f.join(",")} track count: ${a.length}`);this.warn(b.message),this.hls.trigger(C.ERROR,{type:D.MEDIA_ERROR,details:E.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:b})}}else this.shouldReloadPlaylist(e)&&this.setAudioTrack(this.trackId)}onError(a,b){!b.fatal&&b.context&&(b.context.type!==bm||b.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(b.context.groupId)||(this.requestScheduled=-1,this.checkRetry(b)))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(a){this.selectDefaultTrack=!1,this.setAudioTrack(a)}setAudioOption(a){let b=this.hls;if(b.config.audioPreference=a,a){let e=this.allAudioTracks;if(this.selectDefaultTrack=!1,e.length){let f=this.currentTrack;if(f&&b7(a,f,b8))return f;let g=b6(a,this.tracksInGroup,b8);if(g>-1){let a=this.tracksInGroup[g];return this.setAudioTrack(g),a}if(f){var c,d;let f,g,h,i,j,k,l=b.loadLevel;-1===l&&(l=b.firstAutoLevel);let m=(c=b.levels,f=c[d=l],(g=c.reduce((a,b,c)=>{let d=b.uri;return(a[d]||(a[d]=[])).push(c),a},{})[f.uri]).length>1&&(d=Math.max.apply(Math,g)),h=f.videoRange,i=f.frameRate,j=f.codecSet.substring(0,4),(k=b9(c,d,b=>{if(b.videoRange!==h||b.frameRate!==i||b.codecSet.substring(0,4)!==j)return!1;let c=b.audioGroups;return b6(a,e.filter(a=>!c||-1!==c.indexOf(a.groupId)),b8)>-1}))>-1?k:b9(c,d,b=>{let c=b.audioGroups;return b6(a,e.filter(a=>!c||-1!==c.indexOf(a.groupId)),b8)>-1}));if(-1===m)return null;b.nextLoadLevel=m}if(a.channels||a.audioCodec){let b=b6(a,e);if(b>-1)return e[b]}}}return null}setAudioTrack(a){let b=this.tracksInGroup;if(a<0||a>=b.length)return void this.warn(`Invalid audio track id: ${a}`);this.clearTimer(),this.selectDefaultTrack=!1;let c=this.currentTrack,d=b[a],e=d.details&&!d.details.live;if(a===this.trackId&&d===c&&e||(this.log(`Switching to audio-track ${a} "${d.name}" lang:${d.lang} group:${d.groupId} channels:${d.channels}`),this.trackId=a,this.currentTrack=d,this.hls.trigger(C.AUDIO_TRACK_SWITCHING,x({},d)),e))return;let f=this.switchParams(d.url,null==c?void 0:c.details,d.details);this.loadPlaylist(f)}findTrackId(a){let b=this.tracksInGroup;for(let c=0;c<b.length;c++){let d=b[c];if((!this.selectDefaultTrack||d.default)&&(!a||b7(a,d,b8)))return c}if(a){let{name:c,lang:d,assocLang:e,characteristics:f,audioCodec:g,channels:h}=a;for(let a=0;a<b.length;a++)if(b7({name:c,lang:d,assocLang:e,characteristics:f,audioCodec:g,channels:h},b[a],b8))return a;for(let c=0;c<b.length;c++){let d=b[c];if(dC(a.attrs,d.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return c}for(let c=0;c<b.length;c++){let d=b[c];if(dC(a.attrs,d.attrs,["LANGUAGE"]))return c}}return -1}loadPlaylist(a){let b=this.currentTrack;if(this.shouldLoadPlaylist(b)&&b){super.loadPlaylist();let c=b.id,d=b.groupId,e=b.url;if(a)try{e=a.addDirectives(e)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}this.log(`loading audio-track playlist ${c} "${b.name}" lang:${b.lang} group:${d}`),this.clearTimer(),this.hls.trigger(C.AUDIO_TRACK_LOADING,{url:e,id:c,groupId:d,deliveryDirectives:a||null})}}},emeController:eq,cmcdController:class{constructor(a){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=a=>{try{this.apply(a,{ot:r.MANIFEST,su:!this.initialized})}catch(a){I.warn("Could not generate manifest CMCD data.",a)}},this.applyFragmentData=a=>{try{let b=a.frag,c=this.hls.levels[b.level],d=this.getObjectType(b),e={d:1e3*b.duration,ot:d};(d===r.VIDEO||d===r.AUDIO||d==r.MUXED)&&(e.br=c.bitrate/1e3,e.tb=this.getTopBandwidth(d)/1e3,e.bl=this.getBufferLength(d)),this.apply(a,e)}catch(a){I.warn("Could not generate segment CMCD data.",a)}},this.hls=a;const b=this.config=a.config,{cmcd:c}=b;null!=c&&(b.pLoader=this.createPlaylistLoader(),b.fLoader=this.createFragmentLoader(),this.sid=c.sessionId||function(){try{return crypto.randomUUID()}catch(a){try{let a=URL.createObjectURL(new Blob),b=a.toString();return URL.revokeObjectURL(a),b.slice(b.lastIndexOf("/")+1)}catch(b){let a=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,b=>{let c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"==b?c:3&c|8).toString(16)})}}}(),this.cid=c.contentId,this.useHeaders=!0===c.useHeaders,this.includeKeys=c.includeKeys,this.registerListeners())}registerListeners(){let a=this.hls;a.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),a.on(C.MEDIA_DETACHED,this.onMediaDetached,this),a.on(C.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){let a=this.hls;a.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),a.off(C.MEDIA_DETACHED,this.onMediaDetached,this),a.off(C.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}onMediaAttached(a,b){this.media=b.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(a,b){var c,d;this.audioBuffer=null==(c=b.tracks.audio)?void 0:c.buffer,this.videoBuffer=null==(d=b.tracks.video)?void 0:d.buffer}createData(){var a;return{v:1,sf:s.HLS,sid:this.sid,cid:this.cid,pr:null==(a=this.media)?void 0:a.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(a,b={}){y(b,this.createData());let c=b.ot===r.INIT||b.ot===r.VIDEO||b.ot===r.MUXED;this.starved&&c&&(b.bs=!0,b.su=!0,this.starved=!1),null==b.su&&(b.su=this.buffering);let{includeKeys:d}=this;if(d&&(b=Object.keys(b).reduce((a,c)=>(d.includes(c)&&(a[c]=b[c]),a),{})),this.useHeaders){var e;a.headers||(a.headers={}),e=a.headers,y(e,function(a,b={}){if(!a)return{};let c=Object.entries(a),d=Object.entries(es).concat(Object.entries((null==b?void 0:b.customHeaderMap)||{}));return Object.entries(c.reduce((a,b)=>{var c;let[e,f]=b,g=(null==(c=d.find(a=>a[1].includes(e)))?void 0:c[0])||t.REQUEST;return null!=a[g]||(a[g]={}),a[g][e]=f,a},{})).reduce((a,[c,d])=>(a[c]=eH(d,b),a),{})}(b,void 0))}else a.url=function(a,b,c){let d=function(a,b={}){if(!a)return"";let c=eH(a,b);return`CMCD=${encodeURIComponent(c)}`}(b,void 0);if(!d)return a;if(eI.test(a))return a.replace(eI,d);let e=a.includes("?")?"&":"?";return`${a}${e}${d}`}(a.url,b)}getObjectType(a){let{type:b}=a;return"subtitle"===b?r.TIMED_TEXT:"initSegment"===a.sn?r.INIT:"audio"===b?r.AUDIO:"main"===b?this.hls.audioTracks.length?r.VIDEO:r.MUXED:void 0}getTopBandwidth(a){let b,c=0,d=this.hls;if(a===r.AUDIO)b=d.audioTracks;else{let a=d.maxAutoLevel,c=a>-1?a+1:d.levels.length;b=d.levels.slice(0,c)}for(let a of b)a.bitrate>c&&(c=a.bitrate);return c>0?c:NaN}getBufferLength(a){let b=this.hls.media,c=a===r.AUDIO?this.audioBuffer:this.videoBuffer;return c&&b?1e3*ci.bufferInfo(c,b.currentTime,this.config.maxBufferHole).len:NaN}createPlaylistLoader(){let{pLoader:a}=this.config,b=this.applyPlaylistData,c=a||this.config.loader;return class{constructor(a){this.loader=void 0,this.loader=new c(a)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(a,c,d){b(a),this.loader.load(a,c,d)}}}createFragmentLoader(){let{fLoader:a}=this.config,b=this.applyFragmentData,c=a||this.config.loader;return class{constructor(a){this.loader=void 0,this.loader=new c(a)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(a,c,d){b(a),this.loader.load(a,c,d)}}}},contentSteeringController:class{constructor(a){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=a,this.log=I.log.bind(I,"[content-steering]:"),this.registerListeners()}registerListeners(){let a=this.hls;a.on(C.MANIFEST_LOADING,this.onManifestLoading,this),a.on(C.MANIFEST_LOADED,this.onManifestLoaded,this),a.on(C.MANIFEST_PARSED,this.onManifestParsed,this),a.on(C.ERROR,this.onError,this)}unregisterListeners(){let a=this.hls;a&&(a.off(C.MANIFEST_LOADING,this.onManifestLoading,this),a.off(C.MANIFEST_LOADED,this.onManifestLoaded,this),a.off(C.MANIFEST_PARSED,this.onManifestParsed,this),a.off(C.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){let a=1e3*this.timeToLoad-(performance.now()-this.updated);if(a>0)return void this.scheduleRefresh(this.uri,a)}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){-1!==this.reloadTimer&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(a){let b=this.levels;b&&(this.levels=b.filter(b=>b!==a))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(a,b){let{contentSteering:c}=b;null!==c&&(this.pathwayId=c.pathwayId,this.uri=c.uri,this.started&&this.startLoad())}onManifestParsed(a,b){this.audioTracks=b.audioTracks,this.subtitleTracks=b.subtitleTracks}onError(a,b){let{errorAction:c}=b;if((null==c?void 0:c.action)===2&&1===c.flags){let a=this.levels,d=this.pathwayPriority,e=this.pathwayId;if(b.context){let{groupId:c,pathwayId:d,type:f}=b.context;c&&a?e=this.getPathwayForGroupId(c,f,e):d&&(e=d)}e in this.penalizedPathways||(this.penalizedPathways[e]=performance.now()),!d&&a&&(d=a.reduce((a,b)=>(-1===a.indexOf(b.pathwayId)&&a.push(b.pathwayId),a),[])),d&&d.length>1&&(this.updatePathwayPriority(d),c.resolved=this.pathwayId!==e),c.resolved||I.warn(`Could not resolve ${b.details} ("${b.error.message}") with content-steering for Pathway: ${e} levels: ${a?a.length:a} priorities: ${JSON.stringify(d)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(a){this.levels=a;let b=this.getLevelsForPathway(this.pathwayId);if(0===b.length){let c=a[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${c}"`),b=this.getLevelsForPathway(c),this.pathwayId=c}return b.length!==a.length&&this.log(`Found ${b.length}/${a.length} levels in Pathway "${this.pathwayId}"`),b}getLevelsForPathway(a){return null===this.levels?[]:this.levels.filter(b=>a===b.pathwayId)}updatePathwayPriority(a){let b;this.pathwayPriority=a;let c=this.penalizedPathways,d=performance.now();Object.keys(c).forEach(a=>{d-c[a]>3e5&&delete c[a]});for(let d=0;d<a.length;d++){let e=a[d];if(e in c)continue;if(e===this.pathwayId)return;let f=this.hls.nextLoadLevel,g=this.hls.levels[f];if((b=this.getLevelsForPathway(e)).length>0){this.log(`Setting Pathway to "${e}"`),this.pathwayId=e,bT(b),this.hls.trigger(C.LEVELS_UPDATED,{levels:b});let a=this.hls.levels[f];g&&a&&this.levels&&(a.attrs["STABLE-VARIANT-ID"]!==g.attrs["STABLE-VARIANT-ID"]&&a.bitrate!==g.bitrate&&this.log(`Unstable Pathways change from bitrate ${g.bitrate} to ${a.bitrate}`),this.hls.nextLoadLevel=f);break}}}getPathwayForGroupId(a,b,c){let d=this.getLevelsForPathway(c).concat(this.levels||[]);for(let c=0;c<d.length;c++)if(b===bm&&d[c].hasAudioGroup(a)||b===bn&&d[c].hasSubtitleGroup(a))return d[c].pathwayId;return c}clonePathways(a){let b=this.levels;if(!b)return;let c={},d={};a.forEach(a=>{let{ID:e,"BASE-ID":f,"URI-REPLACEMENT":g}=a;if(b.some(a=>a.pathwayId===e))return;let h=this.getLevelsForPathway(f).map(a=>{let b=new L(a.attrs);b["PATHWAY-ID"]=e;let f=b.AUDIO&&`${b.AUDIO}_clone_${e}`,h=b.SUBTITLES&&`${b.SUBTITLES}_clone_${e}`;f&&(c[b.AUDIO]=f,b.AUDIO=f),h&&(d[b.SUBTITLES]=h,b.SUBTITLES=h);let i=eK(a.uri,b["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",g),j=new bL({attrs:b,audioCodec:a.audioCodec,bitrate:a.bitrate,height:a.height,name:a.name,url:i,videoCodec:a.videoCodec,width:a.width});if(a.audioGroups)for(let b=1;b<a.audioGroups.length;b++)j.addGroupId("audio",`${a.audioGroups[b]}_clone_${e}`);if(a.subtitleGroups)for(let b=1;b<a.subtitleGroups.length;b++)j.addGroupId("text",`${a.subtitleGroups[b]}_clone_${e}`);return j});b.push(...h),eJ(this.audioTracks,c,g,e),eJ(this.subtitleTracks,d,g,e)})}loadSteeringManifest(a){let b,c=this.hls.config,d=c.loader;this.loader&&this.loader.destroy(),this.loader=new d(c);try{b=new self.URL(a)}catch(b){this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${a}`);return}if("data:"!==b.protocol){let a=0|(this.hls.bandwidthEstimate||c.abrEwmaDefaultEstimate);b.searchParams.set("_HLS_pathway",this.pathwayId),b.searchParams.set("_HLS_throughput",""+a)}let e={responseType:"json",url:b.href},f=c.steeringManifestLoadPolicy.default,g=f.errorRetry||f.timeoutRetry||{},h={loadPolicy:f,timeout:f.maxLoadTimeMs,maxRetry:g.maxNumRetry||0,retryDelay:g.retryDelayMs||0,maxRetryDelay:g.maxRetryDelayMs||0};this.log(`Requesting steering manifest: ${b}`),this.loader.load(e,h,{onSuccess:(a,c,d,e)=>{this.log(`Loaded steering manifest: "${b}"`);let f=a.data;if(1!==f.VERSION)return void this.log(`Steering VERSION ${f.VERSION} not supported!`);this.updated=performance.now(),this.timeToLoad=f.TTL;let{"RELOAD-URI":g,"PATHWAY-CLONES":h,"PATHWAY-PRIORITY":i}=f;if(g)try{this.uri=new self.URL(g,b).href}catch(a){this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${g}`);return}this.scheduleRefresh(this.uri||d.url),h&&this.clonePathways(h);let j={steeringManifest:f,url:b.toString()};this.hls.trigger(C.STEERING_MANIFEST_LOADED,j),i&&this.updatePathwayPriority(i)},onError:(a,b,c,d)=>{if(this.log(`Error loading steering manifest: ${a.code} ${a.text} (${b.url})`),this.stopLoad(),410===a.code){this.enabled=!1,this.log(`Steering manifest ${b.url} no longer available`);return}let e=1e3*this.timeToLoad;if(429===a.code){let a=this.loader;if("function"==typeof(null==a?void 0:a.getResponseHeader)){let b=a.getResponseHeader("Retry-After");b&&(e=1e3*parseFloat(b))}this.log(`Steering manifest ${b.url} rate limited`);return}this.scheduleRefresh(this.uri||b.url,e)},onTimeout:(a,b,c)=>{this.log(`Timeout loading steering manifest (${b.url})`),this.scheduleRefresh(this.uri||b.url)}})}scheduleRefresh(a,b=1e3*this.timeToLoad){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var b;let c=null==(b=this.hls)?void 0:b.media;c&&!c.ended?this.loadSteeringManifest(a):this.scheduleRefresh(a,1e3*this.timeToLoad)},b)}}});class eU extends b0{constructor(a,b){super(a,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=b,this._registerListeners()}_registerListeners(){let{hls:a}=this;a.on(C.MANIFEST_LOADING,this.onManifestLoading,this),a.on(C.MANIFEST_LOADED,this.onManifestLoaded,this),a.on(C.LEVEL_LOADED,this.onLevelLoaded,this),a.on(C.LEVELS_UPDATED,this.onLevelsUpdated,this),a.on(C.FRAG_BUFFERED,this.onFragBuffered,this),a.on(C.ERROR,this.onError,this)}_unregisterListeners(){let{hls:a}=this;a.off(C.MANIFEST_LOADING,this.onManifestLoading,this),a.off(C.MANIFEST_LOADED,this.onManifestLoaded,this),a.off(C.LEVEL_LOADED,this.onLevelLoaded,this),a.off(C.LEVELS_UPDATED,this.onLevelsUpdated,this),a.off(C.FRAG_BUFFERED,this.onFragBuffered,this),a.off(C.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(a=>{a.loadError=0,a.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(a,b){this.resetLevels()}onManifestLoaded(a,b){let c=this.hls.config.preferManagedMediaSource,e=[],f={},g={},h=!1,i=!1,j=!1;b.levels.forEach(a=>{var b,k;let l=a.attrs,{audioCodec:m,videoCodec:n}=a;(null==(b=m)?void 0:b.indexOf("mp4a.40.34"))!==-1&&(d||(d=/chrome|firefox/i.test(navigator.userAgent)),d&&(a.audioCodec=m=void 0)),m&&(a.audioCodec=m=a6(m,c)),(null==(k=n)?void 0:k.indexOf("avc1"))===0&&(n=a.videoCodec=function(a){let b=a.split(",");for(let a=0;a<b.length;a++){let c=b[a].split(".");if(c.length>2){let d=c.shift()+".";d+=parseInt(c.shift()).toString(16),d+=("000"+parseInt(c.shift()).toString(16)).slice(-4),b[a]=d}}return b.join(",")}(n));let{width:o,height:p,unknownCodecs:q}=a;if(h||(h=!!(o&&p)),i||(i=!!n),j||(j=!!m),null!=q&&q.length||m&&!a_(m,"audio",c)||n&&!a_(n,"video",c))return;let{CODECS:r,"FRAME-RATE":s,"HDCP-LEVEL":t,"PATHWAY-ID":u,RESOLUTION:v,"VIDEO-RANGE":w}=l,x=`${u||"."}-`,y=`${x}${a.bitrate}-${v}-${s}-${r}-${w}-${t}`;if(f[y])if(f[y].uri===a.url||a.attrs["PATHWAY-ID"])f[y].addGroupId("audio",l.AUDIO),f[y].addGroupId("text",l.SUBTITLES);else{let b=g[y]+=1;a.attrs["PATHWAY-ID"]=Array(b+1).join(".");let c=new bL(a);f[y]=c,e.push(c)}else{let b=new bL(a);f[y]=b,g[y]=1,e.push(b)}}),this.filterAndSortMediaOptions(e,b,h,i,j)}filterAndSortMediaOptions(a,b,c,d,e){let f=[],g=[],h=a;if((c||d)&&e&&(h=h.filter(({videoCodec:a,videoRange:b,width:c,height:d})=>{var e;return(!!a||!!(c&&d))&&!!(e=b)&&bI.indexOf(e)>-1})),0===h.length)return void Promise.resolve().then(()=>{if(this.hls){b.levels.length&&this.warn(`One or more CODECS in variant not supported: ${JSON.stringify(b.levels[0].attrs)}`);let a=Error("no level with compatible codecs found in manifest");this.hls.trigger(C.ERROR,{type:D.MEDIA_ERROR,details:E.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:b.url,error:a,reason:a.message})}});if(b.audioTracks){let{preferManagedMediaSource:a}=this.hls.config;eV(f=b.audioTracks.filter(b=>!b.audioCodec||a_(b.audioCodec,"audio",a)))}b.subtitles&&eV(g=b.subtitles);let i=h.slice(0);h.sort((a,b)=>{if(a.attrs["HDCP-LEVEL"]!==b.attrs["HDCP-LEVEL"])return(a.attrs["HDCP-LEVEL"]||"")>(b.attrs["HDCP-LEVEL"]||"")?1:-1;if(c&&a.height!==b.height)return a.height-b.height;if(a.frameRate!==b.frameRate)return a.frameRate-b.frameRate;if(a.videoRange!==b.videoRange)return bI.indexOf(a.videoRange)-bI.indexOf(b.videoRange);if(a.videoCodec!==b.videoCodec){let c=a2(a.videoCodec),d=a2(b.videoCodec);if(c!==d)return d-c}if(a.uri===b.uri&&a.codecSet!==b.codecSet){let c=a3(a.codecSet),d=a3(b.codecSet);if(c!==d)return d-c}return a.averageBitrate!==b.averageBitrate?a.averageBitrate-b.averageBitrate:0});let j=i[0];if(this.steering&&(h=this.steering.filterParsedLevels(h)).length!==i.length){for(let a=0;a<i.length;a++)if(i[a].pathwayId===h[0].pathwayId){j=i[a];break}}this._levels=h;for(let a=0;a<h.length;a++)if(h[a]===j){var k;this._firstLevel=a;let b=j.bitrate,c=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${h.length} level(s) found, first bitrate: ${b}`),(null==(k=this.hls.userConfig)?void 0:k.abrEwmaDefaultEstimate)===void 0){let a=Math.min(b,this.hls.config.abrEwmaDefaultEstimateMax);a>c&&c===eT.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=a)}break}let l=e&&!d,m={levels:h,audioTracks:f,subtitleTracks:g,sessionData:b.sessionData,sessionKeys:b.sessionKeys,firstLevel:this._firstLevel,stats:b.stats,audio:e,video:d,altAudio:!l&&f.some(a=>!!a.url)};this.hls.trigger(C.MANIFEST_PARSED,m),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return 0===this._levels.length?null:this._levels}get level(){return this.currentLevelIndex}set level(a){let b=this._levels;if(0===b.length)return;if(a<0||a>=b.length){let c=Error("invalid level idx"),d=a<0;if(this.hls.trigger(C.ERROR,{type:D.OTHER_ERROR,details:E.LEVEL_SWITCH_ERROR,level:a,fatal:d,error:c,reason:c.message}),d)return;a=Math.min(a,b.length-1)}let c=this.currentLevelIndex,d=this.currentLevel,e=d?d.attrs["PATHWAY-ID"]:void 0,f=b[a],g=f.attrs["PATHWAY-ID"];if(this.currentLevelIndex=a,this.currentLevel=f,c===a&&f.details&&d&&e===g)return;this.log(`Switching to level ${a} (${f.height?f.height+"p ":""}${f.videoRange?f.videoRange+" ":""}${f.codecSet?f.codecSet+" ":""}@${f.bitrate})${g?" with Pathway "+g:""} from level ${c}${e?" with Pathway "+e:""}`);let h={level:a,attrs:f.attrs,details:f.details,bitrate:f.bitrate,averageBitrate:f.averageBitrate,maxBitrate:f.maxBitrate,realBitrate:f.realBitrate,width:f.width,height:f.height,codecSet:f.codecSet,audioCodec:f.audioCodec,videoCodec:f.videoCodec,audioGroups:f.audioGroups,subtitleGroups:f.subtitleGroups,loaded:f.loaded,loadError:f.loadError,fragmentError:f.fragmentError,name:f.name,id:f.id,uri:f.uri,url:f.url,urlId:0,audioGroupIds:f.audioGroupIds,textGroupIds:f.textGroupIds};this.hls.trigger(C.LEVEL_SWITCHING,h);let i=f.details;if(!i||i.live){let a=this.switchParams(f.uri,null==d?void 0:d.details,i);this.loadPlaylist(a)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(a){this.manualLevelIndex=a,void 0===this._startLevel&&(this._startLevel=a),-1!==a&&(this.level=a)}get firstLevel(){return this._firstLevel}set firstLevel(a){this._firstLevel=a}get startLevel(){if(void 0===this._startLevel){let a=this.hls.config.startLevel;return void 0!==a?a:this.hls.firstAutoLevel}return this._startLevel}set startLevel(a){this._startLevel=a}onError(a,b){!b.fatal&&b.context&&b.context.type===bl&&b.context.level===this.level&&this.checkRetry(b)}onFragBuffered(a,{frag:b}){if(void 0!==b&&b.type===bo){let a=b.elementaryStreams;if(!Object.keys(a).some(b=>!!a[b]))return;let c=this._levels[b.level];null!=c&&c.loadError&&(this.log(`Resetting level error count of ${c.loadError} on frag buffered`),c.loadError=0)}}onLevelLoaded(a,b){var c,d;let{level:e,details:f}=b,g=this._levels[e];if(!g){this.warn(`Invalid level index ${e}`),null!=(d=b.deliveryDirectives)&&d.skip&&(f.deltaUpdateFailed=!0);return}e===this.currentLevelIndex?(0===g.fragmentError&&(g.loadError=0),this.playlistLoaded(e,b,g.details)):null!=(c=b.deliveryDirectives)&&c.skip&&(f.deltaUpdateFailed=!0)}loadPlaylist(a){super.loadPlaylist();let b=this.currentLevelIndex,c=this.currentLevel;if(c&&this.shouldLoadPlaylist(c)){let d=c.uri;if(a)try{d=a.addDirectives(d)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}let e=c.attrs["PATHWAY-ID"];this.log(`Loading level index ${b}${(null==a?void 0:a.msn)!==void 0?" at sn "+a.msn+" part "+a.part:""} with${e?" Pathway "+e:""} ${d}`),this.clearTimer(),this.hls.trigger(C.LEVEL_LOADING,{url:d,level:b,pathwayId:c.attrs["PATHWAY-ID"],id:0,deliveryDirectives:a||null})}}get nextLoadLevel(){return -1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(a){this.level=a,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=a)}removeLevel(a){var b;let c=this._levels.filter((b,c)=>c!==a||(this.steering&&this.steering.removeLevel(b),b===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,b.details&&b.details.fragments.forEach(a=>a.level=-1)),!1));bT(c),this._levels=c,this.currentLevelIndex>-1&&null!=(b=this.currentLevel)&&b.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(C.LEVELS_UPDATED,{levels:c})}onLevelsUpdated(a,{levels:b}){this._levels=b}checkMaxAutoUpdated(){let{autoLevelCapping:a,maxAutoLevel:b,maxHdcpLevel:c}=this.hls;this._maxAutoLevel!==b&&(this._maxAutoLevel=b,this.hls.trigger(C.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:a,levels:this.levels,maxAutoLevel:b,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:c}))}}function eV(a){let b={};a.forEach(a=>{let c=a.groupId||"";a.id=b[c]=b[c]||0,b[c]++})}class eW{constructor(a){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=a}abort(a){for(let c in this.keyUriToKeyInfo){let d=this.keyUriToKeyInfo[c].loader;if(d){var b;if(a&&a!==(null==(b=d.context)?void 0:b.frag.type))return;d.abort()}}}detach(){for(let a in this.keyUriToKeyInfo){let b=this.keyUriToKeyInfo[a];(b.mediaKeySessionContext||b.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[a]}}destroy(){for(let a in this.detach(),this.keyUriToKeyInfo){let b=this.keyUriToKeyInfo[a].loader;b&&b.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(a,b=E.KEY_LOAD_ERROR,c,d,e){return new cs({type:D.NETWORK_ERROR,details:b,fatal:!1,frag:a,response:e,error:c,networkDetails:d})}loadClear(a,b){if(this.emeController&&this.config.emeEnabled){let{sn:c,cc:d}=a;for(let a=0;a<b.length;a++){let e=b[a];if(d<=e.cc&&("initSegment"===c||"initSegment"===e.sn||c<e.sn)){this.emeController.selectKeySystemFormat(e).then(a=>{e.setKeyFormat(a)});break}}}}load(a){return!a.decryptdata&&a.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(a).then(b=>this.loadInternal(a,b)):this.loadInternal(a)}loadInternal(a,b){var c,d,e;b&&a.setKeyFormat(b);let f=a.decryptdata;if(!f){let c=Error(b?`Expected frag.decryptdata to be defined after setting format ${b}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(a,E.KEY_LOAD_ERROR,c))}let g=f.uri;if(!g)return Promise.reject(this.createKeyLoadError(a,E.KEY_LOAD_ERROR,Error(`Invalid key URI: "${g}"`)));let h=this.keyUriToKeyInfo[g];if(null!=(c=h)&&c.decryptdata.key)return f.key=h.decryptdata.key,Promise.resolve({frag:a,keyInfo:h});if(null!=(d=h)&&d.keyLoadPromise)switch(null==(e=h.mediaKeySessionContext)?void 0:e.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return h.keyLoadPromise.then(b=>(f.key=b.keyInfo.decryptdata.key,{frag:a,keyInfo:h}))}switch(h=this.keyUriToKeyInfo[g]={decryptdata:f,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},f.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":if("identity"===f.keyFormat)return this.loadKeyHTTP(h,a);return this.loadKeyEME(h,a);case"AES-128":return this.loadKeyHTTP(h,a);default:return Promise.reject(this.createKeyLoadError(a,E.KEY_LOAD_ERROR,Error(`Key supplied with unsupported METHOD: "${f.method}"`)))}}loadKeyEME(a,b){let c={frag:b,keyInfo:a};if(this.emeController&&this.config.emeEnabled){let b=this.emeController.loadKey(c);if(b)return(a.keyLoadPromise=b.then(b=>(a.mediaKeySessionContext=b,c))).catch(b=>{throw a.keyLoadPromise=null,b})}return Promise.resolve(c)}loadKeyHTTP(a,b){let c=this.config,d=new c.loader(c);return b.keyLoader=a.loader=d,a.keyLoadPromise=new Promise((e,f)=>{let g={keyInfo:a,frag:b,responseType:"arraybuffer",url:a.decryptdata.uri},h=c.keyLoadPolicy.default,i={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0};d.load(g,i,{onSuccess:(a,b,c,d)=>{let{frag:g,keyInfo:h,url:i}=c;if(!g.decryptdata||h!==this.keyUriToKeyInfo[i])return f(this.createKeyLoadError(g,E.KEY_LOAD_ERROR,Error("after key load, decryptdata unset or changed"),d));h.decryptdata.key=g.decryptdata.key=new Uint8Array(a.data),g.keyLoader=null,h.loader=null,e({frag:g,keyInfo:h})},onError:(a,c,d,e)=>{this.resetLoader(c),f(this.createKeyLoadError(b,E.KEY_LOAD_ERROR,Error(`HTTP Error ${a.code} loading key ${a.text}`),d,x({url:g.url,data:void 0},a)))},onTimeout:(a,c,d)=>{this.resetLoader(c),f(this.createKeyLoadError(b,E.KEY_LOAD_TIMEOUT,Error("key loading timed out"),d))},onAbort:(a,c,d)=>{this.resetLoader(c),f(this.createKeyLoadError(b,E.INTERNAL_ABORTED,Error("key loading aborted"),d))}})})}resetLoader(a){let{frag:b,keyInfo:c,url:d}=a,e=c.loader;b.keyLoader===e&&(b.keyLoader=null,c.loader=null),delete this.keyUriToKeyInfo[d],e&&e.destroy()}}function eX(){return self.SourceBuffer||self.WebKitSourceBuffer}function eY(){if(!aZ())return!1;let a=eX();return!a||a.prototype&&"function"==typeof a.prototype.appendBuffer&&"function"==typeof a.prototype.remove}class eZ{constructor(a,b,c,d){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=a,this.media=b,this.fragmentTracker=c,this.hls=d}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(a,b){let{config:c,media:d,stalled:e}=this;if(null===d)return;let{currentTime:f,seeking:g}=d,h=this.seeking&&!g,i=!this.seeking&&g;if(this.seeking=g,f!==a){if(this.moved=!0,g||(this.nudgeRetry=0),null!==e){if(this.stallReported){let a=self.performance.now()-e;I.warn(`playback not stuck anymore @${f}, after ${Math.round(a)}ms`),this.stallReported=!1}this.stalled=null}return}if(i||h){this.stalled=null;return}if(d.paused&&!g||d.ended||0===d.playbackRate||!ci.getBuffered(d).length){this.nudgeRetry=0;return}let j=ci.bufferInfo(d,f,0),k=j.nextStart||0;if(g){let a=j.len>2,c=!k||b&&b.start<=f||k-f>2&&!this.fragmentTracker.getPartialFragment(f);if(a||c)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var l;if(!(j.len>0)&&!k)return;let a=Math.max(k,j.start||0)-f,b=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,c=(null==b||null==(l=b.details)?void 0:l.live)?2*b.details.targetduration:2,e=this.fragmentTracker.getPartialFragment(f);if(a>0&&(a<=c||e)){d.paused||this._trySkipBufferHole(e);return}}let m=self.performance.now();if(null===e){this.stalled=m;return}let n=m-e;if(!g&&n>=250&&(this._reportStall(j),!this.media))return;let o=ci.bufferInfo(d,f,c.maxBufferHole);this._tryFixBufferStall(o,n)}_tryFixBufferStall(a,b){let{config:c,fragmentTracker:d,media:e}=this;if(null===e)return;let f=e.currentTime,g=d.getPartialFragment(f);!(g&&(this._trySkipBufferHole(g)||!this.media))&&(a.len>c.maxBufferHole||a.nextStart&&a.nextStart-f<c.maxBufferHole)&&b>1e3*c.highBufferWatchdogPeriod&&(I.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(a){let{hls:b,media:c,stallReported:d}=this;if(!d&&c){this.stallReported=!0;let d=Error(`Playback stalling at @${c.currentTime} due to low buffer (${JSON.stringify(a)})`);I.warn(d.message),b.trigger(C.ERROR,{type:D.MEDIA_ERROR,details:E.BUFFER_STALLED_ERROR,fatal:!1,error:d,buffer:a.len})}}_trySkipBufferHole(a){let{config:b,hls:c,media:d}=this;if(null===d)return 0;let e=d.currentTime,f=ci.bufferInfo(d,e,0),g=e<f.start?f.start:f.nextStart;if(g){let h=f.len<=b.maxBufferHole,i=f.len>0&&f.len<1&&d.readyState<3,j=g-e;if(j>0&&(h||i)){if(j>b.maxBufferHole){let{fragmentTracker:b}=this,c=!1;if(0===e){let a=b.getAppendedFrag(0,bo);a&&g<a.end&&(c=!0)}if(!c){let c=a||b.getAppendedFrag(e,bo);if(c){let a=!1,d=c.end;for(;d<g;){let c=b.getPartialFragment(d);if(c)d+=c.duration;else{a=!0;break}}if(a)return 0}}}let f=Math.max(g+.05,e+.1);if(I.warn(`skipping hole, adjusting currentTime from ${e} to ${f}`),this.moved=!0,this.stalled=null,d.currentTime=f,a&&!a.gap){let b=Error(`fragment loaded with buffer holes, seeking from ${e} to ${f}`);c.trigger(C.ERROR,{type:D.MEDIA_ERROR,details:E.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:b,reason:b.message,frag:a})}return f}}return 0}_tryNudgeBuffer(){let{config:a,hls:b,media:c,nudgeRetry:d}=this;if(null===c)return;let e=c.currentTime;if(this.nudgeRetry++,d<a.nudgeMaxRetry){let f=e+(d+1)*a.nudgeOffset,g=Error(`Nudging 'currentTime' from ${e} to ${f}`);I.warn(g.message),c.currentTime=f,b.trigger(C.ERROR,{type:D.MEDIA_ERROR,details:E.BUFFER_NUDGE_ON_STALL,error:g,fatal:!1})}else{let c=Error(`Playhead still not moving while enough data buffered @${e} after ${a.nudgeMaxRetry} nudges`);I.error(c.message),b.trigger(C.ERROR,{type:D.MEDIA_ERROR,details:E.BUFFER_STALLED_ERROR,error:c,fatal:!0})}}}class e$ extends cK{constructor(a,b,c){super(a,b,c,"[stream-controller]",bo),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){let{hls:a}=this;a.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),a.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),a.on(C.MANIFEST_LOADING,this.onManifestLoading,this),a.on(C.MANIFEST_PARSED,this.onManifestParsed,this),a.on(C.LEVEL_LOADING,this.onLevelLoading,this),a.on(C.LEVEL_LOADED,this.onLevelLoaded,this),a.on(C.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),a.on(C.ERROR,this.onError,this),a.on(C.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),a.on(C.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),a.on(C.BUFFER_CREATED,this.onBufferCreated,this),a.on(C.BUFFER_FLUSHED,this.onBufferFlushed,this),a.on(C.LEVELS_UPDATED,this.onLevelsUpdated,this),a.on(C.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){let{hls:a}=this;a.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),a.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),a.off(C.MANIFEST_LOADING,this.onManifestLoading,this),a.off(C.MANIFEST_PARSED,this.onManifestParsed,this),a.off(C.LEVEL_LOADED,this.onLevelLoaded,this),a.off(C.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),a.off(C.ERROR,this.onError,this),a.off(C.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),a.off(C.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),a.off(C.BUFFER_CREATED,this.onBufferCreated,this),a.off(C.BUFFER_FLUSHED,this.onBufferFlushed,this),a.off(C.LEVELS_UPDATED,this.onLevelsUpdated,this),a.off(C.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(a){if(this.levels){let{lastCurrentTime:b,hls:c}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){let a=c.startLevel;-1===a&&(c.config.testBandwidth&&this.levels.length>1?(a=0,this.bitrateTest=!0):a=c.firstAutoLevel),c.nextLoadLevel=a,this.level=c.loadLevel,this.loadedmetadata=!1}b>0&&-1===a&&(this.log(`Override startPosition with lastCurrentTime @${b.toFixed(3)}`),a=b),this.state=cz,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=a,this.tick()}else this._forceStartLoad=!0,this.state=cy}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case cJ:{let{levels:a,level:b}=this,c=null==a?void 0:a[b],d=null==c?void 0:c.details;if(d&&(!d.live||this.levelLastLoaded===c)){if(this.waitForCdnTuneIn(d))break;this.state=cz}else this.hls.nextLoadLevel!==this.level&&(this.state=cz);break}case cC:{var a;let b=self.performance.now(),c=this.retryDate;if(!c||b>=c||null!=(a=this.media)&&a.seeking){let{levels:a,level:b}=this,c=null==a?void 0:a[b];this.resetStartWhenNotLoaded(c||null),this.state=cz}}}this.state===cz&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){let{hls:a,levelLastLoaded:b,levels:c,media:d}=this;if(null===b||!d&&(this.startFragRequested||!a.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;let e=this.buffering?a.nextLoadLevel:a.loadLevel;if(!(null!=c&&c[e]))return;let f=c[e],g=this.getMainFwdBufferInfo();if(null===g)return;let h=this.getLevelDetails();if(h&&this._streamEnded(g,h)){let a={};this.altAudio&&(a.type="video"),this.hls.trigger(C.BUFFER_EOS,a),this.state=cG;return}if(!this.buffering)return;a.loadLevel!==e&&-1===a.manualLevel&&this.log(`Adapting to level ${e} from level ${this.level}`),this.level=a.nextLoadLevel=e;let i=f.details;if(!i||this.state===cJ||i.live&&this.levelLastLoaded!==f){this.level=e,this.state=cJ;return}let j=g.len,k=this.getMaxBufferLength(f.maxBitrate);if(j>=k)return;this.backtrackFragment&&this.backtrackFragment.start>g.end&&(this.backtrackFragment=null);let l=this.backtrackFragment?this.backtrackFragment.start:g.end,m=this.getNextFragment(l,i);if(this.couldBacktrack&&!this.fragPrevious&&m&&"initSegment"!==m.sn&&"OK"!==this.fragmentTracker.getState(m)){var n;let a=(null!=(n=this.backtrackFragment)?n:m).sn-i.startSN,b=i.fragments[a-1];b&&m.cc===b.cc&&(m=b,this.fragmentTracker.removeFragment(b))}else this.backtrackFragment&&g.len&&(this.backtrackFragment=null);if(m&&this.isLoopLoading(m,l)){if(!m.gap){let a=this.audioOnly&&!this.altAudio?O:P,b=(a===P?this.videoBuffer:this.mediaBuffer)||this.media;b&&this.afterBufferFlushed(b,a,bo)}m=this.getNextFragmentLoopLoading(m,i,g,bo,k)}m&&(!m.initSegment||m.initSegment.data||this.bitrateTest||(m=m.initSegment),this.loadFragment(m,f,l))}loadFragment(a,b,c){let d=this.fragmentTracker.getState(a);this.fragCurrent=a,d===cb||d===cd?"initSegment"===a.sn?this._loadInitSegment(a,b):this.bitrateTest?(this.log(`Fragment ${a.sn} of level ${a.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(a,b)):(this.startFragRequested=!0,super.loadFragment(a,b,c)):this.clearTrackerIfNeeded(a)}getBufferedFrag(a){return this.fragmentTracker.getBufferedFrag(a,bo)}followingBufferedFrag(a){return a?this.getBufferedFrag(a.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,1/0)}nextLevelSwitch(){let{levels:a,media:b}=this;if(null!=b&&b.readyState){let c,d=this.getAppendedFrag(b.currentTime);d&&d.start>1&&this.flushMainBuffer(0,d.start-1);let e=this.getLevelDetails();if(null!=e&&e.live){let a=this.getMainFwdBufferInfo();if(!a||a.len<2*e.targetduration)return}if(!b.paused&&a){let b=a[this.hls.nextLoadLevel],d=this.fragLastKbps;c=d&&this.fragCurrent?this.fragCurrent.duration*b.maxBitrate/(1e3*d)+1:0}else c=0;let f=this.getBufferedFrag(b.currentTime+c);if(f){let a=this.followingBufferedFrag(f);if(a){this.abortCurrentFrag();let b=a.maxStartPTS?a.maxStartPTS:a.start,c=a.duration,d=Math.max(f.end,b+Math.min(Math.max(c-this.config.maxFragLookUpTolerance,c*(this.couldBacktrack?.5:.125)),c*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(d,1/0)}}}}abortCurrentFrag(){let a=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,a&&(a.abortRequests(),this.fragmentTracker.removeFragment(a)),this.state){case cA:case cB:case cC:case cE:case cF:this.state=cz}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(a,b){super.flushMainBuffer(a,b,this.altAudio?"video":null)}onMediaAttached(a,b){super.onMediaAttached(a,b);let c=b.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),c.addEventListener("playing",this.onvplaying),c.addEventListener("seeked",this.onvseeked),this.gapController=new eZ(this.config,c,this.fragmentTracker,this.hls)}onMediaDetaching(){let{media:a}=this;a&&this.onvplaying&&this.onvseeked&&(a.removeEventListener("playing",this.onvplaying),a.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){let a=this.media,b=a?a.currentTime:null;z(b)&&this.log(`Media seeked to ${b.toFixed(3)}`);let c=this.getMainFwdBufferInfo();null===c||0===c.len?this.warn(`Main forward buffer length on "seeked" event ${c?c.len:"empty"})`):this.tick()}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(C.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(a,b){var c;let d,e=!1,f=!1;b.levels.forEach(a=>{let b=a.audioCodec;b&&(e=e||-1!==b.indexOf("mp4a.40.2"),f=f||-1!==b.indexOf("mp4a.40.5"))}),this.audioCodecSwitch=e&&f&&"function"!=typeof(null==(d=eX())||null==(c=d.prototype)?void 0:c.changeType),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=b.levels,this.startFragRequested=!1}onLevelLoading(a,b){let{levels:c}=this;if(!c||this.state!==cz)return;let d=c[b.level];(!d.details||d.details.live&&this.levelLastLoaded!==d||this.waitForCdnTuneIn(d.details))&&(this.state=cJ)}onLevelLoaded(a,b){var c,d;let{levels:e}=this,f=b.level,g=b.details,h=g.totalduration;if(!e)return void this.warn(`Levels were reset while loading level ${f}`);this.log(`Level ${f} loaded [${g.startSN},${g.endSN}]${g.lastPartSn?`[part-${g.lastPartSn}-${g.lastPartIndex}]`:""}, cc [${g.startCC}, ${g.endCC}] duration:${h}`);let i=e[f],j=this.fragCurrent;j&&(this.state===cB||this.state===cC)&&j.level!==b.level&&j.loader&&this.abortCurrentFrag();let k=0;if(g.live||null!=(c=i.details)&&c.live){if(this.checkLiveUpdate(g),g.deltaUpdateFailed)return;k=this.alignPlaylists(g,i.details,null==(d=this.levelLastLoaded)?void 0:d.details)}if(i.details=g,this.levelLastLoaded=i,this.hls.trigger(C.LEVEL_UPDATED,{details:g,level:f}),this.state===cJ){if(this.waitForCdnTuneIn(g))return;this.state=cz}this.startFragRequested?g.live&&this.synchronizeToLiveEdge(g):this.setStartPosition(g,k),this.tick()}_handleFragmentLoadProgress(a){var b;let{frag:c,part:d,payload:e}=a,{levels:f}=this;if(!f)return void this.warn(`Levels were reset while fragment load was in progress. Fragment ${c.sn} of level ${c.level} will not be buffered`);let g=f[c.level],h=g.details;if(!h){this.warn(`Dropping fragment ${c.sn} of level ${c.level} after level details were reset`),this.fragmentTracker.removeFragment(c);return}let i=g.videoCodec,j=h.PTSKnown||!h.live,k=null==(b=c.initSegment)?void 0:b.data,l=this._getAudioCodec(g),m=this.transmuxer=this.transmuxer||new dA(this.hls,bo,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),n=d?d.index:-1,o=new cj(c.level,c.sn,c.stats.chunkCount,e.byteLength,n,-1!==n),p=this.initPTS[c.cc];m.push(e,k,l,i,c,d,h.totalduration,j,o,p)}onAudioTrackSwitching(a,b){let c=this.altAudio;if(!b.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;let a=this.fragCurrent;a&&(this.log("Switching to main audio track, cancel main fragment load"),a.abortRequests(),this.fragmentTracker.removeFragment(a)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();let a=this.hls;c&&(a.trigger(C.BUFFER_FLUSHING,{startOffset:0,endOffset:1/0,type:null}),this.fragmentTracker.removeAllFragments()),a.trigger(C.AUDIO_TRACK_SWITCHED,b)}}onAudioTrackSwitched(a,b){let c=b.id,d=!!this.hls.audioTracks[c].url;if(d){let a=this.videoBuffer;a&&this.mediaBuffer!==a&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=a)}this.altAudio=d,this.tick()}onBufferCreated(a,b){let c,d,e=b.tracks,f=!1;for(let a in e){let b=e[a];if("main"===b.id){if(d=a,c=b,"video"===a){let b=e[a];b&&(this.videoBuffer=b.buffer)}}else f=!0}f&&c?(this.log(`Alternate track found, use ${d}.buffered to schedule main fragment loading`),this.mediaBuffer=c.buffer):this.mediaBuffer=this.media}onFragBuffered(a,b){let{frag:c,part:d}=b;if(c&&c.type!==bo)return;if(this.fragContextChanged(c)){this.warn(`Fragment ${c.sn}${d?" p: "+d.index:""} of level ${c.level} finished buffering, but was aborted. state: ${this.state}`),this.state===cF&&(this.state=cz);return}let e=d?d.stats:c.stats;this.fragLastKbps=Math.round(8*e.total/(e.buffering.end-e.loading.first)),"initSegment"!==c.sn&&(this.fragPrevious=c),this.fragBufferedComplete(c,d)}onError(a,b){var c;if(b.fatal){this.state=cH;return}switch(b.details){case E.FRAG_GAP:case E.FRAG_PARSING_ERROR:case E.FRAG_DECRYPT_ERROR:case E.FRAG_LOAD_ERROR:case E.FRAG_LOAD_TIMEOUT:case E.KEY_LOAD_ERROR:case E.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(bo,b);break;case E.LEVEL_LOAD_ERROR:case E.LEVEL_LOAD_TIMEOUT:case E.LEVEL_PARSING_ERROR:b.levelRetry||this.state!==cJ||(null==(c=b.context)?void 0:c.type)!==bl||(this.state=cz);break;case E.BUFFER_APPEND_ERROR:case E.BUFFER_FULL_ERROR:if(!b.parent||"main"!==b.parent)return;if(b.details===E.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(b)&&this.flushMainBuffer(0,1/0);break;case E.INTERNAL_EXCEPTION:this.recoverWorkerError(b)}}checkBuffer(){let{media:a,gapController:b}=this;if(a&&b&&a.readyState){if(this.loadedmetadata||!ci.getBuffered(a).length){let a=this.state!==cz?this.fragCurrent:null;b.poll(this.lastCurrentTime,a)}this.lastCurrentTime=a.currentTime}}onFragLoadEmergencyAborted(){this.state=cz,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(a,{type:b}){if(b!==O||this.audioOnly&&!this.altAudio){let a=(b===P?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(a,b,bo),this.tick()}}onLevelsUpdated(a,b){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=b.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){let{media:a}=this;if(!a)return;let b=a.currentTime,c=this.startPosition;if(c>=0&&b<c){if(a.seeking)return void this.log(`could not seek to ${c}, already seeking at ${b}`);let d=ci.getBuffered(a),e=(d.length?d.start(0):0)-c;e>0&&(e<this.config.maxBufferHole||e<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${e} to match buffer start`),c+=e,this.startPosition=c),this.log(`seek to target start position ${c} from current time ${b}`),a.currentTime=c}}_getAudioCodec(a){let b=this.config.defaultAudioCodec||a.audioCodec;return this.audioCodecSwap&&b&&(this.log("Swapping audio codec"),b=-1!==b.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),b}_loadBitrateTestFrag(a,b){a.bitrateTest=!0,this._doFragLoad(a,b).then(c=>{let{hls:d}=this;if(!c||this.fragContextChanged(a))return;b.fragmentError=0,this.state=cz,this.startFragRequested=!1,this.bitrateTest=!1;let e=a.stats;e.parsing.start=e.parsing.end=e.buffering.start=e.buffering.end=self.performance.now(),d.trigger(C.FRAG_LOADED,c),a.bitrateTest=!1})}_handleTransmuxComplete(a){var b;let c="main",{hls:d}=this,{remuxResult:e,chunkMeta:f}=a,g=this.getCurrentContext(f);if(!g)return void this.resetWhenMissingContext(f);let{frag:h,part:i,level:j}=g,{video:k,text:l,id3:m,initSegment:n}=e,{details:o}=j,p=this.altAudio?void 0:e.audio;if(this.fragContextChanged(h))return void this.fragmentTracker.removeFragment(h);if(this.state=cE,n){if(null!=n&&n.tracks){let a=h.initSegment||h;this._bufferInitSegment(j,n.tracks,a,f),d.trigger(C.FRAG_PARSING_INIT_SEGMENT,{frag:a,id:c,tracks:n.tracks})}let a=n.initPTS,b=n.timescale;z(a)&&(this.initPTS[h.cc]={baseTime:a,timescale:b},d.trigger(C.INIT_PTS_FOUND,{frag:h,id:c,initPTS:a,timescale:b}))}if(k&&o&&"initSegment"!==h.sn){let a=o.fragments[h.sn-1-o.startSN],b=h.sn===o.startSN,c=!a||h.cc>a.cc;if(!1!==e.independent){let{startPTS:a,endPTS:d,startDTS:e,endDTS:g}=k;if(i)i.elementaryStreams[k.type]={startPTS:a,endPTS:d,startDTS:e,endDTS:g};else if(k.firstKeyFrame&&k.independent&&1===f.id&&!c&&(this.couldBacktrack=!0),k.dropped&&k.independent){let e=this.getMainFwdBufferInfo(),f=(e?e.end:this.getLoadPosition())+this.config.maxBufferHole,i=k.firstKeyFramePTS?k.firstKeyFramePTS:a;if(!b&&f<i-this.config.maxBufferHole&&!c)return void this.backtrack(h);c&&(h.gap=!0),h.setElementaryStreamInfo(k.type,h.start,d,h.start,g,!0)}else b&&a>2&&(h.gap=!0);h.setElementaryStreamInfo(k.type,a,d,e,g),this.backtrackFragment&&(this.backtrackFragment=h),this.bufferFragmentData(k,h,i,f,b||c)}else{if(!b&&!c)return void this.backtrack(h);h.gap=!0}}if(p){let{startPTS:a,endPTS:b,startDTS:c,endDTS:d}=p;i&&(i.elementaryStreams[O]={startPTS:a,endPTS:b,startDTS:c,endDTS:d}),h.setElementaryStreamInfo(O,a,b,c,d),this.bufferFragmentData(p,h,i,f)}if(o&&null!=m&&null!=(b=m.samples)&&b.length){let a={id:c,frag:h,details:o,samples:m.samples};d.trigger(C.FRAG_PARSING_METADATA,a)}if(o&&l){let a={id:c,frag:h,details:o,samples:l.samples};d.trigger(C.FRAG_PARSING_USERDATA,a)}}_bufferInitSegment(a,b,c,d){if(this.state!==cE)return;this.audioOnly=!!b.audio&&!b.video,this.altAudio&&!this.audioOnly&&delete b.audio;let{audio:e,video:f,audiovideo:g}=b;if(e){let b=a.audioCodec,c=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){b&&(b=-1!==b.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5");let a=e.metadata;a&&"channelCount"in a&&1!==(a.channelCount||1)&&-1===c.indexOf("firefox")&&(b="mp4a.40.5")}b&&-1!==b.indexOf("mp4a.40.5")&&-1!==c.indexOf("android")&&"audio/mpeg"!==e.container&&(b="mp4a.40.2",this.log(`Android: force audio codec to ${b}`)),a.audioCodec&&a.audioCodec!==b&&this.log(`Swapping manifest audio codec "${a.audioCodec}" for "${b}"`),e.levelCodec=b,e.id="main",this.log(`Init audio buffer, container:${e.container}, codecs[selected/level/parsed]=[${b||""}/${a.audioCodec||""}/${e.codec}]`)}f&&(f.levelCodec=a.videoCodec,f.id="main",this.log(`Init video buffer, container:${f.container}, codecs[level/parsed]=[${a.videoCodec||""}/${f.codec}]`)),g&&this.log(`Init audiovideo buffer, container:${g.container}, codecs[level/parsed]=[${a.codecs}/${g.codec}]`),this.hls.trigger(C.BUFFER_CODECS,b),Object.keys(b).forEach(a=>{let e=b[a].initSegment;null!=e&&e.byteLength&&this.hls.trigger(C.BUFFER_APPENDING,{type:a,data:e,frag:c,part:null,chunkMeta:d,parent:c.type})}),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,bo)}backtrack(a){this.couldBacktrack=!0,this.backtrackFragment=a,this.resetTransmuxer(),this.flushBufferGap(a),this.fragmentTracker.removeFragment(a),this.fragPrevious=null,this.nextLoadPosition=a.start,this.state=cz}checkFragmentChanged(){let a=this.media,b=null;if(a&&a.readyState>1&&!1===a.seeking){let c=a.currentTime;if(ci.isBuffered(a,c)?b=this.getAppendedFrag(c):ci.isBuffered(a,c+.1)&&(b=this.getAppendedFrag(c+.1)),b){this.backtrackFragment=null;let a=this.fragPlaying,c=b.level;(!a||b.sn!==a.sn||a.level!==c)&&(this.fragPlaying=b,this.hls.trigger(C.FRAG_CHANGED,{frag:b}),a&&a.level===c||this.hls.trigger(C.LEVEL_SWITCHED,{level:c}))}}}get nextLevel(){let a=this.nextBufferedFrag;return a?a.level:-1}get currentFrag(){let a=this.media;return a?this.fragPlaying||this.getAppendedFrag(a.currentTime):null}get currentProgramDateTime(){let a=this.media;if(a){let b=a.currentTime,c=this.currentFrag;if(c&&z(b)&&z(c.programDateTime))return new Date(c.programDateTime+(b-c.start)*1e3)}return null}get currentLevel(){let a=this.currentFrag;return a?a.level:-1}get nextBufferedFrag(){let a=this.currentFrag;return a?this.followingBufferedFrag(a):null}get forceStartLoad(){return this._forceStartLoad}}class e_{static get version(){return"1.5.18"}static isMSESupported(){return eY()}static isSupported(){if(!eY())return!1;let a=aZ();return"function"==typeof(null==a?void 0:a.isTypeSupported)&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(b=>a.isTypeSupported(a1(b,"video")))||["mp4a.40.2","fLaC"].some(b=>a.isTypeSupported(a1(b,"audio"))))}static getMediaSource(){return aZ()}static get Events(){return C}static get ErrorTypes(){return D}static get ErrorDetails(){return E}static get DefaultConfig(){return e_.defaultConfig?e_.defaultConfig:eT}static set DefaultConfig(a){e_.defaultConfig=a}constructor(a={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new dz,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,function(a,b){if("object"==typeof console&&!0===a||"object"==typeof a){!function(a,...b){b.forEach(function(b){let c;H[b]=a[b]?a[b].bind(a):(c=self.console[b])?c.bind(self.console,`[${b}] >`):F})}(a,"debug","log","info","warn","error");try{H.log(`Debug logs enabled for "${b}" in hls.js version 1.5.18`)}catch(a){H=G}}else H=G}(a.debug||!1,"Hls instance");const b=this.config=function(a,b){if((b.liveSyncDurationCount||b.liveMaxLatencyDurationCount)&&(b.liveSyncDuration||b.liveMaxLatencyDuration))throw Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==b.liveMaxLatencyDurationCount&&(void 0===b.liveSyncDurationCount||b.liveMaxLatencyDurationCount<=b.liveSyncDurationCount))throw Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==b.liveMaxLatencyDuration&&(void 0===b.liveSyncDuration||b.liveMaxLatencyDuration<=b.liveSyncDuration))throw Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');let c=function a(b){return b&&"object"==typeof b?Array.isArray(b)?b.map(a):Object.keys(b).reduce((c,d)=>(c[d]=a(b[d]),c),{}):b}(a),d=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach(a=>{let e=`${"level"===a?"playlist":a}LoadPolicy`,f=void 0===b[e],g=[];d.forEach(d=>{let h=`${a}Loading${d}`,i=b[h];if(void 0!==i&&f){g.push(h);let a=c[e].default;switch(b[e]={default:a},d){case"TimeOut":a.maxLoadTimeMs=i,a.maxTimeToFirstByteMs=i;break;case"MaxRetry":a.errorRetry.maxNumRetry=i,a.timeoutRetry.maxNumRetry=i;break;case"RetryDelay":a.errorRetry.retryDelayMs=i,a.timeoutRetry.retryDelayMs=i;break;case"MaxRetryTimeout":a.errorRetry.maxRetryDelayMs=i,a.timeoutRetry.maxRetryDelayMs=i}}}),g.length&&I.warn(`hls.js config: "${g.join('", "')}" setting(s) are deprecated, use "${e}": ${JSON.stringify(b[e])}`)}),x(x({},c),b)}(e_.DefaultConfig,a);this.userConfig=a,b.progressive&&function(a){let b=a.loader;b!==eO&&b!==eM?(I.log("[config]: Custom loader detected, cannot enable progressive streaming"),a.progressive=!1):function(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(a){}return!1}()&&(a.loader=eO,a.progressive=!0,a.enableSoftwareAES=!0,I.log("[config]: Progressive streaming enabled, using FetchLoader"))}(b);const{abrController:c,bufferController:d,capLevelController:e,errorController:f,fpsController:g}=b,h=new f(this),i=this.abrController=new c(this),j=this.bufferController=new d(this),k=this.capLevelController=new e(this),l=new g(this),m=new bt(this),n=new bF(this),o=b.contentSteeringController,p=o?new o(this):null,q=this.levelController=new eU(this,p),r=new ce(this),s=new eW(this.config),t=this.streamController=new e$(this,r,s);k.setStreamController(t),l.setStreamController(t);const u=[m,q,t];p&&u.splice(1,0,p),this.networkControllers=u;const v=[i,j,k,l,n,r];this.audioTrackController=this.createController(b.audioTrackController,u);const w=b.audioStreamController;w&&u.push(new w(this,r,s)),this.subtitleTrackController=this.createController(b.subtitleTrackController,u);const y=b.subtitleStreamController;y&&u.push(new y(this,r,s)),this.createController(b.timelineController,v),s.emeController=this.emeController=this.createController(b.emeController,v),this.cmcdController=this.createController(b.cmcdController,v),this.latencyController=this.createController(bG,v),this.coreComponents=v,u.push(h);const z=h.onErrorOut;"function"==typeof z&&this.on(C.ERROR,z,h)}createController(a,b){if(a){let c=new a(this);return b&&b.push(c),c}return null}on(a,b,c=this){this._emitter.on(a,b,c)}once(a,b,c=this){this._emitter.once(a,b,c)}removeAllListeners(a){this._emitter.removeAllListeners(a)}off(a,b,c=this,d){this._emitter.off(a,b,c,d)}listeners(a){return this._emitter.listeners(a)}emit(a,b,c){return this._emitter.emit(a,b,c)}trigger(a,b){if(this.config.debug)return this.emit(a,a,b);try{return this.emit(a,a,b)}catch(b){if(I.error("An internal error happened while handling event "+a+'. Error message: "'+b.message+'". Here is a stacktrace:',b),!this.triggeringException){this.triggeringException=!0;let c=a===C.ERROR;this.trigger(C.ERROR,{type:D.OTHER_ERROR,details:E.INTERNAL_EXCEPTION,fatal:c,event:a,error:b}),this.triggeringException=!1}}return!1}listenerCount(a){return this._emitter.listenerCount(a)}destroy(){I.log("destroy"),this.trigger(C.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(a=>a.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(a=>a.destroy()),this.coreComponents.length=0;let a=this.config;a.xhrSetup=a.fetchSetup=void 0,this.userConfig=null}attachMedia(a){I.log("attachMedia"),this._media=a,this.trigger(C.MEDIA_ATTACHING,{media:a})}detachMedia(){I.log("detachMedia"),this.trigger(C.MEDIA_DETACHING,void 0),this._media=null}loadSource(a){this.stopLoad();let b=this.media,c=this.url,d=this.url=v.buildAbsoluteURL(self.location.href,a,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,I.log(`loadSource:${d}`),b&&c&&(c!==d||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(b)),this.trigger(C.MANIFEST_LOADING,{url:a})}startLoad(a=-1){I.log(`startLoad(${a})`),this.started=!0,this.resumeBuffering();for(let b=0;b<this.networkControllers.length&&(this.networkControllers[b].startLoad(a),this.started&&this.networkControllers);b++);}stopLoad(){I.log("stopLoad"),this.started=!1;for(let a=0;a<this.networkControllers.length&&(this.networkControllers[a].stopLoad(),!this.started&&this.networkControllers);a++);}resumeBuffering(){I.log("resume buffering"),this.networkControllers.forEach(a=>{a.resumeBuffering&&a.resumeBuffering()})}pauseBuffering(){I.log("pause buffering"),this.networkControllers.forEach(a=>{a.pauseBuffering&&a.pauseBuffering()})}swapAudioCodec(){I.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){I.log("recoverMediaError");let a=this._media;this.detachMedia(),a&&this.attachMedia(a)}removeLevel(a){this.levelController.removeLevel(a)}get levels(){return this.levelController.levels||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(a){I.log(`set currentLevel:${a}`),this.levelController.manualLevel=a,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(a){I.log(`set nextLevel:${a}`),this.levelController.manualLevel=a,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(a){I.log(`set loadLevel:${a}`),this.levelController.manualLevel=a}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(a){this.levelController.nextLoadLevel=a}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(a){I.log(`set firstLevel:${a}`),this.levelController.firstLevel=a}get startLevel(){let a=this.levelController.startLevel;return -1===a&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:a}set startLevel(a){I.log(`set startLevel:${a}`),-1!==a&&(a=Math.max(a,this.minAutoLevel)),this.levelController.startLevel=a}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(a){let b=!!a;b!==this.config.capLevelToPlayerSize&&(b?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=b)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){let{bwEstimator:a}=this.abrController;return a?a.getEstimate():NaN}set bandwidthEstimate(a){this.abrController.resetEstimator(a)}get ttfbEstimate(){let{bwEstimator:a}=this.abrController;return a?a.getEstimateTTFB():NaN}set autoLevelCapping(a){this._autoLevelCapping!==a&&(I.log(`set autoLevelCapping:${a}`),this._autoLevelCapping=a,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(a){bH.indexOf(a)>-1&&this._maxHdcpLevel!==a&&(this._maxHdcpLevel=a,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return -1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){let{levels:a,config:{minAutoBitrate:b}}=this;if(!a)return 0;let c=a.length;for(let d=0;d<c;d++)if(a[d].maxBitrate>=b)return d;return 0}get maxAutoLevel(){let a,{levels:b,autoLevelCapping:c,maxHdcpLevel:d}=this;if(a=-1===c&&null!=b&&b.length?b.length-1:c,d)for(let c=a;c--;){let a=b[c].attrs["HDCP-LEVEL"];if(a&&a<=d)return c}return a}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(a){this.abrController.nextAutoLevel=a}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(a){var b;return null==(b=this.audioTrackController)?void 0:b.setAudioOption(a)}setSubtitleOption(a){var b;return null==(b=this.subtitleTrackController)||b.setSubtitleOption(a),null}get allAudioTracks(){let a=this.audioTrackController;return a?a.allAudioTracks:[]}get audioTracks(){let a=this.audioTrackController;return a?a.audioTracks:[]}get audioTrack(){let a=this.audioTrackController;return a?a.audioTrack:-1}set audioTrack(a){let b=this.audioTrackController;b&&(b.audioTrack=a)}get allSubtitleTracks(){let a=this.subtitleTrackController;return a?a.allSubtitleTracks:[]}get subtitleTracks(){let a=this.subtitleTrackController;return a?a.subtitleTracks:[]}get subtitleTrack(){let a=this.subtitleTrackController;return a?a.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(a){let b=this.subtitleTrackController;b&&(b.subtitleTrack=a)}get subtitleDisplay(){let a=this.subtitleTrackController;return!!a&&a.subtitleDisplay}set subtitleDisplay(a){let b=this.subtitleTrackController;b&&(b.subtitleDisplay=a)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(a){this.config.lowLatencyMode=a}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}e_.defaultConfig=void 0,a.s(["default",()=>e_])}];

//# sourceMappingURL=node_modules_hls_js_dist_hls_mjs_bc37615f._.js.map