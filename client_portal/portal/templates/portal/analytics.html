{% extends 'portal/base.html' %}

{% block title %}Analytics{% endblock %}

{% block content %}
<div class="p-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="font-serif text-3xl font-bold text-white mb-2">Analytics</h1>
        <p class="text-gray-500">Track your key performance metrics and KPIs.</p>
    </div>
    
    <!-- Chart Section -->
    {% if categories %}
    <div class="glass-card rounded-2xl p-6 mb-8">
        <!-- Category Tabs -->
        <div class="flex flex-wrap gap-2 mb-6">
            {% for category in categories %}
            <button onclick="loadChart('{{ category }}')"
                    data-category="{{ category }}"
                    class="category-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-gray-800/50 text-gray-400 border border-transparent hover:bg-gray-800">
                {{ category|title }}
            </button>
            {% endfor %}
        </div>
        
        <!-- Chart Container -->
        <div class="relative h-[400px]">
            <canvas id="metricsChart"></canvas>
        </div>
    </div>
    
    <!-- Metrics Table -->
    <div class="glass-card rounded-2xl p-6">
        <h2 class="text-lg font-bold text-white mb-4">All Data Points</h2>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-glass-border">
                        <th class="text-left py-3 px-4 text-xs uppercase tracking-wider text-gray-500 font-mono">Date</th>
                        <th class="text-left py-3 px-4 text-xs uppercase tracking-wider text-gray-500 font-mono">Category</th>
                        <th class="text-left py-3 px-4 text-xs uppercase tracking-wider text-gray-500 font-mono">Label</th>
                        <th class="text-right py-3 px-4 text-xs uppercase tracking-wider text-gray-500 font-mono">Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for metric in metrics %}
                    <tr class="border-b border-glass-border/50 hover:bg-gray-800/30 transition-colors">
                        <td class="py-3 px-4 text-sm text-gray-400">{{ metric.date|date:"M d, Y" }}</td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 rounded-md bg-accent-cyan/10 text-accent-cyan text-xs font-mono">
                                {{ metric.get_category_display }}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-sm text-gray-300">{{ metric.label }}</td>
                        <td class="py-3 px-4 text-right text-sm font-mono text-white">{{ metric.value|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="glass-card rounded-2xl p-12 text-center">
        <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gray-800/50 flex items-center justify-center">
            <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
        </div>
        <h3 class="text-lg font-bold text-white mb-2">No analytics data yet</h3>
        <p class="text-gray-500 text-sm">Your performance metrics will appear here once your consultant adds data points.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
let chartInstance = null;

function loadChart(category) {
    // Update button states
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('bg-accent-cyan/20', 'text-accent-cyan', 'border-accent-cyan/30');
        btn.classList.add('bg-gray-800/50', 'text-gray-400', 'border-transparent');
    });
    const activeBtn = document.querySelector(`[data-category="${category}"]`);
    if (activeBtn) {
        activeBtn.classList.remove('bg-gray-800/50', 'text-gray-400', 'border-transparent');
        activeBtn.classList.add('bg-accent-cyan/20', 'text-accent-cyan', 'border-accent-cyan/30');
    }
    
    // Fetch data and render chart
    fetch(`{% url 'portal:analytics_data' %}?category=${category}`)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('metricsChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#9ca3af',
                                font: {
                                    family: 'JetBrains Mono'
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    family: 'JetBrains Mono',
                                    size: 10
                                }
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    family: 'JetBrains Mono',
                                    size: 10
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        })
        .catch(err => console.error('Error loading chart:', err));
}

// Load first category on page load
document.addEventListener('DOMContentLoaded', function() {
    const firstCategory = document.querySelector('.category-btn');
    if (firstCategory) {
        loadChart(firstCategory.dataset.category);
    }
});
</script>
{% endblock %}

